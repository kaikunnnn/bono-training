
# コンテンツの出しわけロジックの開発ドキュメント 📝

この内容を参照してステップごとに実装と確認をしながら
アカウントのサブスクリプションの登録状態を確認して
コンテンツを出しわけできるようにしていってください！

---

# Vite で機密コンテンツをプラン別に出し分ける実装状況 - *microCMS + Vimeo 対応*版

以下の実装状況を確認してください：

## ✅ ステップ 0: 開発環境の前提確認

1. **フロントエンド**: ✅
   - Vite + React + TypeScript 環境で実装完了
2. **サーバーサイド**: ✅
   - Supabase Edge Functions で実装完了
3. **データベース**: ✅
   - サブスク情報（`planType`, `is_active`）は Supabase で管理
   - コンテンツはモックデータで実装済み
4. **認証基盤**: ✅
   - JWT + Supabase Auth で実装完了
5. **Vimeo**: 🟡
   - 基本的な埋め込み実装完了
   - ドメイン制限は未設定

---

## ✅ ステップ 1: 認証 & 課金状態を管理する仕組み

### 1-1. ユーザー認証 ✅
- ✅ セッション/トークン管理
- ✅ API認証ヘッダー実装
- ✅ ログイン状態の永続化

### 1-2. サブスク管理 (is_active) ✅
- ✅ `user_subscriptions` テーブル実装
- ✅ Stripe Webhook 連携実装
- ✅ プラン状態チェック機能実装

---

## ✅ ステップ 2: サーバー API で機密コンテンツを返す仕組み

### 2-1. コンテンツ管理方法 🟡
- ✅ モックデータでの実装完了
- 🟠 microCMS での本番実装は未着手

### 2-2. プラン制御のマッピング ✅
- ✅ `CONTENT_PERMISSIONS` による制御実装
- ✅ アクセスレベルのマッピング実装

### 2-3. API実装 ✅
- ✅ GET /api/content/:contentId の実装
- ✅ 認証チェック
- ✅ プランチェック
- ✅ コンテンツ返却処理

---

## ✅ ステップ 3: フロントエンド (Vite) の実装

### 3-1. ログイン状態 & プラン取得 ✅
- ✅ ユーザー状態管理の実装
- ✅ プラン情報の取得と管理
- ✅ エラーハンドリング

### 3-2. 機密コンテンツ取得 ✅
- ✅ 認証付きAPI呼び出し
- ✅ エラーハンドリング
- ✅ ローディング状態管理

### 3-3. UI レベルの分岐 ✅
- ✅ プランに応じたUI制御
- ✅ 未認証/未購読時の案内表示

---

## 🟡 ステップ 4: 動画などの保護

1. Vimeo の埋め込み 🟡
   - ✅ 基本的な埋め込み実装
   - 🟠 ドメイン制限設定は未実施

2. ファイルの保護 ✅
   - ✅ 直リンク防止の実装
   - ✅ プレビュー制御の実装

---

## 🟡 ステップ 5: テスト & 運用

### プラン別テストユーザー 🟡
- ✅ テストユーザーの作成機能
- ✅ プラン切り替えのテスト環境
- 🟠 E2Eテストの実装

### フロントエンド UI のテスト 🟡
- ✅ ログイン状態での表示確認
- ✅ 非ログイン状態での表示確認
- 🟠 自動テストの実装

### Stripe 決済連携のテスト ✅
- ✅ Webhook 動作確認
- ✅ キャンセルフロー確認
- ✅ エラーハンドリング確認

### 運用フロー 🟡

#### コンテンツ管理 🟠
- 🟠 microCMS 管理画面での更新フロー
- 🟠 コンテンツ更新手順の整備

#### プラン拡張時の対応 ✅
- ✅ CONTENT_PERMISSIONS の拡張機能
- ✅ 認可ロジックの修正手順

---

# まとめ

## 基本設計 ✅

- ✅ **サブスクリプション判定**: `is_active` フラグでの管理
  - Stripe連携による自動更新

## コンテンツ管理 🟡

### モックデータ ✅
- ✅ 基本的なコンテンツ構造
- ✅ アクセス制御の実装

### microCMS 🟠
- 🟠 API連携の実装
- 🟠 コンテンツ管理フローの整備

### サーバー API ✅

1. ✅ コンテンツ情報の取得
2. ✅ アクセス制御
   - プラン確認
   - 権限チェック
3. ✅ レスポンス生成

### フロントエンド ✅

1. ✅ API呼び出し
2. ✅ 表示制御実装
3. ✅ エラーハンドリング

## セキュリティ強化 🟡

- ✅ 基本的なアクセス制御
- 🟠 Vimeoのドメイン制限

## 結論

基本的な機能は実装完了。残りの課題：
1. 🟠 microCMS との連携実装
2. 🟠 テスト環境の整備
3. 🟠 運用フローの確立

