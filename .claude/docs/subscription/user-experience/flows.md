# サブスクリプション ユーザーフロー

**最終更新**: 2025-11-29
**作成者**: Takumi

---

## 📑 目次

- [サブスクリプション ユーザーフロー](#サブスクリプション-ユーザーフロー)
  - [📑 目次](#-目次)
  - [🎯 この機能の目的](#-この機能の目的)
  - [👤 対象ユーザー](#-対象ユーザー)
  - [📋 基本フロー](#-基本フロー)
    - [フロー 1: 新規登録（スタンダードプラン）](#フロー-1-新規登録スタンダードプラン)
    - [フロー 2: プラン変更（アップグレード）](#フロー-2-プラン変更アップグレード)
    - [フロー 3: プラン変更（ダウングレード）](#フロー-3-プラン変更ダウングレード)
    - [フロー 4: プランキャンセル](#フロー-4-プランキャンセル)
  - [🚨 異常系フロー](#-異常系フロー)
    - [異常フロー 1: 決済失敗](#異常フロー-1-決済失敗)
    - [異常フロー 2: Webhook 失敗](#異常フロー-2-webhook-失敗)
    - [異常フロー 3: 2 重決済](#異常フロー-3-2-重決済)
  - [🔄 状態遷移](#-状態遷移)
    - [ユーザーの状態](#ユーザーの状態)

---

## 🎯 この機能の目的

**ユーザーが達成したいこと**:

- 自分に合ったプランを選んで登録したい
- プランを変更したい（アップグレード・ダウングレード）
- プランをキャンセルしたい

**ビジネス上の目的**:

- ユーザーが迷わずサブスクリプション登録できる
- プラン変更がスムーズにできる
- 離脱を防ぐ（エラーを最小限に）

---

## 👤 対象ユーザー

- **新規ユーザー**: まだサブスクリプションに登録していない
- **既存ユーザー**: 既にプランに登録済み
- **アップグレード検討ユーザー**: より高機能なプランに興味がある
- **キャンセル検討ユーザー**: プランをやめたい

---

## 📋 基本フロー

### フロー 1: 新規登録（スタンダードプラン）

**Given（前提）**:

- ユーザーは未登録
- ログイン済み

**When（操作）**:

1. /subscription ページを開く
2. プラン一覧を確認
   1. スタンダードプランとフィードバックプラン
   2. それぞれ 1 ヶ月と 3 ヶ月の期間を変更することができ、それぞれのプランを選択できる
3. 「新規に開始したいプランを選択」ボタンをクリック
4. Stripe Checkout ページにリダイレクト
5. 決済情報を入力
6. 決済完了
7. 決済完了後に「サクセスページ」にリダイレクト
8. サクセスページ：登録したプラン名がでていて「完了しました」が表示され、ユーザーは確認できる

**Then（結果）**:

- ✅ 即座にスタンダードプランの機能が使える
- ✅ /subscription ページに「現在のプラン: スタンダード」と表示
- ✅ /account ページにもプラン情報が表示
- ✅ メールで確認通知が届く
- ❌ エラーが発生しない
- ❌ 2 重登録されない

---

### フロー 2: プラン変更（アップグレード）

**Given（前提）**:

- ユーザーは既にスタンダードプランに登録済み

**When（操作）**:

1. /subscription ページを開く
2. 「XXXX プラン」の「プラン変更」ボタンをクリック
3. 選択したプランの"更新確認"ページが表示
   1. 決済情報を確認
   2. 決済内容を確認 → すでに入っているプランとの差額計算があるならそれを表示
   3. この内容で確定できるボタンがある
   4. 注意
      1. この時確認ページが表示された後に、ブラウザバックなどで戻っても何もプランに影響はないです
4. 更新確認ページで更新を確定するボタンを押す
5. （もし Stripe が用意している画面に遷移して確定をしている場合は、確定ボタンを押したらサービスに戻る）
6. 更新が行われました！の表示が出る。自分が変更したプランを確認ができる
7. 決済とプランの変更が完了

**Then（結果）**:

- ✅ 即座にプランの機能が使える
- ✅ /subscription ページに「現在のプラン: "プラン名"＋"期間"」が表示
- ✅ 古いスタンダードプランは自動的にキャンセルされている
- ✅ 日割り計算された金額が請求される
- ❌ 2 重課金されない
- ❌ スタンダードプランの課金が続かない

---

### フロー 3: プラン変更（ダウングレード）

**Given（前提）**:

- ユーザーは既にフィードバックプランに登録済み

**When（操作）**:

1.フロー２と操作とフロー自体は一緒。

**Then（結果）**:

- ✅ 即座に変更したプランに変更される → 理由：差額分を日割り計算して変更できるため
  ※ Stripe の普通の実装と違う仕様の場合は確認してください。

---

### フロー 4: プランキャンセル

**Given（前提）**:

- ユーザーはプランに登録済み

**When（操作）**:

1. /account ページ
2. 自分のアカウント情報が表示されているブロックに以下がある
   1. プランの確認 →Stripe ポータルを表示して今の自分のプランや支払い情報が表示する
   2. プランのキャンセル
3. 「プランをキャンセル」ボタンをクリック
4. Stripe の仕組みを使ってキャンセルが可能
   1. 例：カスタマーポータルのキャンセル確認ページへ遷移するなど

**Then（結果）**:

- ✅ 現在の期間終了時にキャンセルされる
- ✅ 期間終了までは機能が使える
- ✅ 「〇〇日まで利用可能」と表示される
- ✅ 確認メールが届く
- ❌ 即座にサービスが使えなくならない

---

## 🚨 異常系フロー

### 異常フロー 1: 決済失敗

**Given（前提）**:

- ユーザーが新規登録またはプラン変更を試みる

**When（操作）**:

1. Stripe Checkout で決済情報を入力
2. カードが無効で決済失敗

**Then（結果）**:

- ✅ Stripe 側でエラーメッセージが表示される
- ✅ ユーザーは/subscription ページに戻る
- ✅ プランは変更されない
- ✅ 古いプランは維持される
- ❌ データベースに不完全なレコードが残らない

---

### 異常フロー 2: Webhook 失敗

**Given（前提）**:

- ユーザーが決済完了
- Webhook が何らかの理由で失敗

**When（操作）**:

1. Stripe Checkout で決済完了
2. Webhook が 401 エラーで失敗

**Then（結果）**:

- ✅ ユーザーには「決済完了」と表示される
- ✅ Stripe 側には決済記録が残る
- ❌ データベースは更新されない（これは問題）
- ❌ ユーザーは「subscribed: false」のまま

**対処**:

- システム側で Webhook 再試行
- →Webhook が動かない場合はプラン変更を中止する。すでに変更されているならもとに戻せるかどうかを検討、それがダメなら Webhook が効かないなら変更させない仕様にする

---

### 異常フロー 3: 2 重決済

**Given（前提）**:

- ユーザーがプラン変更を試みる
- 何らかの理由で 2 回ボタンをクリック

**When（操作）**:

1. 「このプランを選択」ボタンを連打
2. 複数の Checkout セッションが作成される

**Then（結果）**:

- ✅ ボタンが無効化されて連打できない
- ✅ 1 つの Checkout セッションのみ有効
- ❌ 2 重決済されない

---

## 🔄 状態遷移

### ユーザーの状態

```
未登録
  ↓ (新規登録)
スタンダードプラン
  ↓ (アップグレード)
フィードバックプラン
  ↓ (ダウングレード予約)
フィードバックプラン（次回更新時スタンダードに変更予定）
  ↓ (更新日到来)
スタンダードプラン
  ↓ (キャンセル)
スタンダードプラン（次回更新時キャンセル予定）
  ↓ (期間終了)
未登録
```

---
