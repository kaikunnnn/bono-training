# サブスクリプション Edge Cases（想定外の操作）

**最終更新**: 2025-11-29

---

## 📑 目次

- [🎯 このドキュメントの目的](#-このドキュメントの目的)
- [🔄 ナビゲーション系 Edge Cases](#-ナビゲーション系-edge-cases)
  - [Edge Case 1: ブラウザバック（Checkoutページで）](#edge-case-1-ブラウザバックcheckoutページで)
  - [Edge Case 2: Checkoutページのタブを閉じる](#edge-case-2-checkoutページのタブを閉じる)
  - [Edge Case 3: 決済完了後にページをリロード](#edge-case-3-決済完了後にページをリロード)
- [🖱️ ボタン操作系 Edge Cases](#️-ボタン操作系-edge-cases)
  - [Edge Case 4: ボタン連打](#edge-case-4-ボタン連打)
  - [Edge Case 5: 複数タブで同時操作](#edge-case-5-複数タブで同時操作)
- [💳 決済系 Edge Cases](#-決済系-edge-cases)
  - [Edge Case 6: 決済失敗](#edge-case-6-決済失敗)
  - [Edge Case 7: 決済途中でネットワーク切断](#edge-case-7-決済途中でネットワーク切断)
  - [Edge Case 8: Webhook遅延](#edge-case-8-webhook遅延)
  - [Edge Case 9: Webhook失敗](#edge-case-9-webhook失敗)
- [📅 タイミング系 Edge Cases](#-タイミング系-edge-cases)
  - [Edge Case 10: 更新日当日にプラン変更](#edge-case-10-更新日当日にプラン変更)
  - [Edge Case 11: キャンセル後の再登録](#edge-case-11-キャンセル後の再登録)
- [🔄 プラン変更系 Edge Cases](#-プラン変更系-edge-cases)
  - [Edge Case 12: 同じプランを再選択](#edge-case-12-同じプランを再選択)
  - [Edge Case 13: アップグレード → すぐにダウングレード](#edge-case-13-アップグレード--すぐにダウングレード)
- [👥 ユーザーアカウント系 Edge Cases](#-ユーザーアカウント系-edge-cases)
  - [Edge Case 14: ログアウト中にWebhook到着](#edge-case-14-ログアウト中にwebhook到着)
  - [Edge Case 15: アカウント削除後のWebhook](#edge-case-15-アカウント削除後のwebhook)
- [🌐 環境系 Edge Cases](#-環境系-edge-cases)
  - [Edge Case 16: 古いブラウザ](#edge-case-16-古いブラウザ)
  - [Edge Case 17: JavaScript無効](#edge-case-17-javascript無効)
- [🔒 セキュリティ系 Edge Cases](#-セキュリティ系-edge-cases)
  - [Edge Case 18: CSRF攻撃](#edge-case-18-csrf攻撃)
  - [Edge Case 19: 他人のプラン変更を試みる](#edge-case-19-他人のプラン変更を試みる)
- [📊 データ整合性系 Edge Cases](#-データ整合性系-edge-cases)
  - [Edge Case 20: Stripeとデータベースの不整合](#edge-case-20-stripeとデータベースの不整合)
- [🚨 緊急系 Edge Cases](#-緊急系-edge-cases)
  - [Edge Case 21: Stripe障害](#edge-case-21-stripe障害)
  - [Edge Case 22: データベース障害](#edge-case-22-データベース障害)

---

## 🎯 このドキュメントの目的

ユーザーが「想定外の操作」をした時にどうあるべきかを定義する。

**重要**: Edge Caseを正しく処理することで、バグを防ぎ、ユーザー体験を守る。

---

## 🔄 ナビゲーション系 Edge Cases

### Edge Case 1: ブラウザバック（Checkoutページで）

**状況**:
Stripe Checkoutページで「戻る」ボタンを押す

**期待される動作**:
- ✅ /subscriptionページに戻る
- ✅ 既存のプランは維持される
- ❌ 既存プランが解除されない
- ❌ 不完全なデータがDBに残らない

**現在の問題**:
- ⚠️ 既存プランが解除される（2025-11-28発生・修正済み）

---

### Edge Case 2: Checkoutページのタブを閉じる

**状況**:
Stripe Checkoutページのタブを閉じる

**期待される動作**:
- ✅ 何も変更されない
- ✅ 既存のプランは維持される
- ✅ Stripe側のCheckoutセッションは無効化される

---

### Edge Case 3: 決済完了後にページをリロード

**状況**:
決済完了後、/subscriptionページを何度もリロード

**期待される動作**:
- ✅ 新しいプランが表示される
- ✅ リロードしても2重課金されない
- ✅ データは一貫している

---

## 🖱️ ボタン操作系 Edge Cases

### Edge Case 4: ボタン連打

**状況**:
「このプランを選択」ボタンを連打

**期待される動作**:
- ✅ 1回しか処理されない
- ✅ ボタンがすぐに無効化される
- ✅ ローディングスピナー表示
- ❌ 複数のCheckoutセッションが作成されない

---

### Edge Case 5: 複数タブで同時操作

**状況**:
2つのタブで/subscriptionを開き、異なるプランを同時に選択

**期待される動作**:
- ✅ 最後の操作が優先される
- ✅ 2重課金されない
- ✅ どちらかのプランのみ有効

**実装方法**:
- データベースの排他制御
- Webhook冪等性チェック

---

## 💳 決済系 Edge Cases

### Edge Case 6: 決済失敗

**状況**:
カードが無効で決済失敗

**期待される動作**:
- ✅ Stripe側でエラーメッセージ表示
- ✅ ユーザーは/subscriptionページに戻る
- ✅ 既存のプランは維持される
- ❌ データベースに不完全なレコードが残らない

---

### Edge Case 7: 決済途中でネットワーク切断

**状況**:
Stripe Checkoutで決済情報入力中にネットワーク切断

**期待される動作**:
- ✅ Stripe側でエラーメッセージ表示
- ✅ ユーザーはやり直せる
- ❌ 不完全な決済が処理されない

---

### Edge Case 8: Webhook遅延

**状況**:
決済完了したがWebhookが10秒以上遅延

**期待される動作**:
- ✅ ユーザーには「処理中...」と表示
- ✅ Webhook到着後、即座に反映
- ✅ タイムアウトしない（最大30秒待つ）
- ❌ 「エラー」と表示しない

---

### Edge Case 9: Webhook失敗

**状況**:
Webhookが401エラーで失敗

**期待される動作**:
- ✅ Stripe側で再試行
- ✅ 最終的にはデータベースが更新される
- ⚠️ ユーザーには「反映に時間がかかる場合があります」と案内

**現在の問題**:
- 🔴 Webhook 401エラー発生中（2025-11-29）

---

## 📅 タイミング系 Edge Cases

### Edge Case 10: 更新日当日にプラン変更

**状況**:
次回更新日当日にプラン変更を試みる

**期待される動作**:
- ✅ 新しいプランが即座に開始
- ✅ 新しい更新サイクルが始まる
- ✅ 料金は日割り計算されない（全額請求）

---

### Edge Case 11: キャンセル後の再登録

**状況**:
プランキャンセル後、期間終了前に再登録

**期待される動作**:
- ✅ キャンセルが取り消される
- ✅ 次回更新日はそのまま
- ✅ 新たな決済は発生しない

---

## 🔄 プラン変更系 Edge Cases

### Edge Case 12: 同じプランを再選択

**状況**:
既にスタンダードプランなのに、もう一度スタンダードプランを選択

**期待される動作**:
- ✅ 「既にこのプランに登録済みです」とメッセージ表示
- ✅ Checkoutページに進まない
- ❌ 2重登録されない

---

### Edge Case 13: アップグレード → すぐにダウングレード

**状況**:
スタンダード → フィードバック → スタンダード を連続で実行

**期待される動作**:
- ✅ 最新の操作が有効
- ✅ フィードバックは即座に反映
- ✅ スタンダードへのダウングレードは次回更新時
- ❌ 2重課金されない

---

## 👥 ユーザーアカウント系 Edge Cases

### Edge Case 14: ログアウト中にWebhook到着

**状況**:
決済完了後、ユーザーがログアウト中にWebhookが到着

**期待される動作**:
- ✅ データベースは正しく更新される
- ✅ 次回ログイン時に新プランが反映されている
- ✅ メール通知は届く

---

### Edge Case 15: アカウント削除後のWebhook

**状況**:
アカウント削除直後にWebhookが到着

**期待される動作**:
- ✅ Webhookは正常に処理される
- ✅ エラーログに記録される
- ✅ Stripe側のサブスクリプションはキャンセルされる

---

## 🌐 環境系 Edge Cases

### Edge Case 16: 古いブラウザ

**状況**:
IE11などの古いブラウザで使用

**期待される動作**:
- ✅ 基本的な機能は動作する
- ✅ Stripe Checkoutは正常に動作（Stripe側が対応）
- ⚠️ デザインが崩れる可能性あり

---

### Edge Case 17: JavaScript無効

**状況**:
JavaScriptを無効にして使用

**期待される動作**:
- ⚠️ 「JavaScriptを有効にしてください」とメッセージ表示
- ❌ 機能は使用できない（Reactアプリのため）

---

## 🔒 セキュリティ系 Edge Cases

### Edge Case 18: CSRF攻撃

**状況**:
悪意のあるサイトから/api/subscription/create-checkoutを呼び出し

**期待される動作**:
- ✅ CSRF トークンチェックで拒否
- ✅ 認証チェックで拒否
- ❌ 不正なCheckoutセッションは作成されない

---

### Edge Case 19: 他人のプラン変更を試みる

**状況**:
他のユーザーのサブスクリプションを変更しようとする

**期待される動作**:
- ✅ 認証チェックで拒否
- ✅ ログインユーザーのサブスクリプションのみ操作可能
- ✅ エラーログに記録

---

## 📊 データ整合性系 Edge Cases

### Edge Case 20: Stripeとデータベースの不整合

**状況**:
Stripeには2つのサブスクリプション、DBには1つのみ

**期待される動作**:
- ✅ 管理画面で不整合を検出
- ✅ 手動で修正可能
- ✅ ログに記録

**現在の問題**:
- 🔴 実際に発生中（2025-11-29）

---

## 🚨 緊急系 Edge Cases

### Edge Case 21: Stripe障害

**状況**:
Stripe側で障害発生

**期待される動作**:
- ✅ 「現在サービスが利用できません」とメッセージ表示
- ✅ エラーログに記録
- ✅ ユーザーにメール通知（障害復旧後）

---

### Edge Case 22: データベース障害

**状況**:
Supabaseで障害発生

**期待される動作**:
- ✅ 「現在サービスが利用できません」とメッセージ表示
- ✅ Stripe側の決済は正常に処理される
- ✅ 復旧後にWebhookを再送信して同期

---

**Edge Caseを正しく処理することで、ユーザーは安心してサービスを利用できます。**
