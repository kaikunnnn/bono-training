# サブスクリプション実装全面見直しプロジェクト開始

**日付**: 2025-11-30
**ステータス**: 🔄 Phase 0実施中
**優先度**: 🔴 Critical

---

## 📊 プロジェクト概要

### 目的

サブスクリプション実装の全面的な見直しと再実装。局所的なエラー対応ではなく、システム全体の堅実な動作を目指す。

### 背景

以前の実装で複数の問題が発生:
- 新規サブスク登録が存在してはいけない'community'プランで登録される
- プラン変更(update-subscription)が500エラーで失敗
- 根本的に進め方とやり方に問題がある可能性

### アプローチ

**フェーズ型アプローチ（Approach B）**:
1. 大まかなフェーズに分割
2. 各フェーズごとに詳細を精査・検証
3. 1つずつ確実に実装
4. 次フェーズに進む前に動作確認

全ての作業をCLAUDE.mdと.claudeフォルダに保存しながら進める。

---

## 🔍 現状確認（ユーザー報告）

### 動作状況

| 機能 | 状態 | 詳細 |
|------|------|------|
| 新規登録 | ❌ 動作せず | communityプランになる問題あり |
| プラン変更 | ❌ 動作せず | 500エラー |
| キャンセル | ❌ 動作せず | プラン登録できないため |

**結論**: 全ての体験が動いていない「かなりヤバい状況」

### 既存データ

- TEST環境: リセット可能
- PROD環境: 最悪リセット可能

---

## 📋 ユーザー体験仕様（確認済み）

### プラン構成

- **Standard** プラン（1ヶ月 / 3ヶ月）
- **Feedback** プラン（1ヶ月 / 3ヶ月）
- ~~community~~ プラン（廃止・削除対象）

### 重要な仕様確認

1. **communityプラン**
   - 過去に存在していた
   - 現在は廃止
   - コードから完全削除が必要

2. **ダウングレード**
   - 即座に反映（Stripeのデフォルトと異なる）
   - 日割り計算で差額返金
   - ユーザーにとってわかりやすい

3. **更新確認ページ**
   - 仕様は相談しながら詰める必要あり
   - 目標: 最も実装が簡単で堅実でバグのないページ
   - 選択肢:
     - Option A: Stripeの仕組みでプランごとに直接遷移
     - Option B: 自前でフロントエンド実装
   - Phase 0後に調査・提案予定

---

## 🎯 Phase 0: 緊急現状精査

### 目的

何が壊れているか、なぜ壊れているかを正確に把握する。

### タスク

#### Phase 0-1: 環境変数の確認
- [ ] Stripe API キー（TEST/LIVE）の存在確認
- [ ] Webhook Secretの存在確認
- [ ] Price ID（全プラン・全期間）の存在確認
- [ ] Supabase接続情報の確認
- [ ] 環境変数の整合性チェック

#### Phase 0-2: Edge Functions状態確認
- [ ] create-checkoutの起動状態
- [ ] update-subscriptionの起動状態
- [ ] stripe-webhookの起動状態
- [ ] デプロイ状況の確認
- [ ] ログ出力の確認

#### Phase 0-3: データベース状態確認
- [ ] テーブル構造の確認
- [ ] 既存データの整合性チェック
- [ ] 'community'プランデータの存在確認
- [ ] 環境(environment)フィールドの確認

#### Phase 0-4: 実際の動作テスト
- [ ] 新規登録フローのテスト
- [ ] エラーログの収集
- [ ] フロントエンド・バックエンド両方のログ確認
- [ ] エラー発生箇所の特定

#### Phase 0-5: 問題箇所のリスト化
- [ ] 発見した全ての問題をリスト化
- [ ] 優先順位の決定
- [ ] 依存関係の整理

#### Phase 0-6: 詳細TodoList作成
- [ ] Phase 0の結果をもとに詳細TODO作成
- [ ] Phase 1以降のフェーズ定義
- [ ] 各フェーズの成功基準設定

### 推定所要時間

約30分

---

## 📝 関連ドキュメント

- **ユーザー体験仕様**: `.claude/docs/subscription/user-experience/flows.md`
- **UX要件**: `.claude/docs/subscription/user-experience/requirements.md`
- **既知の問題**: `.claude/docs/subscription/user-experience/issues.md`
- **過去のバグ分析**: `.claude/docs/subscription/issues/2025-11-30-root-cause-analysis-final.md`
- **update-subscription調査**: `.claude/docs/subscription/issues/2025-11-30-update-subscription-500-investigation.md`

---

## ✅ Phase 0 完了後のアクション

1. Phase 0の結果を新規ドキュメントに記録
2. 問題リストと優先順位をTASK-TRACKER.mdに反映
3. 詳細なPhase 1以降のTODOを作成
4. ユーザーに報告・相談
5. Phase 1開始の承認を得る

---

**作成日時**: 2025-11-30
**作成者**: Claude Code
**次のステップ**: Phase 0-1 環境変数の確認
