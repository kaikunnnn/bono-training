# 本番環境サブスクリプション検証

**作成日**: 2025-12-02 JST
**ステータス**: ✅ 検証完了
**テスト実施者**: Takumi

---

## 目的

mainブランチにマージされたサブスクリプション実装が本番環境で正常に動作することを確認する。

---

## 検証項目

### Phase A: 課金なしの確認

| # | 確認項目 | 手順 | 期待結果 | 結果 |
|---|---------|------|---------|------|
| A-1 | ログイン | 本番サイトにアカウントでログイン | ログイン成功 | ✅ |
| A-2 | /subscription 表示 | `/subscription` ページにアクセス | 料金プラン（Standard/Feedback）が表示される | ✅ |
| A-3 | /account 表示 | `/account` ページにアクセス | 現在のステータスが表示される | ✅ |

### Phase B: 課金テスト（新規登録 → キャンセル）

| # | 確認項目 | 手順 | 期待結果 | 結果 |
|---|---------|------|---------|------|
| B-1 | 新規登録 | Standard 1M (¥6,800) を購入 | Checkout完了 → 成功ページ | ✅ |
| B-2 | DB反映 | `/account` を確認 | プランが反映されている | ✅ |
| B-3 | Webhook処理 | Stripe Dashboard → Webhooksログ | 200 OK | ✅ |
| B-4 | キャンセル | カスタマーポータルからキャンセル | キャンセル成功、DB反映 | ⏭️ スキップ |

### Phase C: プラン変更テスト

| # | 確認項目 | 手順 | 期待結果 | 結果 |
|---|---------|------|---------|------|
| C-1 | 期間変更 | Standard 1M → 3M | 変更完了、DB反映 | ✅ |
| C-2 | 変更プレビュー | Feedback 3M を選択 | 差額・日割り計算が表示される | ✅ |
| C-3 | アップグレード実行 | Standard 3M → Feedback 3M に変更 | 変更完了、DB反映 | ✅ |
| C-4 | Webhook処理 | Stripe Dashboard確認 | customer.subscription.updated が 200 OK | ✅ |

---

## テスト順序（実際の実施順）

```
Phase A: 課金なしの確認
    ↓
Phase B: 新規登録 (Standard 1M) → 返金（キャンセルはスキップ）
    ↓
Phase C: 期間変更 (1M→3M) → アップグレード (Standard→Feedback)
```

---

## 前提条件

- [x] Phase 5 本番デプロイ完了
- [x] ENV-001, ENV-002, ENV-003 全て解決済み
- [x] Webhook 200 OK 確認済み

---

## テスト環境

| 項目 | 値 |
|------|-----|
| URL | https://bono-training.vercel.app |
| Supabase | fryogvfhymnpiqwssmuu（本番） |
| Stripe | Live モード |
| テストアカウント | takumi.kai.skywalker@gmail.com |

---

## 検証手順と結果

### Phase A: 課金なしの確認

#### A-1: ログイン ✅

1. https://bono-training.vercel.app にアクセス
2. takumi.kai.skywalker@gmail.com でログイン
3. ログイン成功を確認

**結果**: ✅ 成功

---

#### A-2: /subscription 表示 ✅

1. `/subscription` にアクセス
2. 確認項目:
   - [x] ページが正常に表示される（白画面ではない）
   - [x] Standard プラン（¥6,800 / ¥17,400）が表示
   - [x] Feedback プラン（¥15,800 / ¥41,400）が表示
   - [x] 「選択する」ボタンが機能する
   - [x] DevToolsコンソールに「http://127.0.0.1」が表示されない（ENV-001確認）

**結果**: ✅ 成功

---

#### A-3: /account 表示 ✅

1. `/account` にアクセス
2. 確認項目:
   - [x] ページが正常に表示される
   - [x] 現在のプラン状態が表示される
   - [x] サブスク管理ボタンが表示される

**結果**: ✅ 成功

---

### Phase B: 課金テスト

#### B-1: 新規登録 ✅

1. `/subscription` にアクセス
2. Standard 1M（¥6,800）を選択
3. Stripe Checkout で支払い
4. 成功ページに遷移

**結果**: ✅ 成功
- 決済完了ページ表示
- 「スタンダードプランへようこそ！」メッセージ

---

#### B-2: DB反映確認 ✅

1. `/account` にアクセス
2. 確認項目:
   - [x] プラン: Standard
   - [x] 期間: 1ヶ月
   - [x] ステータス: アクティブ
   - [x] 次回更新日: 2026年1月2日

**結果**: ✅ 成功
- DB確認: `stripe_subscription_id: sub_1SZpw8KUVUnt8GtyqvL0EsA5`

---

#### B-3: Webhook処理確認 ✅

1. Stripe Dashboard → Developers → Webhooks
2. 本番Endpoint のログを確認
3. `checkout.session.completed` が 200 OK

**結果**: ✅ 成功
- Webhook: 200 OK
- Connected Platform (Memberstack Inc.): 200 OK

---

#### B-4: キャンセルテスト ⏭️ スキップ

**理由**: Stripe Dashboard から返金処理を実施。カスタマーポータルからのキャンセルテストはスキップ。

---

### Phase C: プラン変更テスト

#### C-1: 期間変更 (Standard 1M → 3M) ✅

1. `/subscription` で Standard 3M を選択
2. 確認モーダルで確認
3. 変更を確定

**結果**: ✅ 成功
- `/account`: スタンダード（3ヶ月）
- 次回更新日: 2026年3月2日

---

#### C-2: 変更プレビュー ✅

1. Feedback 3M プランを選択
2. 確認項目:
   - [x] 差額が表示される
   - [x] 日割り計算が表示される
   - [x] 変更後の請求額が明確

**結果**: ✅ 成功
- 現在のプラン返金（89日分）: -¥51,620
- 新プラン（89日分）: +¥122,820
- 今回のお支払い合計: +¥71,200

---

#### C-3: アップグレード実行 (Standard 3M → Feedback 3M) ✅

1. 「プラン変更を確定」をクリック
2. 確認項目:
   - [x] 変更処理が完了
   - [x] `/account` でプラン: フィードバック（3ヶ月）と表示
   - [x] ステータス: アクティブ

**結果**: ✅ 成功
- 成功ページ: 「フィードバックプランへの変更が完了しました」
- コンソール: `planType: 'feedback', duration: 3`

---

#### C-4: Webhook処理確認（プラン変更） ✅

Stripe Dashboard で `customer.subscription.updated` を確認

**結果**: ✅ 成功（プラン変更はStripe Billing Portal経由ではなくアプリ内処理）

---

## 検証結果サマリー

| Phase | 結果 | 備考 |
|-------|------|------|
| Phase A | ✅ 完了 | 課金なしの確認 |
| Phase B | ✅ 完了 | 新規登録 → 返金 |
| Phase C | ✅ 完了 | 期間変更 → アップグレード |

---

## 発見されたUX Issue

### Issue 1: 成功画面に期間が表示されない

**現状**:
```
「スタンダードプランへの変更が完了しました」
```

**期待**:
```
「スタンダードプラン（3ヶ月）への変更が完了しました」
```

**優先度**: 低
**影響**: ユーザーが変更後の期間を即座に確認できない

---

### Issue 2: 3ヶ月プランの金額表示が誤解を招く

**現状**:
```
スタンダード: 17,400円/月（一括 52,200円）
フィードバック: 41,400円/月（一括 124,200円）
```

**問題**: 「17,400円/月」は実際には3ヶ月分の金額であり、月あたりの金額ではない

**期待する表示**:
```
スタンダード: 5,800円/月（3ヶ月一括 17,400円）
フィードバック: 13,800円/月（3ヶ月一括 41,400円）
```

**優先度**: 中
**影響**: ユーザーが料金を誤解する可能性がある

---

### Issue 3: /subscriptionページでキャンセル状態が表示されない

**現状**:
```
フィードバック カード: 「現在のプラン」（グレーバッジ）
```

**期待する表示**:
```
フィードバック カード: 「現在のプラン【キャンセル済み】」（オレンジバッジ）
```

**優先度**: 低
**影響**: /subscriptionページでキャンセル状態が分からない

---

## 追加テスト: キャンセルフロー ✅

### キャンセルテスト（Stripe カスタマーポータル経由）

1. `/account` → 「サブスクリプションを管理」をクリック
2. Stripe カスタマーポータルで「サブスクリプションをキャンセル」
3. 確認項目:
   - [x] キャンセル処理が完了
   - [x] `/account` に【キャンセル済み】バッジ表示
   - [x] 利用期限（2026年3月2日）が表示
   - [x] 「プランを再開する →」リンク表示
   - [x] コンソール: `cancelAtPeriodEnd: true`

**結果**: ✅ 成功

---

## 最終確認状態

| 項目 | 値 |
|------|-----|
| ユーザー | takumi.kai.skywalker@gmail.com |
| 現在のプラン | フィードバック（3ヶ月）【キャンセル済み】 |
| 利用期限 | 2026年3月2日 |
| ステータス | cancel_at_period_end = true |
| Stripe Subscription ID | sub_1SZpw8KUVUnt8GtyqvL0EsA5 |

---

**検証完了**: 2025-12-02 JST
**更新者**: Claude Code
