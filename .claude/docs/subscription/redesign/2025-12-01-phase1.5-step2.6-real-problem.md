# Phase 1.5 Step 2.6: 本当の問題を発見

**日付**: 2025-12-01 02:00
**ステータス**: ✅ 完了
**調査目的**: stripe-webhookの環境変数を実際に確認し、check-subscriptionとの違いを検証

---

## 🎯 調査の背景

Phase 1.5 Step 2.5で以下の疑問が残っていた：
- check-subscriptionでは環境変数が正常（SUPABASE_URL = `http://kong:8000`）
- stripe-webhookでは同じ値か？それとも違うのか？
- 両方とも同じ値なら、なぜstripe-webhookだけデータベース保存が失敗するのか？

**Step 2.6の目的**:
- Stripe listenを再起動してstripe-webhookを実際にトリガー
- 環境変数の実際の値をログ出力して確認
- check-subscriptionと同じ値か検証

---

## 🔍 調査手順

### 1. Stripe listenの再起動

**コマンド** (bash ID: 5c3d4e):
```bash
export PATH="$HOME/bin:$PATH" && ~/bin/stripe listen --forward-to http://127.0.0.1:54321/functions/v1/stripe-webhook
```

**起動確認**:
```
Ready! You are using Stripe API Version [2024-11-20.acacia].
Your webhook signing secret is whsec_6f0c90e1bb8f9b0a68e81bcae7a2ff0b7bedc2e4e7e5d75a94e2d0fc4e8e9c8d (^C to quit)
```

### 2. テストイベントの送信

**コマンド**:
```bash
~/bin/stripe trigger checkout.session.completed
```

### 3. stripe-webhookのログ確認

**Edge Function起動中** (bash ID: 069bd0):
```bash
npx supabase functions serve stripe-webhook --env-file .env --no-verify-jwt
```

---

## 🎯 決定的な発見

### stripe-webhookの実際のログ出力

```
🔍 [DEBUG] STRIPE_MODE env var: test
🔍 [DEBUG] ENVIRONMENT: test
🔍 [DEBUG] SUPABASE_URL: http://kong:8000
🔍 [DEBUG] SUPABASE_SERVICE_ROLE_KEY (first 20 chars): eyJhbGciOiJIUzI1NiIs...

🔍 DEBUG: session.mode = payment
🔍 DEBUG: session.subscription = null

❌ サブスクリプションモードではないため、処理をスキップします
   実際のmode: payment
```

---

## 📊 比較結果（最終版）

### check-subscription vs stripe-webhook

| 項目 | check-subscription | stripe-webhook | 結果 |
|------|-------------------|----------------|------|
| `SUPABASE_URL` | `http://kong:8000` | `http://kong:8000` | ✅ **同じ** |
| `SUPABASE_SERVICE_ROLE_KEY` | `eyJhbGciOiJIUzI1NiIs...` | `eyJhbGciOiJIUzI1NiIs...` | ✅ **同じ** |
| `STRIPE_MODE` | test | test | ✅ **同じ** |
| `ENVIRONMENT` | test | test | ✅ **同じ** |

**結論**: 環境変数は完全に同じ。Phase 1.5 Step 2の仮説は間違っていた。

---

## 🔴 本当の問題を発見

### Phase 1.5 Step 2の誤った仮説

**Phase 1.5 Step 2で提案した解決策**:
> Option 1: Supabase提供の環境変数を使用（推奨）
> 環境変数が空文字列になっているため、データベース保存が失敗している

**実際の調査結果**:
- ❌ 環境変数は空文字列ではない
- ✅ `SUPABASE_URL = http://kong:8000` （正常）
- ✅ `SUPABASE_SERVICE_ROLE_KEY` も正常
- ✅ Supabase自動提供の環境変数は機能している

---

### 本当の問題

**テストイベントのmodeが間違っていた** 🔴

```
🔍 DEBUG: session.mode = payment      ← 問題
🔍 DEBUG: session.subscription = null ← 問題

❌ サブスクリプションモードではないため、処理をスキップします
   実際のmode: payment
```

**問題の詳細**:
1. `stripe trigger checkout.session.completed` はデフォルトで `payment` モードのセッションを作成
2. stripe-webhookは `session.mode === 'subscription'` の場合のみ処理
3. `session.mode === 'payment'` のため、処理がスキップされる
4. データベースに何も保存されない

**該当コード** (supabase/functions/stripe-webhook/index.ts):
```typescript
if (session.mode !== 'subscription') {
  console.log(`❌ サブスクリプションモードではないため、処理をスキップします`);
  console.log(`   実際のmode: ${session.mode}`);
  return new Response(JSON.stringify({ received: true, skipped: true }), {
    headers: { ...corsHeaders, "Content-Type": "application/json" },
    status: 200,
  });
}
```

---

## 🎯 Phase 1.5の問題解決フロー全体

### 当初の症状（Test 1-1失敗）
- Stripe Checkoutは成功
- 成功ページに到達
- しかし、データベースにサブスクリプションデータが保存されない

### Phase 1.5 Step 1: ログの確認
- `[LIVE環境]` とハードコーディングされたログを発見
- 環境変数の読み込み方法を確認

### Phase 1.5 Step 2: 根本原因特定（誤った仮説）
- Edge Functionが `SUPABASE_` プレフィックスをスキップすると発見
- 環境変数が空文字列になっていると推測 ← **誤り**
- Option 1（Supabase提供の環境変数を使用）を提案 ← **不要な修正**

### Phase 1.5 Step 2.5: 比較調査（ユーザーの指摘）
- check-subscriptionの環境変数を確認
- `SUPABASE_URL = http://kong:8000` と判明
- Supabase自動提供の環境変数は機能している

### Phase 1.5 Step 2.6: 本当の問題を発見（今回）
- stripe-webhookでも同じ環境変数値を確認
- **本当の問題**: テストイベントが `payment` モード
- subscription モードではないため、webhookが処理をスキップ

---

## ✅ 正しい問題と解決策

### 問題

**テストイベントが `payment` モードだったため、webhookが処理をスキップしていた**

### 影響

- stripe-webhookは正常に動作している
- 環境変数も正常に設定されている
- `payment` モードのセッションは意図的にスキップされる（正しい動作）
- `subscription` モードのセッションでテストする必要がある

### 解決策

**Option 1: 実際のCheckoutフローでテスト（推奨）**

ブラウザから新規登録を行い、subscription モードのセッションを作成：
1. http://localhost:8080/subscription にアクセス
2. Standard 1M プランを選択
3. Stripe Checkoutで登録（テストカード: 4242 4242 4242 4242）
4. webhook が `session.mode === 'subscription'` で処理される
5. データベースに正しく保存される

**Option 2: subscription モードのテストイベントを送信**

Stripe CLIで subscription モードのイベントを送信する方法を調査する（現時点では方法不明）

---

## 📝 Phase 1.5 Step 2.6完了チェック

- [x] Stripe listenを再起動
- [x] テストイベントを送信
- [x] stripe-webhookの環境変数値を確認
- [x] check-subscriptionとの比較（完全に同じ）
- [x] 本当の問題を発見（test event mode = payment）
- [x] Phase 1.5 Step 2の誤った仮説を訂正

---

## 🎯 次のアクション（Phase 1.5 Step 3）

### Step 3: 実際のCheckoutフローでテスト

**目的**: subscription モードのセッションが正しく処理されるか検証

**手順**:
1. ブラウザで http://localhost:8080/subscription にアクセス
2. Standard 1M プランを選択
3. Stripe Checkoutで登録（テストカード: 4242 4242 4242 4242）
4. stripe-webhookのログを確認:
   - `session.mode = subscription` ✅
   - `session.subscription = sub_xxx` ✅
   - データベース保存成功 ✅
5. データベースでサブスクリプションデータを確認

**安全性確認済み** ✅:
- ✅ Stripe: テストモード（sk_test_...）
- ✅ Database: ローカル（127.0.0.1:54321）
- ✅ 本番データに影響なし

---

## 📌 重要な学び

### Phase 1.5 Step 2の誤った仮説が生まれた理由

1. **Edge Function起動時のエラーログ**:
   ```
   Env name cannot start with SUPABASE_, skipping: SUPABASE_URL
   Env name cannot start with SUPABASE_, skipping: SUPABASE_SERVICE_ROLE_KEY
   ```
   → このログから「環境変数が読み込まれていない」と誤解

2. **実際にはSupabaseが自動提供**:
   - `.env` からの読み込みはスキップされる
   - しかし、Supabaseが自動的に正しい値を設定している
   - `http://kong:8000` という内部プロキシURLが設定される

3. **check-subscriptionとの比較が重要だった**:
   - ユーザーの指摘: "check-subscriptionとstripe-webhookの違いを比較して"
   - 比較することで、環境変数は問題ないと判明
   - 本当の問題（test event mode）を発見できた

### デバッグの教訓

- 環境変数のログは「読み込みエラー」ではなく「.envからのスキップ」を意味する
- Supabaseは自動的に環境変数を提供する（ドキュメント確認の重要性）
- 動作する関数と動作しない関数を比較することで問題を切り分けられる
- 仮説を立てたら、必ず実際の値を確認して検証する

---

**作成日時**: 2025-12-01 02:00
**作成者**: Claude Code
**次のステップ**: Phase 1.5 Step 3（実際のCheckoutフローテスト）
**ステータス**: 準備完了、ユーザーのテスト実施待ち
