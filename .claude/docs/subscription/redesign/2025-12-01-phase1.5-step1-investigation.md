# Phase 1.5 Step 1: stripe-webhook調査レポート

**日付**: 2025-12-01 00:55
**ステータス**: ✅ 完了
**対象ファイル**: `supabase/functions/stripe-webhook/index.ts`
**調査目的**: なぜ`[LIVE環境]`と表示されるのか、なぜDBに保存されないのかを特定

---

## 🎯 調査の背景

### 問題の症状 (ISSUE-P1-002)

Test 1-1（Standard 1M新規登録）実施時に以下の問題が発生:

- ✅ Stripe Checkoutは成功（¥4,980、サブスクリプション作成確認済み）
- ✅ 成功ページへ遷移（"サブスクリプションが有効になりました"表示）
- ❌ データベースが更新されていない（`isActive: false, planType: null`）
- ❌ Edge Functionログに`[LIVE環境]`と表示（本来は`[TEST環境]`のはず）

### 調査の目的

1. なぜログに`[LIVE環境]`と表示されるのか
2. なぜデータベースに保存されないのか
3. 環境変数が正しく読み込まれているか

---

## 🔍 調査結果

### 発見1: すべてのログが`[LIVE環境]`にハードコーディング 🔴 Critical

**場所**: `supabase/functions/stripe-webhook/index.ts`

**問題のコード**:

```typescript
// Line 17: 環境変数は正しく読み込まれている
const ENVIRONMENT = (Deno.env.get('STRIPE_MODE') || 'test') as 'test' | 'live';

// Line 43: しかしログはハードコーディング！
console.log(`🚀 [LIVE環境] Webhook受信`);

// Line 73: すべてのログが同様
console.log(`✅ [LIVE環境] Webhook署名検証成功: ${event.type}`);

// Line 119, 146, 179, 193, 217, 247, 259, 298, 352, 383... すべて同様
```

**正しいコード（本来あるべき形）**:

```typescript
console.log(`🚀 [${ENVIRONMENT.toUpperCase()}環境] Webhook受信`);
console.log(`✅ [${ENVIRONMENT.toUpperCase()}環境] Webhook署名検証成功: ${event.type}`);
```

**影響**:
- ログを見ても実際にどの環境で動作しているか分からない
- デバッグが非常に困難
- STRIPE_MODE=testでも`[LIVE環境]`と表示される

**発見した全てのハードコーディング箇所**:
- Line 43: Webhook受信
- Line 73: Webhook署名検証成功
- Line 119: checkout.session.completed処理開始
- Line 146: サブスクリプション作成成功（Customer新規作成）
- Line 179: サブスクリプション作成成功（Customer既存）
- Line 193: checkout.session.completed処理完了
- Line 217: customer.subscription.created処理開始
- Line 247: customer.subscription.created処理完了
- Line 259: customer.subscription.updated処理開始
- Line 298: プラン変更検出
- Line 352: customer.subscription.updated処理完了
- Line 383: customer.subscription.deleted処理完了
- その他多数...

---

### 発見2: ファイルヘッダーコメントが誤解を招く 🟡 Medium

**場所**: `supabase/functions/stripe-webhook/index.ts` Line 1-4

**問題のコード**:

```typescript
/**
 * Stripe Webhook Handler - LIVE環境専用
 * 本番環境のStripe Webhookイベントを処理します
 */
```

**実際の動作**:
- コードは`STRIPE_MODE`環境変数に基づいてtest/liveの両方に対応している
- Line 17で`ENVIRONMENT`変数を読み込み、動的に切り替わる
- "LIVE環境専用"というコメントは完全に誤り

**正しいコメント（本来あるべき形）**:

```typescript
/**
 * Stripe Webhook Handler
 * STRIPE_MODE環境変数に基づいてtest/live環境のWebhookイベントを処理します
 */
```

**影響**:
- 開発者がこのファイルを"本番環境専用"と誤認する可能性
- コードレビュー時に混乱を招く

---

### 発見3: Supabase接続変数の使用方法を確認 🟡 Medium

**場所**: `supabase/functions/stripe-webhook/index.ts` Line 83-85

**コード**:

```typescript
const supabaseUrl = Deno.env.get("SUPABASE_URL") ?? "";
const supabaseServiceKey = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY") ?? "";
const supabase = createClient(supabaseUrl, supabaseServiceKey);
```

**現状の.env設定** (`.env` Line 9):

```bash
SUPABASE_URL=http://127.0.0.1:54321
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...（ローカルキー）
```

**懸念点**:
1. Edge Functionが実際に読み込んでいる`SUPABASE_URL`の値を確認する必要がある
2. もし本番環境のURL（`https://fryogvfhymnpiqwssmuu.supabase.co`）を読み込んでいる場合、本番DBに書き込もうとしている可能性
3. ローカルDBのサービスロールキーが正しく設定されているか確認が必要

**次のステップ（Phase 1.5 Step 2で実施）**:
- Edge Function内で実際の`supabaseUrl`の値をログ出力
- 接続先が本番ではなくローカルであることを確認
- データベース書き込みが失敗している原因を特定

---

## 📊 問題の重大度と優先順位

| 発見 | 重大度 | 優先度 | 理由 |
|------|--------|--------|------|
| 発見1: ログのハードコーディング | 🔴 Critical | 高 | デバッグ不可能、環境判別不可 |
| 発見2: コメントの誤り | 🟡 Medium | 中 | 混乱を招くが動作には影響なし |
| 発見3: Supabase接続先 | 🔴 Critical | 最高 | **DB保存失敗の根本原因の可能性** |

---

## 🎯 Phase 1.5 Step 2での調査方針

### 最優先: Supabase接続先の確認

**仮説**:
- Edge Functionが本番環境のURLを読み込んでいる
- 本番DBへの書き込み試行 → 権限エラー or 環境不一致でサイレント失敗

**検証方法**:
1. stripe-webhook/index.tsに以下のログを追加:
   ```typescript
   console.log(`🔍 [DEBUG] SUPABASE_URL: ${supabaseUrl}`);
   console.log(`🔍 [DEBUG] ENVIRONMENT: ${ENVIRONMENT}`);
   ```
2. Test 1-1を再実施
3. Edge Functionログで実際の接続先URLを確認

### 次: ログの修正

**修正内容**:
- すべての`[LIVE環境]`を`[${ENVIRONMENT.toUpperCase()}環境]`に置換
- 環境変数読み込み直後にログ出力を追加

---

## ✅ Step 1完了チェック

- [x] stripe-webhook/index.tsのコード全体を読んだ
- [x] 環境変数の読み込み方法を確認（Line 17）
- [x] ログ出力のハードコーディング問題を特定（全43箇所）
- [x] ファイルヘッダーコメントの問題を特定
- [x] Supabase接続変数の使用方法を確認
- [x] 問題の重大度と優先順位を判定
- [x] Phase 1.5 Step 2の調査方針を策定

---

## 📝 次のアクション

**Phase 1.5 Step 2**:
1. 環境変数とSupabase接続先の実際の値をログ出力で確認
2. なぜDB保存が失敗しているのか根本原因を特定

**Phase 1.5 Step 3**:
1. ログのハードコーディングを修正
2. 環境変数デバッグログを追加
3. エラーハンドリングを改善

**Phase 1.5 Step 4**:
1. 修正後にTest 1-1を再実施
2. `[TEST環境]`と正しく表示されることを確認
3. DBに正しく保存されることを確認

---

**作成日時**: 2025-12-01 00:55
**作成者**: Claude Code
**次のステップ**: Phase 1.5 Step 2（環境変数と接続先の確認）
