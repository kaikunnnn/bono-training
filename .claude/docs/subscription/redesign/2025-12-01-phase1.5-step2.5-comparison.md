# Phase 1.5 Step 2.5: 比較調査レポート

**日付**: 2025-12-01 01:30
**ステータス**: ✅ 完了
**調査目的**: check-subscriptionとstripe-webhookの環境変数を比較し、なぜ片方だけ動くのか解明

---

## 🎯 調査の背景

### ユーザーからの重要な指摘

Phase 1.5 Step 2で「Edge Functionは`SUPABASE_`プレフィックスの環境変数をスキップする」という根本原因を特定した直後、ユーザーから以下の疑問が提示されました：

> **「check-subscriptionとstripe-webhookの違いを比較して。両方とも SUPABASE_URL を使っているのに、なぜ片方だけ動くのか...コレも明らかにしたらどうですか？必要ないですか？エンジニアリング目線で判断して」**

**この疑問は絶対に必要です。**なぜなら：
- 両方の関数が同じコードパターンを使用している
- 両方とも`Deno.env.get("SUPABASE_URL")`で環境変数を取得
- しかし、Phase 1のテストではcheck-subscriptionは動作していた
- stripe-webhookはデータベースに保存できていない

---

## 🔍 調査手順

### 1. check-subscription Edge Functionの起動と検証

**コマンド**:
```bash
npx supabase functions serve check-subscription --env-file .env --no-verify-jwt
```

**起動ログ** (stderr):
```
Setting up Edge Functions runtime...
Env name cannot start with SUPABASE_, skipping: SUPABASE_SERVICE_ROLE_KEY
Env name cannot start with SUPABASE_, skipping: SUPABASE_URL
Env name cannot start with SUPABASE_, skipping: SUPABASE_ANON_KEY
```

**発見**: ✅ check-subscriptionでも`.env`からの読み込みはスキップされる

### 2. check-subscriptionにデバッグログを追加

**ファイル**: `supabase/functions/check-subscription/utils.ts` Line 28-31

```typescript
export function createSupabaseClients() {
  const supabaseUrl = Deno.env.get("SUPABASE_URL") ?? "";
  const supabaseAnonKey = Deno.env.get("SUPABASE_ANON_KEY") ?? "";
  const supabaseServiceKey = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY") ?? "";

  // 🔍 DEBUG: 環境変数の実際の値を確認
  console.log(`🔍 [CHECK-SUBSCRIPTION DEBUG] SUPABASE_URL: ${supabaseUrl}`);
  console.log(`🔍 [CHECK-SUBSCRIPTION DEBUG] SUPABASE_ANON_KEY (first 20): ${supabaseAnonKey.substring(0, 20)}...`);
  console.log(`🔍 [CHECK-SUBSCRIPTION DEBUG] SUPABASE_SERVICE_ROLE_KEY (first 20): ${supabaseServiceKey.substring(0, 20)}...`);

  return {
    supabaseClient: createClient(supabaseUrl, supabaseAnonKey),
    supabaseAdmin: createClient(supabaseUrl, supabaseServiceKey, {
      auth: { persistSession: false }
    })
  };
}
```

### 3. check-subscriptionを実際にトリガー

**コマンド**:
```bash
curl -X GET "http://127.0.0.1:54321/functions/v1/check-subscription" \
  -H "Authorization: Bearer dummy_token" \
  -H "Content-Type: application/json"
```

**レスポンス**:
```json
{"subscribed":false,"planType":null,"isSubscribed":false,"hasMemberAccess":false,"hasLearningAccess":false}
```

---

## 🎯 決定的な証拠を発見

### check-subscriptionの実際のログ出力

```
[Info] 🔍 [CHECK-SUBSCRIPTION DEBUG] SUPABASE_URL: http://kong:8000
[Info] 🔍 [CHECK-SUBSCRIPTION DEBUG] SUPABASE_ANON_KEY (first 20): eyJhbGciOiJIUzI1NiIs...
[Info] 🔍 [CHECK-SUBSCRIPTION DEBUG] SUPABASE_SERVICE_ROLE_KEY (first 20): eyJhbGciOiJIUzI1NiIs...
```

**重要な発見**:
1. `SUPABASE_URL` = `http://kong:8000` (Supabase内部のプロキシサーバー)
2. `SUPABASE_ANON_KEY` = 正常な値が設定されている
3. `SUPABASE_SERVICE_ROLE_KEY` = 正常な値が設定されている

**結論**:
- `.env`ファイルからの読み込みは確かにスキップされている
- **しかし、Supabaseが自動的に環境変数を提供している**
- check-subscriptionは正常な値を受け取っている

---

## 📊 比較結果サマリー

### check-subscription vs stripe-webhook

| 項目 | check-subscription | stripe-webhook | 結果 |
|------|-------------------|----------------|------|
| `.env`読み込み | スキップ | スキップ | 同じ |
| `SUPABASE_URL`の値 | `http://kong:8000` | ❓ 未確認 | **要調査** |
| `SUPABASE_SERVICE_ROLE_KEY` | 正常な値 | ❓ 未確認 | **要調査** |
| データベース接続 | ✅ 成功 | ❌ 失敗 | **異なる** |
| 起動方法 | `npx supabase functions serve` | `npx supabase functions serve` | 同じ |

---

## 🤔 未解決の謎

### なぜcheck-subscriptionは動いて、stripe-webhookは動かないのか？

**仮説1**: stripe-webhookでも実際には同じ値が設定されている
- **可能性**: 高い
- **検証方法**: stripe-webhookを実際にトリガーしてデバッグログを確認
- **状況**: Stripe listenが停止していたため、今回は検証できなかった

**仮説2**: Supabase提供の環境変数は全てのEdge Functionで同じ
- **根拠**: Supabaseドキュメントによると、SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEYは自動提供される
- **結論**: おそらく、**両方の関数で同じ値が設定されているはず**

**仮説3**: Phase 1.5 Step 2の調査結果は間違っていた？
- **再検証が必要**: stripe-webhookでも`http://kong:8000`が設定されているか確認
- **もし設定されていたら**: データベース保存失敗の原因は別にある

---

## 🔍 追加調査が必要な項目

### 1. stripe-webhookの実際の環境変数値を確認

**方法**:
1. Stripe CLIでテストイベントを送信（Stripe listenを再起動）
2. stripe-webhookのログで`🔍 [DEBUG] SUPABASE_URL`の値を確認
3. check-subscriptionと同じ値（`http://kong:8000`）か検証

### 2. 過去のstripe-webhookログを確認

**Stripe listenのログから**:
- 11月30日 09:45:57 以降は `[200] OK` を返している
- 11月30日 09:25:44 以前は `[500]` エラーを返していた

**この切り替わりのタイミングは何か？**
- 環境変数の修正があったのか？
- コードの変更があったのか？
- ログを詳細に調査する必要がある

### 3. `.env`ファイルの整理

**現在存在する`.env`ファイル**:
- `.env`
- `.env.local`
- `.env.development.local`
- `.env.example`

**調査結果**:
- `.env.local`と`.env.development.local`には`VITE_SUPABASE_*`変数のみ（フロントエンド用）
- `.env`には`SUPABASE_*`変数がある（しかしEdge Functionでスキップされる）

**結論**: `.env`の`SUPABASE_*`変数は不要かもしれない（Supabase自動提供があるため）

---

## 💡 重要な学び

### Phase 1.5 Step 2の調査結果の見直し

**Phase 1.5 Step 2で提案した解決策**:
> Option 1: Supabase提供の環境変数を使用（推奨）

**今回の調査で判明したこと**:
- **既にSupabase提供の環境変数が使われている**
- `.env`からの読み込みは失敗しているが、Supabaseが自動的に値を設定している
- check-subscriptionでは正常に機能している

**新たな疑問**:
- stripe-webhookでも同じ値が設定されているのか？
- もし設定されていたら、なぜデータベース保存が失敗するのか？
- 別の原因があるのではないか？

---

## 📝 Phase 1.5 Step 2.5完了チェック

- [x] check-subscription Edge Functionを起動
- [x] check-subscriptionにデバッグログを追加
- [x] check-subscriptionをトリガーして環境変数の値を確認
- [x] Supabase提供の環境変数が正常に機能していることを確認
- [x] check-subscriptionとstripe-webhookの比較表を作成
- [x] 未解決の謎と追加調査項目を明確化
- [ ] **stripe-webhookの実際の環境変数値を確認（Stripe listen再起動が必要）**

---

## 🎯 次のアクション（Phase 1.5 Step 2.6 - 追加調査）

### オプションA: stripe-webhookの環境変数値を確認

1. Stripe listenを再起動
2. テストイベントを送信
3. stripe-webhookのログで`🔍 [DEBUG] SUPABASE_URL`の値を確認
4. check-subscriptionと同じ値か検証

### オプションB: 現状の仮定で進める

**仮定**:
- stripe-webhookでも`http://kong:8000`が設定されている
- データベース保存失敗の原因は環境変数ではない
- 別の問題（例：エラーハンドリングの欠如、サイレント失敗）がある

**次のステップ**:
- エラーハンドリングを改善
- データベース操作の成功/失敗を明示的にログ出力
- サイレント失敗を防ぐ

---

## 🔴 ユーザーへの質問

**stripe-webhookの環境変数値を確認するために、Stripe listenを再起動してテストを続けますか？**

**それとも、現状の仮定（両方とも同じ値が設定されている）で次のステップ（エラーハンドリング改善）に進みますか？**

---

**作成日時**: 2025-12-01 01:30
**作成者**: Claude Code
**次のステップ**: ユーザーの判断を待つ

