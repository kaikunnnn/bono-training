# Phase 1.5 Step 2: 根本原因特定レポート

**日付**: 2025-12-01 01:10
**ステータス**: ✅ 完了
**調査目的**: なぜデータベースに保存されないのか根本原因を特定

---

## 🎯 調査の背景

Phase 1.5 Step 1の調査で以下を発見:
1. すべてのログが`[LIVE環境]`にハードコーディング
2. ファイルヘッダーコメントが誤解を招く
3. SUPABASE_URL/SUPABASE_SERVICE_ROLE_KEYの実際の値を確認する必要あり

**Step 2の目的**:
- なぜデータベースに保存されないのか根本原因を特定
- `.env`の環境変数が正しく読み込まれているか確認

---

## 🔍 調査手順

### 1. デバッグログの追加

`supabase/functions/stripe-webhook/index.ts`に以下のデバッグログを追加:

**Line 18-19**: 環境変数STRIPE_MODE、ENVIRONMENTの値を出力
```typescript
console.log(`🔍 [DEBUG] STRIPE_MODE env var: ${Deno.env.get('STRIPE_MODE')}`);
console.log(`🔍 [DEBUG] ENVIRONMENT: ${ENVIRONMENT}`);
```

**Line 87-88**: Supabase接続情報を出力
```typescript
console.log(`🔍 [DEBUG] SUPABASE_URL: ${supabaseUrl}`);
console.log(`🔍 [DEBUG] SUPABASE_SERVICE_ROLE_KEY (first 20 chars): ${supabaseServiceKey.substring(0, 20)}...`);
```

### 2. Edge Functionの再起動

```bash
npx supabase functions serve stripe-webhook --env-file .env --no-verify-jwt
```

### 3. 起動ログの確認

---

## 🔴 決定的な証拠を発見

### Edge Function起動時のエラーログ

```
Setting up Edge Functions runtime...
Env name cannot start with SUPABASE_, skipping: SUPABASE_ANON_KEY
Env name cannot start with SUPABASE_, skipping: SUPABASE_SERVICE_ROLE_KEY
Env name cannot start with SUPABASE_, skipping: SUPABASE_URL
```

**これが根本原因です。**

---

## 📊 根本原因の詳細分析

### 発見4: Edge Functionは`SUPABASE_`プレフィックスの環境変数をスキップする 🔴 Critical

**問題のメカニズム**:

1. Supabase Edge Functionランタイムは、セキュリティ上の理由で`SUPABASE_`で始まる環境変数を自動的にスキップする
2. `.env`ファイルに以下の設定があっても無視される:
   ```bash
   SUPABASE_URL=http://127.0.0.1:54321
   SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
   ```
3. 結果として、Edge Function内で `Deno.env.get("SUPABASE_URL")` は `undefined` を返す

**影響範囲**:
- stripe-webhook Edge Function全体
- create-checkout Edge Function（同様の問題の可能性）
- その他、Supabase接続を使用するすべてのEdge Function

---

### 発見5: Supabaseクライアントが無効な状態で初期化される 🔴 Critical

**問題のコード** (`supabase/functions/stripe-webhook/index.ts` Line 83-89):

```typescript
const supabaseUrl = Deno.env.get("SUPABASE_URL") ?? "";               // ❌ "" (空文字列)
const supabaseServiceKey = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY") ?? "";  // ❌ "" (空文字列)
console.log(`🔍 [DEBUG] SUPABASE_URL: ${supabaseUrl}`);               // 出力: ""
console.log(`🔍 [DEBUG] SUPABASE_SERVICE_ROLE_KEY (first 20 chars): ${supabaseServiceKey.substring(0, 20)}...`);
const supabase = createClient(supabaseUrl, supabaseServiceKey);        // ❌ 無効なクライアント
```

**結果**:
- `supabaseUrl` = `""` (空文字列)
- `supabaseServiceKey` = `""` (空文字列)
- `createClient("", "")` で無効なクライアントが作成される
- データベースへの接続・書き込みが完全に失敗

**なぜエラーが表示されないのか**:
- `createClient()`はエラーをスローせず、無効なクライアントを返す
- データベース操作は サイレント失敗（エラーログなしで失敗）
- Edge Functionは正常終了として 200 OK を返す

---

## 🎯 問題の全体像

### データ保存失敗のフロー

```
1. Stripe Webhookイベント受信
   ↓
2. stripe-webhook Edge Function起動
   ↓
3. 環境変数読み込み試行
   ↓
4. ❌ SUPABASE_URL → スキップ → "" (空文字列)
   ↓
5. ❌ SUPABASE_SERVICE_ROLE_KEY → スキップ → "" (空文字列)
   ↓
6. ❌ createClient("", "") → 無効なクライアント
   ↓
7. ❌ データベース書き込み試行 → サイレント失敗
   ↓
8. ✅ Edge Function正常終了 (200 OK)
   ↓
9. ❌ データベースにデータなし
```

### なぜTest 1-1で成功ページまで到達したのか

- Stripe Checkoutは正常に完了（Stripe側の処理）
- Webhookイベントは正常に受信（200 OK）
- Edge Functionは正常に起動・処理・終了
- **しかし、データベースへの書き込みだけが失敗**
- ユーザーは成功ページに到達するが、システムにデータが残らない

---

## ✅ 根本原因の確定

### 問題

**Edge Functionは`SUPABASE_`プレフィックスの環境変数を読み込めない**

### 影響

- Supabaseクライアントが無効な状態で初期化される
- データベースへの全ての操作が失敗する
- ユーザーには成功と表示されるが、データは保存されない

### 該当コード

- `supabase/functions/stripe-webhook/index.ts` Line 83-89
- その他の Edge Functions（create-checkout, check-subscription等）

---

## 🛠️ 解決策

### Option 1: Supabase提供の環境変数を使用（推奨）

Supabase Edge Functionランタイムは、自動的に以下の環境変数を提供:
- `SUPABASE_URL` (自動提供、`.env`不要)
- `SUPABASE_ANON_KEY` (自動提供、`.env`不要)
- `SUPABASE_SERVICE_ROLE_KEY` (自動提供、`.env`不要)

**修正案**:
```typescript
// ❌ 現在のコード（.envから読み込もうとして失敗）
const supabaseUrl = Deno.env.get("SUPABASE_URL") ?? "";
const supabaseServiceKey = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY") ?? "";

// ✅ 修正後のコード（Supabase提供の環境変数を使用）
const supabaseUrl = Deno.env.get("SUPABASE_URL")!;
const supabaseServiceKey = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;
```

実は、Supabaseが自動的に正しい値を設定しているので、`.env`から読み込む必要がありません。

**確認方法**:
Edge Function内で以下のログを追加して確認:
```typescript
console.log(`✅ Supabase自動提供: SUPABASE_URL=${Deno.env.get("SUPABASE_URL")}`);
console.log(`✅ Supabase自動提供: SUPABASE_SERVICE_ROLE_KEY=${Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")?.substring(0, 20)}...`);
```

### Option 2: カスタムプレフィックスを使用

`.env`ファイルで`SUPABASE_`以外のプレフィックスを使用:
```bash
# ❌ スキップされる
SUPABASE_URL=http://127.0.0.1:54321
SUPABASE_SERVICE_ROLE_KEY=...

# ✅ 読み込まれる
CUSTOM_SUPABASE_URL=http://127.0.0.1:54321
CUSTOM_SUPABASE_SERVICE_ROLE_KEY=...
```

**ただし、Option 1が推奨**: Supabaseが自動提供する環境変数を使う方が確実。

---

## 📝 Phase 1.5 Step 2完了チェック

- [x] デバッグログを追加
- [x] Edge Functionを再起動
- [x] 環境変数読み込みエラーを発見
- [x] 根本原因を特定（SUPABASE_プレフィックスがスキップされる）
- [x] Supabaseクライアント無効化のメカニズムを解明
- [x] データ保存失敗のフロー全体を把握
- [x] 解決策を提案（Option 1推奨）

---

## 🎯 次のアクション（Phase 1.5 Step 3）

1. デバッグログを削除または最適化
2. Supabase提供の環境変数を使用するように修正（推奨）
3. ログのハードコーディング問題を修正（`[LIVE環境]` → `[${ENVIRONMENT}環境]`）
4. エラーハンドリングを改善（サイレント失敗を防ぐ）

---

## 📌 重要な学び

### なぜこの問題が見つけにくかったのか

1. **サイレント失敗**: エラーログが全く出力されなかった
2. **200 OK**: Edge Functionが正常終了として応答
3. **成功ページ到達**: ユーザーは成功したと思い込む
4. **ハードコーディングされたログ**: `[LIVE環境]`と表示され、test環境と分からなかった

### デバッグの重要性

- 環境変数の実際の値をログ出力する
- Edge Function起動時のエラーログを必ず確認する
- データベース操作の成功/失敗を明示的にログ出力する

---

**作成日時**: 2025-12-01 01:10
**作成者**: Claude Code
**次のステップ**: Phase 1.5 Step 3（コード修正）
