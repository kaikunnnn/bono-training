# å®Ÿè£…è¨ˆç”»: Webhook 401ã‚¨ãƒ©ãƒ¼ä¿®æ­£ & äºŒé‡èª²é‡‘é˜²æ­¢ï¼ˆæœ€çµ‚ç‰ˆï¼‰

**ä½œæˆæ—¥**: 2025-11-29
**æœ€çµ‚æ›´æ–°**: 2025-11-29
**æ‹…å½“**: Claude Code
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: å®Ÿè£…å¾…æ©Ÿä¸­ï¼ˆUXå®šç¾©å®Œäº†ãƒ»Stripe APIèª¿æŸ»å®Œäº†ï¼‰

---

## ğŸ¯ å®Ÿè£…ã®ç›®çš„

**ä½•ã‚’å®Ÿè£…ã™ã‚‹ã‹ï¼ˆä¸€è¡Œã§ï¼‰**:
Stripe Webhook 401ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£ã—ã€ãƒ—ãƒ©ãƒ³å¤‰æ›´æ™‚ã®äºŒé‡èª²é‡‘ã‚’å®Œå…¨ã«é˜²æ­¢ã™ã‚‹

**ãªãœå®Ÿè£…ã™ã‚‹ã‹**:
- **Critical Issue**: ISSUE-001ï¼ˆäºŒé‡èª²é‡‘ï¼‰ã¨ISSUE-002ï¼ˆç”»é¢æ›´æ–°ã•ã‚Œãªã„ï¼‰ã®æ ¹æœ¬åŸå› ã‚’è§£æ±º
- **UXè¦ä»¶é•å**: ã€Œå³æ™‚åæ˜ ã€ã€Œ2é‡èª²é‡‘ã®çµ¶å¯¾é˜²æ­¢ã€ã¨ã„ã†çµ¶å¯¾ã«å®ˆã‚‹ã¹ãUXåŸå‰‡ã‚’ç¾åœ¨æº€ãŸã—ã¦ã„ãªã„
- **ãƒ“ã‚¸ãƒã‚¹ãƒªã‚¹ã‚¯**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¿¡é ¼ã‚’å¤±ã†å¯èƒ½æ€§ãŒã‚ã‚‹é‡å¤§ãªå•é¡Œ

---

## ğŸ“‹ ç¾çŠ¶åˆ†æ

### UXè¦ä»¶ã®ç¢ºèª

#### requirements.md ã‹ã‚‰æŠ½å‡ºã—ãŸå¿…é ˆè¦ä»¶

**çµ¶å¯¾ã«å®ˆã‚‹ã¹ãUXåŸå‰‡**:

1. **å³æ™‚åæ˜ **ï¼ˆrequirements.md:33-43ï¼‰
   - æ±ºæ¸ˆå®Œäº†å¾Œã€å³åº§ã«æ–°ãƒ—ãƒ©ãƒ³ã®æ©Ÿèƒ½ãŒä½¿ãˆã‚‹
   - Webhookå‡¦ç† â†’ DBæ›´æ–° â†’ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰æ›´æ–°ãŒ3ç§’ä»¥å†…ã«å®Œäº†
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒªãƒ­ãƒ¼ãƒ‰ã—ãªãã¦ã‚‚ç”»é¢ãŒæ›´æ–°ã•ã‚Œã‚‹
   - âŒ **ç¾çŠ¶**: Webhook 401ã‚¨ãƒ©ãƒ¼ã§DBæ›´æ–°ã•ã‚Œãªã„ â†’ ã“ã®è¦ä»¶ã‚’æº€ãŸã›ã¦ã„ãªã„

2. **å³åº§ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯**ï¼ˆrequirements.md:46-55ï¼‰
   - ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯å¾Œ0.1ç§’ä»¥å†…ã«åå¿œ
   - ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ãƒ”ãƒŠãƒ¼è¡¨ç¤ºã€ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–
   - âœ… **ç¾çŠ¶**: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…æ¸ˆã¿ï¼ˆç¢ºèªå¿…è¦ï¼‰

3. **2é‡èª²é‡‘ã®çµ¶å¯¾é˜²æ­¢**ï¼ˆrequirements.md:58-67ï¼‰
   - ãƒ—ãƒ©ãƒ³å¤‰æ›´æ™‚ã€å¤ã„ãƒ—ãƒ©ãƒ³ã¯è‡ªå‹•ã‚­ãƒ£ãƒ³ã‚»ãƒ«
   - ãƒœã‚¿ãƒ³é€£æ‰“ã—ã¦ã‚‚1å›ã—ã‹å‡¦ç†ã•ã‚Œãªã„
   - Webhookå†ªç­‰æ€§ãƒã‚§ãƒƒã‚¯
   - âŒ **ç¾çŠ¶**: Webhook 401ã‚¨ãƒ©ãƒ¼ã§å¤ã„ãƒ—ãƒ©ãƒ³ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œãªã„ â†’ äºŒé‡èª²é‡‘ç™ºç”Ÿ

4. **åˆ†ã‹ã‚Šã‚„ã™ã„ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**ï¼ˆrequirements.md:70-84ï¼‰
   - æ—¥æœ¬èªã§ã€æ¬¡ã«ä½•ã‚’ã™ã¹ãã‹æ˜ç¢º
   - âœ… **ç¾çŠ¶**: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…æ¸ˆã¿ï¼ˆç¢ºèªå¿…è¦ï¼‰

5. **æ˜ç¢ºãªçŠ¶æ…‹è¡¨ç¤º**ï¼ˆrequirements.md:88-97ï¼‰
   - ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³åã€æ¬¡å›æ›´æ–°æ—¥ãŒå¸¸ã«è¡¨ç¤º
   - âŒ **ç¾çŠ¶**: Webhookå¤±æ•—ã§DBãŒæ›´æ–°ã•ã‚Œãªã„ãŸã‚ã€çŠ¶æ…‹è¡¨ç¤ºãŒä¸æ­£ç¢º

#### flows.md ã‹ã‚‰æŠ½å‡ºã—ãŸå¿…é ˆãƒ•ãƒ­ãƒ¼

**ãƒ•ãƒ­ãƒ¼2: ãƒ—ãƒ©ãƒ³å¤‰æ›´ï¼ˆã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ï¼‰**ï¼ˆflows.md:86-114ï¼‰

æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œ:
- âœ… å³åº§ã«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ—ãƒ©ãƒ³ã®æ©Ÿèƒ½ãŒä½¿ãˆã‚‹
- âœ… /subscriptionãƒšãƒ¼ã‚¸ã«ã€Œç¾åœ¨ã®ãƒ—ãƒ©ãƒ³: ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã€ã¨è¡¨ç¤º
- âœ… å¤ã„ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ãƒ—ãƒ©ãƒ³ã¯è‡ªå‹•çš„ã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¦ã„ã‚‹ â† **ã“ã‚ŒãŒç¾åœ¨å‹•ä½œã—ã¦ã„ãªã„**
- âœ… æ—¥å‰²ã‚Šè¨ˆç®—ã•ã‚ŒãŸé‡‘é¡ãŒè«‹æ±‚ã•ã‚Œã‚‹
- âŒ 2é‡èª²é‡‘ã•ã‚Œãªã„ â† **ç¾åœ¨ç™ºç”Ÿã—ã¦ã„ã‚‹**
- âŒ ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ãƒ—ãƒ©ãƒ³ã®èª²é‡‘ãŒç¶šã‹ãªã„ â† **ç¾åœ¨ç¶šã„ã¦ã„ã‚‹**

**æ–°ä»•æ§˜ï¼ˆflows.md:96-106ï¼‰: ç¢ºèªãƒšãƒ¼ã‚¸ã®è¦ä»¶**
- ãƒ—ãƒ©ãƒ³å¤‰æ›´å‰ã«ã€Œæ›´æ–°ç¢ºèªãƒšãƒ¼ã‚¸ã€ã‚’è¡¨ç¤º
- æ±ºæ¸ˆæƒ…å ±ã¨æ±ºæ¸ˆå†…å®¹ï¼ˆå·®é¡è¨ˆç®—ï¼‰ã‚’è¡¨ç¤º
- ç¢ºèªå¾Œã€ãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒƒã‚¯ã—ã¦ã‚‚ãƒ—ãƒ©ãƒ³ã«å½±éŸ¿ã—ãªã„
- ç¢ºå®šãƒœã‚¿ãƒ³ã§å¤‰æ›´ã‚’å®Ÿè¡Œ

**ãƒ•ãƒ­ãƒ¼3: ãƒ—ãƒ©ãƒ³å¤‰æ›´ï¼ˆãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰ï¼‰**ï¼ˆflows.md:118-131ï¼‰

**é‡è¦ãªä»•æ§˜å¤‰æ›´**:
- âŒ **æ—§ä»•æ§˜**: æ¬¡å›æ›´æ–°æ™‚ã«å¤‰æ›´
- âœ… **æ–°ä»•æ§˜**: **å³æ™‚åæ˜ **ï¼ˆrequirements.md:179-187ã§å¤‰æ›´ï¼‰
- **ç†ç”±**: æ—¥å‰²ã‚Šè¨ˆç®—ã§é«˜ã„ãƒ—ãƒ©ãƒ³ã®æ®‹é¡ã‚’æ–°ãƒ—ãƒ©ãƒ³ã«ä½¿ãˆã‚‹ãŸã‚

**ãƒ•ãƒ­ãƒ¼4: ãƒ—ãƒ©ãƒ³ã‚­ãƒ£ãƒ³ã‚»ãƒ«**ï¼ˆflows.md:142-158ï¼‰

**å®Ÿè£…æ–¹æ³•**:
- Stripe Customer Portalã‚’ä½¿ç”¨ï¼ˆflows.md:149-155ï¼‰
- /accountãƒšãƒ¼ã‚¸ã‹ã‚‰ã€Œãƒ—ãƒ©ãƒ³ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ãƒœã‚¿ãƒ³
- Stripeæä¾›ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç¢ºèªãƒšãƒ¼ã‚¸ã¸é·ç§»
- æœŸé–“çµ‚äº†ã¾ã§åˆ©ç”¨å¯èƒ½

#### edge-cases.md ã‹ã‚‰æŠ½å‡ºã—ãŸé–¢é€£ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹

**Edge Case 9: Webhookå¤±æ•—**ï¼ˆedge-cases.md:166-178ï¼‰

æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œ:
- âœ… Stripeå´ã§å†è©¦è¡Œ
- âœ… æœ€çµ‚çš„ã«ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒæ›´æ–°ã•ã‚Œã‚‹
- âš ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯ã€Œåæ˜ ã«æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€ã¨æ¡ˆå†…

âŒ **ç¾çŠ¶**: 401ã‚¨ãƒ©ãƒ¼ã§å†è©¦è¡ŒãŒæˆåŠŸã—ãªã„

---

### ç¾åœ¨ã®çŠ¶æ…‹

**ä½•ãŒã§ãã¦ã„ã‚‹**:
- Stripe Checkoutã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆï¼ˆenvironmentåˆ†é›¢å¯¾å¿œæ¸ˆã¿ï¼‰
- ç’°å¢ƒå¤‰æ•°ã®å‘½åè¦å‰‡ã«ã‚ˆã‚‹ test/live åˆ†é›¢ï¼ˆ`STRIPE_TEST_*` / `STRIPE_*`ï¼‰
- Webhookç½²åæ¤œè¨¼ã®å®Ÿè£…ï¼ˆã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ™ãƒ«ã§ã¯å­˜åœ¨ï¼‰
- äºŒé‡èª²é‡‘é˜²æ­¢ãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè£…ï¼ˆstripe-webhook/index.ts:162-199ï¼‰
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®Realtime subscriptionå®Ÿè£…ï¼ˆuseSubscription.ts:115-143ï¼‰
- è¤‡åˆãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„ã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ä¿è­·

**ä½•ãŒã§ãã¦ã„ãªã„**:
- âŒ Webhook 401ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿï¼ˆç½²åæ¤œè¨¼å¤±æ•—ï¼‰
- âŒ WebhookãŒå¤±æ•—ã™ã‚‹ãŸã‚ã€DBãŒæ›´æ–°ã•ã‚Œãªã„
- âŒ DBãŒæ›´æ–°ã•ã‚Œãªã„ãŸã‚ã€Realtime subscriptionãŒç™ºç«ã—ãªã„
- âŒ å¤ã„ãƒ—ãƒ©ãƒ³ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãŒå®Ÿè¡Œã•ã‚Œãªã„ï¼ˆäºŒé‡èª²é‡‘ï¼‰
- âŒ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«æ–°ãƒ—ãƒ©ãƒ³æƒ…å ±ãŒåæ˜ ã•ã‚Œãªã„
- âŒ ãƒ—ãƒ©ãƒ³å¤‰æ›´æ™‚ã®ç¢ºèªãƒšãƒ¼ã‚¸ãŒæœªå®Ÿè£…
- âŒ ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰ãŒæ¬¡å›æ›´æ–°æ™‚ã®ä»•æ§˜ã®ã¾ã¾ï¼ˆå³æ™‚åæ˜ ã«å¤‰æ›´å¿…è¦ï¼‰
- âŒ **é‡å¤§ãªè¨­è¨ˆå•é¡Œ**: Stripe Checkoutã‚’æ—¢å­˜ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³å¤‰æ›´ã«ä½¿ç”¨ã—ã¦ã„ã‚‹ï¼ˆCheckoutã¯æ–°è¦ä½œæˆå°‚ç”¨ï¼‰

**å•é¡Œç‚¹**:

1. **Webhook 401ã‚¨ãƒ©ãƒ¼ã®åŸå› **ï¼ˆæ¨æ¸¬ï¼‰:
   - Stripeç½²åæ¤œè¨¼ã«ä½¿ç”¨ã™ã‚‹ç’°å¢ƒå¤‰æ•°ãŒé–“é•ã£ã¦ã„ã‚‹å¯èƒ½æ€§
   - `STRIPE_WEBHOOK_SECRET_TEST` vs `STRIPE_WEBHOOK_SECRET_LIVE` ã®é¸æŠãƒ­ã‚¸ãƒƒã‚¯ã«å•é¡Œ
   - ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã®èª­ã¿å–ã‚Šæ–¹æ³•ã«å•é¡Œï¼ˆDenoç‰¹æœ‰ã®å•é¡Œï¼‰

2. **é‡å¤§ãªè¨­è¨ˆå•é¡Œ: Stripe Checkoutã®èª¤ç”¨**:
   - **ç¾çŠ¶**: ãƒ—ãƒ©ãƒ³å¤‰æ›´ã«Stripe Checkoutã‚’ä½¿ç”¨
   - **å•é¡Œ**: Stripe Checkoutã¯**æ–°è¦ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ä½œæˆå°‚ç”¨**
   - **å½±éŸ¿**: æ—¢å­˜ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®å¤‰æ›´ãŒã§ããªã„ â†’ ä»£ã‚ã‚Šã«æ–°ã—ã„ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãŒä½œæˆã•ã‚Œã‚‹ â†’ äºŒé‡èª²é‡‘
   - **æ­£ã—ã„æ–¹æ³•**: **Subscriptions API**ã‚’ä½¿ç”¨ã—ã¦æ—¢å­˜ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°

3. **äºŒé‡èª²é‡‘ãŒç™ºç”Ÿã™ã‚‹ãƒ•ãƒ­ãƒ¼**:
   ```
   1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰â†’ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã«å¤‰æ›´
   2. âŒ Stripe Checkoutå®Œäº†ï¼ˆæ–°ã—ã„ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½œæˆï¼‰
   3. Webhooké€ä¿¡ï¼ˆcheckout.session.completedï¼‰
   4. âŒ 401ã‚¨ãƒ©ãƒ¼ã§å‡¦ç†å¤±æ•—
   5. âŒ å¤ã„ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ãƒ—ãƒ©ãƒ³ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œãªã„
   6. âŒ æ–°ã—ã„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ—ãƒ©ãƒ³ã®æƒ…å ±ãŒDBã«ä¿å­˜ã•ã‚Œãªã„
   7. âŒ 2ã¤ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ï¼ˆäºŒé‡èª²é‡‘ï¼‰
   ```

4. **ç”»é¢ãŒæ›´æ–°ã•ã‚Œãªã„ãƒ•ãƒ­ãƒ¼**:
   ```
   1. Stripe Checkoutå®Œäº†
   2. /subscriptionãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹
   3. Realtime subscriptionãŒå¾…æ©Ÿä¸­
   4. âŒ WebhookãŒ401ã‚¨ãƒ©ãƒ¼ã§å¤±æ•—
   5. âŒ user_subscriptionsãƒ†ãƒ¼ãƒ–ãƒ«ãŒæ›´æ–°ã•ã‚Œãªã„
   6. âŒ Realtimeã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã—ãªã„
   7. âŒ ç”»é¢ãŒæ›´æ–°ã•ã‚Œãªã„ï¼ˆsubscribed: falseã®ã¾ã¾ï¼‰
   8. âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯ã€Œå®Œäº†ã€ã¨è¡¨ç¤ºã•ã‚Œã‚‹ãŒã€å®Ÿéš›ã¯å‡¦ç†ã•ã‚Œã¦ã„ãªã„ï¼ˆfalse completionï¼‰
   ```

---

### é–¢é€£ã™ã‚‹æ—¢å­˜ã‚³ãƒ¼ãƒ‰ãƒ»è¨­å®š

**å½±éŸ¿ã‚’å—ã‘ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«**:
- `supabase/functions/stripe-webhook/index.ts` - Webhookå‡¦ç†ï¼ˆç½²åæ¤œè¨¼ã€ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ï¼‰
- `supabase/functions/_shared/stripe-helpers.ts` - StripeåˆæœŸåŒ–ã€ç’°å¢ƒåˆ¤å®š
- `supabase/functions/create-checkout/index.ts` - Checkoutã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆï¼ˆmetadataã«replace_subscription_idè¨­å®šï¼‰
- `src/hooks/useSubscription.ts` - Realtime subscription
- `src/contexts/SubscriptionContext.tsx` - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰çŠ¶æ…‹ç®¡ç†

**ä½¿ç”¨ã™ã‚‹ç’°å¢ƒå¤‰æ•°**ï¼ˆfrom environment-variables.mdï¼‰:
- `STRIPE_SECRET_KEY_TEST` - Testç’°å¢ƒã®Stripe APIã‚­ãƒ¼
- `STRIPE_SECRET_KEY` - Liveç’°å¢ƒã®Stripe APIã‚­ãƒ¼
- `STRIPE_WEBHOOK_SECRET_TEST` - Testç’°å¢ƒã®Webhookç½²åæ¤œè¨¼ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ
- `STRIPE_WEBHOOK_SECRET_LIVE` - Liveç’°å¢ƒã®Webhookç½²åæ¤œè¨¼ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ
- `SUPABASE_URL` - Supabase API URL
- `SUPABASE_SERVICE_ROLE_KEY` - Supabase Service Role Keyï¼ˆRLSãƒã‚¤ãƒ‘ã‚¹ï¼‰

**ä¾å­˜ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ»API**:
- Stripe API v14.10.0ï¼ˆWebhookç½²åæ¤œè¨¼ã€ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç†ï¼‰
- Supabase Edge Functionsï¼ˆDenoç’°å¢ƒï¼‰
- Supabase Realtimeï¼ˆPostgreSQL LISTEN/NOTIFYï¼‰

---

## ğŸ¨ å®Ÿè£…æ–¹é‡

### Stripe APIèª¿æŸ»ã®çµæœ

**èª¿æŸ»æ—¥**: 2025-11-29

**é‡è¦ãªç™ºè¦‹**:

1. **âœ… ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰ã®å³æ™‚åæ˜ ãŒå¯èƒ½**
   - `proration_behavior: 'always_invoice'` ã§å³æ™‚åæ˜ å¯èƒ½
   - Flexible Billing Modeï¼ˆAPI 2025-06-30.basil+ï¼‰ã§æ­£ç¢ºãªæ—¥å‰²ã‚Šè¨ˆç®—
   - ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã¯è‡ªå‹•çš„ã«æ¬¡å›è«‹æ±‚ã«é©ç”¨ã•ã‚Œã‚‹
   - **çµè«–**: Takumiã•ã‚“ã®è¦ä»¶ã€Œãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰å³æ™‚åæ˜ ã€ã¯æŠ€è¡“çš„ã«å¯èƒ½

2. **âš ï¸ Stripe Checkoutã¯æ—¢å­˜ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³å¤‰æ›´ã«ä½¿ãˆãªã„**
   - Stripe Checkoutã¯**æ–°è¦ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ä½œæˆå°‚ç”¨**
   - æ—¢å­˜ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®å¤‰æ›´ã«ã¯ **Subscriptions API** ã‚’ä½¿ã†å¿…è¦ãŒã‚ã‚‹
   - **ç¾åœ¨ã®å®Ÿè£…ã®å•é¡Œç‚¹**: Checkoutã‚’ä½¿ã£ã¦ã„ã‚‹ãŸã‚ã€æ–°ã—ã„ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãŒä½œæˆã•ã‚Œã‚‹ â†’ äºŒé‡èª²é‡‘

3. **âœ… Preview Invoice APIã§é‡‘é¡ç¢ºèªãŒå¯èƒ½**
   - Subscriptions APIã«ã¯ **Preview Invoice** ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒã‚ã‚‹
   - ãƒ—ãƒ©ãƒ³å¤‰æ›´å‰ã«è«‹æ±‚é¡ã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã§ãã‚‹
   - **çµè«–**: Takumiã•ã‚“ã®è¦ä»¶ã€Œç¢ºèªç”»é¢ã§é‡‘é¡è¡¨ç¤ºã€ã¯æŠ€è¡“çš„ã«å¯èƒ½

4. **âœ… Webhookã®ä¿¡é ¼æ€§**
   - æœ¬ç•ªç’°å¢ƒã§ã¯3æ—¥é–“è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤
   - æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã§é–“éš”ã‚’ç©ºã‘ã¦å†é€ä¿¡
   - **é‡è¦**: å†ªç­‰æ€§ã®å®Ÿè£…ãŒå¿…é ˆï¼ˆåŒã˜ã‚¤ãƒ™ãƒ³ãƒˆIDã‚’2å›å‡¦ç†ã—ãªã„ï¼‰

---

### é¸æŠã—ãŸå®Ÿè£…ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ

**æ–¹é‡**: ã€Œ1ç•ªç°¡å˜ã«å®Ÿè£…ãŒã§ãã‚‹ã‹ã¤ãƒã‚°ãŒå°‘ãªã„æ–¹æ³•ã€ï¼ˆTakumiã•ã‚“ã®è¦æœ›ï¼‰

#### 1. ãƒ—ãƒ©ãƒ³å¤‰æ›´ãƒ•ãƒ­ãƒ¼ï¼ˆæ–°è¦å®Ÿè£…ï¼‰

**ç¾çŠ¶ã®å•é¡Œ**:
- Stripe Checkoutã‚’ä½¿ç”¨ â†’ æ–°ã—ã„ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãŒä½œæˆã•ã‚Œã‚‹

**æ–°ã—ã„å®Ÿè£…**:
1. **Subscriptions API** ã‚’ä½¿ç”¨ã—ã¦æ—¢å­˜ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
2. **Preview Invoice API** ã§é‡‘é¡ã‚’äº‹å‰è¨ˆç®—ã—ã¦ç¢ºèªç”»é¢ã«è¡¨ç¤º
3. **proration_behavior: 'always_invoice'** ã§ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãƒ»ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰ä¸¡æ–¹ã¨ã‚‚å³æ™‚åæ˜ 

**å®Ÿè£…ç®‡æ‰€**:
- æ–°è¦Edge Function: `supabase/functions/update-subscription/index.ts`
- æ–°è¦Edge Function: `supabase/functions/preview-subscription-change/index.ts`
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆæœ€å°é™ã®UIï¼‰

#### 2. ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ•ãƒ­ãƒ¼ï¼ˆStripeæ¨™æº–æ©Ÿèƒ½ã‚’ä½¿ç”¨ï¼‰

**å®Ÿè£…æ–¹æ³•**:
- **Stripe Customer Portal** ã‚’ä½¿ç”¨
- /accountãƒšãƒ¼ã‚¸ã«ã€Œãƒ—ãƒ©ãƒ³ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ãƒœã‚¿ãƒ³ã‚’é…ç½®
- Stripeã®æ¨™æº–ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ•ãƒ­ãƒ¼ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
- æœŸé–“çµ‚äº†ã¾ã§åˆ©ç”¨å¯èƒ½ï¼ˆStripeå´ã§è‡ªå‹•ç®¡ç†ï¼‰

**å®Ÿè£…ç®‡æ‰€**:
- æ–°è¦Edge Function: `supabase/functions/create-portal-session/index.ts`
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: /accountãƒšãƒ¼ã‚¸ã«ãƒœã‚¿ãƒ³è¿½åŠ 

#### 3. Webhookå‡¦ç†ï¼ˆæ—¢å­˜ã‚’ä¿®æ­£ï¼‰

**ä¿®æ­£å†…å®¹**:
1. **Webhook 401ã‚¨ãƒ©ãƒ¼ä¿®æ­£**: ç½²åæ¤œè¨¼ã®ç’°å¢ƒå¤‰æ•°é¸æŠãƒ­ã‚¸ãƒƒã‚¯ç¢ºèª
2. **å†ªç­‰æ€§ãƒã‚§ãƒƒã‚¯è¿½åŠ **: åŒã˜event_idã‚’2å›å‡¦ç†ã—ãªã„
3. **å³åº§ã«200ãƒ¬ã‚¹ãƒãƒ³ã‚¹**: 3ç§’ä»¥å†…ã«å‡¦ç†å®Œäº†ã€éåŒæœŸå‡¦ç†ã¸ã®ç§»è¡Œ
4. **false completioné˜²æ­¢**: WebhookãŒå¤±æ•—ã—ãŸå ´åˆã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«é©åˆ‡ãªã‚¨ãƒ©ãƒ¼è¡¨ç¤º

**å®Ÿè£…ç®‡æ‰€**:
- æ—¢å­˜: `supabase/functions/stripe-webhook/index.ts`

---

### ãªãœã“ã®æ–¹æ³•ã‚’é¸ã‚“ã ã‹

1. **Stripeæ¨™æº–æ©Ÿèƒ½ã‚’æœ€å¤§é™æ´»ç”¨**
   - Subscriptions API: Stripeå…¬å¼ã®æ–¹æ³•ã§ç¢ºå®Ÿ
   - Preview Invoice API: æ­£ç¢ºãªé‡‘é¡è¨ˆç®—
   - Customer Portal: ã‚­ãƒ£ãƒ³ã‚»ãƒ«UIã‚’è‡ªä½œä¸è¦

2. **ãƒã‚°ã®ãƒªã‚¹ã‚¯ã‚’æœ€å°åŒ–**
   - Stripe Checkoutã®èª¤ç”¨ã‚’ä¿®æ­£ï¼ˆæ ¹æœ¬åŸå› è§£æ±ºï¼‰
   - å†ªç­‰æ€§ãƒã‚§ãƒƒã‚¯ã§äºŒé‡å‡¦ç†é˜²æ­¢
   - Webhookè‡ªå‹•ãƒªãƒˆãƒ©ã‚¤ã«é ¼ã‚‹ï¼ˆ3æ—¥é–“ï¼‰

3. **ã‚·ãƒ³ãƒ—ãƒ«ãªå®Ÿè£…**
   - ã‚«ã‚¹ã‚¿ãƒ UIã¯æœ€å°é™ï¼ˆç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®ã¿ï¼‰
   - ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¯Stripe Customer Portalã«ä»»ã›ã‚‹
   - Webhookå‡¦ç†ã¯æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã‚’æ´»ã‹ã™

**æ¤œè¨ã—ã¦å´ä¸‹ã—ãŸæ–¹æ³•**:

| æ–¹æ³• | å´ä¸‹ç†ç”± |
|------|----------|
| Stripe Checkoutã§ãƒ—ãƒ©ãƒ³å¤‰æ›´ | Checkoutã¯æ–°è¦ä½œæˆå°‚ç”¨ã€‚æŠ€è¡“çš„ã«ä¸å¯èƒ½ |
| ã‚«ã‚¹ã‚¿ãƒ ç¢ºèªãƒšãƒ¼ã‚¸ã‚’ä½œã‚Šè¾¼ã‚€ | å®Ÿè£…ãŒè¤‡é›‘ã€‚Stripe APIã§ååˆ† |
| Webhookã‚’ä½¿ã‚ãšã€polling ã§ç¢ºèª | UXè¦ä»¶ã€Œå³æ™‚åæ˜ ï¼ˆ3ç§’ä»¥å†…ï¼‰ã€ã‚’æº€ãŸã›ãªã„ |
| Webhookç½²åæ¤œè¨¼ã‚’ç„¡åŠ¹åŒ– | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ã€‚çµ¶å¯¾ã«ä¸å¯ |
| æ‰‹å‹•ã§ãƒ—ãƒ©ãƒ³ã‚­ãƒ£ãƒ³ã‚»ãƒ« | ã‚¹ã‚±ãƒ¼ãƒ«ã—ãªã„ã€‚Customer PortalãŒä½¿ãˆã‚‹ |

---

### å®Ÿè£…ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆãƒ†ã‚¹ãƒˆé§†å‹•å‹ï¼‰

#### Phase 1: Webhook 401ã‚¨ãƒ©ãƒ¼ä¿®æ­£ï¼ˆæœ€å„ªå…ˆï¼‰

**ç›®çš„**: æ—¢å­˜æ©Ÿèƒ½ã‚’å‹•ä½œã•ã›ã‚‹

**1-1. èª¿æŸ»ãƒ»å•é¡Œç‰¹å®š**
- [ ] Stripe Webhookãƒ­ã‚°ã‚’ç¢ºèªï¼ˆStripe Dashboardï¼‰
- [ ] Edge Function ãƒ­ã‚°ã‚’ç¢ºèªï¼ˆSupabase Dashboardï¼‰
- [ ] 401ã‚¨ãƒ©ãƒ¼ã®è©³ç´°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’åé›†
- [ ] **config.toml ã®ç¢ºèª**ï¼ˆverify_jwtè¨­å®šã®æœ‰ç„¡ï¼‰â† **ã“ã‚ŒãŒ401ã®åŸå› **
- [ ] stripe-webhook/index.ts ã®ç½²åæ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç¢ºèª
- [ ] ç’°å¢ƒå¤‰æ•° `STRIPE_WEBHOOK_SECRET_TEST` / `STRIPE_WEBHOOK_SECRET_LIVE` ã®é¸æŠãƒ­ã‚¸ãƒƒã‚¯ç¢ºèª
- [ ] ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã®èª­ã¿å–ã‚Šæ–¹æ³•ã‚’ç¢ºèªï¼ˆ`req.text()` ã‚’ä½¿ã£ã¦ã„ã‚‹ã‹ï¼‰
- [ ] StripeåˆæœŸåŒ–ã§ `createSubtleCryptoProvider()` ã‚’ä½¿ã£ã¦ã„ã‚‹ã‹ç¢ºèª

**1-2. å®Ÿè£…**

**Step 1: config.toml ã®ä½œæˆãƒ»ä¿®æ­£ï¼ˆæœ€é‡è¦ï¼‰**
- [ ] ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ: `supabase/functions/stripe-webhook/config.toml`
- [ ] ä»¥ä¸‹ã‚’è¨˜è¿°:
```toml
[stripe-webhook]
verify_jwt = false  # Stripe Webhookã¯ç½²åæ¤œè¨¼ã§èªè¨¼ã™ã‚‹ãŸã‚ã€JWTä¸è¦
```

**Step 2: StripeåˆæœŸåŒ–ã®ä¿®æ­£**
- [ ] stripe-webhook/index.ts ã®å†’é ­ã‚’ä»¥ä¸‹ã«ä¿®æ­£:
```typescript
import Stripe from 'https://esm.sh/stripe@17.7.0'

// Denoç’°å¢ƒç”¨ã®crypto providerã‚’ä½¿ç”¨
const stripe = new Stripe(Deno.env.get('STRIPE_SECRET_KEY') || '', {
  apiVersion: '2025-06-30.basil',  // Flexible Billing Modeå¯¾å¿œ
  httpClient: Stripe.createFetchHttpClient(),
})

const cryptoProvider = Stripe.createSubtleCryptoProvider()
```

**Step 3: ç½²åæ¤œè¨¼ã®ä¿®æ­£**
- [ ] ç’°å¢ƒå¤‰æ•°ã‹ã‚‰ç½²åã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’å–å¾—:
```typescript
const isLiveMode = /* Stripeã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰åˆ¤å®š */
const webhookSecret = isLiveMode
  ? Deno.env.get('STRIPE_WEBHOOK_SECRET_LIVE')!
  : Deno.env.get('STRIPE_WEBHOOK_SECRET_TEST')!
```
- [ ] **raw bodyã‚’å–å¾—**ï¼ˆé‡è¦: `.json()` ã¯ä½¿ã‚ãªã„ï¼‰:
```typescript
const body = await req.text()  // â† ã“ã‚ŒãŒå¿…é ˆ
```
- [ ] ç½²åã‚’å–å¾—:
```typescript
const signature = req.headers.get('Stripe-Signature')
if (!signature) {
  return new Response('No signature', { status: 400 })
}
```
- [ ] **constructEventAsync()** ã‚’ä½¿ç”¨ï¼ˆéåŒæœŸç‰ˆï¼‰:
```typescript
const event = await stripe.webhooks.constructEventAsync(
  body,
  signature,
  webhookSecret,
  undefined,
  cryptoProvider  // â† Denoç”¨ã®crypto provider
)
```

**1-3. è‡ªå‹•ãƒ†ã‚¹ãƒˆä½œæˆ**
- [ ] ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ: `supabase/functions/stripe-webhook/index.test.ts`
- [ ] ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: æ­£ã—ã„ç½²åã§200ã‚’è¿”ã™ã‹
- [ ] ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: ä¸æ­£ãªç½²åã§401ã‚’è¿”ã™ã‹
- [ ] ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: Testç’°å¢ƒã®ç½²åã§å‹•ä½œã™ã‚‹ã‹
- [ ] ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹4: Liveç’°å¢ƒã®ç½²åã§å‹•ä½œã™ã‚‹ã‹
- [ ] **ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹5: å¤ã„ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼ˆ6åˆ†å‰ï¼‰ã§ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™ã‹**ï¼ˆãƒªãƒ—ãƒ¬ã‚¤ã‚¢ã‚¿ãƒƒã‚¯é˜²æ­¢ï¼‰
- [ ] **ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹6: Stripe-Signatureãƒ˜ãƒƒãƒ€ãƒ¼ãŒãªã„å ´åˆ400ã‚’è¿”ã™ã‹**
- [ ] `deno test supabase/functions/stripe-webhook/index.test.ts` ã‚’å®Ÿè¡Œ

**1-4. æ‰‹å‹•ãƒ†ã‚¹ãƒˆ**
- [ ] Stripe CLIã§Webhooké€ä¿¡: `stripe listen --forward-to localhost:54321/functions/v1/stripe-webhook`
- [ ] Testç’°å¢ƒã§æ–°è¦ç™»éŒ²ã‚’å®Ÿè¡Œ
- [ ] Edge Functionãƒ­ã‚°ã§200ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç¢ºèª
- [ ] DBã«`user_subscriptions`ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒä½œæˆã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
- [ ] ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§å³åº§ã«åæ˜ ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆRealtime subscriptionï¼‰

**1-5. æˆåŠŸåŸºæº–ï¼ˆã™ã¹ã¦âœ…ã§å®Œäº†ï¼‰**
- [ ] âœ… **config.toml ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹**ï¼ˆverify_jwt = falseï¼‰
- [ ] âœ… **crypto providerãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹**ï¼ˆcreateSubtleCryptoProviderï¼‰
- [ ] âœ… **raw bodyãŒå–å¾—ã•ã‚Œã¦ã„ã‚‹**ï¼ˆreq.text()ï¼‰
- [ ] âœ… **constructEventAsync()ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹**ï¼ˆéåŒæœŸç‰ˆï¼‰
- [ ] âœ… è‡ªå‹•ãƒ†ã‚¹ãƒˆãŒå…¨ã¦ãƒ‘ã‚¹ï¼ˆ6ã¤ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ï¼‰
- [ ] âœ… Webhook ãŒ200ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™
- [ ] âœ… 401ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãªã„
- [ ] âœ… æ–°è¦ç™»éŒ²ãƒ•ãƒ­ãƒ¼ãŒå®Œå…¨ã«å‹•ä½œã™ã‚‹ï¼ˆã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ãƒ»ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ä¸¡æ–¹ï¼‰
- [ ] âœ… Realtime subscriptionãŒç™ºç«ã—ã¦ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å³åº§ã«æ›´æ–°

**æˆæœç‰©**: Webhook 401ã‚¨ãƒ©ãƒ¼è§£æ¶ˆ + ãƒ†ã‚¹ãƒˆå®Œå‚™

---

#### Phase 2: Webhookå†ªç­‰æ€§ãƒã‚§ãƒƒã‚¯è¿½åŠ 

**ç›®çš„**: äºŒé‡å‡¦ç†ã‚’é˜²æ­¢

**2-1. å®Ÿè£…**
- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ: `supabase/migrations/YYYYMMDD_add_webhook_events_table.sql`
- [ ] `webhook_events`ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ
  - `id` UUID PRIMARY KEY
  - `event_id` TEXT UNIQUE NOT NULL
  - `event_type` TEXT NOT NULL
  - `processed_at` TIMESTAMPTZ DEFAULT NOW()
  - `environment` TEXT CHECK (environment IN ('test', 'live'))
- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ: `npx supabase db push`
- [ ] stripe-webhook/index.ts ã«å†ªç­‰æ€§ãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ 
  - ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†å‰ã«`event_id`ã§DBãƒã‚§ãƒƒã‚¯
  - æ—¢ã«å‡¦ç†æ¸ˆã¿ãªã‚‰200ã‚’è¿”ã—ã¦çµ‚äº†
  - æœªå‡¦ç†ãªã‚‰å‡¦ç†ã—ã¦`event_id`ã‚’DBã«ä¿å­˜

**2-2. è‡ªå‹•ãƒ†ã‚¹ãƒˆä½œæˆ**
- [ ] ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«æ›´æ–°: `supabase/functions/stripe-webhook/index.test.ts`
- [ ] ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: åŒã˜event_idã‚’2å›é€ä¿¡ â†’ 1å›ã—ã‹å‡¦ç†ã•ã‚Œãªã„
- [ ] ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: ç•°ãªã‚‹event_idã‚’2å›é€ä¿¡ â†’ ä¸¡æ–¹å‡¦ç†ã•ã‚Œã‚‹
- [ ] ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: webhook_eventsãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒä¿å­˜ã•ã‚Œã‚‹
- [ ] `deno test supabase/functions/stripe-webhook/index.test.ts` ã‚’å®Ÿè¡Œ

**2-3. æ‰‹å‹•ãƒ†ã‚¹ãƒˆ**
- [ ] Stripe CLIã§åŒã˜Webhookã‚’2å›é€ä¿¡
- [ ] DBã®`webhook_events`ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç¢ºèª â†’ 1ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ã¿
- [ ] DBã®`user_subscriptions`ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç¢ºèª â†’ 1ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ã¿ï¼ˆäºŒé‡ç™»éŒ²ã•ã‚Œã¦ã„ãªã„ï¼‰
- [ ] Edge Functionãƒ­ã‚°ã§ã€ŒAlready processedã€ãƒ­ã‚°ã‚’ç¢ºèªï¼ˆ2å›ç›®ï¼‰

**2-4. æˆåŠŸåŸºæº–ï¼ˆã™ã¹ã¦âœ…ã§å®Œäº†ï¼‰**
- [ ] âœ… è‡ªå‹•ãƒ†ã‚¹ãƒˆãŒå…¨ã¦ãƒ‘ã‚¹
- [ ] âœ… åŒã˜Webhookã‚’è¤‡æ•°å›å—ä¿¡ã—ã¦ã‚‚1å›ã—ã‹å‡¦ç†ã•ã‚Œãªã„
- [ ] âœ… webhook_eventsãƒ†ãƒ¼ãƒ–ãƒ«ã«event_idãŒä¿å­˜ã•ã‚Œã‚‹
- [ ] âœ… äºŒé‡ç™»éŒ²ãƒ»äºŒé‡èª²é‡‘ãŒç™ºç”Ÿã—ãªã„

**æˆæœç‰©**: å†ªç­‰æ€§ã®ã‚ã‚‹Webhookå‡¦ç† + ãƒ†ã‚¹ãƒˆå®Œå‚™

---

#### Phase 3: ãƒ—ãƒ©ãƒ³å¤‰æ›´ãƒ•ãƒ­ãƒ¼å®Ÿè£…ï¼ˆæ–°è¦ï¼‰

**3-1. Preview Invoice APIå®Ÿè£…**
- [ ] æ–°è¦Edge Functionä½œæˆ: `supabase/functions/preview-subscription-change/index.ts`
- [ ] StripeåˆæœŸåŒ–ï¼ˆFlexible Billing Modeå¯¾å¿œï¼‰:
```typescript
import Stripe from 'https://esm.sh/stripe@17.7.0'

const stripe = new Stripe(Deno.env.get('STRIPE_SECRET_KEY') || '', {
  apiVersion: '2025-06-30.basil',  // â† Flexible Billing Modeå¯¾å¿œ
  httpClient: Stripe.createFetchHttpClient(),
})
```
- [ ] **æ–°ã—ã„Preview Invoice API**ã‚’ä½¿ç”¨:
```typescript
// 2025å¹´ç‰ˆ: invoices.createPreview() ã‚’ä½¿ç”¨
const previewInvoice = await stripe.invoices.createPreview({
  customer: customerId,
  subscription: subscriptionId,
  subscription_details: {
    items: [{
      id: currentSubscriptionItemId,
      price: newPriceId,
    }],
    proration_behavior: 'always_invoice',
  },
})
```
- [ ] **Note**: `invoices.retrieveUpcoming()` ã¯éæ¨å¥¨ã€‚æœ€æ–°ã® `createPreview()` ã‚’ä½¿ã†
- [ ] è¿”ã‚Šå€¤: å¤‰æ›´å¾Œã®é‡‘é¡ã€æ—¥å‰²ã‚Šè¨ˆç®—ã®è©³ç´°ã€æ¬¡å›è«‹æ±‚é¡

**3-2. Subscription Update APIå®Ÿè£…**
- [ ] æ–°è¦Edge Functionä½œæˆ: `supabase/functions/update-subscription/index.ts`
- [ ] æ—¢å­˜ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³IDã‚’DBã‹ã‚‰å–å¾—
- [ ] **Step 1: Subscription Scheduleã®ç¢ºèª**ï¼ˆé‡è¦ï¼‰:
```typescript
const subscription = await stripe.subscriptions.retrieve(subscriptionId)

// Subscription ScheduleãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€Schedule APIã‚’ä½¿ã†
if (subscription.schedule) {
  throw new Error('ã“ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã«ã¯ScheduleãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚Schedule APIã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚')
  // ã¾ãŸã¯: stripe.subscriptionSchedules.update(subscription.schedule, {...})
}
```
- [ ] **Step 2: æœªæ‰•ã„ã‚¤ãƒ³ãƒœã‚¤ã‚¹ã®ç¢ºèª**:
```typescript
const latestInvoice = await stripe.invoices.retrieve(subscription.latest_invoice as string)

// æœªæ‰•ã„ã®å ´åˆã¯prorationã‚’ç„¡åŠ¹åŒ–ï¼ˆæœªæ‰•ã„æ™‚é–“åˆ†ã®ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚’é˜²ãï¼‰
const prorationBehavior = latestInvoice.status === 'open'
  ? 'none'           // æœªæ‰•ã„ã®å ´åˆ
  : 'always_invoice' // é€šå¸¸
```
- [ ] **Step 3: Subscription Updateå®Ÿè¡Œ**:
```typescript
await stripe.subscriptions.update(subscriptionId, {
  items: [{
    id: subscription.items.data[0].id,
    price: newPriceId,
  }],
  proration_behavior: prorationBehavior,  // â† æœªæ‰•ã„è€ƒæ…®
  billing_cycle_anchor: 'unchanged',      // è«‹æ±‚æ—¥ã‚’å¤‰æ›´ã—ãªã„
})
```
- [ ] Webhookï¼ˆcustomer.subscription.updatedï¼‰ã‚’å¾…ã¤

**3-3. ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°UIå®Ÿè£…**
- [ ] ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä½œæˆ: src/components/subscription/PlanChangeConfirmModal.tsx
- [ ] Preview Invoice APIã‚’å‘¼ã³å‡ºã—ã¦é‡‘é¡ã‚’è¡¨ç¤º
- [ ] è¡¨ç¤ºå†…å®¹:
  - ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³å
  - å¤‰æ›´å¾Œã®ãƒ—ãƒ©ãƒ³å
  - ä»Šã™ãè«‹æ±‚ã•ã‚Œã‚‹é‡‘é¡ï¼ˆæ—¥å‰²ã‚Šè¨ˆç®—ï¼‰
  - æ¬¡å›è«‹æ±‚é¡
- [ ] ã€Œç¢ºå®šã€ãƒœã‚¿ãƒ³ã§Update Subscription APIã‚’å‘¼ã³å‡ºã—
- [ ] ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å®Ÿè£…
- [ ] ãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒƒã‚¯å¯¾å¿œï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¦ã‚‚ãƒ—ãƒ©ãƒ³ã«å½±éŸ¿ãªã—ï¼‰
- [ ] **ãƒ—ãƒ©ãƒ³å¤‰æ›´æˆåŠŸæ™‚ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å®Ÿè£…**ï¼ˆflows.md:104-105å¯¾å¿œï¼‰
  - Update Subscription APIæˆåŠŸå¾Œã€ãƒˆãƒ¼ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
  - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ã€Œãƒ—ãƒ©ãƒ³å¤‰æ›´ã—ã¾ã—ãŸã€
  - å¤‰æ›´å¾Œã®ãƒ—ãƒ©ãƒ³åã¨æœŸé–“ã‚’è¡¨ç¤ºï¼ˆä¾‹: ã€Œãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ 3ãƒ¶æœˆãƒ—ãƒ©ãƒ³ã€ï¼‰
  - ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¦/subscriptionãƒšãƒ¼ã‚¸ã‚’æ›´æ–°

**3-4. è‡ªå‹•ãƒ†ã‚¹ãƒˆä½œæˆ**

**Preview Invoice APIã®ãƒ†ã‚¹ãƒˆ**:
- [ ] ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ: supabase/functions/preview-subscription-change/index.test.ts
- [ ] ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: æ­£ã—ã„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§Preview Invoiceã‚’å–å¾—ã§ãã‚‹ã‹
- [ ] ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: é‡‘é¡è¨ˆç®—ãŒæ­£ã—ã„ã‹ï¼ˆæ—¥å‰²ã‚Šè¨ˆç®—ï¼‰
- [ ] ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: ç„¡åŠ¹ãªã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³IDã§ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™ã‹
- [ ] **ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹4: createPreview()ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‹**ï¼ˆretrieveUpcoming()ã¯ä½¿ã‚ã‚Œã¦ã„ãªã„ã‹ï¼‰

**Subscription Update APIã®ãƒ†ã‚¹ãƒˆ**:
- [ ] ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ: supabase/functions/update-subscription/index.test.ts
- [ ] ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹5: Subscription Update APIãŒæ­£ã—ãå‘¼ã°ã‚Œã‚‹ã‹
- [ ] ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹6: é€šå¸¸æ™‚ã« proration_behavior ãŒ 'always_invoice' ã«ãªã£ã¦ã„ã‚‹ã‹
- [ ] **ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹7: æœªæ‰•ã„ã‚¤ãƒ³ãƒœã‚¤ã‚¹ãŒã‚ã‚‹å ´åˆã€proration_behavior ãŒ 'none' ã«ãªã£ã¦ã„ã‚‹ã‹**
- [ ] **ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹8: Subscription ScheduleãŒã‚ã‚‹å ´åˆã€ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™ã‹**
- [ ] **ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹9: billing_cycle_anchor ãŒ 'unchanged' ã«ãªã£ã¦ã„ã‚‹ã‹**

**UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆ**:
- [ ] React Testing Library ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆ
- [ ] ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹10: Preview APIã®çµæœãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹ã‹
- [ ] ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹11: ã€Œç¢ºå®šã€ãƒœã‚¿ãƒ³ã§Update APIãŒå‘¼ã°ã‚Œã‚‹ã‹
- [ ] ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹12: ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹ã‹
- [ ] **ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹13: APIæˆåŠŸå¾Œã«ãƒˆãƒ¼ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‹**
- [ ] **ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹14: ãƒˆãƒ¼ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å¤‰æ›´å¾Œã®ãƒ—ãƒ©ãƒ³åãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹**

**3-5. æ‰‹å‹•ãƒ†ã‚¹ãƒˆ**
- [ ] Testç’°å¢ƒã§ãƒ—ãƒ©ãƒ³å¤‰æ›´ã‚’å®Ÿè¡Œ
- [ ] ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ â†’ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ï¼‰
  - ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§å·®é¡é‡‘é¡ã‚’ç¢ºèª
  - ã€Œç¢ºå®šã€ã‚’ã‚¯ãƒªãƒƒã‚¯
  - **ã€Œãƒ—ãƒ©ãƒ³å¤‰æ›´ã—ã¾ã—ãŸã€ãƒˆãƒ¼ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª**
  - **å¤‰æ›´å¾Œã®ãƒ—ãƒ©ãƒ³åï¼ˆãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ 1ãƒ¶æœˆãƒ—ãƒ©ãƒ³ï¼‰ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª**
  - å³åº§ã«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ—ãƒ©ãƒ³ã«å¤‰æ›´ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
  - DBã®user_subscriptionsãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç¢ºèª â†’ åŒã˜subscription_idã§æ›´æ–°
  - Stripe Dashboardã‚’ç¢ºèª â†’ 1ã¤ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®ã¿ã‚¢ã‚¯ãƒ†ã‚£ãƒ–
- [ ] ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ â†’ ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ï¼ˆãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰ï¼‰
  - ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆé¡ã‚’ç¢ºèª
  - ã€Œç¢ºå®šã€ã‚’ã‚¯ãƒªãƒƒã‚¯
  - **ã€Œãƒ—ãƒ©ãƒ³å¤‰æ›´ã—ã¾ã—ãŸã€ãƒˆãƒ¼ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª**
  - **å¤‰æ›´å¾Œã®ãƒ—ãƒ©ãƒ³åï¼ˆã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ 1ãƒ¶æœˆãƒ—ãƒ©ãƒ³ï¼‰ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª**
  - å³åº§ã«ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ãƒ—ãƒ©ãƒ³ã«å¤‰æ›´ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
  - Stripe Dashboardã§ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚’ç¢ºèª
- [ ] ãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒƒã‚¯ã®ãƒ†ã‚¹ãƒˆ
  - ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
  - ãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒƒã‚¯ã§æˆ»ã‚‹
  - ãƒ—ãƒ©ãƒ³ãŒå¤‰æ›´ã•ã‚Œã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèª

**3-6. æˆåŠŸåŸºæº–ï¼ˆã™ã¹ã¦âœ…ã§å®Œäº†ï¼‰**
- [ ] âœ… **Flexible Billing Modeå¯¾å¿œ**ï¼ˆAPI version: 2025-06-30.basilï¼‰
- [ ] âœ… **æ–°ã—ã„Preview Invoice APIä½¿ç”¨**ï¼ˆcreatePreviewï¼‰
- [ ] âœ… **Subscription Scheduleã®ãƒã‚§ãƒƒã‚¯ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹**
- [ ] âœ… **æœªæ‰•ã„ã‚¤ãƒ³ãƒœã‚¤ã‚¹ã®ãƒã‚§ãƒƒã‚¯ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹**
- [ ] âœ… è‡ªå‹•ãƒ†ã‚¹ãƒˆãŒå…¨ã¦ãƒ‘ã‚¹ï¼ˆ14å€‹ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ï¼‰
- [ ] âœ… Preview Invoice APIãŒæ­£ç¢ºãªé‡‘é¡ã‚’è¿”ã™
- [ ] âœ… ãƒ—ãƒ©ãƒ³å¤‰æ›´ãŒå³åº§ã«åæ˜ ã•ã‚Œã‚‹ï¼ˆã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãƒ»ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰ä¸¡æ–¹ï¼‰
- [ ] âœ… äºŒé‡èª²é‡‘ãŒç™ºç”Ÿã—ãªã„ï¼ˆStripe Dashboardã§1ã¤ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®ã¿ï¼‰
- [ ] âœ… ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®ãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒƒã‚¯ã§å½±éŸ¿ãªã—
- [ ] âœ… **ãƒ—ãƒ©ãƒ³å¤‰æ›´æˆåŠŸæ™‚ã«ãƒˆãƒ¼ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹**ï¼ˆflows.md:104-105å¯¾å¿œï¼‰
- [ ] âœ… **ãƒˆãƒ¼ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å¤‰æ›´å¾Œã®ãƒ—ãƒ©ãƒ³åãŒè¡¨ç¤ºã•ã‚Œã‚‹**
- [ ] âœ… Realtime subscriptionãŒç™ºç«ã—ã¦ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å³åº§ã«æ›´æ–°
- [ ] âœ… Webhookï¼ˆcustomer.subscription.updatedï¼‰ãŒæ­£å¸¸ã«å‡¦ç†ã•ã‚Œã‚‹
- [ ] âœ… æœªæ‰•ã„ã®å ´åˆã«prorationãŒç„¡åŠ¹åŒ–ã•ã‚Œã‚‹

---

#### Phase 4: ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ•ãƒ­ãƒ¼å®Ÿè£…

**4-1. Customer Portal Session APIå®Ÿè£…**
- [ ] æ–°è¦Edge Functionä½œæˆ: `supabase/functions/create-portal-session/index.ts`
- [ ] Stripe Customer Portal ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
- [ ] ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:
  - customer: Stripe Customer IDï¼ˆDBã‹ã‚‰å–å¾—ï¼‰
  - return_url: `${origin}/account`
- [ ] è¿”ã‚Šå€¤: Portal Session URL

**4-2. ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒšãƒ¼ã‚¸UIæ›´æ–°**
- [ ] src/pages/Account.tsx ã«ã€Œãƒ—ãƒ©ãƒ³ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
- [ ] ã‚¯ãƒªãƒƒã‚¯ã§create-portal-session APIã‚’å‘¼ã³å‡ºã—
- [ ] Portal URLã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
- [ ] ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å®Ÿè£…

**4-3. Webhookå‡¦ç†è¿½åŠ **
- [ ] stripe-webhook/index.ts ã« customer.subscription.deleted ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã‚’è¿½åŠ 
- [ ] DBæ›´æ–°: is_active = false, canceled_at = now()
- [ ] æœŸé–“çµ‚äº†æ—¥ã¾ã§åˆ©ç”¨å¯èƒ½ï¼ˆcancel_at_period_endï¼‰

**4-4. è‡ªå‹•ãƒ†ã‚¹ãƒˆä½œæˆ**
- [ ] ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ: supabase/functions/create-portal-session/index.test.ts
- [ ] ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: æ­£ã—ã„Customer IDã§Portal Sessionã‚’ä½œæˆã§ãã‚‹ã‹
- [ ] ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: return_urlãŒæ­£ã—ãè¨­å®šã•ã‚Œã‚‹ã‹
- [ ] ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: ç„¡åŠ¹ãªCustomer IDã§ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™ã‹
- [ ] Webhook è‡ªå‹•ãƒ†ã‚¹ãƒˆæ›´æ–°: supabase/functions/stripe-webhook/index.test.ts
- [ ] ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹4: customer.subscription.deletedã‚¤ãƒ™ãƒ³ãƒˆã§DBæ›´æ–°ã•ã‚Œã‚‹ã‹
- [ ] ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹5: is_active = false, canceled_atãŒè¨­å®šã•ã‚Œã‚‹ã‹

**4-5. æ‰‹å‹•ãƒ†ã‚¹ãƒˆ**
- [ ] Testç’°å¢ƒã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚’å®Ÿè¡Œ
- [ ] /accountãƒšãƒ¼ã‚¸ã§ã€Œãƒ—ãƒ©ãƒ³ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
- [ ] Stripe Customer Portalã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
- [ ] Portalã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç¢ºèªç”»é¢ã‚’ç¢ºèª
- [ ] ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚’å®Ÿè¡Œ
- [ ] /accountãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹ã“ã¨ã‚’ç¢ºèª
- [ ] DBã®user_subscriptionsãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç¢ºèª â†’ is_active = false
- [ ] æœŸé–“çµ‚äº†æ—¥ã¾ã§åˆ©ç”¨å¯èƒ½ã¨è¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
- [ ] Stripe Dashboardã‚’ç¢ºèª â†’ ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«äºˆç´„çŠ¶æ…‹

**4-6. æˆåŠŸåŸºæº–ï¼ˆã™ã¹ã¦âœ…ã§å®Œäº†ï¼‰**
- [ ] âœ… è‡ªå‹•ãƒ†ã‚¹ãƒˆãŒå…¨ã¦ãƒ‘ã‚¹
- [ ] âœ… Customer Portal Session APIãŒæ­£å¸¸ã«å‹•ä½œ
- [ ] âœ… Stripe Customer Portalã§æ—¥æœ¬èªãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] âœ… ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç¢ºèªç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] âœ… Webhookï¼ˆcustomer.subscription.deletedï¼‰ãŒæ­£å¸¸ã«å‡¦ç†ã•ã‚Œã‚‹
- [ ] âœ… æœŸé–“çµ‚äº†æ—¥ã¾ã§åˆ©ç”¨å¯èƒ½ã¨è¡¨ç¤ºã•ã‚Œã‚‹
- [ ] âœ… æœŸé–“çµ‚äº†æ—¥ã«ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãŒè‡ªå‹•çµ‚äº†

---

#### Phase 5: æ—¢å­˜ã®æ–°è¦ç™»éŒ²ãƒ•ãƒ­ãƒ¼ç¶­æŒ

**5-1. create-checkoutã®ç¢ºèª**
- [ ] supabase/functions/create-checkout/index.ts ã‚’ç¢ºèª
- [ ] æ–°è¦ç™»éŒ²å°‚ç”¨ã§ã‚ã‚‹ã“ã¨ã‚’æ˜è¨˜ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ ï¼‰
- [ ] æ—¢å­˜ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™
- [ ] Testç’°å¢ƒã§å‹•ä½œç¢ºèª

**5-2. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰åˆ†å²ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…**
- [ ] src/pages/Subscription.tsx ã‚’æ›´æ–°
- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’ç¢ºèª
  - subscribed === false â†’ æ–°è¦ç™»éŒ²ãƒ•ãƒ­ãƒ¼ï¼ˆStripe Checkoutï¼‰
  - subscribed === true â†’ ãƒ—ãƒ©ãƒ³å¤‰æ›´ãƒ•ãƒ­ãƒ¼ï¼ˆSubscription Update APIï¼‰
- [ ] ãƒœã‚¿ãƒ³ã®ãƒ©ãƒ™ãƒ«ã‚’é©åˆ‡ã«å¤‰æ›´
  - æ–°è¦: ã€Œã“ã®ãƒ—ãƒ©ãƒ³ã‚’é¸æŠã€
  - å¤‰æ›´: ã€Œã“ã®ãƒ—ãƒ©ãƒ³ã«å¤‰æ›´ã€

**5-3. è‡ªå‹•ãƒ†ã‚¹ãƒˆä½œæˆ**
- [ ] ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«æ›´æ–°: supabase/functions/create-checkout/index.test.ts
- [ ] ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: æœªç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§Checkout Sessionã‚’ä½œæˆã§ãã‚‹ã‹
- [ ] ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™ã‹
- [ ] React Testing Library ã§Subscriptionãƒšãƒ¼ã‚¸ã®ãƒ†ã‚¹ãƒˆ
- [ ] ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: subscribed = false ã§Checkoutãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‹
- [ ] ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹4: subscribed = true ã§ãƒ—ãƒ©ãƒ³å¤‰æ›´ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‹

**5-4. æ‰‹å‹•ãƒ†ã‚¹ãƒˆ**
- [ ] Testç’°å¢ƒã§æ–°è¦ç™»éŒ²ãƒ•ãƒ­ãƒ¼ã‚’ç¢ºèª
- [ ] æœªç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§/subscriptionãƒšãƒ¼ã‚¸ã‚’é–‹ã
- [ ] ã€Œã“ã®ãƒ—ãƒ©ãƒ³ã‚’é¸æŠã€ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
- [ ] ã‚¯ãƒªãƒƒã‚¯ã§Stripe Checkoutã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
- [ ] æ±ºæ¸ˆå®Œäº†å¾Œã€ãƒ—ãƒ©ãƒ³ãŒç™»éŒ²ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
- [ ] æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§/subscriptionãƒšãƒ¼ã‚¸ã‚’é–‹ã
- [ ] ã€Œã“ã®ãƒ—ãƒ©ãƒ³ã«å¤‰æ›´ã€ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
- [ ] ã‚¯ãƒªãƒƒã‚¯ã§ãƒ—ãƒ©ãƒ³å¤‰æ›´ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

**5-5. æˆåŠŸåŸºæº–ï¼ˆã™ã¹ã¦âœ…ã§å®Œäº†ï¼‰**
- [ ] âœ… è‡ªå‹•ãƒ†ã‚¹ãƒˆãŒå…¨ã¦ãƒ‘ã‚¹
- [ ] âœ… æ–°è¦ç™»éŒ²ãƒ•ãƒ­ãƒ¼ãŒCheckoutã‚’ä½¿ç”¨ã—ã¦æ­£å¸¸å‹•ä½œ
- [ ] âœ… ãƒ—ãƒ©ãƒ³å¤‰æ›´ãƒ•ãƒ­ãƒ¼ãŒSubscription Update APIã‚’ä½¿ç”¨
- [ ] âœ… æœªç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§é©åˆ‡ã«åˆ†å²
- [ ] âœ… UIãŒåˆ†ã‹ã‚Šã‚„ã™ã„ï¼ˆãƒœã‚¿ãƒ³ãƒ©ãƒ™ãƒ«ãŒé©åˆ‡ï¼‰
- [ ] âœ… æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒCheckoutã‚’ä½¿ç”¨ã§ããªã„ï¼ˆã‚¨ãƒ©ãƒ¼ãŒè¿”ã‚‹ï¼‰

---

#### Phase 6: Webhookå‡¦ç†ã®å¼·åŒ–

**6-1. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼ˆéåŒæœŸåŒ–ã¯å¿…é ˆï¼‰**

**é‡è¦**: Stripeã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«å¾“ã„ã€**å¿…ãš200ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å³åº§ã«è¿”ã™**ã“ã¨ã€‚
å‡¦ç†ãŒé…ã„ã¨StripeãŒãƒªãƒˆãƒ©ã‚¤ã—ã¦ã—ã¾ã†ã€‚

- [ ] **éåŒæœŸå‡¦ç†ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®Ÿè£…**ï¼ˆå¿…é ˆï¼‰:
```typescript
Deno.serve(async (req) => {
  try {
    // 1. ç½²åæ¤œè¨¼ï¼ˆã“ã‚Œã ã‘åŒæœŸã§å®Ÿè¡Œï¼‰
    const body = await req.text()
    const signature = req.headers.get('Stripe-Signature')!
    const event = await stripe.webhooks.constructEventAsync(
      body,
      signature,
      webhookSecret,
      undefined,
      cryptoProvider
    )

    // 2. å†ªç­‰æ€§ãƒã‚§ãƒƒã‚¯ï¼ˆé«˜é€Ÿã‚¯ã‚¨ãƒªï¼‰
    const alreadyProcessed = await checkEventProcessed(event.id)
    if (alreadyProcessed) {
      return new Response(JSON.stringify({ received: true }), { status: 200 })
    }

    // 3. ã™ãã«200ã‚’è¿”ã™ï¼ˆã“ã“ã¾ã§1ç§’ä»¥å†…ï¼‰
    const response = new Response(
      JSON.stringify({ received: true }),
      {
        status: 200,
        headers: { 'Content-Type': 'application/json' }
      }
    )

    // 4. é‡ã„å‡¦ç†ã¯éåŒæœŸã§å®Ÿè¡Œï¼ˆPromiseã‚’è¿”ã•ãªã„ï¼‰
    processWebhookAsync(event).catch((error) => {
      console.error('Webhookå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error)
      // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°è¨˜éŒ²
    })

    return response
  } catch (error) {
    // ç½²åæ¤œè¨¼å¤±æ•—ãªã©ã®å³åº§ã«è¿”ã™ã¹ãã‚¨ãƒ©ãƒ¼
    return new Response('Error', { status: 400 })
  }
})

async function processWebhookAsync(event: Stripe.Event) {
  // DBæ›´æ–°ã€Stripe APIå‘¼ã³å‡ºã—ãªã©é‡ã„å‡¦ç†
  // ã“ã®å‡¦ç†æ™‚é–“ã¯3ç§’ä»¥å†…ã‚’ç›®æ¨™ã«ã™ã‚‹
}
```

- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨ˆæ¸¬ã‚³ãƒ¼ãƒ‰ã®è¿½åŠ :
```typescript
const startTime = Date.now()
// ... å‡¦ç† ...
const processingTime = Date.now() - startTime
console.log(`Webhookå‡¦ç†æ™‚é–“: ${processingTime}ms`)
```

- [ ] ç›®æ¨™: 200ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¾ã§ **1ç§’ä»¥å†…**ã€éåŒæœŸå‡¦ç†å®Œäº†ã¾ã§ **3ç§’ä»¥å†…**

**6-2. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–**
- [ ] try-catch ã‚’é©åˆ‡ã«é…ç½®
- [ ] ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã«ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿½åŠ 
  - event.id
  - event.type
  - user_id
  - subscription_id
  - ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  - ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹
- [ ] Supabase Edge Function Logsã«è¨˜éŒ²
- [ ] é‡å¤§ãªã‚¨ãƒ©ãƒ¼ã¯Slacké€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

**6-3. Realtimeé€šçŸ¥å®Ÿè£…**
- [ ] Webhookå‡¦ç†å®Œäº†æ™‚ã€Realtimeã§ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«é€šçŸ¥
- [ ] ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§Realtime subscriptionã‚’å®Ÿè£…
- [ ] DBæ›´æ–°ã‚’æ¤œçŸ¥ã—ã¦UIã‚’å³åº§ã«æ›´æ–°
- [ ] ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã®ç®¡ç†
- [ ] ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ï¼ˆ10ç§’å¾…ã£ã¦ã‚‚æ›´æ–°ãŒãªã„å ´åˆï¼‰

**6-4. è‡ªå‹•ãƒ†ã‚¹ãƒˆä½œæˆ**
- [ ] **ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: 200ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒ1ç§’ä»¥å†…ã«è¿”ã‚‹ã‹**:
```typescript
const start = Date.now()
const response = await fetch(webhookUrl, { ... })
const responseTime = Date.now() - start
assert(responseTime < 1000, '200ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒ1ç§’ä»¥å†…ã«è¿”ã‚‹')
assert(response.status === 200)
```
- [ ] **ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: éåŒæœŸå‡¦ç†ãŒ3ç§’ä»¥å†…ã«å®Œäº†ã™ã‚‹ã‹**:
```typescript
// DBæ›´æ–°ã‚’ç›£è¦–
await waitForDBUpdate(eventId, { timeout: 3000 })
```
- [ ] **ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: éåŒæœŸå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚200ãŒè¿”ã‚‹ã‹**:
```typescript
// ã‚ã–ã¨ã‚¨ãƒ©ãƒ¼ã‚’ç™ºç”Ÿã•ã›ã‚‹
// ãã‚Œã§ã‚‚200ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã‚‹ã“ã¨ã‚’ç¢ºèª
```
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ: ã‚¨ãƒ©ãƒ¼æ™‚ã«é©åˆ‡ãªãƒ­ã‚°ãŒè¨˜éŒ²ã•ã‚Œã‚‹ã‹
- [ ] Realtimeé€šçŸ¥ãƒ†ã‚¹ãƒˆ: DBæ›´æ–°ãŒæ­£ã—ãæ¤œçŸ¥ã•ã‚Œã‚‹ã‹
- [ ] **ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹4: å†ªç­‰æ€§ãƒã‚§ãƒƒã‚¯ãŒ1ç§’ä»¥å†…ã«å®Œäº†ã™ã‚‹ã‹**ï¼ˆé«˜é€Ÿã‚¯ã‚¨ãƒªï¼‰
- [ ] **ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹5: PromiseãŒè¿”ã•ã‚Œã¦ã„ãªã„ã‹**ï¼ˆéåŒæœŸå‡¦ç†ãŒawaitã•ã‚Œã¦ã„ãªã„ã‹ï¼‰

**6-5. æ‰‹å‹•ãƒ†ã‚¹ãƒˆ**
- [ ] Testç’°å¢ƒã§å„ç¨®Webhookã‚’é€ä¿¡
- [ ] Edge Function Logsã§å‡¦ç†æ™‚é–“ã‚’ç¢ºèª â†’ 3ç§’ä»¥å†…
- [ ] ã‚ã–ã¨ã‚¨ãƒ©ãƒ¼ã‚’ç™ºç”Ÿã•ã›ã¦ãƒ­ã‚°ã‚’ç¢ºèª
- [ ] Realtime subscriptionãŒç™ºç«ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
- [ ] ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãŒé…ã„çŠ¶æ³ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆï¼ˆChrome DevToolsï¼‰
  - ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‹
  - ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ãŒå‹•ä½œã™ã‚‹ã‹

**6-6. æˆåŠŸåŸºæº–ï¼ˆã™ã¹ã¦âœ…ã§å®Œäº†ï¼‰**
- [ ] âœ… è‡ªå‹•ãƒ†ã‚¹ãƒˆãŒå…¨ã¦ãƒ‘ã‚¹
- [ ] âœ… **200ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒ1ç§’ä»¥å†…ã«è¿”ã‚‹**ï¼ˆStripeè¦ä»¶ï¼‰
- [ ] âœ… **éåŒæœŸå‡¦ç†ãŒ3ç§’ä»¥å†…ã«å®Œäº†**ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ï¼‰
- [ ] âœ… **éåŒæœŸå‡¦ç†ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒæ­£ã—ãå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹**ï¼ˆPromiseã‚’awaitã—ãªã„ï¼‰
- [ ] âœ… **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®šãƒ­ã‚°ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹**ï¼ˆ`Date.now()`ã§è¨ˆæ¸¬ï¼‰
- [ ] âœ… ã‚¨ãƒ©ãƒ¼æ™‚ã«è©³ç´°ãªãƒ­ã‚°ãŒè¨˜éŒ²ã•ã‚Œã‚‹
- [ ] âœ… Realtime subscriptionãŒæ­£å¸¸ã«ç™ºç«
- [ ] âœ… ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãŒå³åº§ã«æ›´æ–°ã•ã‚Œã‚‹ï¼ˆãƒªãƒ­ãƒ¼ãƒ‰ä¸è¦ï¼‰
- [ ] âœ… ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ãŒæ­£ã—ãå‹•ä½œ
- [ ] âœ… false completionï¼ˆå‡¦ç†å¤±æ•—ã ãŒæˆåŠŸè¡¨ç¤ºï¼‰ãŒç™ºç”Ÿã—ãªã„
- [ ] âœ… å†ªç­‰æ€§ãƒã‚§ãƒƒã‚¯ãŒ1ç§’ä»¥å†…ã«å®Œäº†

---

#### Phase 7: çµ±åˆãƒ†ã‚¹ãƒˆ & ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°

**7-1. Testç’°å¢ƒã§ã®çµ±åˆãƒ†ã‚¹ãƒˆ**
- [ ] æ–°è¦ç™»éŒ²ãƒ•ãƒ­ãƒ¼ï¼ˆã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ã€ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼‰
  - [ ] æœªç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§å„ãƒ—ãƒ©ãƒ³ã«ç™»éŒ²
  - [ ] å³åº§ã«ãƒ—ãƒ©ãƒ³ãŒåæ˜ ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
  - [ ] Webhook 200ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç¢ºèª
  - [ ] DBç¢ºèª â†’ user_subscriptions ãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆ
- [ ] ãƒ—ãƒ©ãƒ³å¤‰æ›´ãƒ•ãƒ­ãƒ¼ï¼ˆã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ï¼‰
  - [ ] ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ â†’ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
  - [ ] ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§å·®é¡é‡‘é¡ç¢ºèª
  - [ ] å³åº§ã«å¤‰æ›´ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
  - [ ] DBç¢ºèª â†’ åŒã˜subscription_idã§æ›´æ–°
  - [ ] Stripe Dashboardç¢ºèª â†’ 1ã¤ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®ã¿
- [ ] ãƒ—ãƒ©ãƒ³å¤‰æ›´ãƒ•ãƒ­ãƒ¼ï¼ˆãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰ï¼‰
  - [ ] ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ â†’ ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰
  - [ ] ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆé¡ç¢ºèª
  - [ ] å³åº§ã«å¤‰æ›´ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
  - [ ] Stripe Dashboardç¢ºèª â†’ ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆç¢ºèª
- [ ] ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ•ãƒ­ãƒ¼
  - [ ] Customer Portalã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«
  - [ ] æœŸé–“çµ‚äº†æ—¥ã¾ã§åˆ©ç”¨å¯èƒ½ç¢ºèª
  - [ ] DBç¢ºèª â†’ is_active = false
- [ ] Edge Case ãƒ†ã‚¹ãƒˆ
  - [ ] ãƒœã‚¿ãƒ³é€£æ‰“ â†’ 1å›ã—ã‹å‡¦ç†ã•ã‚Œãªã„
  - [ ] Webhooké…å»¶ â†’ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†å‹•ä½œ
  - [ ] ãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒƒã‚¯ â†’ ãƒ—ãƒ©ãƒ³å½±éŸ¿ãªã—
  - [ ] æ±ºæ¸ˆå¤±æ•— â†’ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º

**7-2. Liveç’°å¢ƒã§ã®å°è¦æ¨¡ãƒ†ã‚¹ãƒˆ**
- [ ] ãƒ†ã‚¹ãƒˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§æ–°è¦ç™»éŒ²
- [ ] ãƒ—ãƒ©ãƒ³å¤‰æ›´ï¼ˆã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ï¼‰
- [ ] ãƒ—ãƒ©ãƒ³å¤‰æ›´ï¼ˆãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰ï¼‰
- [ ] ã‚­ãƒ£ãƒ³ã‚»ãƒ«
- [ ] Stripe Dashboardã§èª²é‡‘ç¢ºèª â†’ äºŒé‡èª²é‡‘ãªã—

**7-3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ**
- [ ] /subscriptionãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚é–“ â†’ 3ç§’ä»¥å†…
- [ ] Checkout ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ â†’ 2ç§’ä»¥å†…
- [ ] **Webhook 200ãƒ¬ã‚¹ãƒãƒ³ã‚¹ â†’ 1ç§’ä»¥å†…**ï¼ˆStripeè¦ä»¶ï¼‰
- [ ] **Webhook éåŒæœŸå‡¦ç† â†’ 3ç§’ä»¥å†…**ï¼ˆDBæ›´æ–°å®Œäº†ã¾ã§ï¼‰
- [ ] Realtime ç™ºç« â†’ å³åº§ã«ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰æ›´æ–°

**7-4. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°**
- [ ] error-database.md ã‚’æ›´æ–°
  - [ ] ERROR-002ï¼ˆWebhook 401ï¼‰ã‚’è§£æ±ºæ¸ˆã¿ã«ãƒãƒ¼ã‚¯
  - [ ] ERROR-003ï¼ˆäºŒé‡èª²é‡‘ï¼‰ã‚’è§£æ±ºæ¸ˆã¿ã«ãƒãƒ¼ã‚¯
  - [ ] æ–°ã—ã„ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Œã°è¿½åŠ 
- [ ] solutions-log.md ã‚’æ›´æ–°
  - [ ] Webhook 401ä¿®æ­£ã®è§£æ±ºç­–ã‚’è¨˜éŒ²
  - [ ] äºŒé‡èª²é‡‘é˜²æ­¢ã®è§£æ±ºç­–ã‚’è¨˜éŒ²
- [ ] decisions.md ã«å®Ÿè£…æ±ºå®šã‚’è¨˜éŒ²
  - [ ] ãªãœSubscriptions APIã‚’é¸ã‚“ã ã‹
  - [ ] ãªãœCustomer Portalã‚’ä½¿ã£ãŸã‹
  - [ ] ãªãœå³æ™‚åæ˜ ã«ã—ãŸã‹
- [ ] CURRENT-FOCUS.md ã‚’æ›´æ–°
  - [ ] ã‚¿ã‚¹ã‚¯å®Œäº†ã‚’è¨˜éŒ²
  - [ ] å±¥æ­´ã«è¿½åŠ 

**7-5. æˆåŠŸåŸºæº–ï¼ˆã™ã¹ã¦âœ…ã§å®Œäº†ï¼‰**
- [ ] âœ… Testç’°å¢ƒã§ã®å…¨ãƒ•ãƒ­ãƒ¼ãŒæ­£å¸¸å‹•ä½œ
- [ ] âœ… Liveç’°å¢ƒã§ã®å°è¦æ¨¡ãƒ†ã‚¹ãƒˆãŒæˆåŠŸ
- [ ] âœ… ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦ä»¶ã‚’æº€ãŸã™
- [ ] âœ… äºŒé‡èª²é‡‘ãŒç™ºç”Ÿã—ãªã„
- [ ] âœ… Webhook 401ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãªã„
- [ ] âœ… false completionãŒç™ºç”Ÿã—ãªã„
- [ ] âœ… å…¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒæœ€æ–°çŠ¶æ…‹
- [ ] âœ… UXè¦ä»¶ï¼ˆrequirements.mdï¼‰ã‚’100%æº€ãŸã™

---

## âš ï¸ ãƒªã‚¹ã‚¯ã¨å¯¾ç­–

| ãƒªã‚¹ã‚¯ | å½±éŸ¿åº¦ | å¯¾ç­– |
|--------|--------|------|
| Webhook 401ã‚¨ãƒ©ãƒ¼ãŒä¿®æ­£ã§ããªã„ | ğŸ”´ é«˜ | Stripe CLIã§ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆã€‚Stripeã‚µãƒãƒ¼ãƒˆã«å•ã„åˆã‚ã›ã€‚ç½²åæ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯ã®æ®µéšçš„ãƒ‡ãƒãƒƒã‚° |
| Subscriptions APIå®Ÿè£…ã®ä¸å…·åˆ | ğŸ”´ é«˜ | Preview Invoice APIã§äº‹å‰ç¢ºèªã€‚Testç’°å¢ƒã§å¾¹åº•ãƒ†ã‚¹ãƒˆã€‚Stripeå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‚ç…§ |
| ãƒ—ãƒ©ãƒ³å¤‰æ›´æ™‚ã®äºŒé‡èª²é‡‘ | ğŸ”´ é«˜ | å†ªç­‰æ€§ãƒã‚§ãƒƒã‚¯å¿…é ˆã€‚Webhookå‡¦ç†ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³åŒ–ã€‚Testç’°å¢ƒã§è¤‡æ•°å›ãƒ†ã‚¹ãƒˆ |
| false completionï¼ˆå‡¦ç†å¤±æ•—ã ãŒæˆåŠŸè¡¨ç¤ºï¼‰ | ğŸ”´ é«˜ | Webhookå‡¦ç†ã‚’3ç§’ä»¥å†…ã«å®Œäº†ã€‚Realtime or pollingã§DBçŠ¶æ…‹ã‚’ç›£è¦–ã€‚ã‚¨ãƒ©ãƒ¼æ™‚ã®æ˜ç¢ºãªé€šçŸ¥ |
| æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®äºŒé‡ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆæ—¢å­˜ãƒã‚°ï¼‰ | ğŸŸ¡ ä¸­ | ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ä¿®æ­£ã€‚Stripe Dashboardã§æ‰‹å‹•ç¢ºèª |
| Webhookå‡¦ç†ä¸­ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ | ğŸŸ¡ ä¸­ | **1ç§’ä»¥å†…ã«200ãƒ¬ã‚¹ãƒãƒ³ã‚¹**ï¼ˆå¿…é ˆï¼‰ã€‚é‡ã„å‡¦ç†ã¯éåŒæœŸåŒ–ï¼ˆ3ç§’ä»¥å†…ï¼‰ã€‚Stripeã®ãƒªãƒˆãƒ©ã‚¤ã«é ¼ã‚‹ï¼ˆ3æ—¥é–“ï¼‰ |
| Preview Invoice APIã®è¨ˆç®—èª¤å·® | ğŸŸ¡ ä¸­ | Stripeå…¬å¼ã®è¨ˆç®—çµæœã‚’ãã®ã¾ã¾è¡¨ç¤ºã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã€Œå®Ÿéš›ã®è«‹æ±‚é¡ã¯ç¢ºå®šæ™‚ã«æ±ºã¾ã‚Šã¾ã™ã€ã¨æ˜è¨˜ |
| Customer Portalã®æ—¥æœ¬èªåŒ– | ğŸŸ¢ ä½ | Stripe Dashboardã§æ—¥æœ¬èªè¨­å®šã€‚ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯èƒ½ |
| Test/Liveç’°å¢ƒã®æ··åœ¨ | ğŸŸ¢ ä½ | ç’°å¢ƒå¤‰æ•°ã®å‘½åè¦å‰‡ã‚’å³å®ˆã€‚composite uniqueåˆ¶ç´„ã§ä¿è­· |
| Realtime subscriptionãŒç™ºç«ã—ãªã„ | ğŸŸ¢ ä½ | Fallback: Edge Functionã‹ã‚‰ã®ç›´æ¥DBèª­ã¿è¾¼ã¿ï¼ˆæ—¢ã«å®Ÿè£…æ¸ˆã¿ï¼‰ |

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

### æ­£å¸¸ç³»

**ã‚±ãƒ¼ã‚¹1: æ–°è¦ç™»éŒ²ï¼ˆã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ãƒ—ãƒ©ãƒ³ï¼‰**
- **å‰ææ¡ä»¶**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæœªç™»éŒ²
- **å®Ÿè¡Œå†…å®¹**:
  1. /subscriptionãƒšãƒ¼ã‚¸ã§ã€Œã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ãƒ—ãƒ©ãƒ³ã‚’é¸æŠã€ã‚’ã‚¯ãƒªãƒƒã‚¯
  2. Stripe Checkoutã§æ±ºæ¸ˆå®Œäº†
  3. Webhookï¼ˆcheckout.session.completedï¼‰ã‚’å—ä¿¡
- **æœŸå¾…çµæœ**:
  - âœ… 3ç§’ä»¥å†…ã«DBãŒæ›´æ–°ã•ã‚Œã‚‹
  - âœ… Realtime subscriptionãŒç™ºç«ã—ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãŒæ›´æ–°ã•ã‚Œã‚‹
  - âœ… /subscriptionãƒšãƒ¼ã‚¸ã«ã€Œç¾åœ¨ã®ãƒ—ãƒ©ãƒ³: ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ã€ã¨è¡¨ç¤º
  - âœ… subscribed: true

**ã‚±ãƒ¼ã‚¹2: ãƒ—ãƒ©ãƒ³å¤‰æ›´ï¼ˆã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰â†’ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ / ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ï¼‰**
- **å‰ææ¡ä»¶**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ—¢ã«ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ãƒ—ãƒ©ãƒ³ã«ç™»éŒ²æ¸ˆã¿
- **å®Ÿè¡Œå†…å®¹**:
  1. /subscriptionãƒšãƒ¼ã‚¸ã§ã€Œãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ—ãƒ©ãƒ³ã‚’é¸æŠã€ã‚’ã‚¯ãƒªãƒƒã‚¯
  2. ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã€å·®é¡é‡‘é¡ã‚’ç¢ºèª
  3. ã€Œç¢ºå®šã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
  4. Subscriptions APIã§æ—¢å­˜ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
  5. Webhookï¼ˆcustomer.subscription.updatedï¼‰ã‚’å—ä¿¡
- **æœŸå¾…çµæœ**:
  - âœ… ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§æ—¥å‰²ã‚Šè¨ˆç®—ã•ã‚ŒãŸé‡‘é¡ãŒè¡¨ç¤ºã•ã‚Œã‚‹
  - âœ… 3ç§’ä»¥å†…ã«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ—ãƒ©ãƒ³ã®æƒ…å ±ãŒDBã«ä¿å­˜ã•ã‚Œã‚‹
  - âœ… å¤ã„ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ãƒ—ãƒ©ãƒ³ã¯åŒã˜ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³IDã§æ›´æ–°ã•ã‚Œã‚‹
  - âœ… Realtime subscriptionãŒç™ºç«ã—ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãŒæ›´æ–°ã•ã‚Œã‚‹
  - âœ… /subscriptionãƒšãƒ¼ã‚¸ã«ã€Œç¾åœ¨ã®ãƒ—ãƒ©ãƒ³: ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã€ã¨è¡¨ç¤º
  - âœ… Stripe Dashboardã§1ã¤ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®ã¿ã‚¢ã‚¯ãƒ†ã‚£ãƒ–
  - âŒ äºŒé‡èª²é‡‘ã•ã‚Œã¦ã„ãªã„

**ã‚±ãƒ¼ã‚¹3: ãƒ—ãƒ©ãƒ³å¤‰æ›´ï¼ˆãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯â†’ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ / ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰ï¼‰**
- **å‰ææ¡ä»¶**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ—¢ã«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ—ãƒ©ãƒ³ã«ç™»éŒ²æ¸ˆã¿
- **å®Ÿè¡Œå†…å®¹**:
  1. /subscriptionãƒšãƒ¼ã‚¸ã§ã€Œã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ãƒ—ãƒ©ãƒ³ã‚’é¸æŠã€ã‚’ã‚¯ãƒªãƒƒã‚¯
  2. ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã€è¿”é‡‘é¡ï¼ˆã‚¯ãƒ¬ã‚¸ãƒƒãƒˆï¼‰ã‚’ç¢ºèª
  3. ã€Œç¢ºå®šã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
  4. Subscriptions APIã§æ—¢å­˜ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
  5. Webhookï¼ˆcustomer.subscription.updatedï¼‰ã‚’å—ä¿¡
- **æœŸå¾…çµæœ**:
  - âœ… **å³åº§ã«ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ãƒ—ãƒ©ãƒ³ã«å¤‰æ›´ã•ã‚Œã‚‹**ï¼ˆæ–°ä»•æ§˜ï¼‰
  - âœ… æ—¥å‰²ã‚Šè¨ˆç®—ã§è¿”é‡‘é¡ãŒã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã¨ã—ã¦æ¬¡å›è«‹æ±‚ã«é©ç”¨ã•ã‚Œã‚‹
  - âœ… /subscriptionãƒšãƒ¼ã‚¸ã«ã€Œç¾åœ¨ã®ãƒ—ãƒ©ãƒ³: ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ã€ã¨è¡¨ç¤º
  - âœ… Stripe Dashboardã§ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆãŒç¢ºèªã§ãã‚‹

**ã‚±ãƒ¼ã‚¹4: ãƒ—ãƒ©ãƒ³ã‚­ãƒ£ãƒ³ã‚»ãƒ«**
- **å‰ææ¡ä»¶**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ—ãƒ©ãƒ³ã«ç™»éŒ²æ¸ˆã¿
- **å®Ÿè¡Œå†…å®¹**:
  1. /accountãƒšãƒ¼ã‚¸ã§ã€Œãƒ—ãƒ©ãƒ³ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
  2. Stripe Customer Portalã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
  3. Stripeæä¾›ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç¢ºèªç”»é¢ã§ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ã‚’é¸æŠ
  4. Webhookï¼ˆcustomer.subscription.deletedï¼‰ã‚’å—ä¿¡
- **æœŸå¾…çµæœ**:
  - âœ… æœŸé–“çµ‚äº†æ—¥ã¾ã§åˆ©ç”¨å¯èƒ½ã¨è¡¨ç¤ºã•ã‚Œã‚‹
  - âœ… æœŸé–“çµ‚äº†æ—¥ã«ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãŒè‡ªå‹•çš„ã«çµ‚äº†
  - âœ… DBã§is_active = falseã«æ›´æ–°ã•ã‚Œã‚‹

---

### ç•°å¸¸ç³»

**ã‚±ãƒ¼ã‚¹1: Webhookç½²åæ¤œè¨¼å¤±æ•—ï¼ˆä¸æ­£ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰**
- **å‰ææ¡ä»¶**: æ‚ªæ„ã®ã‚ã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒWebhook URLã«é€ä¿¡ã•ã‚Œã‚‹
- **å®Ÿè¡Œå†…å®¹**: Stripeç½²åãªã—ã®POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆ
- **æœŸå¾…çµæœ**:
  - âœ… 401ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™
  - âœ… DBã¯æ›´æ–°ã•ã‚Œãªã„
  - âœ… ãƒ­ã‚°ã«ä¸æ­£ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¨˜éŒ²

**ã‚±ãƒ¼ã‚¹2: Webhookå‡¦ç†ä¸­ã«Stripe APIã‚¨ãƒ©ãƒ¼**
- **å‰ææ¡ä»¶**: Stripeã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã«APIã‚¨ãƒ©ãƒ¼
- **å®Ÿè¡Œå†…å®¹**: å¤ã„ãƒ—ãƒ©ãƒ³ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†ä¸­ã«Stripe APIãŒ503ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™
- **æœŸå¾…çµæœ**:
  - âœ… ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã«è¨˜éŒ²
  - âœ… StripeãŒè‡ªå‹•çš„ã«ãƒªãƒˆãƒ©ã‚¤
  - âœ… ãƒªãƒˆãƒ©ã‚¤æ™‚ã«æˆåŠŸã™ã‚Œã°DBãŒæ›´æ–°ã•ã‚Œã‚‹

**ã‚±ãƒ¼ã‚¹3: Webhookå‡¦ç†ä¸­ã«DBæ¥ç¶šã‚¨ãƒ©ãƒ¼**
- **å‰ææ¡ä»¶**: SupabaseãŒä¸€æ™‚çš„ã«ãƒ€ã‚¦ãƒ³
- **å®Ÿè¡Œå†…å®¹**: DBæ›´æ–°å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼
- **æœŸå¾…çµæœ**:
  - âœ… 500ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™
  - âœ… StripeãŒè‡ªå‹•çš„ã«ãƒªãƒˆãƒ©ã‚¤
  - âœ… ãƒªãƒˆãƒ©ã‚¤æ™‚ã«æˆåŠŸã™ã‚Œã°DBãŒæ›´æ–°ã•ã‚Œã‚‹

---

### ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹

**ã‚±ãƒ¼ã‚¹1: ãƒœã‚¿ãƒ³é€£æ‰“ï¼ˆ2é‡ã‚¯ãƒªãƒƒã‚¯ï¼‰**ï¼ˆedge-cases.md Edge Case 4ï¼‰
- **å‰ææ¡ä»¶**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œã“ã®ãƒ—ãƒ©ãƒ³ã‚’é¸æŠã€ãƒœã‚¿ãƒ³ã‚’é€£æ‰“
- **å®Ÿè¡Œå†…å®¹**: é€£ç¶šã§2å›ã‚¯ãƒªãƒƒã‚¯
- **æœŸå¾…çµæœ**:
  - âœ… 1å›ã—ã‹å‡¦ç†ã•ã‚Œãªã„
  - âœ… ãƒœã‚¿ãƒ³ãŒã™ãã«ç„¡åŠ¹åŒ–ã•ã‚Œã‚‹
  - âœ… ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ãƒ”ãƒŠãƒ¼è¡¨ç¤º
  - âŒ è¤‡æ•°ã®Checkoutã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒä½œæˆã•ã‚Œãªã„

**ã‚±ãƒ¼ã‚¹2: Webhooké…å»¶**ï¼ˆedge-cases.md Edge Case 8ï¼‰
- **å‰ææ¡ä»¶**: WebhookãŒ10ç§’ä»¥ä¸Šé…å»¶
- **å®Ÿè¡Œå†…å®¹**: Stripe Checkoutå®Œäº†å¾Œã€WebhookãŒé…ã‚Œã¦åˆ°ç€
- **æœŸå¾…çµæœ**:
  - âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯ã€Œå‡¦ç†ä¸­...ã€ã¨è¡¨ç¤º
  - âœ… Webhookåˆ°ç€å¾Œã€å³åº§ã«åæ˜ 
  - âœ… ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ãªã„ï¼ˆæœ€å¤§30ç§’å¾…ã¤ï¼‰
  - âŒ ã€Œã‚¨ãƒ©ãƒ¼ã€ã¨è¡¨ç¤ºã—ãªã„

**ã‚±ãƒ¼ã‚¹3: åŒã˜ãƒ—ãƒ©ãƒ³ã‚’å†é¸æŠ**ï¼ˆedge-cases.md Edge Case 12ï¼‰
- **å‰ææ¡ä»¶**: æ—¢ã«Starterãƒ—ãƒ©ãƒ³ãªã®ã«ã€ã‚‚ã†ä¸€åº¦Starterãƒ—ãƒ©ãƒ³ã‚’é¸æŠ
- **å®Ÿè¡Œå†…å®¹**: åŒã˜ãƒ—ãƒ©ãƒ³ã‚’é¸æŠ
- **æœŸå¾…çµæœ**:
  - âœ… ã€Œæ—¢ã«ã“ã®ãƒ—ãƒ©ãƒ³ã«ç™»éŒ²æ¸ˆã¿ã§ã™ã€ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
  - âœ… Checkoutãƒšãƒ¼ã‚¸ã«é€²ã¾ãªã„
  - âŒ 2é‡ç™»éŒ²ã•ã‚Œãªã„

**ã‚±ãƒ¼ã‚¹4: Webhookå†ªç­‰æ€§**ï¼ˆå®Ÿè£…å¿…é ˆï¼‰
- **å‰ææ¡ä»¶**: StripeãŒåŒã˜Webhookã‚¤ãƒ™ãƒ³ãƒˆã‚’2å›é€ä¿¡
- **å®Ÿè¡Œå†…å®¹**: checkout.session.completed ã‚’2å›å—ä¿¡ï¼ˆåŒã˜event_idï¼‰
- **æœŸå¾…çµæœ**:
  - âœ… 1å›ç›®ã¯æ­£å¸¸ã«å‡¦ç†
  - âœ… 2å›ç›®ã¯ã€Œæ—¢ã«å‡¦ç†æ¸ˆã¿ã€ã¨ã—ã¦ç„¡è¦–
  - âŒ 2é‡ã«DBæ›´æ–°ã•ã‚Œãªã„

---

## ğŸ“ å®Ÿè£…ã®è©³ç´°

### ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
å¤‰æ›´ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«:
- supabase/functions/stripe-webhook/index.ts
  - ç½²åæ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯ã®ä¿®æ­£
  - ç’°å¢ƒå¤‰æ•°é¸æŠãƒ­ã‚¸ãƒƒã‚¯ã®ç¢ºèª
  - å†ªç­‰æ€§ãƒã‚§ãƒƒã‚¯ã®è¿½åŠ 
  - customer.subscription.updated ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°è¿½åŠ 

- src/pages/Subscription.tsx
  - æ–°è¦ç™»éŒ² vs ãƒ—ãƒ©ãƒ³å¤‰æ›´ã®åˆ†å²å‡¦ç†
  - ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®è¡¨ç¤º

- src/pages/Account.tsx (ã¾ãŸã¯è©²å½“ã™ã‚‹ãƒšãƒ¼ã‚¸)
  - ã€Œãƒ—ãƒ©ãƒ³ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ãƒœã‚¿ãƒ³è¿½åŠ 

æ–°è¦ä½œæˆã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«:
- supabase/functions/preview-subscription-change/index.ts
  - Preview Invoice APIã‚’ä½¿ã£ãŸé‡‘é¡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼

- supabase/functions/update-subscription/index.ts
  - Subscriptions APIã‚’ä½¿ã£ãŸãƒ—ãƒ©ãƒ³å¤‰æ›´

- supabase/functions/create-portal-session/index.ts
  - Customer Portalã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ

- src/components/subscription/PlanChangeConfirmModal.tsx
  - ãƒ—ãƒ©ãƒ³å¤‰æ›´ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°

- supabase/migrations/YYYYMMDD_add_webhook_events_table.sql
  - Webhookå†ªç­‰æ€§ãƒã‚§ãƒƒã‚¯ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«
```

---

### ä¸»è¦ãªé–¢æ•°ãƒ»ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

**é–¢æ•°å: `Deno.serve()` handler in stripe-webhook/index.ts**
- **ç›®çš„**: Stripe Webhookã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ä¿¡ãƒ»å‡¦ç†
- **å¼•æ•°**: `Request` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
- **æˆ»ã‚Šå€¤**: `Response` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆ200 OK or 401/500ã‚¨ãƒ©ãƒ¼ï¼‰
- **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**:
  - ç½²åæ¤œè¨¼å¤±æ•— â†’ 401
  - DBæ¥ç¶šã‚¨ãƒ©ãƒ¼ â†’ 500ï¼ˆStripeãŒãƒªãƒˆãƒ©ã‚¤ï¼‰
  - Stripe APIã‚¨ãƒ©ãƒ¼ â†’ ãƒ­ã‚°è¨˜éŒ²ã—ã¦continue

**é–¢æ•°å: `stripe.webhooks.constructEvent()`**
- **ç›®çš„**: Webhookç½²åã‚’æ¤œè¨¼ã—ã€ã‚¤ãƒ™ãƒ³ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ§‹ç¯‰
- **å¼•æ•°**:
  - `body` (string) - ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ï¼ˆrawï¼‰
  - `signature` (string) - stripe-signatureãƒ˜ãƒƒãƒ€ãƒ¼
  - `secret` (string) - Webhook Secret
- **æˆ»ã‚Šå€¤**: Stripe.Event ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
- **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**:
  - ç½²åä¸ä¸€è‡´ â†’ throw Error â†’ 401ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™

---

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å¤‰æ›´

**ãƒ†ãƒ¼ãƒ–ãƒ«**: `webhook_events`ï¼ˆæ–°è¦ä½œæˆãƒ»å¿…è¦ã«å¿œã˜ã¦ï¼‰
- **å¤‰æ›´å†…å®¹**: Webhookå†ªç­‰æ€§ãƒã‚§ãƒƒã‚¯ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«
- **ã‚«ãƒ©ãƒ **:
  - `id` UUID PRIMARY KEY
  - `event_id` TEXT UNIQUE NOT NULLï¼ˆStripeã®event.idï¼‰
  - `event_type` TEXT NOT NULL
  - `processed_at` TIMESTAMPTZ NOT NULL DEFAULT NOW()
  - `environment` TEXT NOT NULL CHECK (environment IN ('test', 'live'))
- **ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«**: `supabase/migrations/YYYYMMDD_add_webhook_events_table.sql`
- **ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ–¹æ³•**: `DROP TABLE webhook_events;`

**æ³¨æ„**: æ—¢å­˜ã®äºŒé‡èª²é‡‘é˜²æ­¢ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆuser_subscriptions ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¯ã‚¨ãƒªï¼‰ã§ååˆ†ãªå ´åˆã¯ã€ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ä¸è¦ã‹ã‚‚ã—ã‚Œãªã„ã€‚å®Ÿè£…ä¸­ã«åˆ¤æ–­ã€‚

---

## ğŸ” ç¢ºèªäº‹é …

### å®Ÿè£…å‰ãƒã‚§ãƒƒã‚¯
- [ ] `.claude/docs/subscription/user-experience/` ã®ã™ã¹ã¦ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’èª­ã‚“ã 
- [ ] `.claude/docs/subscription/implementation/specifications/current-status-report-2025-11-29.md` ã‚’èª­ã‚“ã 
- [ ] Stripe Webhook ãƒ­ã‚°ã‚’ç¢ºèªã—ãŸ
- [ ] Edge Function ãƒ­ã‚°ã‚’ç¢ºèªã—ãŸ
- [ ] ç’°å¢ƒå¤‰æ•°ãŒã™ã¹ã¦è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ãŸï¼ˆSupabase Dashboardï¼‰
- [ ] Stripe CLI ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ãŸ
- [ ] ãƒªã‚¹ã‚¯ã‚’è©•ä¾¡ã—ãŸ

### å®Ÿè£…ä¸­ãƒã‚§ãƒƒã‚¯
- [ ] Testç’°å¢ƒã§å‹•ä½œç¢ºèªã—ã¦ã‹ã‚‰Liveç’°å¢ƒã«é©ç”¨
- [ ] ç½²åæ¤œè¨¼ã¯çµ¶å¯¾ã«ç„¡åŠ¹åŒ–ã—ãªã„
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’å¿…ãšå®Ÿè£…
- [ ] ãƒ­ã‚°ã‚’é©åˆ‡ã«å‡ºåŠ›ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
- [ ] ã“ã¾ã‚ã«ãƒ†ã‚¹ãƒˆ

### å®Ÿè£…å¾Œãƒã‚§ãƒƒã‚¯
- [ ] ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ãŒé€šã£ãŸï¼ˆæ­£å¸¸ç³»ãƒ»ç•°å¸¸ç³»ãƒ»ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ï¼‰
- [ ] Testç’°å¢ƒã§äºŒé‡èª²é‡‘ãŒç™ºç”Ÿã—ãªã„ã“ã¨ã‚’ç¢ºèª
- [ ] Liveç’°å¢ƒã§å°è¦æ¨¡ãƒ†ã‚¹ãƒˆ
- [ ] error-database.md ã‚’æ›´æ–°ã—ãŸ
- [ ] troubleshooting/solutions-log.md ã‚’æ›´æ–°ã—ãŸ
- [ ] å®Ÿè£…ã®æ±ºå®šäº‹é …ã‚’ implementation/decisions/decisions.md ã«è¨˜éŒ²ã—ãŸ
- [ ] CURRENT-FOCUS.md ã‚’æ›´æ–°ã—ãŸ

---

## ğŸ“– å‚è€ƒè³‡æ–™

**é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**:
- [ç¾çŠ¶ãƒ¬ãƒãƒ¼ãƒˆ](../specifications/current-status-report-2025-11-29.md)
- [UXè¦ä»¶](../../user-experience/requirements.md)
- [ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼](../../user-experience/flows.md)
- [ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹](../../user-experience/edge-cases.md)
- [æ—¢çŸ¥ã®å•é¡Œ](../../user-experience/issues.md)
- [ç’°å¢ƒå¤‰æ•°å®šç¾©](../../../project-knowledge/environment-variables.md)

**å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹**:
- [Stripe Webhook Documentation](https://stripe.com/docs/webhooks)
- [Stripe Webhook Signature Verification](https://stripe.com/docs/webhooks/signatures)
- [Stripe Subscriptions API](https://stripe.com/docs/api/subscriptions)
- [Stripe Preview Invoice API](https://stripe.com/docs/api/invoices/upcoming)
- [Stripe Customer Portal](https://stripe.com/docs/billing/subscriptions/integrating-customer-portal)
- [Stripe Proration Behavior](https://stripe.com/docs/billing/subscriptions/prorations)
- [Stripe CLI - Listen to webhooks locally](https://stripe.com/docs/stripe-cli/webhooks)
- [Supabase Edge Functions Documentation](https://supabase.com/docs/guides/functions)
- [Supabase Realtime Documentation](https://supabase.com/docs/guides/realtime)

---

## ğŸ“ å®Ÿè£…ãƒ­ã‚°

### 2025-11-29 (åˆå‰)

**ã‚„ã£ãŸã“ã¨**:
- Phase 0: ãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ ç¢ºèªï¼ˆæ—¢å­˜ã® subscription/ ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½¿ç”¨ï¼‰
- Phase 1: ç¾çŠ¶ç²¾æŸ»ï¼ˆcurrent-status-report-2025-11-29.md ä½œæˆå®Œäº†ï¼‰
- Phase 2: å®Ÿè£…è¨ˆç”»ç­–å®šï¼ˆãƒ‰ãƒ©ãƒ•ãƒˆç‰ˆä½œæˆï¼‰

**ç™ºè¦‹ã—ãŸå•é¡Œ**:
- Webhook 401ã‚¨ãƒ©ãƒ¼ã®æ­£ç¢ºãªåŸå› ã¯ã¾ã ä¸æ˜ï¼ˆãƒ­ã‚°ç¢ºèªãŒå¿…è¦ï¼‰

---

### 2025-11-29 (åˆå¾Œ)

**ã‚„ã£ãŸã“ã¨**:
- Takumiã•ã‚“ã«ã‚ˆã‚‹ user-experience/ ã®UXå®šç¾©å®Œäº†
- flows.md, requirements.md ã«ã¦ä»•æ§˜å¤‰æ›´ã‚’ç¢ºèª:
  - ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰: æ¬¡å›æ›´æ–°æ™‚ â†’ **å³æ™‚åæ˜ **ã«å¤‰æ›´
  - ç¢ºèªãƒšãƒ¼ã‚¸è¦ä»¶ã®è¿½åŠ 
  - ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ•ãƒ­ãƒ¼ã®æ˜ç¢ºåŒ–ï¼ˆStripe Customer Portalä½¿ç”¨ï¼‰
- Stripe APIæŠ€è¡“èª¿æŸ»ï¼ˆWebæ¤œç´¢ï¼‰:
  - âœ… ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰å³æ™‚åæ˜ ãŒå¯èƒ½ï¼ˆproration_behavior: 'always_invoice'ï¼‰
  - âš ï¸ Stripe Checkoutã¯æ—¢å­˜ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³å¤‰æ›´ã«ä½¿ãˆãªã„ï¼ˆé‡å¤§ãªè¨­è¨ˆå•é¡Œï¼‰
  - âœ… Preview Invoice APIã§é‡‘é¡ç¢ºèªãŒå¯èƒ½
  - âœ… Webhook ã¯3æ—¥é–“è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤
- å®Ÿè£…è¨ˆç”»ã®æœ€çµ‚åŒ–ï¼ˆã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å…¨é¢æ›´æ–°ï¼‰:
  - Subscriptions API + Preview Invoice APIã‚’ä½¿ç”¨ã—ãŸãƒ—ãƒ©ãƒ³å¤‰æ›´ãƒ•ãƒ­ãƒ¼
  - Stripe Customer Portalã‚’ä½¿ç”¨ã—ãŸã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ•ãƒ­ãƒ¼
  - Webhookå†ªç­‰æ€§ãƒã‚§ãƒƒã‚¯ã®è¿½åŠ 
  - 7ã¤ã®Phaseã«å®Ÿè£…ã‚¹ãƒ†ãƒƒãƒ—ã‚’å†æ§‹æˆ

**é‡è¦ãªç™ºè¦‹**:
- **ç¾åœ¨ã®å®Ÿè£…ã®æ ¹æœ¬çš„ãªå•é¡Œ**: Stripe Checkoutã‚’æ—¢å­˜ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³å¤‰æ›´ã«ä½¿ç”¨ã—ã¦ã„ã‚‹
  - Checkoutã¯æ–°è¦ä½œæˆå°‚ç”¨ â†’ æ–°ã—ã„ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãŒä½œæˆã•ã‚Œã‚‹ â†’ äºŒé‡èª²é‡‘
  - æ­£ã—ãã¯ Subscriptions API ã‚’ä½¿ç”¨ã—ã¦æ—¢å­˜ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°ã™ã‚‹

**å®Ÿè£…æ–¹é‡ã®æ±ºå®š**:
- Takumiã•ã‚“ã®è¦æœ›ã€Œ1ç•ªç°¡å˜ã«å®Ÿè£…ãŒã§ãã‚‹ã‹ã¤ãƒã‚°ãŒå°‘ãªã„æ–¹æ³•ã€ã«åŸºã¥ã:
  1. Stripeæ¨™æº–æ©Ÿèƒ½ã‚’æœ€å¤§é™æ´»ç”¨ï¼ˆSubscriptions API, Preview Invoice, Customer Portalï¼‰
  2. ã‚«ã‚¹ã‚¿ãƒ UIã¯æœ€å°é™ï¼ˆç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®ã¿ï¼‰
  3. Webhookè‡ªå‹•ãƒªãƒˆãƒ©ã‚¤ã«é ¼ã‚‹ï¼ˆ3æ—¥é–“ï¼‰
  4. å†ªç­‰æ€§ãƒã‚§ãƒƒã‚¯ã§äºŒé‡å‡¦ç†é˜²æ­¢

**æ¬¡å›ã‚„ã‚‹ã“ã¨**:
- Phase 4: å®Ÿè£…é–‹å§‹
  - Phase 1: Webhook 401ã‚¨ãƒ©ãƒ¼ä¿®æ­£ï¼ˆæœ€å„ªå…ˆï¼‰
  - Phase 2: Webhookå†ªç­‰æ€§ãƒã‚§ãƒƒã‚¯è¿½åŠ 
  - Phase 3: ãƒ—ãƒ©ãƒ³å¤‰æ›´ãƒ•ãƒ­ãƒ¼å®Ÿè£…ï¼ˆSubscriptions APIï¼‰
  - Phase 4: ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ•ãƒ­ãƒ¼å®Ÿè£…ï¼ˆCustomer Portalï¼‰
  - Phase 5: æ–°è¦ç™»éŒ²ãƒ•ãƒ­ãƒ¼ç¶­æŒ
  - Phase 6: Webhookå‡¦ç†ã®å¼·åŒ–
  - Phase 7: ãƒ†ã‚¹ãƒˆ & ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°

---

## âœ… å®Œäº†å ±å‘Š

**å®Ÿè£…å®Œäº†æ—¥**: (æœªå®Œäº†)

**æœ€çµ‚çš„ãªæˆæœç‰©**:
- (å®Ÿè£…å¾Œã«è¨˜å…¥)

**æ®‹èª²é¡Œ**:
- (å®Ÿè£…å¾Œã«è¨˜å…¥)

**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—**:
- (å®Ÿè£…å¾Œã«è¨˜å…¥)

---

**ã“ã®è¨ˆç”»ã«å¾“ã£ã¦ã€æ®µéšçš„ã«å®Ÿè£…ã‚’é€²ã‚ã¾ã™ã€‚**
**UXè¦ä»¶ã‚’100%æº€ãŸã™ã“ã¨ã‚’æœ€å„ªå…ˆã¨ã—ã¾ã™ã€‚**
