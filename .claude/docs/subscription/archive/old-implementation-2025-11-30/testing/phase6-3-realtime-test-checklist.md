# Phase 6-3: Realtime通知実装 テストチェックリスト

**テスト実施日**: YYYY-MM-DD
**テスト実施者**: Takumi
**実装バージョン**: Phase 6-3完了版

---

## 📋 テスト前の準備

### 必須条件

- [ ] ローカル開発サーバーが起動中 (`npm run dev`)
- [ ] Supabase プロジェクトが起動中
- [ ] Stripe Test Mode APIキーが設定済み
- [ ] テスト用アカウントでログイン済み
- [ ] テスト用アカウントに既存のサブスクリプションがある

### 環境確認

```bash
# 開発サーバー起動確認
npm run dev

# Supabase プロジェクト確認
npx supabase status
```

**確認項目**:
- [ ] `http://localhost:8080` でアクセス可能
- [ ] Supabase Edge Functions がデプロイ済み

---

## 🧪 Test 1: 正常系 - プラン変更のRealtime通知

**目的**: プラン変更時にRealtime通知が正しく動作し、ページリロードなしで即座に反映されるか確認

### 手順

1. **初期状態の確認**
   - [ ] `/subscription` ページを開く
   - [ ] 現在のプラン名をメモ: `__________________`
   - [ ] ブラウザのコンソールを開く（DevTools > Console）

2. **プラン変更の実行**
   - [ ] 期間タブを選択（1ヶ月 or 3ヶ月）
   - [ ] 他のプランの「プラン変更」ボタンをクリック
   - [ ] 確認モーダルが表示される
   - [ ] 日割り計算金額を確認: `__________________`
   - [ ] 「確定」ボタンをクリック

3. **Realtime通知の確認**
   - [ ] トースト表示: 「プラン変更を受け付けました」
   - [ ] トースト表示: 「変更を処理中です。しばらくお待ちください...」
   - [ ] ローディングアニメーション表示中

4. **タイマーで処理時間を測定**
   - **開始時刻**: `__:__:__`
   - コンソールで以下のログを確認:
     ```
     プラン変更を確定します {...}
     ```

5. **Realtime検知の確認**
   - コンソールで以下のログを確認:
     ```
     ✅ プラン変更をRealtime検知: {...}
     ```
   - **検知時刻**: `__:__:__`
   - **所要時間**: `____秒` ← 3秒より速いか？
   - [ ] トースト表示: 「プラン変更が完了しました」
   - [ ] トースト表示: 「新しいプランが適用されました。」
   - [ ] ローディングが終了

6. **UI更新の確認**
   - [ ] **ページリロードは発生していないか？** ← 重要！
   - [ ] プラン名が即座に変更された
   - [ ] 新しいプラン名: `__________________`
   - [ ] 「現在のプラン」バッジが新しいプランに移動

7. **DB確認**
   ```sql
   -- Supabase SQL Editorで実行
   SELECT * FROM user_subscriptions
   WHERE user_id = 'YOUR_USER_ID'
   ORDER BY updated_at DESC
   LIMIT 1;
   ```
   - [ ] `plan_type` が新しいプランになっている
   - [ ] `duration` が選択した期間になっている
   - [ ] `updated_at` が更新されている

### 成功基準

- ✅ 3秒以内にRealtime通知を検知
- ✅ ページリロードなしでUIが更新
- ✅ 成功トーストメッセージが表示
- ✅ DBが正しく更新されている

### 結果

**結果**: [ ] 成功 / [ ] 失敗

**所要時間**: `____秒`

**メモ**:
```
（問題があれば記載）
```

---

## 🧪 Test 2: タイミングテスト - 即座の反映確認

**目的**: 従来の固定3秒待機と比較して、Realtime通知が高速に動作するか確認

### 手順

1. **別のプランに変更**
   - [ ] Test 1と同じ手順でプラン変更を実行

2. **タイムスタンプの記録**
   - ブラウザコンソールでタイムスタンプを確認:
     ```
     プラン変更を確定します {...}        ← 開始時刻: __:__:__
     ✅ プラン変更をRealtime検知: {...}  ← 検知時刻: __:__:__
     ```

3. **処理時間の計算**
   - **所要時間**: `____秒`
   - [ ] 3秒未満で完了したか？
   - [ ] Webhookが1-2秒で完了した場合、即座に反映されたか？

### 成功基準

- ✅ Webhookが早く完了すれば、それに応じて早く反映される
- ✅ 固定3秒待機ではなく、実際のWebhook完了時間に依存

### 結果

**結果**: [ ] 成功 / [ ] 失敗

**所要時間**: `____秒`

**メモ**:
```
（従来の3秒固定と比較してどうだったか）
```

---

## 🧪 Test 3: エラー系 - タイムアウトテスト

**目的**: Webhookが10秒以内に完了しない場合、適切なエラーメッセージが表示されるか確認

### ⚠️ 注意

このテストは実際にWebhookを停止させる必要があるため、**本番環境では実施しないでください**。

### 手順（オプション - 上級者向け）

**方法1: Edge Functionを一時的に無効化**

```bash
# Edge Functionをローカルで停止
# (Supabase CLIで実行中の場合)
# Ctrl+C で停止
```

1. **Edge Functionを停止**
   - [ ] Supabase Edge Functionを一時停止

2. **プラン変更を実行**
   - [ ] `/subscription` ページで「プラン変更」を実行
   - [ ] 「確定」ボタンをクリック

3. **10秒待機**
   - **開始時刻**: `__:__:__`
   - [ ] ローディングが継続中

4. **タイムアウト検知**
   - **タイムアウト時刻**: `__:__:__`
   - コンソールで確認:
     ```
     ⚠️ プラン変更のタイムアウト（10秒経過）
     ```
   - [ ] トースト表示: 「処理に時間がかかっています」
   - [ ] トースト表示: 「プラン変更の処理が完了していない可能性があります。ページを更新してご確認ください。」
   - [ ] ローディングが終了

5. **Edge Functionを再起動**
   ```bash
   npx supabase functions serve
   ```

### 成功基準

- ✅ 10秒経過後にタイムアウトエラーが表示
- ✅ 適切なエラーメッセージが表示
- ✅ ローディングが正しく終了

### 結果

**結果**: [ ] 成功 / [ ] 失敗 / [ ] スキップ

**メモ**:
```
（テスト実施できない場合はスキップして構いません）
```

---

## 🧪 Test 4: UX確認 - ページリロードの不発生

**目的**: プラン変更時にページ全体のリロードが発生せず、スムーズなUXになっているか確認

### 手順

1. **ページにマーカーを追加**
   - [ ] ブラウザコンソールを開く
   - [ ] 以下を実行してページにマーカーを追加:
     ```javascript
     // ページの右上にマーカーを表示
     const marker = document.createElement('div');
     marker.textContent = 'TEST MARKER';
     marker.style.cssText = 'position:fixed;top:10px;right:10px;background:red;color:white;padding:10px;z-index:9999;';
     document.body.appendChild(marker);
     ```
   - [ ] 画面右上に赤いマーカー「TEST MARKER」が表示される

2. **プラン変更を実行**
   - [ ] `/subscription` ページで「プラン変更」を実行
   - [ ] 「確定」ボタンをクリック

3. **マーカーの確認**
   - Realtime通知が来るまで待つ
   - [ ] **マーカーが消えずに残っているか？** ← 重要！

4. **判定**
   - マーカーが残っている → ページリロードなし ✅
   - マーカーが消えた → ページリロード発生 ❌

### 成功基準

- ✅ マーカーが消えずに残っている（ページリロードなし）
- ✅ UIがスムーズに更新される

### 結果

**結果**: [ ] 成功（マーカー残存） / [ ] 失敗（マーカー消失）

**メモ**:
```
```

---

## 🧪 Test 5: 複数回のプラン変更

**目的**: 連続してプラン変更を実行しても、Realtime subscriptionが正しくクリーンアップされ、メモリリークが発生しないか確認

### 手順

1. **1回目のプラン変更**
   - [ ] Standard 1ヶ月 → Feedback 1ヶ月
   - [ ] Realtime通知を確認
   - [ ] プラン変更完了

2. **2回目のプラン変更**
   - [ ] Feedback 1ヶ月 → Feedback 3ヶ月
   - [ ] Realtime通知を確認
   - [ ] プラン変更完了

3. **3回目のプラン変更**
   - [ ] Feedback 3ヶ月 → Standard 3ヶ月
   - [ ] Realtime通知を確認
   - [ ] プラン変更完了

4. **コンソールでチャンネル確認**
   ```javascript
   // Supabase Realtimeのチャンネル数を確認
   console.log('Active channels:', supabase.getChannels());
   ```
   - [ ] 古いチャンネルが残っていないか確認
   - [ ] `plan_change_detection` チャンネルが重複していないか確認

### 成功基準

- ✅ 3回とも正常にプラン変更完了
- ✅ 古いチャンネルが残っていない（クリーンアップ成功）

### 結果

**結果**: [ ] 成功 / [ ] 失敗

**メモ**:
```
```

---

## 🧪 Test 6: 既存のuseSubscription hookとの連携

**目的**: 個別のRealtime subscription（`plan_change_detection`）と既存の`useSubscription` hookのRealtime subscriptionが競合せず、両方とも正しく動作するか確認

### 手順

1. **プラン変更前の状態確認**
   - [ ] ブラウザコンソールを開く
   - [ ] 以下のログを確認:
     ```
     Realtime Subscriptionを設定: { userId: "..." }
     Realtime Subscription status: SUBSCRIBED
     ```
   - [ ] `useSubscription` hookのRealtime subscriptionが動作中

2. **プラン変更の実行**
   - [ ] 「プラン変更」を実行
   - [ ] 以下の2つのログが両方とも出力されるか確認:
     ```
     ✅ プラン変更をRealtime検知: {...}          ← plan_change_detection
     サブスクリプション更新を検知: {...}           ← useSubscription hook
     ```

3. **UI更新の確認**
   - [ ] プラン名が即座に更新
   - [ ] 「現在のプラン」バッジが移動
   - [ ] すべてのUI要素が正しく更新

### 成功基準

- ✅ 両方のRealtime subscriptionが正常動作
- ✅ UIが2回更新されても問題なし

### 結果

**結果**: [ ] 成功 / [ ] 失敗

**メモ**:
```
```

---

## 📊 テスト結果サマリー

| テスト項目 | 結果 | 所要時間 | 備考 |
|-----------|------|---------|------|
| Test 1: 正常系 - プラン変更 | [ ] 成功 / [ ] 失敗 | ____秒 | |
| Test 2: タイミングテスト | [ ] 成功 / [ ] 失敗 | ____秒 | |
| Test 3: タイムアウトテスト | [ ] 成功 / [ ] 失敗 / [ ] スキップ | ____秒 | |
| Test 4: ページリロード不発生 | [ ] 成功 / [ ] 失敗 | - | |
| Test 5: 複数回のプラン変更 | [ ] 成功 / [ ] 失敗 | - | |
| Test 6: useSubscription連携 | [ ] 成功 / [ ] 失敗 | - | |

---

## ✅ 総合判定

**Phase 6-3 実装テスト**: [ ] 合格 / [ ] 不合格

### 合格基準

- Test 1（正常系）: 必須
- Test 2（タイミング）: 必須
- Test 4（ページリロード不発生）: 必須
- Test 5（複数回プラン変更）: 推奨
- Test 6（useSubscription連携）: 推奨
- Test 3（タイムアウト）: オプション

**最低限の合格条件**: Test 1, 2, 4がすべて成功

---

## 🐛 発見した問題

**問題1**:
- **現象**:
- **再現手順**:
- **期待動作**:
- **対処方法**:

**問題2**:
- **現象**:
- **再現手順**:
- **期待動作**:
- **対処方法**:

---

## 📝 テスト完了後のチェックリスト

- [ ] すべてのテスト結果を記録した
- [ ] 発見した問題をドキュメント化した
- [ ] 重大な問題があれば修正が必要
- [ ] 軽微な問題は Issue として記録
- [ ] テスト結果を実装ログに転記

---

## 🔄 次のステップ

**テスト合格の場合**:
1. Phase 6完了を宣言
2. Phase 7（統合テスト）へ進む

**テスト不合格の場合**:
1. 問題を修正
2. 再テスト実施

---

**テスト実施日**: YYYY-MM-DD
**完了時刻**: __:__
**所要時間**: ____分
