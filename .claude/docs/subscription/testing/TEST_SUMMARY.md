# テストサマリー - 2025-11-27更新

## 📊 全体状況

### ✅ 完了済みテスト
なし（Option 3実装直後）

### 🔄 実施予定テスト（Option 3実装後）
- Test 3A-R: スタンダード1ヶ月→3ヶ月（再テスト）
- Test 3B-R: スタンダード3ヶ月→1ヶ月（再テスト）

### ⏸️ 未実施テスト（従来のテストケース）
- Test 1: 新規登録
- Test 2A: フィードバック→スタンダード（ダウングレード）
- Test 2B: スタンダード→フィードバック（アップグレード）
- Test 3A: 期間変更 1ヶ月→3ヶ月（延長）
- Test 3B: 期間変更 3ヶ月→1ヶ月（短縮）
- Test 4: キャンセル
- Test 5: 二重課金防止

---

## 📋 テスト一覧（詳細）

### Test 1: ログイン済みユーザーの新規登録

**目的**: 新規ユーザーがサブスクリプションに登録できることを確認

**前提条件**:
- 認証済みユーザー
- サブスクリプションなし

**手順**:
1. `/subscription` ページにアクセス
2. プラン選択（例: スタンダード1ヶ月）
3. Stripe Checkout画面で支払い
4. `/subscription/success` にリダイレクト
5. サブスクリプション有効化を確認

**検証項目**:
- [ ] Checkoutセッション作成成功
- [ ] 支払い完了
- [ ] DBに新規サブスクレコード作成
- [ ] `is_active=true`
- [ ] アクセス権限が正しい

**期待結果**: 新規サブスクリプション作成成功

**ドキュメント**: `user-flow-test.md` Line 30-148

---

### Test 2A: プラン変更 - ダウングレード（Feedback → Standard）

**目的**: プラン変更（高→低）でプロレーションが正しく計算されることを確認

**前提条件**:
- アクティブなフィードバックプラン（1ヶ月）

**手順**:
1. `/subscription` でスタンダード1ヶ月を選択
2. **Option 3**: Stripe Checkout画面に遷移
3. プロレーション確認:
   ```
   スタンダードプラン (1ヶ月): ¥4,980
   フィードバックプラン (1ヶ月)のクレジット: -¥1,480
   今回のお支払い: ¥3,500
   ```
4. 支払い完了
5. `/subscription?updated=true` にリダイレクト

**検証項目**:
- [ ] Stripeに**1つだけ**アクティブなサブスク（スタンダード）
- [ ] 旧サブスク（フィードバック）がキャンセル済み
- [ ] プロレーション金額が正しい
- [ ] DB: `plan_type='standard'`

**期待結果**: ダウングレード成功、二重課金なし

**ドキュメント**: `user-flow-test.md` Line 150-386

---

### Test 2B: プラン変更 - アップグレード（Standard → Feedback）

**目的**: プラン変更（低→高）でプロレーションが正しく計算されることを確認

**前提条件**:
- アクティブなスタンダードプラン（1ヶ月）

**手順**:
1. `/subscription` でフィードバック1ヶ月を選択
2. **Option 3**: Stripe Checkout画面に遷移
3. プロレーション確認
4. 支払い完了

**検証項目**:
- [ ] Stripeに**1つだけ**アクティブなサブスク（フィードバック）
- [ ] 旧サブスク（スタンダード）がキャンセル済み
- [ ] DB: `plan_type='feedback'`

**期待結果**: アップグレード成功、二重課金なし

**ドキュメント**: `user-flow-test.md` Line 388-602

---

### Test 3A: 期間変更 - 延長（1ヶ月 → 3ヶ月）

**目的**: 同じプラン内で期間変更（短→長）が正しく動作することを確認

**前提条件**:
- アクティブなスタンダード1ヶ月プラン

**手順**:
1. `/subscription` で期間タブ「3ヶ月」を選択
2. スタンダードプランの「このプランに変更する」ボタンをクリック
3. **Option 3**: Stripe Checkout画面に遷移
4. プロレーション確認:
   ```
   スタンダードプラン (3ヶ月): ¥11,940
   スタンダードプラン (1ヶ月)のクレジット: -¥4,958
   今回のお支払い: ¥6,982
   ```
5. 支払い完了
6. `/subscription?updated=true` にリダイレクト
7. 「プランを変更しました」トースト表示

**検証項目**:
- [ ] Console log: 「既存契約者: Stripe Checkoutでプラン変更します」
- [ ] Checkout画面が表示される（Portal画面ではない）
- [ ] プロレーション金額が正しい
- [ ] Stripe Dashboardで**アクティブなサブスクが1つだけ**
- [ ] 旧サブスク（1ヶ月）がキャンセル済み
- [ ] DB: `plan_type='standard'`, `duration=3`, `is_active=true`

**期待結果**: 期間延長成功、**二重課金なし**

**ドキュメント**: `user-flow-test.md` Line 604-738

---

### Test 3A-R: 期間変更 - 延長（Option 3再テスト）⭐ **次に実施**

**目的**: **Deep Link問題が解決され、二重課金が発生しないことを確認**

**前提条件**:
- ✅ Option 3実装完了
- アクティブなスタンダード1ヶ月プラン

**手順**: Test 3Aと同じ

**重要な違い**:
- ❌ **旧実装**: Deep Link → Customer Portal → 二重課金リスク
- ✅ **新実装**: Stripe Checkout → 既存サブスク自動キャンセル → 安全

**検証項目**: Test 3Aと同じ + 以下を追加確認:
- [ ] **Stripeに2つのアクティブなサブスクが絶対に存在しない**
- [ ] プロレーション計算にグロースプランが混入しない

**期待結果**: **Error Case 2が再発しない**

**ドキュメント**: `plan-change-option3-implementation.md` (Test 3A-R)

---

### Test 3B: 期間変更 - 短縮（3ヶ月 → 1ヶ月）

**目的**: 同じプラン内で期間変更（長→短）が正しく動作することを確認

**前提条件**:
- アクティブなスタンダード3ヶ月プラン

**手順**:
1. `/subscription` で期間タブ「1ヶ月」を選択
2. スタンダードプランの「このプランに変更する」ボタンをクリック
3. **Option 3**: Stripe Checkout画面に遷移
4. プロレーション確認:
   ```
   スタンダードプラン (1ヶ月): ¥4,980
   スタンダードプラン (3ヶ月)のクレジット: -¥11,940
   今回のお支払い: ¥0 (クレジット残高: ¥6,960)
   ```
5. 支払い完了（即座に完了、カード不要）

**検証項目**:
- [ ] Stripeに**1つだけ**アクティブなサブスク（1ヶ月）
- [ ] クレジット残高が正しく計算されている
- [ ] DB: `duration=1`

**期待結果**: 期間短縮成功、二重課金なし

**ドキュメント**: `user-flow-test.md` Line 740-865

---

### Test 3B-R: 期間変更 - 短縮（Option 3再テスト）⭐ **次に実施**

**目的**: ダウングレード時のプロレーション計算とクレジット残高を確認

**前提条件**:
- Test 3A-R完了
- アクティブなスタンダード3ヶ月プラン

**手順**: Test 3Bと同じ

**検証項目**: Test 3Bと同じ

**期待結果**: 期間短縮成功、二重課金なし

**ドキュメント**: `plan-change-option3-implementation.md` (Test 3B-R)

---

### Test 4: キャンセル

**目的**: サブスクリプションのキャンセルが正しく動作することを確認

**前提条件**:
- アクティブなサブスクリプション

**手順**:
1. アカウントページから「キャンセル」ボタンをクリック
2. Customer Portal画面に遷移
3. キャンセル確認
4. キャンセル完了

**検証項目**:
- [ ] Stripe: `cancel_at_period_end=true`
- [ ] DB: `cancel_at_period_end=true`
- [ ] 期間終了まではアクセス可能
- [ ] 期間終了後にアクセス不可

**期待結果**: キャンセル成功、期間終了まで利用可能

**ドキュメント**: `user-flow-test.md` Line 867-1035

---

### Test 5: 二重課金防止

**目的**: 同時に複数のプラン変更を実行しても二重課金が発生しないことを確認

**前提条件**:
- アクティブなスタンダード1ヶ月プラン

**手順**:
1. ブラウザタブ1: スタンダード3ヶ月に変更（Checkout画面表示）
2. ブラウザタブ2: フィードバック1ヶ月に変更（Checkout画面表示）
3. タブ1で支払い完了
4. タブ2で支払い完了

**検証項目**:
- [ ] Stripeに**1つだけ**アクティブなサブスク（フィードバック1ヶ月）
- [ ] スタンダード3ヶ月サブスクがキャンセル済み
- [ ] 最後に支払ったプランが有効

**期待結果**: 二重課金なし、最後のプランのみ有効

**ドキュメント**: `user-flow-test.md` Line 1037-1123

---

## 🎯 推奨テスト順序

### Phase 1: Option 3実装の検証（最優先）⭐
1. **Test 3A-R**: スタンダード1ヶ月→3ヶ月（Deep Link問題解決確認）
2. **Test 3B-R**: スタンダード3ヶ月→1ヶ月（ダウングレード確認）

**目的**: Error Case 2が再発しないことを確認

---

### Phase 2: 基本機能の確認（推奨）
3. **Test 1**: 新規登録（基礎機能）
4. **Test 2A**: フィードバック→スタンダード（ダウングレード）
5. **Test 2B**: スタンダード→フィードバック（アップグレード）
6. **Test 4**: キャンセル

**目的**: Option 3実装が基本機能に影響しないことを確認

---

### Phase 3: エッジケース（時間があれば）
7. **Test 5**: 二重課金防止（同時操作）

**目的**: 極端なケースでも安全性を確認

---

## 🐛 既知の問題

### Error Case 1: 環境変数 `useTestPrice` 未定義エラー
**ステータス**: ✅ 解決済み（2025-11-27）
**詳細**: `user-flow-test.md` Line 1173-1270

### Error Case 2: Deep Link使用時の二重課金問題
**ステータス**: 🔧 修正完了（Option 3実装）→ テスト待ち
**詳細**: `user-flow-test.md` Line 1272-1411

---

## 📚 関連ドキュメント

### メインドキュメント
- **user-flow-test.md**: 全テストケースの詳細（43,254 bytes）
- **plan-change-option3-implementation.md**: Option 3実装計画とテスト計画

### 補助ドキュメント
- **comprehensive-test-plan.md**: 包括的なテスト計画
- **plan-type-reproduction-test.md**: プランタイプ検出問題の再現テスト
- **testing-log.md**: テスト実施ログ

---

## ✅ 次のアクション

1. **Test 3A-R実施**: スタンダード1ヶ月→3ヶ月（Option 3）
   - 目的: Deep Link二重課金問題が解決されたことを確認
   - 成功条件: Stripeに1つだけアクティブなサブスク

2. **Test 3B-R実施**: スタンダード3ヶ月→1ヶ月（Option 3）
   - 目的: ダウングレード時のプロレーション確認
   - 成功条件: クレジット残高が正しく計算される

3. **Error Case 2を「解決済み」に更新**
   - テスト成功後、user-flow-test.mdを更新

4. **他のテストケース実施検討**
   - Test 1, 2A, 2B, 4を優先的に実施

---

**最終更新**: 2025-11-27
**作成者**: Claude Code
**Option 3実装**: ✅ 完了
**デプロイ**: ✅ 完了
**テスト準備**: ✅ 完了
