# ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤ºãƒã‚° èª¿æŸ»ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

**ä½œæˆæ—¥**: 2025-12-11
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: èª¿æŸ»ä¸­

---

## å•é¡Œã®æ¦‚è¦

**ç—‡çŠ¶**: è¨˜äº‹è©³ç´°ãƒšãƒ¼ã‚¸(`/articles/{slug}`)ã§ã€å·¦ã‚µã‚¤ãƒ‰ãƒŠãƒ“ã«ãƒ¬ãƒƒã‚¹ãƒ³ãƒ»ã‚¯ã‚¨ã‚¹ãƒˆãƒ»è¨˜äº‹ãŒè¡¨ç¤ºã•ã‚Œãªã„

**æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œ**:
```
[å·¦ã‚µã‚¤ãƒ‰ãƒŠãƒ“]
â”œâ”€â”€ ãƒ­ã‚´
â”œâ”€â”€ â† ãƒ¬ãƒƒã‚¹ãƒ³ã«æˆ»ã‚‹
â”œâ”€â”€ ãƒ¬ãƒƒã‚¹ãƒ³ã‚«ãƒ¼ãƒ‰ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã€ã‚µãƒ ãƒã€é€²æ—%ï¼‰
â””â”€â”€ ã‚¯ã‚¨ã‚¹ãƒˆãƒªã‚¹ãƒˆ
    â”œâ”€â”€ ã‚¯ã‚¨ã‚¹ãƒˆ1: ã‚¿ã‚¤ãƒˆãƒ«
    â”‚   â”œâ”€â”€ âœ… è¨˜äº‹1 (å®Œäº†)
    â”‚   â”œâ”€â”€ â†’ è¨˜äº‹2 (ç¾åœ¨)
    â”‚   â””â”€â”€ ğŸ”’ è¨˜äº‹3 (ãƒ—ãƒ¬ãƒŸã‚¢ãƒ )
    â””â”€â”€ ã‚¯ã‚¨ã‚¹ãƒˆ2: ã‚¿ã‚¤ãƒˆãƒ«
        â””â”€â”€ ...
```

---

## ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

```
1. ArticleDetail.tsx
   â”‚
   â””â”€ getArticleWithContext(slug) ã‚’å‘¼ã³å‡ºã—
      â”‚
      â”œâ”€ Sanity Query å®Ÿè¡Œ
      â”‚   â”œâ”€ article ã®åŸºæœ¬æƒ…å ±ã‚’å–å¾—
      â”‚   â”œâ”€ questInfo: ã“ã®è¨˜äº‹ã‚’å‚ç…§ã—ã¦ã„ã‚‹Questã‚’å–å¾—
      â”‚   â”‚   â””â”€ lessonInfo: Quest.lesson ã‹ã‚‰ Lesson ã‚’å–å¾—
      â”‚   â”‚       â””â”€ quests[]: Lesson ã®å…¨ã‚¯ã‚¨ã‚¹ãƒˆ
      â”‚   â”‚           â””â”€ articles[]: å„ã‚¯ã‚¨ã‚¹ãƒˆã®å…¨è¨˜äº‹
      â”‚   â”‚
      â”‚   â””â”€ æˆ»ã‚Šå€¤: ArticleWithContext
      â”‚
      â””â”€ ArticleSideNav ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«æ¸¡ã™
         â”‚
         â”œâ”€ article.lessonInfo ãŒ null â†’ ã€Œãƒ¬ãƒƒã‚¹ãƒ³æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€è¡¨ç¤º
         â”‚
         â””â”€ article.lessonInfo ãŒå­˜åœ¨ â†’ ãƒŠãƒ“ã‚’æç”»
```

---

## åŸå› ã®å¯èƒ½æ€§

### 1. Sanityãƒ‡ãƒ¼ã‚¿ã®å‚ç…§ä¸è¶³ (æœ€ã‚‚å¯èƒ½æ€§ãŒé«˜ã„)

**ç¢ºèªç‚¹**:
- è¨˜äº‹(Article)ãŒQuest.articlesã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹
- Quest.lessonãŒLessonã‚’å‚ç…§ã—ã¦ã„ã‚‹ã‹
- Lesson.questsãŒQuestã‚’å‚ç…§ã—ã¦ã„ã‚‹ã‹

**ç¢ºèªæ–¹æ³•**:
```groq
// Sanity Vision ã§å®Ÿè¡Œ
*[_type == "article" && slug.current == "å¯¾è±¡ã®slug"] {
  title,
  "questInfo": *[_type == "quest" && references(^._id)][0] {
    title,
    lesson-> { title }
  }
}
```

**è§£æ±ºç­–**:
Sanity Studioã§ä»¥ä¸‹ã‚’è¨­å®š:
1. Quest â†’ articles ã«è¨˜äº‹ã‚’è¿½åŠ 
2. Quest â†’ lesson ã«ãƒ¬ãƒƒã‚¹ãƒ³ã‚’è¨­å®š
3. Lesson â†’ quests ã«ã‚¯ã‚¨ã‚¹ãƒˆã‚’è¿½åŠ 

---

### 2. Webflow ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã®å•é¡Œ

**èƒŒæ™¯**:
- ä¸€éƒ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯Webflowã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹
- ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã§å‚ç…§ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§

**ç¢ºèªç‚¹**:
```bash
# Webflowã‚½ãƒ¼ã‚¹ãŒã‚ã‚‹ãƒ¬ãƒƒã‚¹ãƒ³ã‚’ç¢ºèª
*[_type == "lesson" && defined(webflowSource)]
```

---

### 3. ã‚¹ã‚­ãƒ¼ãƒã®åŒæ–¹å‘å‚ç…§

**ç¾çŠ¶ã®ã‚¹ã‚­ãƒ¼ãƒé–¢ä¿‚**:
```
Lesson
â”œâ”€â”€ quests: Reference[] â†’ Quest (é †æ–¹å‘)

Quest
â”œâ”€â”€ lesson: Reference â†’ Lesson (é€†æ–¹å‘)
â”œâ”€â”€ articles: Reference[] â†’ Article (é †æ–¹å‘)

Article
â”œâ”€â”€ quest: Reference â†’ Quest (é€†æ–¹å‘ã€readOnly)
```

**å•é¡Œ**:
- `Lesson.quests` ã¨ `Quest.lesson` ã®ä¸¡æ–¹ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹
- ã©ã¡ã‚‰ã‹ãŒæ¬ ã‘ã‚‹ã¨ãƒŠãƒ“ãŒè¡¨ç¤ºã•ã‚Œãªã„

---

## ãƒ‡ãƒãƒƒã‚°æ‰‹é †

### Step 1: ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèª

```javascript
// ä»¥ä¸‹ã®è­¦å‘ŠãŒå‡ºã¦ã„ãªã„ã‹ç¢ºèª
[getArticleWithContext] Article "xxx" has no questInfo
[getArticleWithContext] Quest "xxx" has no lesson reference
```

### Step 2: Sanity Visionã§ã‚¯ã‚¨ãƒªã‚’ãƒ†ã‚¹ãƒˆ

```groq
// è¨˜äº‹ã®å…¨ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ç¢ºèª
*[_type == "article" && slug.current == "å¯¾è±¡ã®slug"][0] {
  _id,
  title,
  "questInfo": *[_type == "quest" && references(^._id)][0] {
    _id,
    title,
    lesson-> {
      _id,
      title
    }
  }
}
```

### Step 3: ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ã‚’ç¢ºèª

```groq
// QuestãŒã‚ã‚‹ãŒã€lessonãŒãªã„ã‚‚ã®ã‚’æ¤œç´¢
*[_type == "quest" && !defined(lesson)] {
  _id,
  title
}

// ArticleãŒã‚ã‚‹ãŒã€ã©ã®Questã«ã‚‚å«ã¾ã‚Œã¦ã„ãªã„ã‚‚ã®ã‚’æ¤œç´¢
*[_type == "article"] {
  _id,
  title,
  "questCount": count(*[_type == "quest" && references(^._id)])
} | order(questCount asc)
```

---

## ä¿®æ­£æ‰‹é †

### Case A: ãƒ‡ãƒ¼ã‚¿ä¿®æ­£ã®ã¿ã§è§£æ±º

1. Sanity Studio ã‚’é–‹ã
2. è©²å½“ã®è¨˜äº‹ã‚’ç¢ºèª
3. Quest ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
4. Quest ã® lesson ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç¢ºèª
5. å¿…è¦ã«å¿œã˜ã¦ãƒ‡ãƒ¼ã‚¿ã‚’ä¿®æ­£

### Case B: ã‚¹ã‚­ãƒ¼ãƒä¿®æ­£ãŒå¿…è¦

1. `sanity-studio/schemaTypes/` ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿®æ­£
2. `sanity dev` ã§ãƒ­ãƒ¼ã‚«ãƒ«ç¢ºèª
3. `sanity deploy` ã§ãƒ‡ãƒ—ãƒ­ã‚¤

---

## ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

### ä¿®æ­£å¾Œã®ç¢ºèªé …ç›®

- [ ] è¨˜äº‹è©³ç´°ãƒšãƒ¼ã‚¸ã‚’é–‹ã
- [ ] å·¦ã‚µã‚¤ãƒ‰ãƒŠãƒ“ã«ãƒ¬ãƒƒã‚¹ãƒ³æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ã‚¯ã‚¨ã‚¹ãƒˆãƒªã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] è¨˜äº‹ãƒªã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ç¾åœ¨ã®è¨˜äº‹ãŒãƒã‚¤ãƒ©ã‚¤ãƒˆã•ã‚Œã‚‹
- [ ] ä»–ã®è¨˜äº‹ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦é·ç§»ã§ãã‚‹
- [ ] é€²æ—ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹ï¼ˆãƒ­ã‚°ã‚¤ãƒ³æ™‚ï¼‰

---

## é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

| ãƒ•ã‚¡ã‚¤ãƒ« | å½¹å‰² |
|---------|------|
| `src/lib/sanity.ts` | Sanityã‚¯ã‚¨ãƒªå®šç¾© |
| `src/pages/ArticleDetail.tsx` | è¨˜äº‹è©³ç´°ãƒšãƒ¼ã‚¸ |
| `src/components/article/sidebar/ArticleSideNav.tsx` | ã‚µã‚¤ãƒ‰ãƒŠãƒ“ |
| `sanity-studio/schemaTypes/quest.ts` | Questã‚¹ã‚­ãƒ¼ãƒ |
| `sanity-studio/schemaTypes/lesson.ts` | Lessonã‚¹ã‚­ãƒ¼ãƒ |
| `sanity-studio/schemaTypes/article.ts` | Articleã‚¹ã‚­ãƒ¼ãƒ |
