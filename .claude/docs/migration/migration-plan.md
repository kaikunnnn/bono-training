# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç§»è¡Œè¨ˆç”»

**ä½œæˆæ—¥**: 2025-12-05
**æœ€çµ‚æ›´æ–°**: 2025-12-05
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: Phase 2 é€²è¡Œä¸­

---

## æ¦‚è¦

Memberstack + Webflow ã‹ã‚‰ Supabase Auth + Supabase DB + Stripe ã¸ã®ç§»è¡Œè¨ˆç”»ã€‚

### é‡è¦ãªå‰æ

- **Stripeã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯åŒä¸€** - é¡§å®¢IDã€ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã€æ”¯æ‰•ã„æ–¹æ³•ã¯ãã®ã¾ã¾ä½¿ç”¨
- **Stripeãƒ‡ãƒ¼ã‚¿ã¯å¤‰æ›´ã—ãªã„** - èª­ã¿å–ã‚Šã®ã¿
- **Price IDã¯å…±é€š** - æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã¨æ–°ã‚·ã‚¹ãƒ†ãƒ ã§åŒã˜Price IDã‚’ä½¿ç”¨
- **ç§»è¡Œå¯¾è±¡** - ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã¨DBç´ä»˜ã‘ã®ã¿

---

## ç¾çŠ¶åˆ†æ

### æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ï¼ˆMemberstack + Webflowï¼‰

```
Memberstack
â”œâ”€â”€ ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ï¼ˆemail/passwordï¼‰
â”œâ”€â”€ Stripeé¡§å®¢IDç´ä»˜ã‘
â””â”€â”€ ãƒ—ãƒ©ãƒ³ç®¡ç†

Webflow
â””â”€â”€ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
```

### æ–°ã‚·ã‚¹ãƒ†ãƒ ï¼ˆSupabase + Stripeï¼‰

```
Supabase Auth
â”œâ”€â”€ ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ï¼ˆemail/passwordï¼‰
â””â”€â”€ auth.users ãƒ†ãƒ¼ãƒ–ãƒ«

Supabase DB (public schema)
â”œâ”€â”€ stripe_customersï¼ˆé¡§å®¢IDç´ä»˜ã‘ï¼‰
â”œâ”€â”€ user_subscriptionsï¼ˆã‚µãƒ–ã‚¹ã‚¯çŠ¶æ…‹ï¼‰
â””â”€â”€ ãã®ä»–ï¼ˆlesson_progressç­‰ï¼‰

Stripeï¼ˆå¤‰æ›´ãªã—ï¼‰
â”œâ”€â”€ é¡§å®¢ï¼ˆcus_xxxï¼‰
â”œâ”€â”€ ã‚µãƒ–ã‚¹ã‚¯ï¼ˆsub_xxxï¼‰
â””â”€â”€ æ”¯æ‰•ã„æ–¹æ³•
```

---

## æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ 

### auth.usersï¼ˆ2,045è¡Œï¼‰

| ã‚«ãƒ©ãƒ  | å‹ | èª¬æ˜ |
|--------|-----|------|
| id | uuid | PK |
| email | varchar | ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ |
| encrypted_password | varchar | ãƒãƒƒã‚·ãƒ¥åŒ–ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ |
| email_confirmed_at | timestamptz | ãƒ¡ãƒ¼ãƒ«ç¢ºèªæ—¥æ™‚ |

### public.stripe_customersï¼ˆ2,042è¡Œï¼‰

| ã‚«ãƒ©ãƒ  | å‹ | èª¬æ˜ |
|--------|-----|------|
| id | uuid | PK |
| user_id | uuid | FK â†’ auth.users.id |
| stripe_customer_id | varchar | Stripeé¡§å®¢IDï¼ˆcus_xxxï¼‰ |
| environment | text | test / live |

### public.user_subscriptionsï¼ˆ2,037è¡Œï¼‰

| ã‚«ãƒ©ãƒ  | å‹ | èª¬æ˜ |
|--------|-----|------|
| id | uuid | PK |
| user_id | uuid | FK â†’ auth.users.id |
| plan_type | text | standard / feedback |
| is_active | boolean | ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ |
| stripe_subscription_id | text | ã‚µãƒ–ã‚¹ã‚¯IDï¼ˆsub_xxxï¼‰ |
| stripe_customer_id | text | é¡§å®¢IDï¼ˆcus_xxxï¼‰ |
| plan_members | boolean | ãƒ¡ãƒ³ãƒãƒ¼ã‚¢ã‚¯ã‚»ã‚¹æ¨© |
| duration | integer | å¥‘ç´„æœŸé–“ï¼ˆæœˆï¼‰ |
| current_period_end | timestamptz | æ¬¡å›æ›´æ–°æ—¥ |
| environment | text | test / live |

---

## Price ID ãƒãƒƒãƒ”ãƒ³ã‚°

| ãƒ—ãƒ©ãƒ³å | Price ID | plan_type | duration | ç·é¡ | æœˆé¡æ›ç®— |
|----------|----------|-----------|----------|------|----------|
| Standard 1ãƒ¶æœˆ | price_1RStBiKUVUnt8GtynMfKweby | standard | 1 | Â¥6,800/æœˆ | - |
| Standard 3ãƒ¶æœˆ | price_1RStCiKUVUnt8GtyKJiieo6d | standard | 3 | Â¥17,400/3ãƒ¶æœˆ | Â¥5,800/æœˆç›¸å½“ |
| Feedback 1ãƒ¶æœˆ | price_1RStgOKUVUnt8GtyVPVelPg3 | feedback | 1 | Â¥15,800/æœˆ | - |
| Feedback 3ãƒ¶æœˆ | price_1RSuB1KUVUnt8GtyAwgTK4Cp | feedback | 3 | Â¥41,400/3ãƒ¶æœˆ | Â¥13,800/æœˆç›¸å½“ |

â€»3ãƒ¶æœˆãƒ—ãƒ©ãƒ³ã¯ä¸€æ‹¬æ‰•ã„ã€3ãƒ¶æœˆæ¯ã«æ›´æ–°

**é‡è¦**: æ—¢å­˜Memberstackãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚‚åŒã˜Price IDã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã€ãƒãƒƒãƒ”ãƒ³ã‚°å¤‰æ›ã¯ä¸è¦ã€‚

---

## ç§»è¡Œãƒ•ãƒ­ãƒ¼

### å˜ä¸€ãƒ¦ãƒ¼ã‚¶ãƒ¼ç§»è¡Œ

```
å…¥åŠ›: { email, stripe_customer_id }
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Supabase Authã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ   â”‚
â”‚    - email ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ        â”‚
â”‚    - ä»®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆ            â”‚
â”‚    - email_confirmed_at è¨­å®š     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. stripe_customers ã«æŒ¿å…¥       â”‚
â”‚    - user_id = æ–°è¦ä½œæˆID        â”‚
â”‚    - stripe_customer_id          â”‚
â”‚    - environment = 'live'        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. user_subscriptions ã«æŒ¿å…¥     â”‚
â”‚    - plan_type åˆ¤å®šï¼ˆPrice IDï¼‰  â”‚
â”‚    - is_active è¨­å®š              â”‚
â”‚    - stripe_subscription_id      â”‚
â”‚    - current_period_end          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡  â”‚
â”‚    - Supabase Auth APIä½¿ç”¨       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
å‡ºåŠ›: { success, user_id, error? }
```

---

## ç§»è¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆä¸€è¦§

| ã‚¹ã‚¯ãƒªãƒ—ãƒˆ | èª¬æ˜ | çŠ¶æ…‹ |
|------------|------|------|
| `migrate-create-auth-users.ts` | Authãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ | âœ… å®Œäº† (2,022/2,162) |
| `migrate-stripe-customers.ts` | stripe_customersåŒæœŸ | â¸ï¸ å¾…æ©Ÿä¸­ |
| `migrate-subscriptions.ts` | user_subscriptionsåŒæœŸ | â¸ï¸ å¾…æ©Ÿä¸­ |

---

## å®Ÿè¡Œè¨ˆç”»

### Phase 0: æº–å‚™ âœ… å®Œäº†

1. ç§»è¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆ
2. CSVãƒ•ã‚¡ã‚¤ãƒ«æº–å‚™
3. ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ä½œæˆ

### Phase 1: ãƒ†ã‚¹ãƒˆç§»è¡Œ âœ… å®Œäº†

1. 1ä»¶ãƒ†ã‚¹ãƒˆ âœ… æˆåŠŸ
2. 10ä»¶ãƒ†ã‚¹ãƒˆ âœ… æˆåŠŸ

### Phase 2: æœ¬ç•ªç§»è¡Œ ğŸ”„ é€²è¡Œä¸­

1. âœ… Auth ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆï¼ˆ2,022/2,162ä»¶ = 93.5%ï¼‰
2. â¸ï¸ stripe_customers ãƒ†ãƒ¼ãƒ–ãƒ«åŒæœŸ
3. â¸ï¸ user_subscriptions ãƒ†ãƒ¼ãƒ–ãƒ«åŒæœŸ

### Phase 3: å®Œäº†ç¢ºèª

1. å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³å¯èƒ½ç¢ºèª
2. ã‚µãƒ–ã‚¹ã‚¯çŠ¶æ…‹æ­£å¸¸ç¢ºèª
3. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡

---

## å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰

### Script 2: stripe_customers åŒæœŸ

```bash
npx tsx scripts/migrate-stripe-customers.ts stripe-customers.csv
```

### Script 3: user_subscriptions åŒæœŸ

```bash
npx tsx scripts/migrate-subscriptions.ts stripe-subscriptions.csv
```

---

## ãƒªã‚¹ã‚¯ã¨å¯¾ç­–

| ãƒªã‚¹ã‚¯ | å¯¾ç­– |
|--------|------|
| ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹é‡è¤‡ | ç§»è¡Œå‰ã«é‡è¤‡ãƒã‚§ãƒƒã‚¯ |
| Stripeã‚µãƒ–ã‚¹ã‚¯ä¸æ•´åˆ | ç§»è¡Œæ™‚ã«Stripeã‹ã‚‰æœ€æ–°çŠ¶æ…‹å–å¾— |
| ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¿˜ã‚Œ | å…¨å“¡ã«ãƒªã‚»ãƒƒãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡ |
| ç§»è¡Œå¤±æ•— | ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆæº–å‚™ |

---

## æ³¨æ„äº‹é …

1. **Stripeãƒ‡ãƒ¼ã‚¿ã¯çµ¶å¯¾ã«å¤‰æ›´ã—ãªã„**
2. **æ®µéšçš„ã«å®Ÿè¡Œ**ï¼ˆä¸€æ‹¬ç§»è¡Œã¯æœ€å¾Œï¼‰
3. **è©³ç´°ãƒ­ã‚°ã‚’è¨˜éŒ²**
4. **ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å¯èƒ½ãªçŠ¶æ…‹ã‚’ç¶­æŒ**

---

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [DATA-MAPPING.md](./DATA-MAPPING.md) - ãƒ‡ãƒ¼ã‚¿ãƒãƒƒãƒ”ãƒ³ã‚°è©³ç´°
- [ROLLBACK-PLAN.md](./ROLLBACK-PLAN.md) - ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †
- [phase2-full-migration-report.md](./phase2-full-migration-report.md) - Phase 2 ç§»è¡Œãƒ¬ãƒãƒ¼ãƒˆ
