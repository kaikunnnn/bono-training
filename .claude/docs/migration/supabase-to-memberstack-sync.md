# Supabase â†’ Memberstack é€†æ–¹å‘åŒæœŸ

**ä½œæˆæ—¥**: 2025-01-21
**æ›´æ–°æ—¥**: 2025-01-21
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… å®Ÿè£…å®Œäº†
**é–¢é€£ãƒ–ãƒ©ãƒ³ãƒ**: `feat/memberstack-account-sync`

---

## æ¦‚è¦

æ–°ã‚µã‚¤ãƒˆï¼ˆSupabase + Stripeï¼‰ã§ç™ºç”Ÿã—ãŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ»ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã€æ—§ã‚µã‚¤ãƒˆï¼ˆMemberstackï¼‰ã«è‡ªå‹•åŒæœŸã™ã‚‹ä»•çµ„ã¿ã®èª¿æŸ»çµæœã¨å®Ÿè£…è¨ˆç”»ã€‚

### èƒŒæ™¯

- ç¾åœ¨: bono ã‚µã‚¤ãƒˆï¼ˆMemberstack + Stripeï¼‰â†’ æ–°ã‚µã‚¤ãƒˆï¼ˆSupabase + Stripeï¼‰ã¸ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿæ–½ä¸­
- è¦ä»¶: é€†æ–¹å‘ï¼ˆSupabase â†’ Memberstackï¼‰ã¸ã®åŒæœŸã‚‚å¿…è¦
- ç›®çš„: ç§»è¡ŒæœŸé–“ä¸­ã€ä¸¡ã‚µã‚¤ãƒˆã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåŒã˜ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹

---

## èª¿æŸ»çµæœ

### Memberstack Admin API ä»•æ§˜

| é …ç›® | å€¤ |
|------|-----|
| Base URL | `https://admin.memberstack.com` |
| èªè¨¼ | `X-API-KEY` ãƒ˜ãƒƒãƒ€ãƒ¼ |
| Secret Key | Test: `sk_sb_xxx` / Live: `sk_live_xxx` |
| ãƒ¬ãƒ¼ãƒˆåˆ¶é™ | **25ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ç§’**ï¼ˆå¢—åŠ ä¸å¯ï¼‰ |

### åˆ©ç”¨å¯èƒ½ãªã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

```
POST   /members                        # ãƒ¡ãƒ³ãƒãƒ¼ä½œæˆ
GET    /members                        # ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§
GET    /members/{id}                   # ãƒ¡ãƒ³ãƒãƒ¼å–å¾—
PUT    /members/{id}                   # ãƒ¡ãƒ³ãƒãƒ¼æ›´æ–°
DELETE /members/{id}                   # ãƒ¡ãƒ³ãƒãƒ¼å‰Šé™¤
POST   /members/{id}/add-plan          # ãƒ—ãƒ©ãƒ³è¿½åŠ 
POST   /members/{id}/remove-plan       # ãƒ—ãƒ©ãƒ³å‰Šé™¤
```

### ã‚³ãƒ¼ãƒ‰ä¾‹

```javascript
// èªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼
const headers = {
  'X-API-KEY': 'sk_live_xxx',
  'Content-Type': 'application/json'
};

// ãƒ¡ãƒ³ãƒãƒ¼ä½œæˆï¼ˆãƒ—ãƒ©ãƒ³ä»˜ãï¼‰
const response = await fetch('https://admin.memberstack.com/members', {
  method: 'POST',
  headers,
  body: JSON.stringify({
    email: 'user@example.com',
    password: 'password123',
    plans: [{ planId: 'pln_xxx' }],
    customFields: { name: 'John' },
    metaData: {
      supabaseUserId: 'uuid-xxx',
      stripeCustomerId: 'cus_xxx'
    }
  })
});

// ãƒ—ãƒ©ãƒ³è¿½åŠ 
await fetch(`https://admin.memberstack.com/members/${memberId}/add-plan`, {
  method: 'POST',
  headers,
  body: JSON.stringify({ planId: 'pln_xxx' })
});

// ãƒ—ãƒ©ãƒ³å‰Šé™¤
await fetch(`https://admin.memberstack.com/members/${memberId}/remove-plan`, {
  method: 'POST',
  headers,
  body: JSON.stringify({ planId: 'pln_xxx' })
});
```

---

## é‡å¤§ãªåˆ¶é™äº‹é …

### æœ‰æ–™ãƒ—ãƒ©ãƒ³ã¯APIã§è¿½åŠ ã§ããªã„

> "You can add or remove plans via API as long as they are **FREE**."

- `add-plan` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯ **ç„¡æ–™ãƒ—ãƒ©ãƒ³ã®ã¿** å¯¾å¿œ
- æœ‰æ–™ãƒ—ãƒ©ãƒ³ã®è¿½åŠ ã¯ **ãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªèº«ãŒStripeãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã§æ”¯æ‰•ã„** ãŒå¿…é ˆ
- ã“ã‚Œã¯Memberstackã®è¨­è¨ˆæ€æƒ³ï¼ˆæ”¯æ‰•ã„åŒæ„ãŒå¿…è¦ï¼‰

### Stripeé€£æºã®åˆ¶é™

- **Stripeå´ã§ç›´æ¥ä½œæˆã•ã‚ŒãŸã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã¯Memberstackã«è‡ªå‹•åŒæœŸã•ã‚Œãªã„**
- Stripeã®å•†å“ï¼ˆProducts/Pricesï¼‰ã¯Memberstackå´ã§ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹
- æ—¢å­˜ã®Stripeé¡§å®¢ã‚’Memberstackãƒ¡ãƒ³ãƒãƒ¼ã«ç´ä»˜ã‘ã‚‹ã«ã¯æ‰‹å‹•ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå¿…è¦

---

## å®Ÿç¾å¯èƒ½ãªåŒæœŸç¯„å›²

| æ“ä½œ | Supabase â†’ Memberstack | æ–¹æ³• |
|------|------------------------|------|
| æ–°è¦ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ | âœ… å¯èƒ½ | `POST /members` |
| ç„¡æ–™ãƒ—ãƒ©ãƒ³å‰²ã‚Šå½“ã¦ | âœ… å¯èƒ½ | `POST /members/{id}/add-plan` |
| **æœ‰æ–™ãƒ—ãƒ©ãƒ³å‰²ã‚Šå½“ã¦** | âŒ **ä¸å¯èƒ½** | APIåˆ¶é™ |
| ãƒ—ãƒ©ãƒ³å‰Šé™¤ï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼‰ | âœ… å¯èƒ½ | `POST /members/{id}/remove-plan` |
| ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æ›´æ–° | âœ… å¯èƒ½ | `PUT /members/{id}` |

---

## æ¨å¥¨ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ: ç„¡æ–™ãƒ—ãƒ©ãƒ³ + Webhooké€£æº

### è¨­è¨ˆæ€æƒ³

Memberstackã‚’æœ€çµ‚çš„ã«æ¨ã¦ã‚‹å‰æã§ã€**ç§»è¡ŒæœŸé–“ä¸­ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©ãƒ—ãƒ­ã‚­ã‚·**ã¨ã—ã¦æ‰±ã†ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Stripeï¼ˆèª²é‡‘ã®çœŸå®Ÿï¼‰                                â”‚
â”‚  - èª°ãŒã„ãã‚‰æ‰•ã£ã¦ã„ã‚‹ã‹                            â”‚
â”‚  - ã‚µãƒ–ã‚¹ã‚¯ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹                              â”‚
â”‚  - è«‹æ±‚å±¥æ­´                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Supabaseï¼ˆæ–°ã‚µã‚¤ãƒˆ - çœŸã®ã‚½ãƒ¼ã‚¹ãƒ»ã‚ªãƒ–ãƒ»ãƒˆã‚¥ãƒ«ãƒ¼ã‚¹ï¼‰   â”‚
â”‚  - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ                                â”‚
â”‚  - Stripeã¨ç´ä»˜ã„ãŸã‚µãƒ–ã‚¹ã‚¯çŠ¶æ…‹                      â”‚
â”‚  - user_subscriptions, stripe_customers             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼ Webhook ã§åŒæœŸï¼ˆä¸€æ–¹å‘ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Memberstackï¼ˆæ—§ã‚µã‚¤ãƒˆ - ç§»è¡ŒæœŸé–“ä¸­ã®ã‚¢ã‚¯ã‚»ã‚¹ç®¡ç†ï¼‰    â”‚
â”‚  - ç„¡æ–™ãƒ—ãƒ©ãƒ³ = ã‚¢ã‚¯ã‚»ã‚¹æ¨©ã®ã‚¹ã‚¤ãƒƒãƒ                  â”‚
â”‚  - èª²é‡‘ãƒ‡ãƒ¼ã‚¿ã¯æŒãŸãªã„ï¼ˆStripeã¨ã®ç´ä»˜ã‘ä¸è¦ï¼‰        â”‚
â”‚  - ç§»è¡Œå®Œäº†å¾Œã¯åœæ­¢                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åŒæœŸãƒ•ãƒ­ãƒ¼

```
æ–°ã‚µã‚¤ãƒˆï¼ˆSupabase + Stripeï¼‰ã§ã‚µãƒ–ã‚¹ã‚¯æ“ä½œ
    â”‚
    â”œâ”€â”€ æ–°è¦ç™»éŒ² â”€â”€â†’ Memberstack: ãƒ¡ãƒ³ãƒãƒ¼ä½œæˆ + ç„¡æ–™ãƒ—ãƒ©ãƒ³å‰²ã‚Šå½“ã¦
    â”‚
    â”œâ”€â”€ æ›´æ–° â”€â”€â”€â”€â”€â”€â†’ Memberstack: ãƒ—ãƒ©ãƒ³å¤‰æ›´ï¼ˆç„¡æ–™ãƒ—ãƒ©ãƒ³é–“ï¼‰
    â”‚
    â””â”€â”€ ã‚­ãƒ£ãƒ³ã‚»ãƒ« â”€â†’ Memberstack: remove-plan
```

### å®Ÿè£…ã‚¤ãƒ¡ãƒ¼ã‚¸

```
Stripe: subscription ã‚­ãƒ£ãƒ³ã‚»ãƒ«/æœŸé™åˆ‡ã‚Œ
    â†“
Supabase stripe-webhook: æ¤œçŸ¥
  - customer.subscription.updated (cancel_at_period_end = true)
  - customer.subscription.deleted (æœŸé™åˆ‡ã‚Œ)
    â†“
Memberstack API å‘¼ã³å‡ºã—
  POST /members/{memberId}/remove-plan
    â†“
ç„¡æ–™ãƒ—ãƒ©ãƒ³å‰Šé™¤ â†’ ã‚¢ã‚¯ã‚»ã‚¹æ¨©å¤±åŠ¹
```

---

## Memberstackå´ã®æº–å‚™ï¼ˆå®Ÿè£…å‰ã«å¿…è¦ï¼‰

1. **ã€ŒAPIç”¨ç„¡æ–™ãƒ—ãƒ©ãƒ³ã€ã‚’ä½œæˆ**
   - ãƒ—ãƒ©ãƒ³åä¾‹: `API Sync - Standard`, `API Sync - Feedback`
   - ä¾¡æ ¼: ç„¡æ–™

2. **æœ‰æ–™ãƒ—ãƒ©ãƒ³ã¨åŒã˜ã‚¢ã‚¯ã‚»ã‚¹æ¨©ã‚’è¨­å®š**
   - åŒã˜ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ»ãƒšãƒ¼ã‚¸ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯

3. **è¤‡æ•°ãƒ—ãƒ©ãƒ³ãŒã‚ã‚‹å ´åˆã¯ã€ãã‚Œãã‚Œã«å¯¾å¿œã™ã‚‹ç„¡æ–™ãƒ—ãƒ©ãƒ³ã‚’ä½œæˆ**

---

## å®Ÿè£…ã‚¿ã‚¹ã‚¯

### Phase 1: æº–å‚™ âœ… å®Œäº†
- [x] Memberstack Admin API ã‚­ãƒ¼ã‚’å–å¾—
- [x] ç’°å¢ƒå¤‰æ•°ã«è¿½åŠ ï¼ˆ`MEMBERSTACK_SECRET_KEY`ï¼‰
- [x] Memberstackå´ã§ç„¡æ–™ãƒ—ãƒ©ãƒ³ã‚’ä½œæˆ
  - `API Sync - Standard`: `pln_api-sync-standard--g741f0nsv`
  - `API Sync - Feedback`: `pln_api-sync-feedback--q641i0nfl`
- [x] ãƒ—ãƒ©ãƒ³IDã‚’ç’°å¢ƒå¤‰æ•°ã«è¿½åŠ 

### Phase 2: Edge Function æ‹¡å¼µ âœ… å®Œäº†
- [x] `supabase/functions/_shared/memberstack.ts` ä½œæˆ
- [x] `stripe-webhook/index.ts` ã«MemberstackåŒæœŸãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ 
- [x] ä»¥ä¸‹ã®ã‚¤ãƒ™ãƒ³ãƒˆã§Memberstack APIã‚’å‘¼ã³å‡ºã™:
  - `checkout.session.completed` â†’ ãƒ¡ãƒ³ãƒãƒ¼ä½œæˆ + ãƒ—ãƒ©ãƒ³è¿½åŠ 
  - `customer.subscription.updated` â†’ ãƒ—ãƒ©ãƒ³å¤‰æ›´å¯¾å¿œ
  - `customer.subscription.deleted` â†’ ãƒ—ãƒ©ãƒ³å‰Šé™¤
- [x] Edge Functionãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†

### Phase 3: ãƒ‡ãƒ¼ã‚¿ãƒãƒƒãƒ”ãƒ³ã‚°
- å®Ÿè£…æ–¹å¼: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ç´ä»˜ã‘ï¼ˆãƒãƒƒãƒ”ãƒ³ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«ä¸è¦ï¼‰
- Memberstackå´ã§ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ `supabaseUserId`, `stripeCustomerId` ã‚’ä¿å­˜

### Phase 4: ãƒ†ã‚¹ãƒˆ ğŸ”„ é€²è¡Œä¸­
- [ ] ãƒ†ã‚¹ãƒˆç’°å¢ƒã§å‹•ä½œç¢ºèª
- [ ] æœ¬ç•ªç’°å¢ƒã§ã®ãƒ†ã‚¹ãƒˆ

---

## å‚è€ƒãƒªãƒ³ã‚¯

- [Memberstack Admin REST API - Member Actions](https://developers.memberstack.com/admin-rest-api/member-actions)
- [Memberstack Admin Package (REST)](https://docs.memberstack.com/hc/en-us/articles/17385829931419-Memberstack-Admin-Package-REST)
- [Community: API paid plans limitation](https://docs.memberstack.com/hc/en-us/community/posts/16176747944091-API-to-create-update-member-and-assign-subscription-plan)
- [3 Ways to Cancel a Member's Plan](https://docs.memberstack.com/hc/en-us/articles/11269224717851-3-Ways-to-Cancel-a-Member-s-Plan)

---

## å‚™è€ƒ

- **Memberstackã‚’æ¨ã¦ã‚‹äºˆå®šãªã‚‰ã€èª²é‡‘ãƒ‡ãƒ¼ã‚¿ã¨ã®ç´ä»˜ã‘ãŒãªã„ã“ã¨ã¯å•é¡Œã«ãªã‚‰ãªã„**
- Memberstackã¯ã€Œç§»è¡ŒæœŸé–“ä¸­ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©ç®¡ç†ã€ã¨ã—ã¦æ©Ÿèƒ½ã™ã‚Œã°ã‚ˆã„
- å®Œå…¨ç§»è¡Œå¾Œã¯Memberstackã‚’åœæ­¢ã™ã‚‹ã ã‘ã§OK
