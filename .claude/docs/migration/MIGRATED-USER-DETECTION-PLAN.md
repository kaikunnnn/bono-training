# 移行ユーザー判定機能 実装計画

**作成日**: 2025-12-05
**ステータス**: 計画中
**優先度**: 高（Phase B テスト前に実装推奨）

---

## 概要

### 背景

Memberstack から Supabase Auth への移行により、既存ユーザー（約2,000人）は**旧パスワードが使用できない**状態になっている。

現状では、移行ユーザーがログインしようとすると「メールアドレスまたはパスワードが正しくありません」という一般的なエラーが表示され、混乱を招く。

### 目的

移行ユーザーがログインに失敗した際に、**専用のメッセージ**を表示し、パスワードリセットへ誘導する。

### 期待するUX

```
移行ユーザーがログイン試行
    ↓
パスワード不一致でエラー
    ↓
「システム移行により、パスワードの再設定が必要です。
 サブスクリプション情報はそのまま引き継がれます。
 [パスワードを再設定する]」
    ↓
パスワードリセットページへ誘導
```

---

## 技術設計

### 判定方法

移行ユーザーは `auth.users.raw_user_meta_data.migrated_from = 'stripe'` で識別可能。

```sql
SELECT id, email, raw_user_meta_data->>'migrated_from' as migrated_from
FROM auth.users
WHERE email = 'user@example.com';
```

### アーキテクチャ

```
┌─────────────────┐     ┌──────────────────────┐     ┌─────────────┐
│  Login.tsx      │────▶│  check-migrated-user │────▶│  Supabase   │
│  (フロント)     │     │  (Edge Function)     │     │  Database   │
└─────────────────┘     └──────────────────────┘     └─────────────┘
        │                         │
        │    { isMigrated: true } │
        │◀────────────────────────┘
        │
        ▼
  専用メッセージ表示
```

---

## 実装内容

### 1. Edge Function: `check-migrated-user`

**ファイル**: `supabase/functions/check-migrated-user/index.ts`

**機能**:
- メールアドレスを受け取る
- auth.users でユーザーを検索
- `migrated_from` の有無を返す

**リクエスト**:
```json
{
  "email": "user@example.com"
}
```

**レスポンス**:
```json
{
  "exists": true,
  "isMigrated": true
}
```

**セキュリティ考慮**:
- ユーザーの存在有無を返すため、レート制限を設ける
- 詳細なユーザー情報は返さない

---

### 2. フロントエンド: Login.tsx 修正

**ファイル**: `src/pages/Training/Login.tsx`

**変更内容**:

1. ログイン失敗時に Edge Function を呼び出す
2. 移行ユーザーの場合、専用メッセージを表示
3. パスワードリセットへのボタンを表示

**表示メッセージ案**:

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
⚠️ パスワードの再設定が必要です

システムの移行により、新しいパスワードを
設定していただく必要があります。

ご利用中のサブスクリプション情報は
そのまま引き継がれますのでご安心ください。

[パスワードを再設定する]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 実装手順

### Step 1: Edge Function 作成

```bash
# ディレクトリ作成
mkdir -p supabase/functions/check-migrated-user

# ファイル作成
# index.ts を作成
```

### Step 2: Edge Function デプロイ

```bash
supabase functions deploy check-migrated-user
```

### Step 3: フロントエンド修正

- `src/pages/Training/Login.tsx` を修正

### Step 4: フロントエンド デプロイ

- Vercel に自動デプロイ（git push）

### Step 5: 動作確認

1. 移行ユーザーでログイン試行 → 専用メッセージ表示
2. 新規ユーザーでログイン試行 → 通常エラーメッセージ
3. パスワードリセットフローの確認

---

## 工数見積もり

| タスク | 時間 |
|--------|------|
| Edge Function 作成 | 15分 |
| Edge Function デプロイ | 5分 |
| Login.tsx 修正 | 20分 |
| テスト | 10分 |
| **合計** | **約50分** |

---

## リスクと対策

| リスク | 対策 |
|--------|------|
| Edge Function のエラー | フォールバックで通常エラーを表示 |
| レート制限攻撃 | Edge Function にレート制限を実装 |
| ユーザー存在確認の悪用 | 存在有無のみ返す（詳細情報は返さない） |

---

## テスト計画

### テストケース

| # | ケース | 期待結果 |
|---|--------|----------|
| 1 | 移行ユーザー + 間違ったパスワード | 専用メッセージ表示 |
| 2 | 新規ユーザー + 間違ったパスワード | 通常エラーメッセージ |
| 3 | 存在しないメールアドレス | 通常エラーメッセージ |
| 4 | 移行ユーザー + 正しいパスワード | ログイン成功 |

---

## 完了条件

- [ ] Edge Function `check-migrated-user` がデプロイされている
- [ ] Login.tsx が修正されている
- [ ] 移行ユーザーに専用メッセージが表示される
- [ ] 新規ユーザーには通常エラーが表示される
- [ ] パスワードリセットへの導線が機能する

---

## 関連ドキュメント

- [VERIFICATION-TEST-PLAN.md](./VERIFICATION-TEST-PLAN.md) - 検証テスト計画
- [MEMBER-TEST-FLOW.md](./MEMBER-TEST-FLOW.md) - メンバーテストフロー
- [MIGRATION-PLAN.md](./MIGRATION-PLAN.md) - 移行計画
