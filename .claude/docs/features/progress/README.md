# レッスン進捗機能 ドキュメント

**作成日**: 2025-12-06
**ステータス**: ✅ 調査完了

---

## 概要

レッスン・記事の完了機能に関するドキュメント群です。
基本的に UX-SPECIFICATION.md の実現をもとに開発を進めていきます。

### 調査結果サマリー

**発見した重大な問題**:

| 重大度 | 問題           | 影響                               |
| ------ | -------------- | ---------------------------------- |
| 🔴 高  | RLS 無効       | 他ユーザーのデータ閲覧・改ざん可能 |
| 🔴 高  | レース条件     | 同時クリックでエラー発生           |
| 🟡 中  | キャッシュなし | パフォーマンス低下                 |

**推奨アクション**:

1. RLS 有効化（最優先）
2. upsert パターンへの変更
3. 楽観的更新の導入

詳細は `potential-issues.md` を参照。

---

## ドキュメント一覧

| ファイル                    | 内容                 | ステータス |
| --------------------------- | -------------------- | ---------- |
| `INVESTIGATION-PLAN.md`     | 調査計画・フェーズ   | ✅ 完了    |
| `current-implementation.md` | 現状の実装詳細       | ✅ 完了    |
| `database-schema.md`        | DB テーブル構造・RLS | ✅ 完了    |
| `data-flow.md`              | データフロー図       | ✅ 完了    |
| `potential-issues.md`       | 潜在的な問題と対策   | ✅ 完了    |

---

## 調査フェーズ

```
Phase 1: フロントエンド実装の調査     ✅ 完了
Phase 2: データベース構造の調査       ✅ 完了
Phase 3: データフロー・状態管理の調査 ✅ 完了
Phase 4: 潜在的問題の分析             ✅ 完了
Phase 5: 調査結果のまとめ             ✅ 完了
```

---

## 主要な発見

### 1. 2 つの進捗システムが存在

| システム | テーブル           | サービス                            |
| -------- | ------------------ | ----------------------------------- |
| Training | `user_progress`    | `src/services/training/progress.ts` |
| Article  | `article_progress` | `src/services/progress.ts`          |

### 2. セキュリティ問題

- **RLS が全テーブルで無効** → 他ユーザーのデータ操作可能

### 3. レース条件

- SELECT → INSERT パターンで同時クリック時にエラー発生

---

## 関連ファイル（コード）

### サービス層

| ファイル                            | 役割              |
| ----------------------------------- | ----------------- |
| `src/services/progress.ts`          | Article 進捗 API  |
| `src/services/training/progress.ts` | Training 進捗 API |

### コンポーネント層

| ファイル                                            | 役割                         |
| --------------------------------------------------- | ---------------------------- |
| `src/pages/ArticleDetail.tsx`                       | 記事詳細ページ（完了ボタン） |
| `src/pages/LessonDetail.tsx`                        | レッスン詳細ページ           |
| `src/components/article/sidebar/ArticleSideNav.tsx` | サイドナビ（進捗表示）       |
| `src/components/training/TaskActionButton.tsx`      | タスク完了ボタン             |

### データベース

| テーブル           | 用途                |
| ------------------ | ------------------- |
| `article_progress` | 記事完了状態        |
| `lesson_progress`  | レッスン完了状態    |
| `user_progress`    | Training タスク進捗 |

---

## 次のステップ

1. **RLS 有効化**（セキュリティ修正）
2. **upsert パターンへの変更**（レース条件修正）
3. **楽観的更新導入**（UX 改善）

---

## 更新履歴

| 日付       | 内容               |
| ---------- | ------------------ |
| 2025-12-06 | 全フェーズ調査完了 |
| 2025-12-06 | 初版作成・調査開始 |
