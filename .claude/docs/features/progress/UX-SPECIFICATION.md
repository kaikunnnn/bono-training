# 進捗機能 UX 仕様書

**作成日**: 2025-12-07
**ステータス**: ドラフト

---

## 概要

レッスン・記事の進捗管理機能の体験仕様書です。
以下 3 つを定義します。

- １：マイページの「進行中ーセクション」に並ぶ体験
- ２：レッスン中に完了ボタンを押すときの体験
- ３：マイページの「進行中ー画面」の体験

---

# １：マイページの「進行中ーセクション」に並ぶ体験

## 1. ユーザーストーリー

いかのフローを叶えるために「進捗機能の Ver1」を制作していきます。

1. ユーザーは「レッスン」を進めながら、レッスンのクエストの中にある記事を進める
2. ユーザーは記事 1 つを完了したときに、記事画面にある「完了ボタン」を押す
3. はじめてレッスンの中の記事画面にある完了ボタンを押すと、マイページの「進行中」にレッスンが表示される。
4. マイページに表示されたレッスンは進捗率を%で確認でき、それをクリックすることでマイページから進行中のレッスンの記事にすぐにアクセスすることができる
5. マイページのなかの進行中のレッスンは最新順にならんでいる。最新は追加された時間の新しい順である。マイページは最大 2 つの進行中レッスンを並べることができる。2 つ以上は「進行中」の画面ですべて見ることができる。
6. マイページの中には「進行中」の画面がありタブで切り替えられる
7. 進行中の画面は「進行中のレッスン」が最新順に並んでいる。
8. 進行中のレッスンの順番を管理することができる
   ⇨ マイページに表示する進行中を 2 つまでセットすることができる。

※悩み：進行中のレッスンは最大 2 つだが、マイページで最新順で並べるのではなく「進行中」のステータスがついたレッスンのみを並べる仕様にしたほうがよいか？

## 2. 画面仕様

## 4. データ要件

### 進捗管理の「レッスンオブジェクト」

マイページや、進行中、の画面で表示される、「レッスン進捗」が表示されるオブジェクト。

- 情報構造：2 つのブロックで構成

  - レッスンブロック：リンクになっていてレッスン詳細ページに飛ぶことができる
    - レッスンアイコン
    - レッスンタイトル
    - 進捗率を表すバー（記事詳細ページでも表示）
    - 新緑率を%で表すもの（記事詳細ページでも表示）
  - 次の記事ブロック：リンクになっていて、レッスンの中で完了している記事の次の記事へのリンクになっている
    - "次へ 👉️”の表示：固定表示
    - 記事のタイトル

- デザインデータは Figma から読み取ったものを以下のファイルにまとめます
  - [レッスンオブジェクトのデザインデータ](./lesson-object-design-data.md)

### 進行中画面

マイページを切り替えると表示される「進行中」の画面の情報です。

- 表示されるブロック
  - 進行中
    - 進行中のレッスンが表示される
    - オブジェクトは”進捗管理の「レッスンオブジェクト」
  - 一覧
    - 進行中ではないけど、進行中として扱われたことのあるレッスンが並ぶ
    - 並び順は「完了したもの（100%）」がまず最初、そのつぎに追加された順番で並ぶ

## 5. 今後の機能拡張案

- 「ロードマップ」という別の単位でも進捗を表示させたい

---

# ２：レッスン中に完了ボタンを押すときの体験

## 1. ユーザーストーリー

1. ユーザーはレッスンの中のクエストと記事を進める
2. 記事１つ１つに完了ボタンがあり、完了状態にすると、トースト UI で「ナイスデザイン 🕺 １歩進んだぜ」が表示される
3. クエストのなかの記事がすべて完了するとクエスト自体も完了済みになる。クエストが完了するとトースト UI で花火が上がりつつ「ナイスすぎぃ！パワぁー！💪」というメッセージが表示される
4. レッスンすべてのチェックが付くと完了率が１００％になり、モーダルの UI で「おめでとう！新しいスキルを習得しました！＋レッスンが完了しました。その情熱が旅を前に進めてまえにすすめてたんだ。今日は美味しいものでも食べよう」が表示されます。
5. 完了率 100%のレッスンはマイページでも確認できます。マイページは完了率 100％になってもすぐに非表示にせず、”このレッスンを進行中から取り消す”このレッスンが表示されそれを押すと進行中からは非表示になりあ m す
6. 100%のレッスンはマイページ＞進行中のページで 100％の表示を見ることができます。

## 2. 画面仕様

いかのファイルに画面仕様・デザイン仕様をまとめます。

- 記事の完了ボタンを押した時
- クエストの完了が行われた時
- レッスンが 100％完了になった時の 3 つです。

## 3. データ要件

## 4. 今後の機能拡張案

- 各トーストやモーダルで表示するメッセージは、ランダムか、指定で変化があるようにしたいです。

---

# ３：マイページの「進行中ー画面」の体験

## 1. ユーザーストーリー

- ユーザーは過去の実績を確認して自分を奮い立たせたり、過去進捗したコンテンツノ確認をしたいです。
- また、「進行中」に並べるレッスンなどを管理することがしたい。
- そのためにマイページのなかの「進行中」の専用画面に訪れます。
- 1 : レッスンの進捗率がすべて表示される
  - 「進行中」と「一覧」のセクションがある
  - 進行中：進行中にセットしたレッスンの進捗率が表示されている
  - 一覧：過去進行中になったレッスンが一覧で表示されている。100％になっているものが先に表示、そのあとに過去最新順で表示されます。
  - 進行中と一覧にあるものは、重ならないです。

## 2. 画面仕様

- 進行中、一覧の順にセクションがあります。
- 各セクションに表示するレッスンオブジェクトは、マイページの進捗表示に使うレッスンオブジェクトと一緒です。

## 3. データ要件

## 4. 今後の機能拡張案

- 今後「ロードマップ」という、複数のレッスンが合わさって 1 つになった単位の進捗表示の検討もしています。

---

## 確認事項・質問（Claude より）

### Q1: 「進行中」へのセット方法

> 「マイページに表示する進行中を 2 つまでセットすることができる」

- **質問**: ユーザーが手動で「進行中にセット」するのか、それとも最新の 2 つが自動で表示されるのか？
- **確認したい理由**: UI と実装方法が大きく変わるため
- 回答
- っっっｓ

基本的には自動で最新のものがセットされます。つまり新しいレッスンに対して完了チェックをつけるとそれが最新のものなのでそれが表示されると言う仕組みになりますが、一応進捗進行中の管理みたいなもので、自分で一度進行中に並んだレッスンを進行中に無理矢理セットすることもやってもいいのかなと思ってますが、どう思いますか？

### Q2: 進行中から取り消した後の挙動

> 「"このレッスンを進行中から取り消す"を押すと進行中からは非表示になります」

- **質問**: 取り消したレッスンを再度「進行中」に戻すことはできるか？
- **確認したい理由**: 「一覧」からドラッグして戻す等の UI が必要かどうか
  背景としては、これを書いた背景としては、これ中のものが 100%になったときの対応なんですね。まず 100%になったからって、勝手に取り消すのではなくて、その達成感を味わえるためにマイページに進行中として表示されていて欲しいですと進行中にあった場合ですね。その 100%になったものがまずその話がありますと、それとは別に進行中を取り消す事は基本的にできないかなと思います。4100%になったときだけこれを取り消すっていうか一覧に戻すみたいなものができるところですね。一覧からドラッグして進行中に戻すみたいな。なんかそういう機能が必要かどうかって話は？ 1 の話とも一緒なんですけど進行中の管理みたいなものでできてもいいかなとは思っています。はいこれについてもでもどう思うかをちょっと聞きたい。普通の実装にしたいのそこの観点でちょっと答えてもらうとありがたいです。

### Q3: 「次へ」の記事の決定ロジック

> 「レッスンの中で完了している記事の次の記事へのリンク」

- **質問**: 「次の記事」はどのように決まるか？
  - A: クエスト内の順番（上から順）
  - B: レッスン内の全記事を通した順番
  - C: その他
- **確認したい理由**: Sanity のデータ構造と照らし合わせて実装方法を決めるため

ちょっと難しいと思うんですけど、理想はですね。レッスン全体の記事の順番の中でその順番の中で 1 番進んでいる官僚チェックがついている記事の次の記事がリンクになるみたいなのが想定したことではありますが、その観点でちょっと複雑な場合は教えて欲しいですね。

### Q4: 一覧への追加タイミング

> 「進行中ではないけど、進行中として扱われたことのあるレッスン」

- **質問**: 「進行中として扱われた」の定義は？

  - A: レッスン内の記事を 1 つでも完了したら自動追加
  - B: ユーザーが明示的に「進行中に追加」したもののみ

- **確認したい理由**: 自動追加だとレッスン外の記事完了との整合性を考える必要がある

- A です。
- "自動追加だとレッスン外の記事完了との整合性を考える必要がある"👉️ レッスン外の記事完了とはなんですか？

### Q5: 進捗率の計算方法

- **質問**: 進捗率（%）は何を基準に計算するか？
  - A: レッスン内の全記事数に対する完了記事数
  - B: レッスン内の全クエスト数に対する完了クエスト数
  - C: その他（加重平均など）
- **例**: レッスンに 3 クエスト、合計 10 記事がある場合、5 記事完了で 50%？

- 回答：すでに実装してある内容でいいです。A になっている気がします。

### Q6: レッスンに属さない記事の扱い

- **質問**: 現在、記事単体でも「完了」できる機能があるが、レッスンに属さない記事を完了した場合はどうなるか？

  - A: マイページには何も表示されない（レッスン進捗のみ対象）
  - B: 別の「完了した記事」セクションを用意する
  - C: その他

- マイページには何も表示されません。というかレッスンに属してない記事には完了を付けたくないです

### Q7: 既存データとの整合性

- **質問**: 既に`article_progress`テーブルにデータがあるユーザーは、どう扱うか？
  - A: 既存の完了記事を元に、レッスン進捗を自動計算して表示
  - B: 新機能リリース後の完了のみを対象とする
- **確認したい理由**: マイグレーション処理の有無を判断するため

- まだテストした実装無いようなのでゼロから実装を考えてオッケです。B になりますかね？

---

## Claude からの回答・提案

### Q1/Q2 への回答: シンプルな実装を推奨

**結論: Ver1 では「自動のみ」で OK、手動管理は後から追加可能**

理由:

1. **自動表示のみで十分機能する** - 最新 2 つが自動で並ぶだけで、ほとんどのユースケースをカバーできる
2. **手動管理は UI/実装が複雑になる** - ドラッグ&ドロップや「進行中にセット」ボタンなど、追加 UI が必要
3. **後から追加しやすい** - DB に`is_pinned`フラグを追加するだけで拡張可能

**Ver1 の提案:**

- マイページ: 最新 2 つを自動表示
- 100%完了時: 「レッスンを完了する」ボタンで非表示化
- 一覧から進行中への復帰: Ver1 ではなし（記事を再度完了すれば自動で戻る）

👉️ オッケーそれでいこう

### Q3 への回答: 実装は可能だが少し複雑

**「レッスン全体の記事順番で、最も進んだ完了記事の次」は実装可能**

実装方法:

1. レッスン → クエスト（順番あり） → 記事（順番あり）の 3 階層
2. 全記事をフラット化して順番を付ける
3. 完了済み記事の中で最大順番のものを探す
4. その次の記事を「次へ」とする

**注意点:**

- Sanity から毎回全クエスト・記事を取得する必要がある（パフォーマンス考慮）
- 未完了の記事を飛ばして完了した場合の挙動を決める必要あり
  - 例: 記事 1,2,3 があり、記事 1 と記事 3 を完了した場合 → 「次へ」は記事 2？記事 4（次のクエスト）？

**提案:** 「未完了で最も順番が若い記事」を次へとする方がシンプルかも
👉️ はい、この提案で行きたいです。
ちなみにパフォーマンスが気になります。毎回全クエスト取得はちょっとヤバそうです。実際に時間がかかりますしリクエストも多いですよね？
どう考えるとよいでしょうか。

---

### Q3 パフォーマンス対策の提案（Claude）

**問題:** マイページ表示のたびにSanityから全クエスト・記事を取得すると遅い

**解決策: 「次の記事ID」をDBに保存する**

```
【記事完了時の処理フロー】
1. ユーザーが記事を完了
2. その場でSanityからレッスン構造を取得（この時点では必要）
3. 「次の未完了記事」を計算
4. DBの lesson_progress テーブルに保存:
   - lesson_id
   - progress_percent
   - next_article_id  ← これを追加
   - next_article_title ← これも追加（表示用）
   - updated_at

【マイページ表示時】
1. DBから lesson_progress を取得するだけ
2. Sanityへのリクエスト不要 → 高速
```

**メリット:**
- マイページ表示が高速（DBのみ）
- Sanityへのリクエストは記事完了時の1回だけ
- 記事完了は頻度が低いので負荷にならない

**デメリット:**
- Sanityでレッスン構造が変わった場合、DBの情報が古くなる可能性
  - 対策: 記事完了時に毎回再計算するので、使っていれば自然に更新される
  - 対策: 定期的なバッチ処理で同期（必要なら）

**結論:** この方式なら毎回Sanity取得は不要です。おすすめ。

### Q4 への補足: 「レッスン外の記事」について

Q6 で回答いただいた通り、「レッスンに属さない記事には完了を付けたくない」とのことなので、この懸念は解消されました。

**確認:** 現在レッスンに属さない記事にも完了ボタンがありますが、これを非表示にする対応も必要ですか？

---

## 決定事項まとめ（Ver1）

### 仕様決定

| 項目 | 決定内容 |
|------|---------|
| 進行中の表示 | 最新2つを**自動表示**（手動管理はVer2以降） |
| 進行中からの取り消し | **100%完了時のみ**「レッスンを完了する」ボタンで一覧に移動 |
| 一覧から進行中への復帰 | Ver1ではなし（記事を再度完了すれば自動で戻る） |
| 「次の記事」ロジック | **未完了で最も順番が若い記事**（レッスン全体順） |
| 一覧への追加 | 記事1つ完了で**自動追加** |
| 進捗率の計算 | **記事数ベース**（完了記事数 / 全記事数） |
| レッスン外記事 | 完了ボタンを**非表示**にする |
| 既存データ | 対象外（新規実装としてゼロから） |

### 技術設計（シンプル・低負荷）

**基本方針:** DBには進捗情報のみ保存、「次の記事」は表示時に計算

```
【DBテーブル: lesson_progress】
- user_id
- lesson_id
- progress_percent（進捗率）
- status: 'in_progress' | 'completed'
- updated_at

※「次の記事ID」はDBに保存しない
```

**処理フロー:**

```
【記事完了時】
1. article_progress に完了記録を保存
2. lesson_progress の progress_percent を更新
3. 100%なら status を 'completed' に
→ Sanity取得は不要、DBのみで完結

【マイページ表示時】
1. DBから lesson_progress を取得（高速）
2. 進行中レッスン（最新2つ）のみSanityから構造取得
3. 「次の記事」を計算して表示
→ Sanity取得は2レッスン分だけ

【進行中画面（一覧）表示時】
1. DBから全 lesson_progress を取得
2. 進捗率・ステータスのみ表示（「次の記事」は不要）
→ Sanity取得なし、DBのみで高速
```

**なぜこれがシンプルか:**
- 記事完了時: DB更新のみ（Sanity取得なし）
- マイページ: 進行中2件だけSanity取得（軽い）
- 一覧50件: DBのみで表示可能（高速）

### 追加確定事項（2025-12-17）

1. **「進行中」の定義** ✅ 確定
   - `status != 'completed'` のレッスンを `updated_at` 降順でソート
   - 上位2件が「進行中」としてマイページに表示
   - 100%完了後に「レッスンを完了する」を押すと `status = 'completed'` になり、進行中から外れる

2. **一覧での「次の記事」表示** ✅ 確定
   - 一覧では「次の記事」リンクは**不要**（進捗率のみ表示）
   - これにより一覧表示はDBのみで完結し、高速

---

## 更新履歴

| 日付       | 内容     |
| ---------- | -------- |
| 2025-12-17 | Q&A議論を経て決定事項・技術設計をまとめ |
| 2025-12-07 | 初版作成 |
