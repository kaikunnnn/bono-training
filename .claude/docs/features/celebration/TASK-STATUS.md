# 熱血コーチング・セレブレーション機能 タスクステータス

**最終更新**: 2025-12-19

---

## 概要

記事・クエスト・レッスン完了時に、達成感を演出するセレブレーション機能。
3 段階のレベルで異なる演出を行う。

---

## 🎯 開発計画

### Phase 1: 進捗表示バグの修正（優先度：高）

**問題**: マイページで進行中レッスンが3つ並んでしまう

**ゴール**: 進行中は2つまで、その他は「進捗リスト」に表示

#### Step 1-1: 現状調査
- [ ] マイページの進捗表示コンポーネントを特定
- [ ] 現在のデータ取得・表示ロジックを確認
- [ ] 表示条件の仕様を整理

#### Step 1-2: 実装
- [ ] 進行中レッスンを2つまでに制限するロジック追加
- [ ] 「進捗リスト」セクションの作成
  - 完了レッスン（100%）を優先表示
  - その他の進捗ありレッスンを表示
- [ ] スタイル調整

#### Step 1-3: 確認
- [ ] 進行中が2つまでになっているか確認
- [ ] 進捗リストに正しく表示されるか確認

---

### Phase 2: 完了状態の取り消し問題（優先度：高）

**問題**: 100%完了後に記事の完了を外しても、レッスンは「完了」状態のまま

**ゴール**: 状態の整合性を保つ仕組みを実装

#### Step 2-1: 方針決定
- [ ] 以下のオプションから選択:
  - **A案**: 記事完了を外したら自動でレッスン完了状態も解除
  - **B案**: レッスン完了は一度取得したら永続（記事は個別管理）
  - **C案**: 確認ダイアログを出して選択させる

#### Step 2-2: 実装
- [ ] 選択した方針に基づいて実装
- [ ] 関連するDB/状態管理の更新

#### Step 2-3: 確認
- [ ] 完了を外した時の動作確認
- [ ] データ整合性の確認

---

### Phase 3: マイページスタイル調整（優先度：中）

**ゴール**: 完了レッスンの表示を改善

#### Step 3-1: スタイル調整
- [ ] 「進行中」状態での完了部分のスタイル調整
- [ ] 完了レッスン一覧のスタイル調整

#### Step 3-2: 確認
- [ ] 各状態での見た目確認

---

### Phase 4: 機能改善（優先度：低）

#### Step 4-1: ユーザー設定
- [ ] 効果音ON/OFF設定の追加
- [ ] 音量調整機能

#### Step 4-2: メッセージ調整
- [ ] MVP内容の定義
- [ ] 熱血メッセージの最終調整

---

### Phase 5: 将来拡張の設計確認（優先度：低）

#### Step 5-1: 設計レビュー
- [ ] 合計完了数による称号システムの実現可能性確認
- [ ] コース/ロードマップ単位の完了対応可能性確認

#### Step 5-2: 必要に応じてリファクタリング
- [ ] 拡張しやすい設計への変更（必要な場合）

---

## 📊 進捗サマリー

| Phase | タスク | ステータス | 備考 |
|-------|--------|------------|------|
| 1 | 進捗表示バグ修正 | 🔴 未着手 | 優先度：高 |
| 2 | 完了状態の取り消し | 🔴 未着手 | 優先度：高、方針決定が必要 |
| 3 | マイページスタイル | 🔴 未着手 | Phase 1完了後 |
| 4 | 機能改善 | 🔴 未着手 | MVP後でOK |
| 5 | 将来拡張設計 | 🔴 未着手 | MVP後でOK |

**凡例**: 🔴 未着手 / 🟡 進行中 / 🟢 完了

---

## 完了タスク

### レベル 1: 記事完了セレブレーション

- [x] ランダムな熱血メッセージでトースト表示
- [x] 効果音（軽い「ポン」音）

### レベル 2: クエスト完了セレブレーション

- [x] モーダル表示（5 秒後に自動閉じ）
- [x] 手動で閉じるボタン
- [x] 紙吹雪（中規模）
- [x] 効果音（達成感のある「ピロリン ♪」）
- [x] チェックアイコン緑色
- [x] ふわふわアニメーション
- [x] 自動閉じプログレスバー

### レベル 3: レッスン完了セレブレーション

- [x] 全画面モーダル表示
- [x] 手動で閉じるボタンのみ（自動閉じなし）
- [x] 紙吹雪（大規模・連続発射）
- [x] 効果音（ファンファーレ）
- [x] アイコンふわふわアニメーション
- [x] 熱血メッセージ表示

### 開発ツール

- [x] `/dev/celebration` プレビューページ
- [x] 各演出の個別テストボタン
- [x] 紙吹雪テストボタン（小・中・大）
- [x] 効果音テストボタン（記事・クエスト・レッスン）
- [x] スタイル調整ガイド（ファイルパス一覧）

### 統合

- [x] ArticleDetail.tsx への統合
- [x] 完了判定ロジック（記事 → クエスト → レッスン）
- [x] useCelebration フックで一元管理

---

## 参考情報

### Phase 1 の背景（進捗表示バグ）

**現在の表示**:
![alt text](<Screenshot 2025-12-19 at 10.27.08.png>)

**問題点**: 進行中レッスンが3つ並んでしまっている

**期待する動作**:
- 進行中は2つまで
- 完了レッスンは「進捗リスト」に表示
- その他の進捗ありレッスンも「進捗リスト」に表示

---

### Phase 2 の背景（完了状態の取り消し）

**現在の問題**:
- レッスンを100%完了 → レッスン「完了」状態になる
- その後、記事の完了を外す → レッスンは「完了」のまま（データ不整合）

**検討が必要な点**:
- ユーザー体験としてどうあるべきか
- 「完了」は実績として残すべきか、動的に計算すべきか

---

### Phase 5 の背景（将来拡張）

**想定する機能**:
1. 合計完了数に応じた称号付与
2. コース/ロードマップ単位の完了セレブレーション
3. マイページでの実績表示

**現在の設計で対応可能か要確認**

---

## 作成・修正ファイル一覧

### 新規作成

| ファイル                                              | 説明                       |
| ----------------------------------------------------- | -------------------------- |
| `src/lib/celebration-sounds.ts`                       | 効果音（Web Audio API）    |
| `src/lib/celebration-messages.ts`                     | 熱血メッセージ定義         |
| `src/lib/confetti.ts`                                 | 紙吹雪エフェクト           |
| `src/components/celebration/CelebrationModal.tsx`     | レッスン完了モーダル       |
| `src/components/celebration/QuestCompletionModal.tsx` | クエスト完了モーダル       |
| `src/hooks/useCelebration.ts`                         | セレブレーション管理フック |
| `src/pages/dev/CelebrationComponents.tsx`             | 開発プレビューページ       |

### 修正

| ファイル                      | 変更内容             |
| ----------------------------- | -------------------- |
| `src/pages/ArticleDetail.tsx` | セレブレーション統合 |
| `src/App.tsx`                 | dev ルート追加       |
| `tailwind.config.ts`          | success カラー追加   |

---

## 効果音仕様

| レベル       | 音の特徴              | 音階                     |
| ------------ | --------------------- | ------------------------ |
| 記事完了     | 軽い 2 音             | C5 → E5                  |
| クエスト完了 | 上昇 3 音             | C5 → E5 → G5             |
| レッスン完了 | ファンファーレ + 和音 | C5 → E5 → G5 → C6 + 和音 |

---

## テスト方法

### 開発プレビューページ

```
http://localhost:8080/dev/celebration
```

### 個別テスト

- 「記事完了トースト」ボタン → トースト + 効果音
- 「クエスト完了」ボタン → モーダル + 紙吹雪 + 効果音
- 「レッスン完了」ボタン → 全画面モーダル + 紙吹雪 + 効果音

### 実際のフローでテスト

1. 記事ページ (`/articles/[slug]`) を開く
2. 「完了」ボタンをクリック
3. 進捗に応じてセレブレーションが発火

---

## 備考

- 効果音は Web Audio API で生成（外部ファイル不要）
- 紙吹雪は canvas-confetti ライブラリを使用
- モーダルアニメーションは framer-motion を使用
- 2 キーフレーム制限に注意（spring/inertia アニメーション）

---

## 次のアクション

ユーザーによる確認待ち:

1. 実際の完了フローでの動作確認
2. 効果音・演出の調整要望があれば対応
3. 追加機能の要望があれば検討
