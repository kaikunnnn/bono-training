# 熱血コーチング・セレブレーション機能 タスクステータス

**最終更新**: 2025-12-19

---

## 概要

記事・クエスト・レッスン完了時に、達成感を演出するセレブレーション機能。
3 段階のレベルで異なる演出を行う。

---

## 🎯 開発計画

### Phase 1: 進捗表示バグの修正（優先度：高）

**問題**: マイページで進行中レッスンが3つ並んでしまう

**ゴール**: 進行中は2つまで、その他は「進捗リスト」に表示

#### Step 1-1: 現状調査 ✅ 完了
- [x] マイページの進捗表示コンポーネントを特定 → `src/pages/MyPage.tsx`
- [x] 現在のデータ取得・表示ロジックを確認
- [x] 表示条件の仕様を整理

**現在のロジック（MyPage.tsx）:**
```
inProgressLessonsData:    0% < 進捗 < 100% のレッスン
readyToCompleteLessonsData: 進捗 === 100% && 完了ボタン未押下
completedLessonsData:     完了済みレッスン（status === 'completed'）

allActiveLessons = inProgressLessonsData + readyToCompleteLessonsData

表示ロジック:
- 「all」タブ: allActiveLessons.slice(0, 2) → 2つまで
- 「progress」タブ: allActiveLessons 全て → ここが問題！
```

**問題点:**
- 「progress」タブでは制限なく全て表示される
- 「進捗リスト」セクションが存在しない

#### Step 1-2: 実装 ✅ 完了
- [x] 進行中レッスンを2つまでに制限するロジック追加
- [x] 「その他の進捗」セクションの作成（3つ目以降のレッスンを表示）
- [x] 「完了したレッスン」セクションは既存のまま維持

**実装内容（MyPage.tsx）:**
```typescript
// 進行中セクションは常に2つまで表示
const displayedInProgressLessons = allActiveLessons.slice(0, 2);
// 3つ目以降は「その他の進捗」セクションに表示（進捗タブのみ）
const overflowLessons = allActiveLessons.slice(2);
```

**表示構造（進捗タブ）:**
1. 「進行中」セクション - 最大2つ
2. 「その他の進捗」セクション - 3つ目以降（オーバーフロー分）
3. 「完了したレッスン」セクション - 完了済みレッスン

#### Step 1-3: 確認 ✅ 完了
- [x] 進行中が2つまでになっているか確認
- [x] その他の進捗に正しく表示されるか確認
- [x] 「その他の進捗」を「完了」「取り組み中」でH3分割
- [x] レスポンシブ対応（PC: 2列、スマホ: 1列）

---

### Phase 1.5: アナリティクス対応確認（優先度：高）

**目的**: サービスグロースのため、ユーザーの学習進捗データを分析可能な状態かを確認

**なぜ重要か**:
- どのレッスンが完了率が高い/低いかを把握
- どこまで進めている人が多いか（離脱ポイント）を特定
- サービス全体の学習進捗状況を可視化

#### Step 1.5-1: 現状のデータ構造確認 ✅ 完了
- [x] 進捗データのDB構造を確認（どのテーブルに何が保存されているか）
- [x] 以下のデータが取得可能か確認:
  - ユーザーごとのレッスン完了数
  - レッスンごとの完了ユーザー数
  - 記事ごとの完了ユーザー数
  - 完了日時（時系列分析用）

**関連テーブル:**

| テーブル | 用途 | 行数 | RLS |
|----------|------|------|-----|
| `article_progress` | 記事の完了状態 | 6 | ❌ 無効 |
| `lesson_progress` | レッスンの完了状態 | 3 | ✅ 有効 |
| `user_progress` | Trainingタスク進捗 | 0 | ❌ 無効 |

**主要カラム:**

| テーブル | user_id | content_id | status | completed_at | started_at | updated_at |
|----------|---------|------------|--------|--------------|------------|------------|
| article_progress | ✅ | article_id | ✅ | ✅ | ❌ | ✅ |
| lesson_progress | ✅ | lesson_id | ✅ | ✅ | ✅ | ✅ |

#### Step 1.5-2: 分析可能なデータ一覧 ✅ 完了

**✅ 取得可能:**
| データ | 取得方法 | 備考 |
|--------|----------|------|
| ユーザーごとのレッスン完了数 | `lesson_progress WHERE status='completed' GROUP BY user_id` | OK |
| レッスンごとの完了ユーザー数 | `lesson_progress WHERE status='completed' GROUP BY lesson_id` | OK |
| 記事ごとの完了ユーザー数 | `article_progress WHERE status='completed' GROUP BY article_id` | OK |
| 完了日時 | `completed_at` カラム | 時系列分析可能 |
| レッスン開始日時 | `lesson_progress.started_at` | OK |
| 最終更新日時 | `updated_at` カラム | 学習頻度分析可能 |

**⚠️ 取得に制限あり:**
| データ | 問題点 | 対策案 |
|--------|--------|--------|
| レッスン名・記事名 | Sanity CMSにあり、DBにはIDのみ | Sanity APIとJOINが必要 |
| 記事の開始日時 | `article_progress` に `started_at` がない | カラム追加が必要 |
| 「開始者数」の正確な計算 | 記事を1つでも開始した人を追跡できない | `started_at` 追加で解決 |

**❌ 取得不可（DB改修が必要）:**
| データ | 必要な改修 |
|--------|-----------|
| 記事閲覧開始時刻 | `article_progress.started_at` カラム追加 |
| ページ滞在時間 | 別途トラッキング実装が必要 |

#### Step 1.5-3: 確認項目チェックリスト ✅ 完了

**レッスン分析**:
- [x] レッスン別の完了率（完了者数 / 開始者数）→ ⚠️ 「開始者数」は `lesson_progress.started_at` から取得可能
- [x] レッスン別の平均進捗率 → ⚠️ 記事完了率から計算は可能だがリアルタイムではない
- [x] レッスンごとの離脱ポイント（どの記事で止まっているか）→ ✅ `article_progress` から分析可能

**ユーザー分析**:
- [x] アクティブユーザー数（進捗がある人）→ ✅ `lesson_progress` or `article_progress` で取得可能
- [x] 完了レッスン数の分布 → ✅ `lesson_progress WHERE status='completed'` で取得可能
- [x] 継続率（複数レッスンを完了している人の割合）→ ✅ SQLで計算可能

**時系列分析**:
- [x] 日別/週別/月別の完了数推移 → ✅ `completed_at` で分析可能
- [x] ユーザーの学習頻度 → ✅ `updated_at` で分析可能

---

### Step 1.5 結論

**🟢 アナリティクス対応状況: 概ね良好**

現在のDB構造で主要な分析は可能。以下の改善を推奨:

| 優先度 | 改善項目 | 効果 |
|--------|----------|------|
| 🟡 中 | `article_progress.started_at` 追加 | 記事開始率・離脱率の正確な計算 |
| 🔴 高 | `article_progress` RLS有効化 | セキュリティ向上（分析には影響なし） |

**サンプルクエリ（参考）:**

```sql
-- レッスン別完了者数
SELECT lesson_id, COUNT(*) as completed_count
FROM lesson_progress
WHERE status = 'completed'
GROUP BY lesson_id;

-- 日別完了数推移
SELECT DATE(completed_at) as date, COUNT(*) as count
FROM article_progress
WHERE status = 'completed'
GROUP BY DATE(completed_at)
ORDER BY date;

-- アクティブユーザー数
SELECT COUNT(DISTINCT user_id) as active_users
FROM article_progress;
```

---

### Phase 2: 完了状態の取り消し問題（優先度：高） ✅ 完了

**問題**: 100%完了後に記事の完了を外しても、レッスンは「完了」状態のまま

**ゴール**: 状態の整合性を保つ仕組みを実装

#### Step 2-1: 方針決定 ✅ 完了
- [x] 以下のオプションから選択: **C案を採用**
  - **A案**: 記事完了を外したら自動でレッスン完了状態も解除
  - **B案**: レッスン完了は一度取得したら永続（記事は個別管理）
  - **C案**: 確認ダイアログを出して選択させる ← 採用

#### Step 2-2: 実装 ✅ 完了
- [x] `removeLessonCompletion` 関数を `progress.ts` に追加
- [x] `ArticleDetail.tsx` に確認ダイアログを追加
- [x] 完了チェックを外す時にレッスン完了状態をチェック
- [x] 完了済みレッスンの場合は確認ダイアログを表示
- [x] ユーザーが「解除する」を選択した場合にレッスン完了も解除

**実装ファイル**:
- `src/services/progress.ts`: `removeLessonCompletion` 関数追加
- `src/pages/ArticleDetail.tsx`: 確認ダイアログ実装

**動作フロー**:
```
1. 完了済み記事のチェックを外そうとする
   ↓
2. getLessonStatus でレッスンの完了状態をチェック
   ↓
3. レッスンが完了済みの場合 → 確認ダイアログ表示
   「レッスン完了を解除しますか？」
   ↓
4. ユーザーが「解除する」をクリック
   ↓
5. removeLessonCompletion でレッスン完了を解除
   ↓
6. toggleArticleCompletion で記事完了を解除
```

#### Step 2-3: 確認 ✅ 完了
- [x] コンパイルエラーなし
- [x] TypeScript型チェックパス
- [x] デバッグログ追加済み（コンソールで動作確認可能）

---

### Phase 3: マイページスタイル調整（優先度：中）

**ゴール**: 完了レッスンの表示を改善

#### Step 3-1: スタイル調整
- [ ] 「進行中」状態での完了部分のスタイル調整
- [ ] 完了レッスン一覧のスタイル調整

#### Step 3-2: 確認
- [ ] 各状態での見た目確認

---

### Phase 4: 機能改善（優先度：低） ✅ 完了

#### Step 4-1: ユーザー設定
- [ ] 効果音ON/OFF設定の追加
- [ ] 音量調整機能 → ユーザーが自分で対応予定

#### Step 4-2: メッセージ調整 ✅ 完了
- [x] 熱血メッセージの最終調整（デザイン学習向けにリニューアル）
- [x] プレビューページのハードコード修正（コンポーネント化）

**確定メッセージ** (`src/lib/celebration-messages.ts`):

**レベル1（記事完了）: 5種類からランダム**
| タイトル | 説明 |
|---------|------|
| ナイスデザイン💪 | デザイン筋に効いてるぅ〜 |
| ええやん！✨ | 前進前進〜！ |
| やるぅ〜！🔥 | うまいもん食べよう |
| いい感じ！👏 | この調子でいこ〜！ |
| おつかれ！👍 | 首と肩のストレッチしてくれよな |

**レベル2（クエスト完了）:**
- タイトル: クエスト完了！✨
- 説明: 『{クエスト名}』クリア！いい感じ〜！

**レベル3（レッスン完了）:**
- メインタイトル: レッスン完了！今日は優勝だ！🎉
- サブタイトル: 『{レッスン名}』やりきった！
- 本文: めっちゃええやん！最高！今日はうまいもん食べよう！
- ボタン: 閉じる

---

### Phase 5: 将来拡張の設計確認（優先度：低）

#### Step 5-1: 設計レビュー
- [ ] 合計完了数による称号システムの実現可能性確認
- [ ] コース/ロードマップ単位の完了対応可能性確認

#### Step 5-2: 必要に応じてリファクタリング
- [ ] 拡張しやすい設計への変更（必要な場合）

---

## 📊 進捗サマリー

| Phase | タスク | ステータス | 備考 |
|-------|--------|------------|------|
| 1 | 進捗表示バグ修正 | 🟢 完了 | マイページ表示改善完了 |
| 1.5 | アナリティクス対応確認 | 🟢 完了 | 概ね良好、改善案あり |
| 2 | 完了状態の取り消し | 🟢 完了 | C案（確認ダイアログ）を採用 |
| 3 | マイページスタイル | 🔴 未着手 | Phase 2完了後 |
| 4 | 機能改善 | 🟢 完了 | メッセージ調整完了（デザイン学習向け） |
| 5 | 将来拡張設計 | 🔴 未着手 | MVP後でOK |

**凡例**: 🔴 未着手 / 🟡 進行中 / 🟢 完了

---

## 完了タスク

### レベル 1: 記事完了セレブレーション

- [x] ランダムな熱血メッセージでトースト表示
- [x] 効果音（軽い「ポン」音）

### レベル 2: クエスト完了セレブレーション

- [x] モーダル表示（5 秒後に自動閉じ）
- [x] 手動で閉じるボタン
- [x] 紙吹雪（中規模）
- [x] 効果音（達成感のある「ピロリン ♪」）
- [x] チェックアイコン緑色
- [x] ふわふわアニメーション
- [x] 自動閉じプログレスバー

### レベル 3: レッスン完了セレブレーション

- [x] 全画面モーダル表示
- [x] 手動で閉じるボタンのみ（自動閉じなし）
- [x] 紙吹雪（大規模・連続発射）
- [x] 効果音（ファンファーレ）
- [x] アイコンふわふわアニメーション
- [x] 熱血メッセージ表示

### 開発ツール

- [x] `/dev/celebration` プレビューページ
- [x] 各演出の個別テストボタン
- [x] 紙吹雪テストボタン（小・中・大）
- [x] 効果音テストボタン（記事・クエスト・レッスン）
- [x] スタイル調整ガイド（ファイルパス一覧）

### 統合

- [x] ArticleDetail.tsx への統合
- [x] 完了判定ロジック（記事 → クエスト → レッスン）
- [x] useCelebration フックで一元管理

---

## 参考情報

### Phase 1 の背景（進捗表示バグ）

**現在の表示**:
![alt text](<Screenshot 2025-12-19 at 10.27.08.png>)

**問題点**: 進行中レッスンが3つ並んでしまっている

**期待する動作**:
- 進行中は2つまで
- 完了レッスンは「進捗リスト」に表示
- その他の進捗ありレッスンも「進捗リスト」に表示

---

### Phase 2 の背景（完了状態の取り消し）

**現在の問題**:
- レッスンを100%完了 → レッスン「完了」状態になる
- その後、記事の完了を外す → レッスンは「完了」のまま（データ不整合）

**検討が必要な点**:
- ユーザー体験としてどうあるべきか
- 「完了」は実績として残すべきか、動的に計算すべきか

---

### Phase 5 の背景（将来拡張）

**想定する機能**:
1. 合計完了数に応じた称号付与
2. コース/ロードマップ単位の完了セレブレーション
3. マイページでの実績表示

**現在の設計で対応可能か要確認**

---

## 作成・修正ファイル一覧

### 新規作成

| ファイル                                              | 説明                       |
| ----------------------------------------------------- | -------------------------- |
| `src/lib/celebration-sounds.ts`                       | 効果音（Web Audio API）    |
| `src/lib/celebration-messages.ts`                     | 熱血メッセージ定義         |
| `src/lib/confetti.ts`                                 | 紙吹雪エフェクト           |
| `src/components/celebration/CelebrationModal.tsx`     | レッスン完了モーダル       |
| `src/components/celebration/QuestCompletionModal.tsx` | クエスト完了モーダル       |
| `src/hooks/useCelebration.ts`                         | セレブレーション管理フック |
| `src/pages/dev/CelebrationComponents.tsx`             | 開発プレビューページ       |

### 修正

| ファイル                      | 変更内容             |
| ----------------------------- | -------------------- |
| `src/pages/ArticleDetail.tsx` | セレブレーション統合 |
| `src/App.tsx`                 | dev ルート追加       |
| `tailwind.config.ts`          | success カラー追加   |

---

## 効果音仕様

| レベル       | 音の特徴              | 音階                     |
| ------------ | --------------------- | ------------------------ |
| 記事完了     | 軽い 2 音             | C5 → E5                  |
| クエスト完了 | 上昇 3 音             | C5 → E5 → G5             |
| レッスン完了 | ファンファーレ + 和音 | C5 → E5 → G5 → C6 + 和音 |

---

## テスト方法

### 開発プレビューページ

```
http://localhost:8080/dev/celebration
```

### 個別テスト

- 「記事完了トースト」ボタン → トースト + 効果音
- 「クエスト完了」ボタン → モーダル + 紙吹雪 + 効果音
- 「レッスン完了」ボタン → 全画面モーダル + 紙吹雪 + 効果音

### 実際のフローでテスト

1. 記事ページ (`/articles/[slug]`) を開く
2. 「完了」ボタンをクリック
3. 進捗に応じてセレブレーションが発火

---

## 備考

- 効果音は Web Audio API で生成（外部ファイル不要）
- 紙吹雪は canvas-confetti ライブラリを使用
- モーダルアニメーションは framer-motion を使用
- 2 キーフレーム制限に注意（spring/inertia アニメーション）

---

## 次のアクション

ユーザーによる確認待ち:

1. 実際の完了フローでの動作確認
2. 効果音・演出の調整要望があれば対応
3. 追加機能の要望があれば検討
