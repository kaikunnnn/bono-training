# 熱血コーチング・セレブレーション機能 実装計画

**作成日**: 2025-12-18
**ステータス**: 計画中

---

## 1. 現状分析

### 1.1 実装済み機能

| 機能 | 状態 | 詳細 |
|------|------|------|
| 記事完了トグル | ✅ 実装済み | `toggleArticleCompletion()` + トースト |
| レッスン完了マーク | ✅ 実装済み | `markLessonAsCompleted()` + トースト |
| クエスト完了判定 | ⚠️ UIのみ | DB保存なし、通知なし |
| confetti演出 | ❌ 未実装 | ライブラリなし |
| 完了モーダル | ❌ 未実装 | なし |

### 1.2 問題点

1. **クエスト完了時の演出がない** - 全記事完了してもモーダル表示されない
2. **レッスン完了時のモーダルがない** - トーストのみ
3. **熱血演出がない** - 紙吹雪・アニメーションなし

---

## 2. 仕様（熱血コーチング・セレブレーション）

### レベル1: 記事完了（小目標達成）
- **トリガー**: 記事を「完了」にした瞬間
- **演出**: トースト通知（sonner）
- **デザイン**: 薄い赤背景
- **文言例**:
  - 「いい汗かいたな！」
  - 「昨日の自分より強くなってるぞ！」
  - 「ナイスバルク！」

### レベル2: クエスト完了（中目標達成）
- **トリガー**: クエスト内の全記事を完了した瞬間
- **演出**:
  - 派手なトースト（赤枠・太文字）
  - 紙吹雪（少量 particleCount: 100）
- **デザイン**:
  - 枠線: `border-red-500`
  - 背景: `bg-red-50`
  - アイコン: 🔥（炎）
- **文言**:
  - タイトル: 「ナイスマッスル！！」
  - 詳細: 「その調子だ！『〇〇』という高い壁を越えたな！」

### レベル3: レッスン完了（完全制覇）
- **トリガー**: 全進捗100%達成後（0.5秒のタメ）
- **演出**: 全画面モーダル
- **デザイン**:
  - グラデーション: `from-red-50 to-white`
  - アイコン: 🔥（中央）、⚡🏆（周囲）
  - アニメーション: Spring Animation
  - 紙吹雪: 断続的に左右から発射
- **文言**:
  - タイトル: 「優勝だ！！お前がNo.1だ！！」
  - 本文: 「素晴らしい！その情熱が奇跡を起こしたんだ！今日は焼き肉だ！！」
  - サブ: 「限界を超えて全てのメニューを消化しました！」
- **ボタン**: 「次の大会へ！」（`bg-red-600`）

---

## 3. 技術スタック

| 用途 | ライブラリ | 状態 |
|------|-----------|------|
| アイコン | lucide-react (Flame, Zap, Trophy) | ✅ 導入済み |
| アニメーション | motion/react (framer-motion) | ⚠️ 要確認 |
| 紙吹雪 | canvas-confetti | ❌ 要インストール |
| トースト | sonner | ✅ 導入済み |
| モーダル | Radix UI Dialog | ✅ 導入済み |

---

## 4. 実装タスク一覧

### Phase 1: 準備（依存関係）
| # | タスク | 工数 | 優先度 |
|---|--------|------|--------|
| 1.1 | canvas-confetti インストール | 5min | 🔴 |
| 1.2 | framer-motion 確認・インストール | 5min | 🔴 |

### Phase 2: レベル1 - 記事完了トースト改善
| # | タスク | 工数 | 優先度 |
|---|--------|------|--------|
| 2.1 | 熱血メッセージ配列作成 | 10min | 🟡 |
| 2.2 | トーストスタイル変更（赤背景） | 15min | 🟡 |
| 2.3 | ランダムメッセージ表示実装 | 10min | 🟡 |

### Phase 3: レベル2 - クエスト完了演出
| # | タスク | 工数 | 優先度 |
|---|--------|------|--------|
| 3.1 | クエスト完了検知ロジック実装 | 30min | 🔴 |
| 3.2 | 派手なトーストコンポーネント作成 | 30min | 🔴 |
| 3.3 | confetti 発射ユーティリティ作成 | 20min | 🔴 |
| 3.4 | ArticleDetail に検知・演出統合 | 30min | 🔴 |

### Phase 4: レベル3 - レッスン完了モーダル
| # | タスク | 工数 | 優先度 |
|---|--------|------|--------|
| 4.1 | CelebrationModal コンポーネント作成 | 1h | 🔴 |
| 4.2 | アイコンアニメーション実装 | 30min | 🟡 |
| 4.3 | 紙吹雪連続演出実装 | 20min | 🟡 |
| 4.4 | MyPage / LessonDetail に統合 | 30min | 🔴 |

### Phase 5: テスト・調整
| # | タスク | 工数 | 優先度 |
|---|--------|------|--------|
| 5.1 | 全レベル動作確認 | 30min | 🔴 |
| 5.2 | アニメーション調整 | 20min | 🟡 |
| 5.3 | レスポンシブ確認 | 15min | 🟡 |

---

## 5. 実装順序（推奨）

```
Phase 1: 準備
    ↓
Phase 3: クエスト完了（ユーザーが困っている問題）
    ↓
Phase 4: レッスン完了モーダル
    ↓
Phase 2: 記事完了トースト改善
    ↓
Phase 5: テスト
```

**理由**: ユーザーが「クエスト完了モーダルが見えない」と報告しているため、Phase 3を優先。

---

## 6. ファイル構成（実装済み）

```
src/
├── components/
│   ├── celebration/
│   │   └── CelebrationModal.tsx      # ✅ レッスン完了モーダル
│   └── ui/
│       └── toast.tsx                 # ✅ celebrationバリアント追加
├── hooks/
│   └── useCelebration.ts             # ✅ 演出管理フック
├── lib/
│   ├── confetti.ts                   # ✅ 紙吹雪ユーティリティ
│   └── celebration-messages.ts       # ✅ 熱血メッセージ定義
└── pages/
    └── ArticleDetail.tsx             # ✅ セレブレーション統合
```

---

## 7. 進捗トラッキング

### 現在のフェーズ: ✅ 実装完了

| タスク | 状態 | 完了日 |
|--------|------|--------|
| 1.1 canvas-confetti インストール | ✅ 完了 | 2025-12-18 |
| 1.2 framer-motion 確認 | ✅ 完了 | 2025-12-18 |
| 3.1 クエスト完了検知ロジック | ✅ 完了 | 2025-12-18 |
| 3.2 派手トーストバリアント追加 | ✅ 完了 | 2025-12-18 |
| 3.3 confetti発射ユーティリティ | ✅ 完了 | 2025-12-18 |
| 3.4 ArticleDetail統合 | ✅ 完了 | 2025-12-18 |
| 4.1 CelebrationModal作成 | ✅ 完了 | 2025-12-18 |
| 5.1 動作確認（デバッグログ追加） | ✅ 完了 | 2025-12-18 |

---

## 8. テスト手順

### ブラウザでのテスト方法

1. **開発サーバー起動**: http://localhost:8080/
2. **ログイン**: テストアカウントでログイン
3. **記事ページに移動**: レッスン → クエスト → 記事 の順で遷移
4. **ブラウザのDevToolsを開く**: Console タブを表示
5. **完了ボタンをクリック**: 記事の完了ボタンをクリック
6. **Console ログを確認**: `[Celebration Debug]` のログでデータフローを確認

### 期待される動作

| レベル | トリガー | 演出 | Console ログ |
|--------|----------|------|--------------|
| Level 1 | 記事完了（クエスト未完了） | トースト | `[Celebration] ✅ Article Complete` |
| Level 2 | クエスト内全記事完了 | トースト + 紙吹雪 | `[Celebration] 🔥 Quest Complete!` |
| Level 3 | レッスン100%達成 | モーダル + 紙吹雪連続 | `[Celebration] 🎉 Lesson Complete!` |

### デバッグログの確認項目

```javascript
[Celebration Debug] {
  currentArticleId: "...",     // 現在の記事ID
  currentQuestId: "...",       // 現在のクエストID（undefinedなら問題）
  currentQuestTitle: "...",    // クエストタイトル
  questArticleMap: {...},      // クエストIDと記事IDのマッピング
  progress: {                  // 進捗データ
    completedArticleIds: [...],
    percentage: 50
  },
  lessonQuests: [...]          // レッスン内のクエスト一覧
}
```

### 問題が発生した場合

1. **`currentQuestId` が `undefined`**: Sanityのデータ構造を確認
2. **`questArticleMap` にクエストがない**: クエストと記事の参照関係を確認
3. **`progress` が空**: Supabaseのローカル環境を確認

---

## 9. 注意事項

### セキュリティ（RLS）について
- 現在 `article_progress`, `lesson_progress` テーブルの RLS が無効
- この機能実装後、別途セキュリティ修正を行う予定
- 本機能はフロントエンドのみの変更のため、RLS問題には影響しない

### レース条件について
- `toggleArticleCompletion` に潜在的なレース条件あり
- 本機能実装とは別途対応予定

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2025-12-18 | 初版作成 |
