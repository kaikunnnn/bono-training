# レッスン完了機能 調査計画

**作成日**: 2025-12-06
**目的**: 現状のレッスン完了機能の技術的な問題点を洗い出す

---

## 調査の背景

レッスンの「完了」ボタンを押すと、レッスンごとに進捗が溜まっていく機能がある。
この実装に技術的な問題がないか調査する。

---

## 調査フェーズ

### Phase 1: フロントエンド実装の調査

**目的**: 完了ボタンがどのように実装されているか把握する

**調査項目**:
1. 完了ボタンのコンポーネント特定
2. ボタンクリック時のイベントハンドラ
3. API呼び出しの実装
4. 楽観的更新 or 悲観的更新の確認
5. エラーハンドリングの実装

**検索キーワード**:
- `complete`, `completed`, `progress`
- `lesson`, `article`
- `markAsComplete`, `markComplete`

**出力**: `current-implementation.md` の「フロントエンド」セクション

---

### Phase 2: データベース構造の調査

**目的**: 進捗データがどのように保存されているか把握する

**調査項目**:
1. 進捗を保存するテーブルの特定
2. テーブルのカラム構造
3. インデックスの設定
4. RLS（Row Level Security）ポリシー
5. 外部キー制約

**調査方法**:
- `supabase/migrations/` 内のマイグレーションファイル
- MCP経由でのテーブル構造確認（mcp:enable後）

**出力**: `database-schema.md`

---

### Phase 3: データフロー・状態管理の調査

**目的**: データの流れと状態管理を把握する

**調査項目**:
1. Context / Provider の実装
2. React Query / SWR の使用有無
3. 進捗データの取得タイミング
4. キャッシュ戦略
5. 状態の同期方法

**出力**: `data-flow.md`

---

### Phase 4: 潜在的問題の分析

**目的**: 技術的な問題点を洗い出す

**分析観点**:

#### セキュリティ
- [ ] 認証なしでの進捗登録が可能か
- [ ] 他ユーザーの進捗を操作可能か
- [ ] RLSが適切に設定されているか

#### データ整合性
- [ ] 同じレッスンの重複完了が可能か
- [ ] 存在しないレッスンIDで完了可能か
- [ ] 競合状態（race condition）の可能性

#### パフォーマンス
- [ ] N+1問題の有無
- [ ] 適切なインデックスがあるか
- [ ] 不要な再レンダリングがないか

#### エラーハンドリング
- [ ] 通信エラー時のUI挙動
- [ ] リトライ機能の有無
- [ ] オフライン対応

**出力**: `potential-issues.md`

---

### Phase 5: 調査結果のまとめ

**目的**: 調査結果を整理し、次のアクションを決定する

**作業内容**:
1. 各ドキュメントの完成確認
2. 問題点の優先順位付け
3. 改善提案の作成
4. CLAUDE.md の更新（進捗機能セクション追加）

**出力**:
- `README.md` の更新
- `TASK-TRACKER.md` の作成（必要に応じて）
- `.claude/CLAUDE.md` の更新

---

## 調査の進め方

```
1. コードベースの検索（Grep/Glob）
   ↓
2. 関連ファイルの読み込み（Read）
   ↓
3. 発見事項をドキュメントに記録（Write）
   ↓
4. 次のPhaseへ
```

---

## 注意事項

- **MCP使用時**: 本番DBを参照するため、`npm run mcp:enable` 後は読み取り専用で使用
- **変更禁止**: 調査フェーズでは実装変更を行わない
- **記録重視**: 発見事項は全てドキュメントに記録する

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2025-12-06 | 調査計画作成 |
