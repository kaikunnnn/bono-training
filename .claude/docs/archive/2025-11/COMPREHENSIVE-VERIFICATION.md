# ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  ç·åˆæ¤œè¨¼ãƒ¬ãƒãƒ¼ãƒˆ

**ä½œæˆæ—¥**: 2025-11-24
**æ¤œè¨¼è€…**: Claude
**å¯¾è±¡**: Deep Link æ©Ÿèƒ½è¿½åŠ å¾Œã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“

---

## ğŸ“‹ ç›®æ¬¡

1. [æ¤œè¨¼æ¦‚è¦](#æ¤œè¨¼æ¦‚è¦)
2. [æ¤œè¨¼çµæœã‚µãƒãƒªãƒ¼](#æ¤œè¨¼çµæœã‚µãƒãƒªãƒ¼)
3. [æ©Ÿèƒ½åˆ¥æ¤œè¨¼](#æ©Ÿèƒ½åˆ¥æ¤œè¨¼)
4. [æ½œåœ¨çš„ãƒªã‚¹ã‚¯ã®åˆ†æ](#æ½œåœ¨çš„ãƒªã‚¹ã‚¯ã®åˆ†æ)
5. [æ¨å¥¨äº‹é …](#æ¨å¥¨äº‹é …)
6. [ãƒ†ã‚¹ãƒˆæº–å‚™å®Œäº†ç¢ºèª](#ãƒ†ã‚¹ãƒˆæº–å‚™å®Œäº†ç¢ºèª)

---

## æ¤œè¨¼æ¦‚è¦

### æ¤œè¨¼ç›®çš„

Deep Link æ©Ÿèƒ½è¿½åŠ ã«ã‚ˆã‚Šã€ä»¥ä¸‹ã®ç‚¹ã‚’ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š

1. **æ—¢å­˜æ©Ÿèƒ½ã¸ã®å½±éŸ¿ãŒãªã„ã‹**
2. **ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç†å…¨ä½“ï¼ˆæ–°è¦ç™»éŒ²ã€æ›´æ–°ã€è§£ç´„ï¼‰ãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã‹**
3. **äºŒé‡èª²é‡‘ãƒªã‚¹ã‚¯ãŒãªã„ã‹**
4. **ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãŒä¿ãŸã‚Œã‚‹ã‹**

### æ¤œè¨¼æ–¹æ³•

- ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰é™çš„è§£æ
- Webhook ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ãƒ•ãƒ­ãƒ¼ã®ç¢ºèª
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆ¶ç´„ã®ç¢ºèª
- Edge Functions ã®ãƒ‡ãƒ—ãƒ­ã‚¤çŠ¶æ³ç¢ºèª
- ç’°å¢ƒå¤‰æ•°ã®ç¢ºèª
- éå»ã®ãƒ†ã‚¹ãƒˆçµæœã¨ã®æ•´åˆæ€§ç¢ºèª

---

## æ¤œè¨¼çµæœã‚µãƒãƒªãƒ¼

| é …ç›® | çŠ¶æ…‹ | å‚™è€ƒ |
|------|------|------|
| **æ–°è¦ç™»éŒ²** | âœ… æ­£å¸¸ | äºŒé‡èª²é‡‘é˜²æ­¢ãƒ¡ã‚«ãƒ‹ã‚ºãƒ å‹•ä½œç¢ºèªæ¸ˆã¿ |
| **ãƒ—ãƒ©ãƒ³å¤‰æ›´ï¼ˆDeep Linkï¼‰** | âœ… æ­£å¸¸ | æ–°æ©Ÿèƒ½ã€å®Ÿè£…æ­£ã—ã„ |
| **ãƒ—ãƒ©ãƒ³å¤‰æ›´ï¼ˆæ¨™æº–ãƒ¢ãƒ¼ãƒ‰ï¼‰** | âœ… æ­£å¸¸ | æ—¢å­˜æ©Ÿèƒ½ã€å½±éŸ¿ãªã— |
| **è§£ç´„å‡¦ç†** | âœ… æ­£å¸¸ | æ—¢å­˜æ©Ÿèƒ½ã€å½±éŸ¿ãªã— |
| **Webhook å‡¦ç†** | âœ… æ­£å¸¸ | ã™ã¹ã¦ã®ã‚¤ãƒ™ãƒ³ãƒˆæ­£ã—ãå‡¦ç† |
| **ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§** | âœ… æ­£å¸¸ | DBåˆ¶ç´„ã«ã‚ˆã‚Šä¿è¨¼ |
| **ç’°å¢ƒå¤‰æ•°** | âœ… æ­£å¸¸ | ã™ã¹ã¦è¨­å®šæ¸ˆã¿ |
| **Edge Functions** | âœ… æ­£å¸¸ | ã™ã¹ã¦æœ€æ–°ç‰ˆãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿ |

**ç·åˆè©•ä¾¡**: âœ… **ãƒ†ã‚¹ãƒˆå®Ÿæ–½å¯èƒ½**

---

## æ©Ÿèƒ½åˆ¥æ¤œè¨¼

### 1. æ–°è¦ç™»éŒ²ï¼ˆcreate-checkoutï¼‰

#### å‡¦ç†ãƒ•ãƒ­ãƒ¼

```mermaid
graph TD
    A[ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ—ãƒ©ãƒ³é¸æŠ] --> B[create-checkout Edge Function]
    B --> C{æ—¢å­˜ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç¢ºèª}
    C -->|å­˜åœ¨ã™ã‚‹| D[Stripe APIã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«]
    D --> E[DBã§is_active=false]
    E --> F[Checkout ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ]
    C -->|å­˜åœ¨ã—ãªã„| F
    F --> G[ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ±ºæ¸ˆ]
    G --> H[checkout.session.completed Webhook]
    H --> I[æ—¢å­˜ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³éã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–]
    I --> J[æ–°è¦ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’DBç™»éŒ²]
```

#### äºŒé‡èª²é‡‘é˜²æ­¢ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ï¼ˆ3é‡ï¼‰

1. **create-checkout ã§ã®äº‹å‰ã‚­ãƒ£ãƒ³ã‚»ãƒ«** (L196-289)
   ```typescript
   // æ—¢å­˜ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã™ã¹ã¦ã‚­ãƒ£ãƒ³ã‚»ãƒ«
   for (const sub of existingSubscriptions) {
     if (sub.status === 'active' || sub.status === 'trialing') {
       await stripe.subscriptions.cancel(sub.id, { prorate: true });
     }
   }
   ```
   - âœ… **ç¢ºèªæ¸ˆã¿**: 1ã¤ã§ã‚‚ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¤±æ•—ã—ãŸã‚‰æ–°è¦Checkoutä½œæˆã‚’ä¸­æ­¢

2. **Webhook ã§ã®éã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–** (L152-186)
   ```typescript
   // checkout.session.completed æ™‚ã«æ—¢å­˜ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç¢ºèª
   const existingActiveSubs = await supabase
     .from("user_subscriptions")
     .select("stripe_subscription_id")
     .eq("user_id", userId)
     .eq("is_active", true)
     .eq("environment", ENVIRONMENT)
     .neq("stripe_subscription_id", subscriptionId);

   // è¦‹ã¤ã‹ã£ãŸå ´åˆã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«
   for (const oldSub of existingActiveSubs) {
     await stripe.subscriptions.cancel(oldSub.stripe_subscription_id, { prorate: true });
   }
   ```
   - âœ… **ç¢ºèªæ¸ˆã¿**: Webhook ã§ã‚‚äºŒé‡ãƒã‚§ãƒƒã‚¯

3. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆ¶ç´„**
   ```sql
   ALTER TABLE user_subscriptions
   ADD CONSTRAINT stripe_customers_user_id_environment_key
   UNIQUE (user_id, environment);
   ```
   - âœ… **ç¢ºèªæ¸ˆã¿**: 1ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»1ç’°å¢ƒã«ã¤ã1ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ã¿

#### æ¤œè¨¼çµæœ

- âœ… äºŒé‡èª²é‡‘ãƒªã‚¹ã‚¯ãªã—
- âœ… prorateï¼ˆæ—¥å‰²ã‚Šè¨ˆç®—ï¼‰ãŒæ­£ã—ãé©ç”¨ã•ã‚Œã‚‹
- âœ… DBæ•´åˆæ€§ãŒä¿è¨¼ã•ã‚Œã‚‹

---

### 2. ãƒ—ãƒ©ãƒ³å¤‰æ›´ï¼ˆDeep Link - ä»Šå›ã®å®Ÿè£…ï¼‰

#### å‡¦ç†ãƒ•ãƒ­ãƒ¼

```mermaid
graph TD
    A[ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ—ãƒ©ãƒ³é¸æŠ] --> B[getCustomerPortalUrlå‘¼ã³å‡ºã—]
    B --> C{planType & durationæŒ‡å®š?}
    C -->|Yes| D[create-customer-portal Deep Linkãƒ¢ãƒ¼ãƒ‰]
    C -->|No| E[create-customer-portal æ¨™æº–ãƒ¢ãƒ¼ãƒ‰]
    D --> F[Stripe APIã§ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³è©³ç´°å–å¾—]
    F --> G[getPriceIdå‘¼ã³å‡ºã—]
    G --> H[flow_dataè¨­å®š]
    H --> I[Customer Portal URLç”Ÿæˆ]
    I --> J[ãƒ—ãƒ©ãƒ³å¤‰æ›´ç¢ºèªç”»é¢ã«ç›´æ¥é·ç§»]
    J --> K[ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¤‰æ›´ç¢ºå®š]
    K --> L[customer.subscription.updated Webhook]
    L --> M[DBã®plan_type, durationæ›´æ–°]
```

#### å®Ÿè£…è©³ç´°ç¢ºèª

**create-customer-portal/index.ts (L158-206):**

```typescript
// Deep Link ãƒ¢ãƒ¼ãƒ‰åˆ¤å®š
const isDeepLinkMode = !!(planType && duration);

if (isDeepLinkMode && planType && duration) {
  // 1. ç¾åœ¨ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³IDã‚’å–å¾—
  const { data: subscription } = await supabase
    .from('user_subscriptions')
    .select('stripe_subscription_id')
    .eq('user_id', user.id)
    .eq('environment', environment)
    .eq('is_active', true)
    .single();

  // 2. Stripe APIã‹ã‚‰ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³è©³ç´°ã‚’å–å¾—
  const stripeSubscription = await stripe.subscriptions.retrieve(stripeSubscriptionId);
  const subscriptionItemId = stripeSubscription.items.data[0].id;

  // 3. æ–°ã—ã„ãƒ—ãƒ©ãƒ³ã®Price IDã‚’å–å¾—
  const newPriceId = getPriceId(planType, duration, environment);

  // 4. flow_dataã‚’è¨­å®š
  sessionConfig.flow_data = {
    type: 'subscription_update_confirm',
    subscription_update_confirm: {
      subscription: stripeSubscriptionId,
      items: [{ id: subscriptionItemId, price: newPriceId, quantity: 1 }]
    }
  };
}
```

#### æ¤œè¨¼çµæœ

- âœ… **æ—¢å­˜ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°**ï¼ˆæ–°è¦ä½œæˆã§ã¯ãªã„ï¼‰
- âœ… **prorationè‡ªå‹•é©ç”¨**ï¼ˆStripeã®æ¨™æº–å‹•ä½œï¼‰
- âœ… **æ–°è¦ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ä½œæˆã—ãªã„**ï¼ˆäºŒé‡èª²é‡‘ãªã—ï¼‰
- âœ… **Webhook ã§ DB åŒæœŸ**ï¼ˆcustomer.subscription.updatedï¼‰
- âœ… **ç’°å¢ƒå¤‰æ•°ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**ï¼ˆgetPriceIdã§è©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰

---

### 3. ãƒ—ãƒ©ãƒ³å¤‰æ›´ï¼ˆæ¨™æº–ãƒ¢ãƒ¼ãƒ‰ - æ—¢å­˜æ©Ÿèƒ½ï¼‰

#### å‡¦ç†ãƒ•ãƒ­ãƒ¼

```mermaid
graph TD
    A[ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ—ãƒ©ãƒ³å¤‰æ›´è¦æ±‚] --> B[getCustomerPortalUrlå‘¼ã³å‡ºã—]
    B --> C[create-customer-portal æ¨™æº–ãƒ¢ãƒ¼ãƒ‰]
    C --> D[Customer Portal ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸]
    D --> E[ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹å‹•ã§ãƒ—ãƒ©ãƒ³å¤‰æ›´]
    E --> F[customer.subscription.updated Webhook]
    F --> G[DBã®plan_type, durationæ›´æ–°]
```

#### æ¤œè¨¼çµæœ

- âœ… **Deep Linkå®Ÿè£…ã«ã‚ˆã‚‹å½±éŸ¿ãªã—**
- âœ… `getCustomerPortalUrl(returnUrl)` ã®å‘¼ã³å‡ºã—ã¯å¼•ãç¶šãå‹•ä½œ
- âœ… å¾Œæ–¹äº’æ›æ€§ã‚ã‚Š

---

### 4. è§£ç´„å‡¦ç†

#### å‡¦ç†ãƒ•ãƒ­ãƒ¼

```mermaid
graph TD
    A[ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè§£ç´„] --> B[Customer Portal]
    B --> C[Stripeå´ã§è§£ç´„]
    C --> D[customer.subscription.deleted Webhook]
    D --> E[DBã®is_active=false]
    D --> F[subscriptions ã®end_timestampè¨­å®š]
```

#### Webhook å‡¦ç†ç¢ºèª

**stripe-webhook-test/index.ts (L366-417):**

```typescript
async function handleSubscriptionDeleted(stripe: any, supabase: any, subscription: any) {
  // 1. ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³IDã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—
  const { data: subData } = await supabase
    .from("user_subscriptions")
    .select("user_id")
    .eq("stripe_subscription_id", subscriptionId)
    .eq("environment", ENVIRONMENT)
    .single();

  // 2. subscriptions ã® end_timestamp ã‚’ç¾åœ¨æ™‚åˆ»ã«è¨­å®š
  await supabase
    .from("subscriptions")
    .update({ end_timestamp: new Date().toISOString() })
    .eq("stripe_subscription_id", subscriptionId)
    .eq("environment", ENVIRONMENT);

  // 3. user_subscriptions ã‚’æ›´æ–°
  await supabase
    .from("user_subscriptions")
    .update({
      is_active: false,
      plan_members: false
    })
    .eq("user_id", userId)
    .eq("environment", ENVIRONMENT);
}
```

#### æ¤œè¨¼çµæœ

- âœ… **Deep Linkå®Ÿè£…ã«ã‚ˆã‚‹å½±éŸ¿ãªã—**
- âœ… è§£ç´„å‡¦ç†ã¯æ­£ã—ãå‹•ä½œ

---

### 5. Webhookå‡¦ç†

#### å¯¾å¿œã‚¤ãƒ™ãƒ³ãƒˆ

| ã‚¤ãƒ™ãƒ³ãƒˆ | å‡¦ç†å†…å®¹ | æ¤œè¨¼çµæœ |
|---------|---------|---------|
| `checkout.session.completed` | æ–°è¦ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç™»éŒ² | âœ… æ­£å¸¸ |
| `customer.subscription.updated` | ãƒ—ãƒ©ãƒ³å¤‰æ›´ã®åæ˜  | âœ… æ­£å¸¸ |
| `customer.subscription.deleted` | è§£ç´„å‡¦ç† | âœ… æ­£å¸¸ |

#### customer.subscription.updated ã®å‡¦ç†ç¢ºèª

**stripe-webhook-test/index.ts (L422-527):**

```typescript
async function handleSubscriptionUpdated(stripe: any, supabase: any, subscription: any) {
  // 1. é¡§å®¢IDã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—
  const { data: customerData } = await supabase
    .from("stripe_customers")
    .select("user_id")
    .eq("stripe_customer_id", customerId)
    .eq("environment", ENVIRONMENT)
    .single();

  // 2. Price IDã‹ã‚‰ãƒ—ãƒ©ãƒ³ã‚¿ã‚¤ãƒ—ã¨æœŸé–“ã‚’åˆ¤å®š
  const priceId = subscription.items.data[0].price.id;
  // ... Price ID ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆL458-479ï¼‰

  // 3. user_subscriptions ã‚’æ›´æ–°
  await supabase
    .from("user_subscriptions")
    .update({
      plan_type: planType,
      duration: duration,
      is_active: subscription.status === "active",
      cancel_at_period_end: subscription.cancel_at_period_end || false,
      cancel_at: subscription.cancel_at ? new Date(subscription.cancel_at * 1000).toISOString() : null,
      current_period_end: subscription.current_period_end ? new Date(subscription.current_period_end * 1000).toISOString() : null,
      updated_at: new Date().toISOString()
    })
    .eq("user_id", userId)
    .eq("environment", ENVIRONMENT);
}
```

#### æ¤œè¨¼çµæœ

- âœ… **ç’°å¢ƒãƒ•ã‚£ãƒ«ã‚¿é©ç”¨**ï¼ˆtest/liveåˆ†é›¢ï¼‰
- âœ… **Price ID ãƒãƒƒãƒ”ãƒ³ã‚°æ­£ç¢º**
- âœ… **ã‚­ãƒ£ãƒ³ã‚»ãƒ«æƒ…å ±ã‚‚æ­£ã—ãåæ˜ **
- âœ… **Deep Link ã‹ã‚‰ã®ãƒ—ãƒ©ãƒ³å¤‰æ›´ã‚’æ­£ã—ãå‡¦ç†**

---

### 6. ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§

#### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆ¶ç´„

**20251121_add_unique_constraints.sql:**

```sql
-- (user_id, environment) ã®è¤‡åˆuniqueåˆ¶ç´„
ALTER TABLE user_subscriptions
ADD CONSTRAINT stripe_customers_user_id_environment_key
UNIQUE (user_id, environment);

-- (stripe_subscription_id, environment) ã®è¤‡åˆuniqueåˆ¶ç´„
ALTER TABLE user_subscriptions
ADD CONSTRAINT user_subscriptions_stripe_subscription_id_environment_key
UNIQUE (stripe_subscription_id, environment);
```

#### æ¤œè¨¼çµæœ

- âœ… **1ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»1ç’°å¢ƒã«ã¤ã1ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®ã¿**
- âœ… **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¬ãƒ™ãƒ«ã§äºŒé‡èª²é‡‘ã‚’é˜²æ­¢**
- âœ… **ç’°å¢ƒåˆ†é›¢ãŒä¿è¨¼ã•ã‚Œã‚‹**

---

### 7. ç’°å¢ƒå¤‰æ•°

#### ç¢ºèªæ¸ˆã¿ç’°å¢ƒå¤‰æ•°ï¼ˆSupabase Secretsï¼‰

```bash
# ãƒ†ã‚¹ãƒˆç’°å¢ƒ
VITE_STRIPE_STANDARD_1M_PRICE_ID  # âœ… è¨­å®šæ¸ˆã¿
VITE_STRIPE_STANDARD_3M_PRICE_ID  # âœ… è¨­å®šæ¸ˆã¿
VITE_STRIPE_FEEDBACK_1M_PRICE_ID  # âœ… è¨­å®šæ¸ˆã¿
VITE_STRIPE_FEEDBACK_3M_PRICE_ID  # âœ… è¨­å®šæ¸ˆã¿

# Webhookç”¨
STRIPE_TEST_STANDARD_1M_PRICE_ID  # âœ… è¨­å®šæ¸ˆã¿
STRIPE_TEST_STANDARD_3M_PRICE_ID  # âœ… è¨­å®šæ¸ˆã¿
STRIPE_TEST_FEEDBACK_1M_PRICE_ID  # âœ… è¨­å®šæ¸ˆã¿
STRIPE_TEST_FEEDBACK_3M_PRICE_ID  # âœ… è¨­å®šæ¸ˆã¿

# Stripe API Keys
STRIPE_TEST_SECRET_KEY            # âœ… è¨­å®šæ¸ˆã¿
STRIPE_WEBHOOK_SECRET_TEST        # âœ… è¨­å®šæ¸ˆã¿
```

#### æ¤œè¨¼çµæœ

- âœ… **ã™ã¹ã¦ã®ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šæ¸ˆã¿**
- âœ… **getPriceIdã§é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**
- âœ… **ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã«è§£æ±ºç­–ã‚’æç¤º**

---

### 8. Edge Functions ãƒ‡ãƒ—ãƒ­ã‚¤çŠ¶æ³

| Function | Version | Status | æœ€çµ‚æ›´æ–° |
|----------|---------|--------|---------|
| check-subscription | 157 | ACTIVE | 2025-11-22 |
| create-checkout | 162 | ACTIVE | 2025-11-21 |
| create-customer-portal | **40** | ACTIVE | **2025-11-24** |
| stripe-webhook-test | 18 | ACTIVE | 2025-11-22 |
| update-subscription | 20 | ACTIVE | 2025-11-22 |

#### æ¤œè¨¼çµæœ

- âœ… **create-customer-portal ã¯æœ€æ–°ç‰ˆï¼ˆDeep Linkå®Ÿè£…å«ã‚€ï¼‰**
- âœ… **ã™ã¹ã¦ã® Edge Functions ãŒ ACTIVE**

---

## æ½œåœ¨çš„ãƒªã‚¹ã‚¯ã®åˆ†æ

### 1. æ—¢çŸ¥ã®å•é¡Œç‚¹ï¼ˆæ”¹å–„ã®ä½™åœ°ï¼‰

#### å•é¡Œ1: DBæ›´æ–°å¤±æ•—æ™‚ã®ãƒªãƒˆãƒ©ã‚¤ãªã—

**ç®‡æ‰€**: `update-subscription/index.ts (L175-180)`

```typescript
// DBæ›´æ–°å¤±æ•—ã—ã¦ã‚‚ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã•ãªã„
if (dbError) {
  console.warn('âš ï¸ DBæ›´æ–°å¤±æ•—ï¼ˆWebhookã§æœ€çµ‚åŒæœŸï¼‰:', dbError);
}
```

**å½±éŸ¿**:
- Webhook ã§æœ€çµ‚çš„ã«åŒæœŸã•ã‚Œã‚‹ãŸã‚ã€å®Ÿè³ªçš„ãªå½±éŸ¿ã¯å°ã•ã„
- ãŸã ã—ã€Webhook ãŒé…å»¶ã—ãŸå ´åˆã€ä¸€æ™‚çš„ã«ãƒ‡ãƒ¼ã‚¿ãŒä¸æ•´åˆã«ãªã‚‹å¯èƒ½æ€§

**æ¨å¥¨å¯¾å¿œ**:
- ãƒªãƒˆãƒ©ã‚¤æ©Ÿæ§‹ã®è¿½åŠ ï¼ˆå„ªå…ˆåº¦ï¼šä¸­ï¼‰

---

#### å•é¡Œ2: ç’°å¢ƒåˆ¤å®šã®æ›–æ˜§ã•

**ç®‡æ‰€**:
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: `import.meta.env.MODE`
- Edge Function: `useTestPrice` ãƒ•ãƒ©ã‚°

**å½±éŸ¿**:
- ç¾çŠ¶ã¯æ­£ã—ãå‹•ä½œã—ã¦ã„ã‚‹
- ãŸã ã—ã€2ã¤ã®ç’°å¢ƒåˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ãŒå­˜åœ¨ã™ã‚‹ãŸã‚ã€å°†æ¥çš„ã«ä¸æ•´åˆã®å¯èƒ½æ€§

**æ¨å¥¨å¯¾å¿œ**:
- ç’°å¢ƒåˆ¤å®šã®ä¸€å…ƒåŒ–ï¼ˆå„ªå…ˆåº¦ï¼šä½ï¼‰
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã® `environment` å±æ€§ã‚’DBã«ä¿å­˜ã™ã‚‹æ–¹å¼ã‚’æ¤œè¨

---

### 2. Deep Link å®Ÿè£…ã«ã‚ˆã‚‹æ–°è¦ãƒªã‚¹ã‚¯

#### ãƒªã‚¹ã‚¯1: getPriceId ã§ã®ã‚¨ãƒ©ãƒ¼

**æƒ³å®šã‚±ãƒ¼ã‚¹**:
- ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„
- ç„¡åŠ¹ãªãƒ—ãƒ©ãƒ³ã‚¿ã‚¤ãƒ—ãŒæŒ‡å®šã•ã‚Œã‚‹

**å¯¾ç­–**:
- âœ… **å®Ÿè£…æ¸ˆã¿**: è©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§è§£æ±ºç­–ã‚’æç¤º
  ```typescript
  if (!priceId) {
    const errorMessage = [
      `âŒ Price ID not found: ${envVarName} is not set`,
      'ğŸ”§ Solution:',
      `  npx supabase secrets set ${envVarName}=<your_price_id>`,
      'ğŸ“š Note:',
      '  - Edge Functions use Supabase Secrets, not .env files'
    ].join('\n');
    throw new Error(errorMessage);
  }
  ```

**æ¤œè¨¼çµæœ**: âœ… **ãƒªã‚¹ã‚¯è»½æ¸›æ¸ˆã¿**

---

#### ãƒªã‚¹ã‚¯2: Stripe API ã‚¨ãƒ©ãƒ¼

**æƒ³å®šã‚±ãƒ¼ã‚¹**:
- ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚‰ãªã„
- ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚¢ã‚¤ãƒ†ãƒ ãŒå­˜åœ¨ã—ãªã„

**å¯¾ç­–**:
- âœ… **å®Ÿè£…æ¸ˆã¿**: try-catch ã§ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
  ```typescript
  try {
    const stripeSubscription = await stripe.subscriptions.retrieve(stripeSubscriptionId);
    if (!stripeSubscription.items.data || stripeSubscription.items.data.length === 0) {
      throw new Error('ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚¢ã‚¤ãƒ†ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    }
  } catch (error) {
    console.error('âŒ Error:', error);
    return new Response(JSON.stringify({ error: error.message }), { status: 500 });
  }
  ```

**æ¤œè¨¼çµæœ**: âœ… **ãƒªã‚¹ã‚¯è»½æ¸›æ¸ˆã¿**

---

### 3. éå»ã®ãƒ†ã‚¹ãƒˆçµæœã¨ã®æ•´åˆæ€§

#### Test 1: æ–°è¦ç™»éŒ²ï¼ˆ2025-11-21ï¼‰

**çµæœ**: âœ… å®Œå…¨æˆåŠŸ

**æ¤œè¨¼**:
- âœ… äºŒé‡èª²é‡‘é˜²æ­¢ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã¯å¼•ãç¶šãå‹•ä½œ
- âœ… Deep Link å®Ÿè£…ã«ã‚ˆã‚‹å½±éŸ¿ãªã—

---

#### Test 2: ãƒ—ãƒ©ãƒ³å¤‰æ›´ï¼ˆStandard â†’ Feedbackï¼‰

**çµæœ**: âš ï¸ éƒ¨åˆ†æˆåŠŸï¼ˆæ ¹æœ¬å•é¡Œç™ºè¦‹ï¼‰

**éå»ã®å•é¡Œ**:
- âŒ Proration ãŒé©ç”¨ã•ã‚Œã¦ã„ãªã„
- âŒ å¤ã„ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãŒå‰Šé™¤ã•ã‚Œã¦ã„ã‚‹ï¼ˆå±¥æ­´ãªã—ï¼‰

**Deep Link ã«ã‚ˆã‚‹è§£æ±º**:
- âœ… Customer Portal çµŒç”±ã§ãƒ—ãƒ©ãƒ³å¤‰æ›´
- âœ… Stripe ãŒ `subscription.update()` ã‚’å®Ÿè¡Œï¼ˆæ–°è¦ä½œæˆã§ã¯ãªã„ï¼‰
- âœ… Proration è‡ªå‹•é©ç”¨
- âœ… å±¥æ­´ãŒä¿æŒã•ã‚Œã‚‹

**æ¤œè¨¼çµæœ**: âœ… **éå»ã®å•é¡Œã¯ Deep Link ã§è§£æ±º**

---

## æ¨å¥¨äº‹é …

### 1. å³åº§ã«å¯¾å¿œã™ã¹ãäº‹é …

ãªã—ï¼ˆã™ã¹ã¦å®Ÿè£…æ¸ˆã¿ï¼‰

---

### 2. å°†æ¥çš„ãªæ”¹å–„äº‹é …

#### å„ªå…ˆåº¦ï¼šä¸­

1. **DBæ›´æ–°å¤±æ•—æ™‚ã®ãƒªãƒˆãƒ©ã‚¤æ©Ÿæ§‹**
   - `update-subscription` ã§DBæ›´æ–°å¤±æ•—æ™‚ã«ãƒªãƒˆãƒ©ã‚¤
   - Webhook ã§ã®æœ€çµ‚åŒæœŸã‚’ãƒ•ã‚§ã‚¤ãƒ«ã‚»ãƒ¼ãƒ•ã¨ã—ã¦æ®‹ã™

#### å„ªå…ˆåº¦ï¼šä½

2. **ç’°å¢ƒåˆ¤å®šã®ä¸€å…ƒåŒ–**
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã® `environment` å±æ€§ã‚’DBã«ä¿å­˜
   - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨Edge Functionã§çµ±ä¸€

3. **ãƒ­ã‚°ç›£è¦–ã®å¼·åŒ–**
   - Supabase Logs ã§å®šæœŸçš„ã«ã‚¨ãƒ©ãƒ¼ç¢ºèª
   - ã‚¢ãƒ©ãƒ¼ãƒˆæ©Ÿèƒ½ã®å°å…¥

---

## ãƒ†ã‚¹ãƒˆæº–å‚™å®Œäº†ç¢ºèª

### âœ… ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [x] **ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†**
  - ã™ã¹ã¦ã®Edge Functionsã‚’ç¢ºèª
  - Webhookå‡¦ç†ã‚’ç¢ºèª
  - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèª

- [x] **ç’°å¢ƒå¤‰æ•°ç¢ºèª**
  - Supabase Secrets è¨­å®šæ¸ˆã¿
  - `supabase secrets list` ã§ç¢ºèªæ¸ˆã¿

- [x] **ãƒ‡ãƒ—ãƒ­ã‚¤ç¢ºèª**
  - create-customer-portal Version 40 ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿
  - ã™ã¹ã¦ã®Edge FunctionsãŒACTIVE

- [x] **äºŒé‡èª²é‡‘é˜²æ­¢ç¢ºèª**
  - create-checkout: äº‹å‰ã‚­ãƒ£ãƒ³ã‚»ãƒ«å®Ÿè£…
  - Webhook: éã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–å®Ÿè£…
  - DBåˆ¶ç´„: uniqueåˆ¶ç´„è¨­å®š

- [x] **å¾Œæ–¹äº’æ›æ€§ç¢ºèª**
  - æ—¢å­˜ã®å‘¼ã³å‡ºã—æ–¹æ³•ã¯å¼•ãç¶šãå‹•ä½œ
  - Deep Link ã¯ opt-inï¼ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æŒ‡å®šæ™‚ã®ã¿ï¼‰

- [x] **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ç¢ºèª**
  - getPriceId: è©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  - Stripe API: try-catch ã§æ•æ‰
  - Webhook: å„ã‚¤ãƒ™ãƒ³ãƒˆã§ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°

- [x] **éå»ã®ãƒ†ã‚¹ãƒˆçµæœç¢ºèª**
  - Test 1 ã®äºŒé‡èª²é‡‘é˜²æ­¢ã¯ç¶­æŒ
  - Test 2 ã®å•é¡Œï¼ˆProration ãªã—ï¼‰ã¯ Deep Link ã§è§£æ±º

---

## çµè«–

### ç·åˆè©•ä¾¡

**âœ… ãƒ†ã‚¹ãƒˆå®Ÿæ–½å¯èƒ½**

**ç†ç”±**:

1. **å®Ÿè£…ã®å¥å…¨æ€§**
   - Deep Link å®Ÿè£…ã¯æ—¢å­˜æ©Ÿèƒ½ã«å½±éŸ¿ã—ãªã„
   - Stripe API ã®æ¨™æº–æ©Ÿèƒ½ï¼ˆflow_dataï¼‰ã‚’ä½¿ç”¨
   - Webhook å‡¦ç†ã¸ã®å½±éŸ¿ãªã—

2. **å®‰å…¨æ€§**
   - äºŒé‡èª²é‡‘ãƒªã‚¹ã‚¯ãªã—ï¼ˆ3é‡ã®ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ãƒãƒƒãƒˆï¼‰
   - ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãŒ DB åˆ¶ç´„ã§ä¿è¨¼
   - ç’°å¢ƒå¤‰æ•°ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å®Ÿè£…æ¸ˆã¿

3. **ãƒ†ã‚¹ãƒˆæº–å‚™**
   - ã™ã¹ã¦ã®ç’°å¢ƒå¤‰æ•°è¨­å®šæ¸ˆã¿
   - Edge Functions æœ€æ–°ç‰ˆãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿
   - ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã®ç¢ºèªæ‰‹é †ã‚‚æ•´å‚™æ¸ˆã¿

### ãƒ†ã‚¹ãƒˆå®Ÿæ–½æ‰‹é †

**TESTING-LOG.md ã®æœ€ä¸‹éƒ¨ã€Œâœ… ç’°å¢ƒå¤‰æ•°ã‚¨ãƒ©ãƒ¼ä¿®æ­£å®Œäº† - å†ãƒ†ã‚¹ãƒˆæº–å‚™å®Œäº†ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³**ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

**æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œ**:
- âœ… Customer Portal ãŒ 500 ã‚¨ãƒ©ãƒ¼ãªãé–‹ã
- âœ… **ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã§ã¯ãªãã€ãƒ—ãƒ©ãƒ³å¤‰æ›´ç¢ºèªç”»é¢ã«ç›´æ¥é·ç§»**
- âœ… é¸æŠã—ãŸãƒ—ãƒ©ãƒ³ï¼ˆã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ 1ãƒ¶æœˆï¼‰ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- âœ… Prorationï¼ˆæ—¥å‰²ã‚Šè¨ˆç®—ï¼‰é‡‘é¡ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¤‰æ›´ã‚’ç¢ºå®š
- âœ… Webhook ã§ DB ãŒåŒæœŸã•ã‚Œã‚‹

---

**ä½œæˆè€…**: Claude (Sonnet 4.5)
**æœ€çµ‚æ›´æ–°**: 2025-11-24
