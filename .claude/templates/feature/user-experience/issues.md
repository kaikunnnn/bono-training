# サブスクリプション UX問題トラッカー

**最終更新**: 2025-11-29

---

## 🎯 このドキュメントの目的

実際に使っていて「これ変だな」「使いにくい」と感じた問題を記録する。

**使い方**:
1. 問題を発見したらすぐに追加
2. 深刻度を記載（🔴 高 / 🟡 中 / 🟢 低）
3. Claude Codeが修正したら「✅ 解決済み」に移動

---

## 🔴 Critical（高優先度）

### [ISSUE-001] プラン変更時に二重課金が発生する

**深刻度**: 🔴 Critical
**発生日**: 2025-11-29
**ステータス**: 🔧 修正中

**問題**:
Starter → Premiumにプラン変更したところ、両方のプランが課金されている。

**再現手順**:
1. Starterプランに登録
2. 「Premiumプランを選択」ボタンをクリック
3. Stripe Checkoutで決済完了
4. Stripe Dashboardを確認 → 2つのアクティブなサブスクリプション

**期待値**:
- 古いStarterプランは自動的にキャンセルされる
- Premiumプランのみアクティブになる

**原因**:
Webhook 401エラーで古いプランがキャンセルされない

**関連ドキュメント**:
- [ERROR-002](../troubleshooting/error-database.md#error-002-stripe-webhook-401-error---二重課金サブスク状態更新失敗)
- [CURRENT-FOCUS.md](../../CURRENT-FOCUS.md)

---

### [ISSUE-002] 決済完了後、画面が更新されない

**深刻度**: 🔴 Critical
**発生日**: 2025-11-29
**ステータス**: 🔧 修正中

**問題**:
プラン変更完了後、/subscriptionページに戻っても新プランが表示されない。
ページをリロードしても `subscribed: false` のまま。

**再現手順**:
1. プラン変更を実行
2. Stripe Checkoutで決済完了
3. /subscriptionページに戻る
4. 画面を確認 → 古い状態のまま
5. リロード → それでも変わらない
6. Consoleを確認 → `subscribed: false`

**期待値**:
- 決済完了後、即座に新プランが表示される
- `subscribed: true` になる
- リロード不要で画面が更新される

**原因**:
Webhook 401エラーでデータベースが更新されない

---

## 🟡 Medium（中優先度）

### [ISSUE-101] プラン変更時の確認ダイアログがない

**深刻度**: 🟡 中
**発生日**: 2025-11-XX
**ステータス**: 📋 未対応

**問題**:
「このプランを選択」ボタンをクリックすると、確認なしで即座にCheckoutページに遷移する。
誤クリックした場合、戻るのが面倒。

**再現手順**:
1. /subscriptionページで「Premiumプランを選択」をクリック
2. 確認なしでStripe Checkoutに遷移

**期待値**:
```
確認ダイアログ例:
「Premiumプラン (¥4,980/月) に変更しますか？
 現在のStarterプランは自動的にキャンセルされます。」

 [キャンセル] [変更する]
```

**優先度**:
中（二重課金問題を解決した後に対応）

---

### [ISSUE-102] 料金表示が分かりにくい

**深刻度**: 🟡 中
**発生日**: 2025-11-XX
**ステータス**: 📋 未対応

**問題**:
プラン一覧で「¥4,989/月」と表示されているが、税込かどうか不明。

**期待値**:
「¥4,989（税込）/月」と明示

---

## 🟢 Low（低優先度）

### [ISSUE-201] プラン変更時のローディング状態が不明確

**深刻度**: 🟢 低
**発生日**: 2025-11-XX
**ステータス**: 📋 未対応

**問題**:
「このプランを選択」ボタンをクリックしてから、Checkoutページに遷移するまでの間、何も表示されない。
ボタンが効いたかどうか分からない。

**期待値**:
- ボタンクリック → ローディングスピナー表示
- 「Checkoutページを準備中...」などのメッセージ

---

### [ISSUE-202] 次回更新日が表示されない

**深刻度**: 🟢 低
**発生日**: 2025-11-XX
**ステータス**: 📋 未対応

**問題**:
/subscriptionページに現在のプランは表示されるが、次回更新日が表示されない。
「いつまで使えるか」が分からない。

**期待値**:
```
現在のプラン: Premium
次回更新日: 2025-12-29
次回請求額: ¥4,980（税込）
```

---

## ✅ 解決済み

### [ISSUE-301] ブラウザバックで既存プランが解除される（✅ 解決済み）

**深刻度**: 🔴 Critical → ✅ 解決済み
**発生日**: 2025-11-28
**解決日**: 2025-11-28

**問題**:
Stripe Checkoutページで「戻る」ボタンを押すと、既存のプランが解除されてしまう。

**解決方法**:
Checkoutセッション作成時に `cancel_url` を設定し、既存プランの状態を保持するように修正。

**関連ドキュメント**:
- [ブラウザバックバグ分析](../../archive/issues/browser-back-bug-analysis.md)

---

### [ISSUE-302] Webhook環境変数バグ（✅ 解決済み）

**深刻度**: 🔴 Critical → ✅ 解決済み
**発生日**: 2025-11-28
**解決日**: 2025-11-28

**問題**:
本番環境とテスト環境のWebhook Secretが混在して、署名検証が失敗していた。

**解決方法**:
`STRIPE_WEBHOOK_SECRET_TEST` と `STRIPE_WEBHOOK_SECRET_LIVE` を明示的に分離。

**関連ドキュメント**:
- [Webhook環境変数バグ](../../archive/issues/2025-11-28-webhook-environment-bug.md)

---

## 📝 Issue追加テンプレート

新しいIssueを追加する時は、以下のフォーマットを使用してください：

```markdown
### [ISSUE-XXX] [問題タイトル]

**深刻度**: 🔴 高 / 🟡 中 / 🟢 低
**発生日**: YYYY-MM-DD
**ステータス**: 📋 未対応 / 🔧 修正中 / ✅ 解決済み

**問題**:
何が起きているか、具体的に記述


**再現手順**:
1. 
2. 
3. 

**期待値**:
どうあるべきか


**優先度**:
なぜこの深刻度か


**関連ドキュメント**:
- [リンク](path/to/doc.md)
```

---

## 🎯 Issue番号の採番ルール

| 範囲 | 深刻度 |
|------|--------|
| 001-099 | 🔴 Critical |
| 101-199 | 🟡 Medium |
| 201-299 | 🟢 Low |
| 301-399 | ✅ 解決済み |

---

## 📊 Issue統計

**全体**:
- 🔴 Critical: 2件（修正中）
- 🟡 Medium: 2件（未対応）
- 🟢 Low: 2件（未対応）
- ✅ 解決済み: 2件

**最優先**: [ISSUE-001] 二重課金問題

---

**UX問題を放置せず、すぐに記録・修正することで、ユーザー体験を改善できます。**
