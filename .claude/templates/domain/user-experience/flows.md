# サブスクリプション ユーザーフロー

**最終更新**: 2025-11-29
**作成者**: Takumi

---

## 🎯 この機能の目的

**ユーザーが達成したいこと**:
- 自分に合ったプランを選んで登録したい
- プランを変更したい（アップグレード・ダウングレード）
- プランをキャンセルしたい

**ビジネス上の目的**:
- ユーザーが迷わずサブスクリプション登録できる
- プラン変更がスムーズにできる
- 離脱を防ぐ（エラーを最小限に）

---

## 👤 対象ユーザー

- **新規ユーザー**: まだサブスクリプションに登録していない
- **既存ユーザー**: 既にプランに登録済み
- **アップグレード検討ユーザー**: より高機能なプランに興味がある
- **キャンセル検討ユーザー**: プランをやめたい

---

## 📋 基本フロー

### フロー1: 新規登録（Starterプラン）

**Given（前提）**:
- ユーザーは未登録
- ログイン済み

**When（操作）**:
1. /subscriptionページを開く
2. プラン一覧を確認
3. 「Starterプランを選択」ボタンをクリック
4. Stripe Checkoutページにリダイレクト
5. 決済情報を入力
6. 決済完了

**Then（結果）**:
- ✅ 即座にStarterプランの機能が使える
- ✅ /subscriptionページに「現在のプラン: Starter」と表示
- ✅ /accountページにもプラン情報が表示
- ✅ メールで確認通知が届く
- ❌ エラーが発生しない
- ❌ 2重登録されない

---

### フロー2: プラン変更（アップグレード）

**Given（前提）**:
- ユーザーは既にStarterプランに登録済み

**When（操作）**:
1. /subscriptionページを開く
2. 「Premiumプラン」の「このプランを選択」ボタンをクリック
3. Stripe Checkoutページで決済情報を確認
4. 決済完了

**Then（結果）**:
- ✅ 即座にPremiumプランの機能が使える
- ✅ /subscriptionページに「現在のプラン: Premium」と表示
- ✅ 古いStarterプランは自動的にキャンセルされている
- ✅ 日割り計算された金額が請求される
- ❌ 2重課金されない
- ❌ Starterプランの課金が続かない

---

### フロー3: プラン変更（ダウングレード）

**Given（前提）**:
- ユーザーは既にPremiumプランに登録済み

**When（操作）**:
1. /subscriptionページを開く
2. 「Starterプラン」の「このプランを選択」ボタンをクリック
3. Stripe Checkoutページで決済情報を確認
4. 決済完了

**Then（結果）**:
- ✅ 次の更新日からStarterプランに変更される
- ✅ 現在の期間終了まではPremiumプランの機能が使える
- ✅ 確認メッセージで変更タイミングが明示される
- ❌ 即座にダウングレードされない（返金問題を避けるため）

---

### フロー4: プランキャンセル

**Given（前提）**:
- ユーザーはプランに登録済み

**When（操作）**:
1. /subscriptionページを開く
2. 「プランをキャンセル」ボタンをクリック
3. 確認ダイアログで「キャンセルする」を選択

**Then（結果）**:
- ✅ 現在の期間終了時にキャンセルされる
- ✅ 期間終了までは機能が使える
- ✅ 「〇〇日まで利用可能」と表示される
- ✅ 確認メールが届く
- ❌ 即座にサービスが使えなくならない

---

## 🚨 異常系フロー

### 異常フロー1: 決済失敗

**Given（前提）**:
- ユーザーが新規登録またはプラン変更を試みる

**When（操作）**:
1. Stripe Checkoutで決済情報を入力
2. カードが無効で決済失敗

**Then（結果）**:
- ✅ Stripe側でエラーメッセージが表示される
- ✅ ユーザーは/subscriptionページに戻る
- ✅ プランは変更されない
- ✅ 古いプランは維持される
- ❌ データベースに不完全なレコードが残らない

---

### 異常フロー2: Webhook失敗

**Given（前提）**:
- ユーザーが決済完了
- Webhookが何らかの理由で失敗

**When（操作）**:
1. Stripe Checkoutで決済完了
2. Webhookが401エラーで失敗

**Then（結果）**:
- ✅ ユーザーには「決済完了」と表示される
- ✅ Stripe側には決済記録が残る
- ❌ データベースは更新されない（これは問題）
- ❌ ユーザーは「subscribed: false」のまま

**対処**:
- システム側でWebhook再試行
- 手動でデータベース修正
- ユーザーには「反映まで数分かかる場合があります」と案内

---

### 異常フロー3: 2重決済

**Given（前提）**:
- ユーザーがプラン変更を試みる
- 何らかの理由で2回ボタンをクリック

**When（操作）**:
1. 「このプランを選択」ボタンを連打
2. 複数のCheckoutセッションが作成される

**Then（結果）**:
- ✅ ボタンが無効化されて連打できない
- ✅ 1つのCheckoutセッションのみ有効
- ❌ 2重決済されない

---

## 🔄 状態遷移

### ユーザーの状態

```
未登録
  ↓ (新規登録)
Starterプラン
  ↓ (アップグレード)
Premiumプラン
  ↓ (ダウングレード予約)
Premiumプラン（次回更新時Starterに変更予定）
  ↓ (更新日到来)
Starterプラン
  ↓ (キャンセル)
Starterプラン（次回更新時キャンセル予定）
  ↓ (期間終了)
未登録
```

---

## 📱 各ページの役割

### /subscription

**目的**: プラン選択・変更

**表示内容**:
- プラン一覧
- 現在のプラン（登録済みの場合）
- 各プランの「選択」ボタン
- キャンセルボタン（登録済みの場合）

---

### /account

**目的**: アカウント情報確認

**表示内容**:
- 現在のプラン
- 次回更新日
- プラン履歴

---

### Stripe Checkout

**目的**: 決済情報入力

**Stripeが提供**: 
- 決済フォーム
- セキュリティ
- エラーハンドリング

---

## 🎯 UX成功の定義

### 1. スムーズな登録
- 迷わずプランを選択できる
- 決済完了まで5分以内

### 2. 即時反映
- 決済完了後、即座に機能が使える
- 「反映待ち」がない

### 3. 安心感
- エラーが分かりやすい
- 「何が起きているか」が常に明確
- 2重課金の心配がない

### 4. 柔軟な変更
- プラン変更が簡単
- キャンセルも簡単

---

**このフローを実現することで、ユーザーは迷わずサブスクリプションを利用できます。**
