
name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run linting
      run: npm run lint
    
    - name: Run type checking (production build)
      run: npx tsc --noEmit --project tsconfig.json
    
    - name: Run tests with Jest configuration
      run: npx jest --passWithNoTests --coverage --watchAll=false --config jest.config.js
    
    - name: Build application
      run: npm run build

    # „Ç≥„É≥„ÉÜ„É≥„ÉÑÊ§úË®º„ÅØÊó¢Â≠ò„Éá„Éº„Çø„ÅÆÂïèÈ°å„Å´„Çà„Çä‰∏ÄÊôÇÁöÑ„Å´ÁÑ°ÂäπÂåñÔºàÂà•PR„ÅßÂØæÂøú‰∫àÂÆöÔºâ
    # - name: Validate training content quality
    #   run: |
    #     chmod +x scripts/run-all-validations.sh
    #     ./scripts/run-all-validations.sh

    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      if: success()

  # ENV-001 ÊÅí‰πÖÂØæÁ≠ñ: „Éè„Éº„Éâ„Ç≥„Éº„Éâ„Åï„Çå„Åü„É≠„Éº„Ç´„É´URL„ÅÆÊ§úÂá∫
  hardcoded-url-check:
    runs-on: ubuntu-latest
    name: Check for hardcoded local URLs

    steps:
    - uses: actions/checkout@v3

    - name: Check for hardcoded local Supabase URLs
      run: |
        echo "üîç Checking for hardcoded local URLs in source code..."

        FOUND_ISSUES=0

        # Note: grep -v ".includes(" excludes validation code that checks for these patterns
        # This prevents false positives from the ENV-001 check in vite.config.ts

        # Pattern 1: 127.0.0.1:54321 (local Supabase) - exclude validation code
        if grep -r -n "127\.0\.0\.1:54321" --include="*.ts" --include="*.tsx" --include="*.js" src/ vite.config.ts 2>/dev/null | grep -v "\.includes(" | grep -v "// Pattern"; then
          echo "‚ùå ERROR: Found hardcoded 127.0.0.1:54321 in source files"
          FOUND_ISSUES=1
        fi

        # Pattern 2: localhost:54321 - exclude validation code
        if grep -r -n "localhost:54321" --include="*.ts" --include="*.tsx" --include="*.js" src/ vite.config.ts 2>/dev/null | grep -v "\.includes(" | grep -v "// Pattern"; then
          echo "‚ùå ERROR: Found hardcoded localhost:54321 in source files"
          FOUND_ISSUES=1
        fi

        # Pattern 3: FORCED_LOCAL pattern (common mistake)
        if grep -r -n "FORCED_LOCAL" --include="*.ts" --include="*.tsx" --include="*.js" src/ vite.config.ts 2>/dev/null | grep -v "// Pattern"; then
          echo "‚ùå ERROR: Found FORCED_LOCAL pattern in source files"
          FOUND_ISSUES=1
        fi

        # Pattern 4: define block with hardcoded env vars in vite.config
        if grep -n "JSON\.stringify.*127\.0\.0\.1" vite.config.ts 2>/dev/null; then
          echo "‚ùå ERROR: Found hardcoded URL in vite.config.ts define block"
          FOUND_ISSUES=1
        fi

        if [ $FOUND_ISSUES -eq 1 ]; then
          echo ""
          echo "=========================================="
          echo "üö® HARDCODED LOCAL URL DETECTED!"
          echo "=========================================="
          echo ""
          echo "This will cause production to point to localhost."
          echo "Please use environment variables instead:"
          echo "  - VITE_SUPABASE_URL"
          echo "  - VITE_SUPABASE_ANON_KEY"
          echo ""
          echo "See: .claude/docs/subscription/redesign/investigations/2025-12-02-environment-issues.md"
          exit 1
        fi

        echo "‚úÖ No hardcoded local URLs found"
