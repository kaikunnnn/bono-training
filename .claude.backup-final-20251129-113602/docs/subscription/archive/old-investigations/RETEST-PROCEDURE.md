# 再テスト決済の実施手順

**作成日:** 2025-11-21 14:42 JST

---

## 目的

データベーススキーマ修正後、Webhookが正常に動作してデータが保存されることを確認する。

---

## 前提条件（修正完了）

✅ **修正1:** subscriptionsテーブルにenvironmentカラムを追加（14:40 完了）
✅ **修正2:** user_subscriptionsテーブルにUNIQUE(user_id, environment)制約を追加（14:41 完了）

---

## 再テスト実施手順

### ステップ1: テスト決済を実施

1. **アプリケーションにアクセス**
   ```
   URL: http://localhost:8080/subscribe
   ```

2. **ログイン**
   - メールアドレス: `takumi.kai.skywalker@gmail.com`

3. **決済情報を入力**
   - テストカード番号: `4242 4242 4242 4242`
   - 有効期限: `12/34`
   - CVC: `123`
   - 郵便番号: `12345`

4. **決済を完了**

5. **リダイレクト先URLを記録**
   ```
   リダイレクトURL: ___________________________________
   ```

---

### ステップ2: ブラウザコンソールを確認

**期待される結果:**
- ❌ `Edge Functionエラー、直接DBから取得します` が表示されない
- ✅ `DB直接取得結果: {isActive: true, planType: "standard", ...}` のようなデータが表示される

**実際の結果:**
```
ここにコンソールログを貼り付けてください




```

---

### ステップ3: /accountページを確認

1. **アクセス**
   ```
   URL: http://localhost:8080/account
   ```

2. **表示内容を確認**

**期待される結果:**
- ✅ 「現在のプラン: スタンダード」のような表示
- ✅ サブスクリプション情報が正しく表示される

**実際の結果:**
```
ここに表示内容を貼り付けてください




```

---

### ステップ4: Stripe Dashboardを確認

1. **アクセス**
   ```
   URL: https://dashboard.stripe.com/test/payments
   ```

2. **最新の決済を確認**

**記録すべき情報:**
```
Payment Intent ID: ___________________________________
Customer ID: ___________________________________
Subscription ID: ___________________________________
金額: ___________________________________
ステータス: ___________________________________
```

---

### ステップ5: Webhookログを確認（Claude実施）

**確認項目:**
- [ ] `🧪 [TEST環境] Webhook受信` ログあり
- [ ] `✅ [TEST環境] Webhook署名検証成功` ログあり
- [ ] エラーログなし

**結果:**（Claudeが記入）
```
ここにログ結果を記録




```

---

### ステップ6: データベースを確認（Claude実施）

**実行SQL:**
```sql
SELECT
  id,
  user_id,
  stripe_customer_id,
  stripe_subscription_id,
  plan_type,
  is_active,
  environment,
  created_at
FROM user_subscriptions
WHERE environment = 'test'
ORDER BY created_at DESC
LIMIT 3;
```

**確認項目:**
- [ ] 新しいレコードが作成されている
- [ ] `environment` = 'test'
- [ ] `is_active` = true
- [ ] `plan_type` = 'standard' (または選択したプラン)
- [ ] `stripe_customer_id` と `stripe_subscription_id` が正しく保存されている

**結果:**（Claudeが記入）
```
ここにクエリ結果を記録




```

---

## 成功基準

### ✅ すべて成功の場合
- [ ] 決済が完了
- [ ] ブラウザコンソールにエラーなし
- [ ] /accountページで正しいプラン表示
- [ ] Webhookログにエラーなし
- [ ] データベースにデータ保存成功

### ❌ 失敗がある場合
- エラーログを完全にコピー
- ERROR-ANALYSIS.mdに追記
- 原因を特定して追加修正

---

## 結果サマリー（実施後に記入）

### テスト実施日時
```
___________________________________
```

### 総合結果
```
[ ] ✅ 完全成功 - すべての項目が正常動作
[ ] ⚠️ 部分成功 - 一部エラーあり
[ ] ❌ 失敗 - 重大なエラーあり
```

### 問題点（あれば）
```
ここに問題点を記録




```

### 次のアクション
```
ここに次のアクションを記録




```
