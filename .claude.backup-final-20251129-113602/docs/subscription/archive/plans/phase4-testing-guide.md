# Phase 4 テストガイド

**作成日**: 2025-11-28
**関連ドキュメント**:
- `plan-change-modal-implementation.md` - 実装仕様
- `implementation-progress.md` - 実装進捗

---

## 📋 目次

1. [Phase 4-2: UIの目視確認](#phase-4-2-uiの目視確認)
2. [Phase 4-3: Test 2B実施（E2Eテスト）](#phase-4-3-test-2b実施e2eテスト)
3. [テスト実施チェックリスト](#テスト実施チェックリスト)

---

## Phase 4-2: UIの目視確認

### 目的
開発サーバーでプラン変更確認モーダルが正しく表示され、プロレーション計算が正確に表示されることを確認する。

### 前提条件
- ✅ Phase 1-3の実装完了
- ✅ ユニットテスト全パス
- ✅ TypeScript型エラーなし
- 📌 **既存のサブスクリプション契約が必要**（Standard 1ヶ月プランを推奨）

### テスト環境準備

#### 1. 開発サーバー起動
```bash
npm run dev
```

#### 2. テストユーザーでログイン
既存のサブスクリプション契約があるユーザーでログインする。

**確認項目**:
- [ ] `/subscription` ページにアクセス
- [ ] 現在のプラン情報が表示されている
- [ ] サブスクリプション期間終了日（renewalDate）が正しく表示されている

---

### テストケース 1: モーダル表示確認

**操作手順**:
1. `/subscription` ページで、現在のプランと異なるプランの「購読」ボタンをクリック

**期待される動作**:
- [ ] プラン変更確認モーダルが表示される
- [ ] モーダルがページ中央に表示される
- [ ] 背景がオーバーレイで暗くなる

**確認項目（モーダル内容）**:
- [ ] タイトル「プラン変更の確認」が表示
- [ ] 現在のプラン情報（プラン名、期間、月額料金）が正しく表示
- [ ] 矢印アイコン（下向き）が表示
- [ ] 新しいプラン情報（プラン名、期間、月額料金）が正しく表示
- [ ] 区切り線（Separator）が表示

---

### テストケース 2: プロレーション表示確認

**前提条件**:
- 現在のプラン: Standard 1ヶ月（¥4,000/月）
- 新しいプラン: Feedback 1ヶ月（¥1,480/月）
- 残り日数: 15日と仮定（実際の残り日数により変動）

**確認項目（プロレーション表示セクション）**:
- [ ] 青色の背景ボックスで表示されている
- [ ] タイトル「📊 今回のお支払い」が表示
- [ ] 現在のプラン返金額が表示（緑色のテキスト）
  - 例: `現在のプラン返金（15日分）: -¥2,000`
- [ ] 新プラン請求額が表示
  - 例: `新プラン（15日分）: +¥740`
- [ ] 区切り線
- [ ] 合計金額が表示（返金の場合は緑色、追加請求の場合は赤色）
  - 例: `-¥1,260 返金`（Standard→Feedbackの場合）

**計算式検証**:
```
現在のプラン日割り: ¥4,000 / 30日 × 15日 = ¥2,000
新プラン日割り: ¥1,480 / 30日 × 15日 = ¥740
合計: -¥2,000 + ¥740 = -¥1,260（返金）
```

- [ ] 計算結果が正しい
- [ ] カンマ区切りで表示されている（例: `2,000`）
- [ ] 通貨記号「¥」が付いている

---

### テストケース 3: 次回請求情報確認

**確認項目**:
- [ ] 次回請求日が表示されている
  - 形式: `yyyy年M月d日`（例: `2025年12月13日`）
- [ ] 次回以降の月額料金が表示されている
  - 例: `次回以降: ¥1,480/月`
- [ ] 日本語フォーマットが正しい

---

### テストケース 4: 注意事項表示確認

**確認項目**:
- [ ] 黄色の背景ボックスで表示されている
- [ ] 黄色の枠線（border）がある
- [ ] アイコン「⚠️」が表示
- [ ] テキスト内容が正しい:
  ```
  プラン変更を確定すると、現在のプランはキャンセルされ、新しいプランに切り替わります。
  ```

---

### テストケース 5: ボタン操作確認

#### 5-1: キャンセルボタン

**操作手順**:
1. モーダルの「キャンセル」ボタンをクリック

**期待される動作**:
- [ ] モーダルが閉じる
- [ ] `/subscription` ページに戻る
- [ ] プラン変更は実行されない

#### 5-2: プラン変更を確定ボタン

**操作手順**:
1. モーダルの「プラン変更を確定」ボタンをクリック

**期待される動作**:
- [ ] モーダルが閉じる
- [ ] ローディング状態になる
- [ ] Stripe Checkout画面に遷移する
- [ ] **次のセクション（Test 2B）で詳細確認**

---

### テストケース 6: レスポンシブデザイン確認

**確認項目**:
- [ ] モバイル表示（375px幅）で正しく表示される
- [ ] タブレット表示（768px幅）で正しく表示される
- [ ] デスクトップ表示（1024px以上）で正しく表示される
- [ ] モーダルの最大幅が適切（max-w-md = 448px）
- [ ] テキストが折り返され、読みやすい

---

### テストケース 7: 複数プランパターン確認

#### パターン 1: Standard 1ヶ月 → Standard 3ヶ月
- [ ] プラン名が正しく表示（スタンダード）
- [ ] 期間が正しく表示（1ヶ月 → 3ヶ月）
- [ ] 月額料金が正しく表示（¥4,000/月 → ¥3,800/月）
- [ ] プロレーション計算が正しい

#### パターン 2: Feedback 1ヶ月 → Feedback 3ヶ月
- [ ] プラン名が正しく表示（フィードバック）
- [ ] 期間が正しく表示（1ヶ月 → 3ヶ月）
- [ ] 月額料金が正しく表示（¥1,480/月 → ¥1,280/月）
- [ ] プロレーション計算が正しい

#### パターン 3: Standard → Feedback（プランタイプ変更）
- [ ] プラン名が変わる（スタンダード → フィードバック）
- [ ] 返金額が大きくなる（高額プランから低額プランへ）
- [ ] 合計が返金（緑色）で表示される

#### パターン 4: Feedback → Standard（プランタイプ変更）
- [ ] プラン名が変わる（フィードバック → スタンダード）
- [ ] 追加請求額が発生（低額プランから高額プランへ）
- [ ] 合計が追加請求（赤色）で表示される

---

### テストケース 8: エッジケース確認

#### ケース 1: 残り日数が1日の場合
- [ ] プロレーション計算が正しい（少額）
- [ ] 「（1日分）」と表示される

#### ケース 2: 残り日数が0日の場合（期限当日）
**期待される動作**:
- [ ] プロレーション = ¥0（返金も請求もなし）
- [ ] モーダルは表示されるが、金額は全て¥0

#### ケース 3: 残り日数が30日の場合（更新直後）
- [ ] 1ヶ月分丸々の計算になる
- [ ] 計算が正確（月額料金と同額）

---

### 目視確認チェックリスト

#### デザイン・UI
- [ ] モーダルの影（shadow）が適切
- [ ] フォントサイズが読みやすい
- [ ] 色のコントラストが適切（アクセシビリティ）
- [ ] アイコンが正しく表示される（ArrowDown, ⚠️, 📊）
- [ ] 各セクションの余白（padding/margin）が適切

#### タイポグラフィ
- [ ] 日本語テキストが正しく表示
- [ ] 数字のカンマ区切りが正しい
- [ ] 通貨記号「¥」が付いている
- [ ] 日付フォーマットが日本語（`yyyy年M月d日`）

#### インタラクション
- [ ] ボタンのホバー効果がある
- [ ] ボタンクリック時のフィードバックがある
- [ ] モーダルの開閉アニメーションがスムーズ
- [ ] 背景クリックでモーダルが閉じない（意図的）

---

## Phase 4-3: Test 2B実施（E2Eテスト）

### 目的
実際にプラン変更を完了させ、エンドツーエンドで動作を確認する。

**重要**: このテストは実際のStripe支払いを伴うため、テストモードで実施することを推奨。

---

### 前提条件

#### 必須条件
- ✅ Phase 4-2（UI目視確認）完了
- 📌 **テスト用のStripeアカウントでテストモード使用**
- 📌 現在のサブスクリプション: **Standard 1ヶ月プラン**を契約中
- 📌 残り日数: 15日程度が理想（プロレーション計算が分かりやすい）

#### 事前確認
```bash
# 1. Stripe CLI で webhook リスニング開始（別ターミナル）
stripe listen --forward-to localhost:54321/functions/v1/stripe-webhook

# 2. 開発サーバー起動
npm run dev

# 3. ブラウザでログイン
# テストユーザーでログイン（Standard 1ヶ月契約中のユーザー）
```

---

### Test 2B: プラン変更フルフロー

#### Step 1: 現在の状態確認

**操作手順**:
1. `/subscription` ページにアクセス

**確認項目**:
- [ ] 現在のプラン: **Standard 1ヶ月**
- [ ] 月額料金: **¥4,000/月**
- [ ] 次回更新日が表示されている（例: 2025年12月13日）
- [ ] ステータス: **アクティブ**

**スクリーンショット撮影**:
- 📸 変更前のサブスクリプション画面

---

#### Step 2: プラン変更開始

**操作手順**:
1. **Feedback 1ヶ月プラン**の「購読」ボタンをクリック

**確認項目**:
- [ ] プラン変更確認モーダルが表示される

---

#### Step 3: モーダル内容確認（Test 2B仕様）

**確認項目（プラン情報）**:
- [ ] 現在のプラン: **スタンダード 1ヶ月プラン**
- [ ] 現在の月額: **¥4,000/月**
- [ ] 矢印アイコン表示
- [ ] 新しいプラン: **フィードバック 1ヶ月プラン**
- [ ] 新しい月額: **¥1,480/月**

**確認項目（プロレーション）**:
残り日数が**15日**の場合の例:
- [ ] 現在のプラン返金: **-¥2,000**（緑色）
- [ ] 新プラン請求: **+¥740**
- [ ] 合計: **-¥1,260 返金**（緑色）

**計算式検証**:
```
現在のプラン: ¥4,000 / 30日 × 15日 = ¥2,000
新プラン: ¥1,480 / 30日 × 15日 = ¥740
合計: -¥2,000 + ¥740 = -¥1,260（返金）
```

**確認項目（その他）**:
- [ ] 次回請求日が正しい
- [ ] 次回以降: **¥1,480/月**
- [ ] 注意事項が表示されている

**スクリーンショット撮影**:
- 📸 プラン変更確認モーダル（プロレーション表示）

---

#### Step 4: プラン変更確定

**操作手順**:
1. 「プラン変更を確定」ボタンをクリック

**期待される動作**:
- [ ] モーダルが閉じる
- [ ] ローディング表示
- [ ] **Stripe Checkout画面**に遷移

---

#### Step 5: Stripe Checkout画面確認（重要）

**確認項目（画面タイトル）**:
- [ ] 画面タイトルが「**Update subscription**」または「**サブスクリプションを更新**」
- [ ] ❌ 「Subscribe to...」や「新規購読」ではない（これが出たら失敗）

**確認項目（プラン情報）**:
- [ ] プラン名: **Feedback 1ヶ月**（または対応する英語表示）
- [ ] 月額料金: **¥1,480/月**

**確認項目（支払い金額）**:
- [ ] 今回の支払い: **プロレーション後の金額**
  - 返金の場合: `-¥1,260`相当の表示
  - または「Credit applied」のような表示
- [ ] 次回以降の請求: **¥1,480/月**

**確認項目（支払い方法）**:
- [ ] 既存の支払い方法が表示されている
- [ ] 新しいカード情報入力は不要（既存顧客として扱われている）

**スクリーンショット撮影**:
- 📸 Stripe Checkout画面（「Update subscription」表示）
- 📸 支払い金額詳細

---

#### Step 6: 支払い完了

**操作手順**:
1. Stripe Checkoutで支払いを完了する
   - テストモードの場合: テストカード番号 `4242 4242 4242 4242` を使用
   - CVC: 任意の3桁
   - 有効期限: 未来の日付

**期待される動作**:
- [ ] 支払い処理が成功
- [ ] `/subscription?updated=true` にリダイレクト
- [ ] トースト通知が表示される: 「プランを変更しました」

**スクリーンショット撮影**:
- 📸 トースト通知表示

---

#### Step 7: 変更後の状態確認

**確認項目（Subscription ページ）**:
- [ ] 現在のプラン: **Feedback 1ヶ月**
- [ ] 月額料金: **¥1,480/月**
- [ ] 次回更新日が正しい（変更前と同じ日付）
- [ ] ステータス: **アクティブ**

**スクリーンショット撮影**:
- 📸 変更後のサブスクリプション画面

---

#### Step 8: Stripeダッシュボード確認

**操作手順**:
1. Stripe ダッシュボードにログイン
2. 該当顧客のサブスクリプションを確認

**確認項目（Subscription詳細）**:
- [ ] プラン: **Feedback 1ヶ月**
- [ ] ステータス: **Active**
- [ ] 次回請求日が正しい
- [ ] 次回請求額: **¥1,480**

**確認項目（Invoice履歴）**:
- [ ] プロレーションを含むInvoiceが作成されている
- [ ] 返金額と新規請求額が正しく記録されている
- [ ] 合計金額が正しい（返金の場合はマイナス）

**確認項目（Payment履歴）**:
- [ ] 支払い/返金が正しく処理されている
- [ ] 二重課金が発生していない

**スクリーンショット撮影**:
- 📸 Stripeダッシュボード - Subscription詳細
- 📸 Stripeダッシュボード - Invoice詳細
- 📸 Stripeダッシュボード - Payment履歴

---

#### Step 9: Edge Function ログ確認

**操作手順**:
```bash
# Supabase Edge Function のログ確認
supabase functions logs check-subscription --limit 50
```

**確認項目**:
- [ ] `checkout.session.completed` webhookが正しく処理されている
- [ ] データベース更新ログがある
- [ ] エラーログがない

**または**:
```bash
# Stripe CLI のwebhookログ確認
# stripe listenを実行中のターミナルでログを確認
```

**スクリーンショット撮影**:
- 📸 Edge Functionログ（成功ログ）

---

#### Step 10: データベース確認（オプション）

**操作手順**:
```sql
-- Supabase SQL Editorで実行
SELECT
  user_id,
  plan_type,
  duration,
  is_active,
  current_period_end,
  cancel_at_period_end,
  updated_at
FROM user_subscriptions
WHERE user_id = 'YOUR_USER_ID'
ORDER BY updated_at DESC
LIMIT 1;
```

**確認項目**:
- [ ] `plan_type`: **feedback**
- [ ] `duration`: **1**
- [ ] `is_active`: **true**
- [ ] `current_period_end`: 変更前と同じ日時
- [ ] `updated_at`: 最新のタイムスタンプ

---

### Test 2B 完了チェックリスト

#### ✅ 成功条件（全て満たす必要あり）
- [ ] プラン変更確認モーダルが正しく表示された
- [ ] プロレーション計算が正確だった
- [ ] Stripe Checkoutで「**Update subscription**」と表示された（新規購読ではない）
- [ ] 支払いが成功した
- [ ] トースト通知「プランを変更しました」が表示された
- [ ] 変更後のプランが正しく反映された（Feedback 1ヶ月）
- [ ] 次回更新日が変更されていない
- [ ] Stripeダッシュボードで確認したプランが正しい
- [ ] **二重課金が発生していない**
- [ ] Edge Functionログにエラーがない

#### ❌ 失敗パターン（これらが発生したら問題）
- [ ] Checkout画面で「Subscribe to...」（新規購読）と表示された → **Deep Link問題再発**
- [ ] 二重課金が発生した → **Option 3が正しく動作していない**
- [ ] プロレーション計算が間違っている → **計算ロジックのバグ**
- [ ] モーダルが表示されない → **統合エラー**
- [ ] データベース更新が失敗した → **Webhook処理エラー**

---

### 追加テストケース（オプション）

#### Test 2B-2: 期間変更（同じプランタイプ）

**前提条件**: Feedback 1ヶ月契約中

**操作手順**:
1. Feedback 3ヶ月プランに変更

**確認項目**:
- [ ] モーダルでプロレーション表示
  - 返金: Feedback 1ヶ月の残り日数分
  - 請求: Feedback 3ヶ月の残り日数分
  - 合計: 小額の返金（3ヶ月の方が月額安いため）
- [ ] Checkout画面で「Update subscription」
- [ ] 変更完了後、Feedback 3ヶ月になっている

---

#### Test 2B-3: アップグレード（低額→高額）

**前提条件**: Feedback 1ヶ月契約中

**操作手順**:
1. Standard 1ヶ月プランに変更

**確認項目**:
- [ ] モーダルでプロレーション表示
  - 返金: Feedback 1ヶ月の残り日数分（少額）
  - 請求: Standard 1ヶ月の残り日数分（高額）
  - 合計: **追加請求**（赤色で表示）
- [ ] Checkout画面で追加請求額が正しい
- [ ] 変更完了後、Standard 1ヶ月になっている

---

## テスト実施チェックリスト

### Phase 4-2: UI目視確認

#### 基本動作
- [ ] テストケース 1: モーダル表示確認
- [ ] テストケース 2: プロレーション表示確認
- [ ] テストケース 3: 次回請求情報確認
- [ ] テストケース 4: 注意事項表示確認
- [ ] テストケース 5-1: キャンセルボタン
- [ ] テストケース 5-2: 確定ボタン（Test 2Bで確認）

#### レスポンシブ・デザイン
- [ ] テストケース 6: レスポンシブデザイン確認
- [ ] 目視確認チェックリスト（デザイン・UI）
- [ ] 目視確認チェックリスト（タイポグラフィ）
- [ ] 目視確認チェックリスト（インタラクション）

#### 複数パターン
- [ ] テストケース 7-1: Standard 1ヶ月 → Standard 3ヶ月
- [ ] テストケース 7-2: Feedback 1ヶ月 → Feedback 3ヶ月
- [ ] テストケース 7-3: Standard → Feedback
- [ ] テストケース 7-4: Feedback → Standard

#### エッジケース
- [ ] テストケース 8-1: 残り1日
- [ ] テストケース 8-2: 残り0日（当日）
- [ ] テストケース 8-3: 残り30日（更新直後）

---

### Phase 4-3: Test 2B（E2Eテスト）

#### メインフロー（Test 2B）
- [ ] Step 1: 現在の状態確認
- [ ] Step 2: プラン変更開始
- [ ] Step 3: モーダル内容確認
- [ ] Step 4: プラン変更確定
- [ ] Step 5: Stripe Checkout画面確認（**最重要**）
- [ ] Step 6: 支払い完了
- [ ] Step 7: 変更後の状態確認
- [ ] Step 8: Stripeダッシュボード確認
- [ ] Step 9: Edge Functionログ確認
- [ ] Step 10: データベース確認（オプション）

#### 成功条件確認
- [ ] ✅ 全ての成功条件を満たしている
- [ ] ❌ 失敗パターンが1つも発生していない

#### 追加テスト（オプション）
- [ ] Test 2B-2: 期間変更（同じプランタイプ）
- [ ] Test 2B-3: アップグレード（低額→高額）

---

## 📸 スクリーンショット一覧

### 必須スクリーンショット
1. 変更前のサブスクリプション画面
2. プラン変更確認モーダル（プロレーション表示）
3. Stripe Checkout画面（「Update subscription」表示）
4. 支払い金額詳細
5. トースト通知表示
6. 変更後のサブスクリプション画面
7. Stripeダッシュボード - Subscription詳細
8. Stripeダッシュボード - Invoice詳細
9. Stripeダッシュボード - Payment履歴
10. Edge Functionログ（成功ログ）

### 保存先
```
.claude/docs/subscription/testing/screenshots/phase4/
├── 01-before-change.png
├── 02-modal-proration.png
├── 03-checkout-update.png
├── 04-payment-details.png
├── 05-toast-notification.png
├── 06-after-change.png
├── 07-stripe-subscription.png
├── 08-stripe-invoice.png
├── 09-stripe-payment.png
└── 10-edge-function-logs.png
```

---

## 🐛 問題発生時の対処

### 問題 1: モーダルが表示されない

**原因候補**:
- `showConfirmModal`の状態管理エラー
- `renewalDate`が取得できていない
- インポートエラー

**デバッグ手順**:
```typescript
// Subscription.tsx の handleSubscribe 内にログ追加
console.log('Modal state:', {
  showConfirmModal,
  selectedNewPlan,
  planType,
  currentDuration,
  renewalDate
});
```

**確認項目**:
- [ ] `renewalDate`が`null`または`undefined`ではない
- [ ] `planType`と`currentDuration`が正しい値
- [ ] ブラウザのコンソールエラーを確認

---

### 問題 2: プロレーション計算が間違っている

**デバッグ手順**:
```typescript
// PlanChangeConfirmModal.tsx 内にログ追加
console.log('Proration calculation:', {
  currentPlanInfo,
  newPlanInfo,
  currentPeriodEnd,
  proration
});
```

**確認項目**:
- [ ] `currentPeriodEnd`の日時が正しい
- [ ] `monthlyPrice`が正しく取得できている
- [ ] ユニットテストと同じ計算結果か確認

---

### 問題 3: Checkoutで「Subscribe to...」と表示される（失敗）

**原因**: Option 3のCheckoutロジックが正しく動作していない

**確認項目**:
- [ ] `createCheckoutSession`の引数が正しいか
- [ ] Edge Functionのログを確認
- [ ] Stripe Checkoutの`mode`が`subscription`になっているか
- [ ] 既存のサブスクリプションIDが渡されているか

**対処方法**:
1. Edge Functionログを確認: `supabase functions logs create-checkout`
2. Stripe APIリクエストログを確認
3. 必要に応じて`.claude/docs/subscription/issues/`にissueを記録

---

### 問題 4: 二重課金が発生した（最悪のケース）

**即座に実施**:
1. ❌ **テストを中止**
2. Stripeダッシュボードで確認
3. 必要に応じて手動で返金処理
4. Edge Functionログを全て保存
5. `.claude/docs/subscription/issues/`に詳細なissueを記録

**根本原因調査**:
- Option 3のCheckoutロジック実装を再確認
- Webhookハンドラーを確認
- 既存サブスクリプションのキャンセル処理を確認

---

## 📝 テスト完了報告フォーマット

テスト完了後、以下の形式で報告書を作成してください。

### 報告書テンプレート

```markdown
# Phase 4 テスト完了報告

**実施日**: YYYY-MM-DD
**実施者**: [名前]
**環境**: テストモード / 本番モード

---

## Phase 4-2: UI目視確認

### 実施結果
- ✅ / ❌ 全テストケース合格

### 詳細
- テストケース 1: ✅ / ❌
- テストケース 2: ✅ / ❌
...

### 発見した問題
1. [問題の説明]
2. ...

### スクリーンショット
- 📎 [スクリーンショットへのリンク]

---

## Phase 4-3: Test 2B（E2Eテスト）

### 実施結果
- ✅ / ❌ Test 2B合格

### フロー確認
- Step 1: ✅ / ❌
- Step 2: ✅ / ❌
...

### 成功条件確認
- ✅ / ❌ 全ての成功条件を満たした
- ✅ / ❌ 失敗パターンが発生しなかった

### Stripe確認結果
- プラン変更: ✅ / ❌ 正常
- 二重課金: ✅ / ❌ 発生せず
- Invoice: ✅ / ❌ 正常

### 発見した問題
1. [問題の説明]
2. ...

### スクリーンショット
- 📎 [スクリーンショット一覧へのリンク]

---

## 総合評価

### 合否
- ✅ 合格 / ❌ 不合格

### 次のアクション
1. [必要なアクション]
2. ...

### コメント
[テスト全体を通しての所感、改善提案など]
```

---

**ドキュメント終了**
