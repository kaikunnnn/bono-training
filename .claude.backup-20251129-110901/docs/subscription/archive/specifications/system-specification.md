# ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚·ã‚¹ãƒ†ãƒ  å®Œå…¨ä»•æ§˜æ›¸

**æœ€çµ‚æ›´æ–°**: 2025-11-24
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 2.1
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… æœ¬ç•ªç¨¼åƒä¸­ï¼ˆDeep Link & Webhook å®Œå…¨å¯¾å¿œï¼‰

---

## ğŸ“‹ ç›®æ¬¡

1. [ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦](#ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦)
2. [ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
3. [å®Ÿè£…æ¸ˆã¿æ©Ÿèƒ½](#å®Ÿè£…æ¸ˆã¿æ©Ÿèƒ½)
4. [ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼](#ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼)
5. [æŠ€è¡“ä»•æ§˜](#æŠ€è¡“ä»•æ§˜)
6. [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ](#ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ)
7. [Edge Functions](#edge-functions)
8. [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£](#ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£)
9. [ãƒ†ã‚¹ãƒˆè¨ˆç”»](#ãƒ†ã‚¹ãƒˆè¨ˆç”»)

---

## ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦

### ãƒ—ãƒ©ãƒ³æ§‹æˆ

| ãƒ—ãƒ©ãƒ³ | 1ãƒ¶æœˆæ‰•ã„ | 3ãƒ¶æœˆæ‰•ã„ | æ©Ÿèƒ½ |
|--------|-----------|-----------|------|
| **Feedback** | Â¥1,480/æœˆ | Â¥980/æœˆ | ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚¢ã‚¯ã‚»ã‚¹ |
| **Standard** | Â¥3,480/æœˆ | Â¥2,980/æœˆ | ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ + å­¦ç¿’ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ |
| **Growth** | Â¥9,800/æœˆ | Â¥8,800/æœˆ | å…¨æ©Ÿèƒ½ + ã‚µãƒãƒ¼ãƒˆ |

### ä¸»è¦æ©Ÿèƒ½

- âœ… æ–°è¦ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç™»éŒ²
- âœ… ãƒ—ãƒ©ãƒ³å¤‰æ›´ï¼ˆStandard â‡” Feedback â‡” Growthï¼‰
- âœ… æœŸé–“å¤‰æ›´ï¼ˆ1ãƒ¶æœˆ â‡” 3ãƒ¶æœˆï¼‰
- âœ… ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆæœŸé–“çµ‚äº†æ™‚ï¼‰
- âœ… äºŒé‡èª²é‡‘é˜²æ­¢
- âœ… ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ
- âœ… Test/Live ç’°å¢ƒåˆ†é›¢

---

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆå›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰  â”‚ (React + TypeScript)
â”‚  Vite           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                  â”‚
         â–¼                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Supabase Auth   â”‚              â”‚ Stripe Checkout â”‚
â”‚ (èªè¨¼ç®¡ç†)      â”‚              â”‚ (æ±ºæ¸ˆç”»é¢)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                  â”‚
         â”‚                                  â”‚ Webhook
         â–¼                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Supabase Edge Functions                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ check-subscription    (è³¼èª­çŠ¶æ…‹ç¢ºèª)           â”‚
â”‚ â€¢ create-checkout       (Checkout ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ)â”‚
â”‚ â€¢ create-customer-portal (ã‚«ã‚¹ã‚¿ãƒãƒ¼ãƒãƒ¼ã‚¿ãƒ«)    â”‚
â”‚ â€¢ stripe-webhook        (Webhook ãƒãƒ³ãƒ‰ãƒ©)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Supabase Database (PostgreSQL)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ user_subscriptions    (è³¼èª­æƒ…å ±)               â”‚
â”‚ â€¢ stripe_customers      (Stripe é¡§å®¢æƒ…å ±)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Realtime
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Supabase Realtime                        â”‚
â”‚  (DBå¤‰æ›´ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒ•ãƒ­ãƒ³ãƒˆã«é€šçŸ¥)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

#### æ–°è¦ç™»éŒ²ãƒ•ãƒ­ãƒ¼
```
ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ ãƒ—ãƒ©ãƒ³é¸æŠ â†’ create-checkout â†’ Stripe Checkout
â†’ æ±ºæ¸ˆå®Œäº† â†’ Webhook â†’ DBä¿å­˜ â†’ Realtimeé€šçŸ¥ â†’ UIæ›´æ–°
```

#### ãƒ—ãƒ©ãƒ³å¤‰æ›´ãƒ•ãƒ­ãƒ¼ï¼ˆDeep Linkå¯¾å¿œ - 2025-11-24æ›´æ–°ï¼‰
```
ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ ãƒ—ãƒ©ãƒ³é¸æŠ â†’ create-customer-portal (Deep Link)
â†’ Stripe Portalï¼ˆãƒ—ãƒ©ãƒ³å¤‰æ›´ç¢ºèªç”»é¢ã«ç›´æ¥é·ç§»ï¼‰
â†’ å¤‰æ›´ç¢ºå®š â†’ æ—¢å­˜ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°ï¼ˆæ–°è¦ä½œæˆã›ãšï¼‰
â†’ Webhook (customer.subscription.updated) â†’ DBæ›´æ–°
â†’ Realtimeé€šçŸ¥ â†’ UIæ›´æ–°
```

**é‡è¦ãªä»•æ§˜å¤‰æ›´ï¼ˆ2025-11-24ï¼‰:**
- âŒ æ—§å®Ÿè£…: æ–°ã—ã„ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã€æ—§ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆãƒ—ãƒ­ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æœªé©ç”¨ï¼‰
- âœ… æ–°å®Ÿè£…: æ—¢å­˜ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ›´æ–°ï¼ˆãƒ—ãƒ­ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è‡ªå‹•é©ç”¨ï¼‰
- âœ… Deep Link: Customer Portal ã®ãƒ—ãƒ©ãƒ³å¤‰æ›´ç¢ºèªç”»é¢ã«ç›´æ¥é·ç§»
- âœ… Webhook: `customer.subscription.updated` ã‚¤ãƒ™ãƒ³ãƒˆã§ `plan_type` ã¨ `duration` ã‚’è‡ªå‹•æ›´æ–°

#### è³¼èª­ç¢ºèªãƒ•ãƒ­ãƒ¼
```
ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰ â†’ check-subscription â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ â†’ DBæ¤œç´¢
â†’ ç’°å¢ƒåˆ¤å®š(test/live) â†’ ãƒ‡ãƒ¼ã‚¿å–å¾— â†’ ãƒ•ãƒ­ãƒ³ãƒˆè¡¨ç¤º
```

---

## å®Ÿè£…æ¸ˆã¿æ©Ÿèƒ½

### âœ… 1. æ–°è¦ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç™»éŒ²

**å¯¾å¿œãƒ•ãƒ­ãƒ¼**:
- ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ–°è¦ç™»éŒ²

**æœªå¯¾å¿œ**:
- æœªãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ–°è¦ç™»éŒ²ï¼ˆãƒ—ãƒ©ãƒ³é¸æŠâ†’èªè¨¼â†’è‡ªå‹•Checkoutï¼‰

**å®Ÿè£…å ´æ‰€**:
- ãƒ•ãƒ­ãƒ³ãƒˆ: `src/pages/Subscription.tsx`
- Edge Function: `supabase/functions/create-checkout/index.ts`

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**:
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ—ãƒ©ãƒ³ãƒ»æœŸé–“ã‚’é¸æŠ
2. `create-checkout` Edge Function å‘¼ã³å‡ºã—
3. **æ—¢å­˜ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒ–ã‚¹ã‚¯ã‚’å…¨ã¦ã‚­ãƒ£ãƒ³ã‚»ãƒ«**ï¼ˆäºŒé‡èª²é‡‘é˜²æ­¢ï¼‰
4. Stripe Checkout ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
5. Checkout ãƒšãƒ¼ã‚¸ã«é·ç§»
6. æ±ºæ¸ˆå®Œäº†å¾Œ Webhook ã§ DB ä¿å­˜

---

### âœ… 2. ãƒ—ãƒ©ãƒ³å¤‰æ›´

**å¯¾å¿œãƒ‘ã‚¿ãƒ¼ãƒ³**:
- Standard â†’ Feedback
- Feedback â†’ Standard
- Standard â†’ Growth
- Growth â†’ Standard
- Feedback â†’ Growth
- Growth â†’ Feedback

**å®Ÿè£…å ´æ‰€**:
- ãƒ•ãƒ­ãƒ³ãƒˆ: `src/pages/Subscription.tsx`
- Edge Function: `supabase/functions/create-customer-portal/index.ts`

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**:
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ–°ã—ã„ãƒ—ãƒ©ãƒ³ã‚’é¸æŠ
2. `create-customer-portal` Edge Function å‘¼ã³å‡ºã—ï¼ˆ`useDeepLink: true`ï¼‰
3. Stripe Customer Portal ã®ãƒ—ãƒ©ãƒ³å¤‰æ›´ç”»é¢ã«ç›´æ¥é·ç§»
4. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ—ãƒ©ãƒ³å¤‰æ›´ã‚’ç¢ºå®š
5. Webhook å—ä¿¡:
   - `customer.subscription.updated` (æ—§ã‚µãƒ–ã‚¹ã‚¯)
   - `customer.subscription.created` (æ–°ã‚µãƒ–ã‚¹ã‚¯)
6. DB æ›´æ–°:
   - æ—§ã‚µãƒ–ã‚¹ã‚¯: `is_active = false`
   - æ–°ã‚µãƒ–ã‚¹ã‚¯: æ–°è¦ãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆ
7. Realtime ã§ UI è‡ªå‹•æ›´æ–°

**æ—¥å‰²ã‚Šè¨ˆç®—**:
- Stripe ãŒè‡ªå‹•çš„ã«æ®‹ã‚Šæ—¥æ•°åˆ†ã‚’è¨ˆç®—
- å·®é¡ã‚’è«‹æ±‚ or è¿”é‡‘

---

### âœ… 3. æœŸé–“å¤‰æ›´

**å¯¾å¿œãƒ‘ã‚¿ãƒ¼ãƒ³**:
- 1ãƒ¶æœˆæ‰•ã„ â†’ 3ãƒ¶æœˆæ‰•ã„
- 3ãƒ¶æœˆæ‰•ã„ â†’ 1ãƒ¶æœˆæ‰•ã„

**å‡¦ç†**:
- ãƒ—ãƒ©ãƒ³å¤‰æ›´ã¨åŒã˜ãƒ•ãƒ­ãƒ¼
- Stripe ãŒè‡ªå‹•çš„ã«æ—¥å‰²ã‚Šè¨ˆç®—

**ä¾¡æ ¼ä¾‹**:
```
Standard 1ãƒ¶æœˆ: Â¥3,480/æœˆ
Standard 3ãƒ¶æœˆ: Â¥2,980/æœˆï¼ˆÂ¥500ãŠå¾—ï¼‰
```

---

### âœ… 4. ã‚­ãƒ£ãƒ³ã‚»ãƒ«

**ä»•æ§˜**:
- å³æ™‚ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã§ã¯ãªã„
- æœŸé–“çµ‚äº†æ™‚ã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆ`cancel_at_period_end: true`ï¼‰
- æœŸé–“ä¸­ã¯å¼•ãç¶šãåˆ©ç”¨å¯èƒ½

**å®Ÿè£…å ´æ‰€**:
- ãƒ•ãƒ­ãƒ³ãƒˆ: `src/pages/Account.tsx`
- Edge Function: `supabase/functions/create-customer-portal/index.ts`

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**:
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç®¡ç†ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
2. `create-customer-portal` Edge Function å‘¼ã³å‡ºã—ï¼ˆ`useDeepLink: false`ï¼‰
3. Stripe Customer Portal ã«é·ç§»
4. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€â†’ã€ŒæœŸé–“çµ‚äº†æ™‚ã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ã‚’é¸æŠ
5. Webhook å—ä¿¡ï¼ˆ`customer.subscription.updated`ï¼‰
6. DB æ›´æ–°:
   - `cancel_at_period_end = true`
   - `cancel_at = ã‚­ãƒ£ãƒ³ã‚»ãƒ«äºˆå®šæ—¥`
   - `is_active = true`ï¼ˆæœŸé–“ä¸­ã¯æœ‰åŠ¹ï¼‰
7. Realtime ã§ UI è‡ªå‹•æ›´æ–°ï¼ˆã€Œè§£ç´„äºˆå®šã€ãƒãƒƒã‚¸è¡¨ç¤ºï¼‰
8. æœŸé–“çµ‚äº†æ—¥ã« Stripe ãŒè‡ªå‹•å‰Šé™¤
9. Webhook å—ä¿¡ï¼ˆ`customer.subscription.deleted`ï¼‰
10. DB æ›´æ–°: `is_active = false`

**UIè¡¨ç¤º**:
- è§£ç´„äºˆå®šæ™‚: ğŸ”´ è§£ç´„äºˆå®šãƒãƒƒã‚¸ + åˆ©ç”¨æœŸé™è¡¨ç¤º
- æœŸé–“çµ‚äº†å¾Œ: ã€Œã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³æœªç™»éŒ²ã€

---

### âœ… 5. è³¼èª­çŠ¶æ…‹ç¢ºèª

**å®Ÿè£…å ´æ‰€**:
- Edge Function: `supabase/functions/check-subscription/index.ts`
- ãƒ•ãƒ­ãƒ³ãƒˆ: `src/hooks/useSubscription.ts`

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**:
1. ãƒ•ãƒ­ãƒ³ãƒˆã‹ã‚‰ Edge Function å‘¼ã³å‡ºã—
2. ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ç¢ºèª
3. **ç’°å¢ƒåˆ¤å®š**ï¼ˆtest/liveï¼‰
4. DB ã‹ã‚‰è³¼èª­æƒ…å ±ã‚’æ¤œç´¢:
   - ã¾ãšç¾åœ¨ã®ç’°å¢ƒã§æ¤œç´¢
   - è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°é€†ã®ç’°å¢ƒã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ¤œç´¢
5. è³¼èª­æƒ…å ±ã‚’è¿”å´:
   - `subscribed`: boolean
   - `planType`: 'standard' | 'feedback' | 'growth'
   - `duration`: 1 | 3
   - `cancelAtPeriodEnd`: boolean
   - `cancelAt`: string | null
   - `renewalDate`: string | null
   - `hasMemberAccess`: boolean
   - `hasLearningAccess`: boolean

**ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯**:
- Edge Function ã‚¨ãƒ©ãƒ¼æ™‚ã¯ç›´æ¥ DB ã‹ã‚‰å–å¾—
- ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã€ŒEdge Functionã‚¨ãƒ©ãƒ¼ã€ç›´æ¥DBã‹ã‚‰å–å¾—ã—ã¾ã™ã€ã¨è¡¨ç¤º

---

### âœ… 6. äºŒé‡èª²é‡‘é˜²æ­¢

**å®Ÿè£…ç®‡æ‰€**:

#### 6-1. Checkout ä½œæˆå‰ã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«
**å ´æ‰€**: `create-checkout/index.ts`

```typescript
// æ—¢å­˜ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒ–ã‚¹ã‚¯ã‚’å…¨ã¦å–å¾—
const existingSubscriptions = await getActiveSubscriptions(userId);

// å…¨ã¦ã‚­ãƒ£ãƒ³ã‚»ãƒ«
for (const sub of existingSubscriptions) {
  await stripe.subscriptions.cancel(sub.id, { prorate: true });
  await updateDbSubscription(sub.id, { is_active: false });
}

// ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¤±æ•—æ™‚ã¯ Checkout ä½œæˆã‚’ä¸­æ­¢ï¼ˆåŸå­æ€§ä¿è¨¼ï¼‰
```

#### 6-2. Webhook å—ä¿¡æ™‚ã«é‡è¤‡ãƒã‚§ãƒƒã‚¯
**å ´æ‰€**: `stripe-webhook/index.ts`

```typescript
// æ–°è¦ã‚µãƒ–ã‚¹ã‚¯ä½œæˆæ™‚
if (event.type === 'checkout.session.completed') {
  // æ—¢å­˜ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒ–ã‚¹ã‚¯ã‚’ is_active = false ã«æ›´æ–°
  await deactivateOldSubscriptions(userId);

  // æ–°ã—ã„ã‚µãƒ–ã‚¹ã‚¯ã‚’ upsert
  await upsertSubscription(newSubscriptionData);
}
```

#### 6-3. upsert ã§é‡è¤‡é˜²æ­¢
**å ´æ‰€**: DBæ“ä½œå…¨èˆ¬

```typescript
.upsert({
  stripe_subscription_id: subscriptionId,
  // ...
}, { onConflict: 'stripe_subscription_id' })
```

**DBåˆ¶ç´„**:
```sql
-- user_id + environment ã§ UNIQUE åˆ¶ç´„
ALTER TABLE user_subscriptions
ADD CONSTRAINT user_subscriptions_user_id_environment_key
UNIQUE (user_id, environment);
```

---

### âœ… 7. Test/Live ç’°å¢ƒåˆ†é›¢

**ä»•æ§˜**:
- Test ãƒ¢ãƒ¼ãƒ‰: Stripe ãƒ†ã‚¹ãƒˆã‚­ãƒ¼ä½¿ç”¨
- Live ãƒ¢ãƒ¼ãƒ‰: Stripe æœ¬ç•ªã‚­ãƒ¼ä½¿ç”¨
- DB ã« `environment` ã‚«ãƒ©ãƒ ã§ç®¡ç†

**ç’°å¢ƒåˆ¤å®šãƒ­ã‚¸ï¿½ï¿½**:
```typescript
// utils.ts
export function getCurrentEnvironment(): 'test' | 'live' {
  const testKey = Deno.env.get("STRIPE_TEST_SECRET_KEY");
  return testKey ? 'test' : 'live';
}
```

**DBæ¤œç´¢æ™‚ã®å‹•ä½œ**:
1. ã¾ãšç¾åœ¨ã®ç’°å¢ƒï¼ˆtest/liveï¼‰ã§æ¤œç´¢
2. è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°é€†ã®ç’°å¢ƒã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ¤œç´¢
3. ã©ã¡ã‚‰ã«ã‚‚ãªã‘ã‚Œã° null ã‚’è¿”ã™

**ç’°å¢ƒå¤‰æ•°**:
```
STRIPE_TEST_SECRET_KEY=sk_test_...
STRIPE_LIVE_SECRET_KEY=sk_live_...
STRIPE_WEBHOOK_SECRET_TEST=whsec_...
STRIPE_WEBHOOK_SECRET_LIVE=whsec_...
```

---

### âœ… 8. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ

**å®Ÿè£…å ´æ‰€**:
- `src/hooks/useSubscription.ts`

**ä»•çµ„ã¿**:
```typescript
// Supabase Realtime ã§DBå¤‰æ›´ã‚’è³¼èª­
supabase
  .channel('user_subscriptions_changes')
  .on('postgres_changes', {
    event: '*',
    schema: 'public',
    table: 'user_subscriptions',
    filter: `user_id=eq.${user.id}`
  }, (payload) => {
    // DBå¤‰æ›´ã‚’æ¤œçŸ¥ã—ãŸã‚‰è‡ªå‹•çš„ã«æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    fetchSubscription();
  })
  .subscribe();
```

**åŠ¹æœ**:
- Webhook ã§ DB æ›´æ–°å¾Œã€å³åº§ã«ãƒ•ãƒ­ãƒ³ãƒˆã«åæ˜ 
- ãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰ä¸è¦
- ä»–ã®ã‚¿ãƒ–ã§å¤‰æ›´ã—ã¦ã‚‚å…¨ã‚¿ãƒ–ã§åŒæœŸ

---

### âœ… 9. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

#### 9-1. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼
**å®Ÿè£…**: `src/utils/retry.ts`

```typescript
export async function retryWithExponentialBackoff<T>(
  fn: () => Promise<T>,
  maxRetries = 3
): Promise<T> {
  // æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã§ãƒªãƒˆãƒ©ã‚¤
  // 1ç§’ â†’ 2ç§’ â†’ 4ç§’
}
```

**å¯¾è±¡ã‚¨ãƒ©ãƒ¼**:
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼
- 5xx ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼
- 429 Too Many Requests

#### 9-2. Stripe API ã‚¨ãƒ©ãƒ¼
**å®Ÿè£…**: Edge Functions å†…

```typescript
try {
  const session = await stripe.checkout.sessions.create({...});
} catch (error) {
  return new Response(JSON.stringify({
    error: true,
    message: 'Stripe API ã‚¨ãƒ©ãƒ¼: ' + error.message
  }), { status: 500 });
}
```

#### 9-3. Edge Function ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
**å®Ÿè£…**: `useSubscription.ts`

```typescript
// Edge Function å¤±æ•—æ™‚ã¯ç›´æ¥ DB ã‹ã‚‰å–å¾—
if (edgeFunctionResponse.error) {
  console.warn('Edge Functionã‚¨ãƒ©ãƒ¼ã€ç›´æ¥DBã‹ã‚‰å–å¾—ã—ã¾ã™');
  const dbData = await supabase
    .from('user_subscriptions')
    .select('*')
    .eq('user_id', user.id)
    .maybeSingle();
  // ...
}
```

---

## ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼

### ãƒ•ãƒ­ãƒ¼1: æ–°è¦ç™»éŒ²ï¼ˆãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ï¼‰

```
1. /subscription ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹
   â†“
2. ãƒ—ãƒ©ãƒ³ãƒ»æœŸé–“ã‚’é¸æŠï¼ˆä¾‹: Standard 1ãƒ¶æœˆï¼‰
   â†“
3. ã€Œä»Šã™ãå§‹ã‚ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
   â†“
4. create-checkout Edge Function å‘¼ã³å‡ºã—
   â†“
5. æ—¢å­˜ã‚µãƒ–ã‚¹ã‚¯ã‚’å…¨ã¦ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆäºŒé‡èª²é‡‘é˜²æ­¢ï¼‰
   â†“
6. Stripe Checkout ãƒšãƒ¼ã‚¸ã«é·ç§»
   â†“
7. ã‚«ãƒ¼ãƒ‰æƒ…å ±å…¥åŠ›ãƒ»æ±ºæ¸ˆå®Œäº†
   â†“
8. /subscription/success ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
   â†“
9. Webhook ã§ DB ä¿å­˜
   â†“
10. Realtime ã§ UI æ›´æ–°
   â†“
11. ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
```

**å®Ÿè£…çŠ¶æ…‹**: âœ… å®Œäº†

---

### ãƒ•ãƒ­ãƒ¼2: ãƒ—ãƒ©ãƒ³å¤‰æ›´

```
1. /subscription ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹
   â†“
2. æ–°ã—ã„ãƒ—ãƒ©ãƒ³ã‚’é¸æŠï¼ˆä¾‹: Feedback 3ãƒ¶æœˆï¼‰
   â†“
3. ã€Œãƒ—ãƒ©ãƒ³å¤‰æ›´ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
   â†“
4. create-customer-portal å‘¼ã³å‡ºã—ï¼ˆuseDeepLink: trueï¼‰
   â†“
5. Stripe Customer Portalï¼ˆãƒ—ãƒ©ãƒ³å¤‰æ›´ç”»é¢ï¼‰ã«é·ç§»
   â†“
6. æ–°ã—ã„ãƒ—ãƒ©ãƒ³ã‚’ç¢ºèªãƒ»å¤‰æ›´å®Ÿè¡Œ
   â†“
7. Webhook å—ä¿¡:
   - customer.subscription.updated (æ—§)
   - customer.subscription.created (æ–°)
   â†“
8. DB æ›´æ–°:
   - æ—§ã‚µãƒ–ã‚¹ã‚¯: is_active = false
   - æ–°ã‚µãƒ–ã‚¹ã‚¯: æ–°è¦ãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆ
   â†“
9. Realtime ã§ UI æ›´æ–°ï¼ˆå³åº§ï¼‰
   â†“
10. æ–°ã—ã„ãƒ—ãƒ©ãƒ³ã§åˆ©ç”¨é–‹å§‹
```

**å®Ÿè£…çŠ¶æ…‹**: âœ… å®Œäº†

---

### ãƒ•ãƒ­ãƒ¼3: ã‚­ãƒ£ãƒ³ã‚»ãƒ«

```
1. /account ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹
   â†“
2. ã€Œã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç®¡ç†ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
   â†“
3. create-customer-portal å‘¼ã³å‡ºã—ï¼ˆuseDeepLink: falseï¼‰
   â†“
4. Stripe Customer Portal ã«é·ç§»
   â†“
5. ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€â†’ã€ŒæœŸé–“çµ‚äº†æ™‚ã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ã‚’é¸æŠ
   â†“
6. Webhook å—ä¿¡ï¼ˆcustomer.subscription.updatedï¼‰
   â†“
7. DB æ›´æ–°:
   - cancel_at_period_end = true
   - cancel_at = ã‚­ãƒ£ãƒ³ã‚»ãƒ«äºˆå®šæ—¥
   - is_active = true
   â†“
8. Realtime ã§ UI æ›´æ–°ï¼ˆã€Œè§£ç´„äºˆå®šã€ãƒãƒƒã‚¸è¡¨ç¤ºï¼‰
   â†“
9. æœŸé–“çµ‚äº†æ—¥ã¾ã§åˆ©ç”¨å¯èƒ½
   â†“
10. æœŸé–“çµ‚äº†æ—¥ã« Stripe ãŒè‡ªå‹•å‰Šé™¤
   â†“
11. Webhook å—ä¿¡ï¼ˆcustomer.subscription.deletedï¼‰
   â†“
12. DB æ›´æ–°: is_active = false
   â†“
13. ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯
```

**å®Ÿè£…çŠ¶æ…‹**: âœ… å®Œäº†

---

## æŠ€è¡“ä»•æ§˜

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰

**æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯**:
- React 18
- TypeScript
- Vite
- React Router
- Supabase Client

**ä¸»è¦ãƒ•ã‚¡ã‚¤ãƒ«**:
- `src/pages/Subscription.tsx` - ãƒ—ãƒ©ãƒ³é¸æŠãƒ»å¤‰æ›´
- `src/pages/Account.tsx` - ã‚µãƒ–ã‚¹ã‚¯æƒ…å ±è¡¨ç¤º
- `src/hooks/useSubscription.ts` - ã‚µãƒ–ã‚¹ã‚¯çŠ¶æ…‹ç®¡ç†
- `src/services/stripe.ts` - Stripeé–¢é€£APIå‘¼ã³å‡ºã—
- `src/utils/retry.ts` - ãƒªãƒˆãƒ©ã‚¤å‡¦ç†

---

### Edge Functions

#### check-subscription
**å½¹å‰²**: è³¼èª­çŠ¶æ…‹ç¢ºèª

**å…¥åŠ›**: ãªã—ï¼ˆAuthorization ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰ user_id å–å¾—ï¼‰

**å‡ºåŠ›**:
```typescript
{
  subscribed: boolean;
  planType: 'standard' | 'feedback' | 'growth' | null;
  duration: 1 | 3 | null;
  isSubscribed: boolean;
  cancelAtPeriodEnd: boolean;
  cancelAt: string | null;
  renewalDate: string | null;
  hasMemberAccess: boolean;
  hasLearningAccess: boolean;
}
```

**å‡¦ç†**:
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ç¢ºèª
2. ç’°å¢ƒåˆ¤å®šï¼ˆtest/liveï¼‰
3. DB ã‹ã‚‰è³¼èª­æƒ…å ±æ¤œç´¢
4. ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™è¨ˆç®—
5. ãƒ¬ã‚¹ãƒãƒ³ã‚¹è¿”å´

**ã‚¨ãƒ©ãƒ¼æ™‚**:
```typescript
{
  error: true,
  message: "ã‚µãƒ¼ãƒãƒ¼å†…éƒ¨ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ",
  subscribed: false,
  planType: null
}
```

---

#### create-checkout
**å½¹å‰²**: Stripe Checkout ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ

**å…¥åŠ›**:
```typescript
{
  successUrl: string;
  planType: 'standard' | 'feedback' | 'growth';
  duration: 1 | 3;
}
```

**å‡ºåŠ›**:
```typescript
{
  url: string; // Checkout URL
}
```

**å‡¦ç†**:
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ç¢ºèª
2. **æ—¢å­˜ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒ–ã‚¹ã‚¯ã‚’å…¨ã¦ã‚­ãƒ£ãƒ³ã‚»ãƒ«**ï¼ˆäºŒé‡èª²é‡‘é˜²æ­¢ï¼‰
3. Price ID å–å¾—ï¼ˆç’°å¢ƒå¤‰æ•°ã‹ã‚‰ï¼‰
4. Stripe Checkout ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
5. Checkout URL è¿”å´

**å¿…é ˆç’°å¢ƒå¤‰æ•°ï¼ˆSupabase Secretsï¼‰:**
```bash
# Stripe API Keys
STRIPE_TEST_SECRET_KEY=sk_test_xxxxx
STRIPE_LIVE_SECRET_KEY=sk_live_xxxxx

# Stripe Webhook Secretsï¼ˆé‡è¦ï¼ï¼‰
STRIPE_WEBHOOK_SECRET_TEST=whsec_xxxxx  # â† å¿…é ˆï¼æœªè¨­å®šã ã¨401ã‚¨ãƒ©ãƒ¼
STRIPE_WEBHOOK_SECRET_LIVE=whsec_xxxxx

# Stripe Price IDsï¼ˆTestç’°å¢ƒï¼‰
VITE_STRIPE_STANDARD_1M_PRICE_ID=price_xxxxx
VITE_STRIPE_STANDARD_3M_PRICE_ID=price_xxxxx
VITE_STRIPE_FEEDBACK_1M_PRICE_ID=price_xxxxx
VITE_STRIPE_FEEDBACK_3M_PRICE_ID=price_xxxxx

# Stripe Price IDsï¼ˆLiveç’°å¢ƒ - æœªè¨­å®šï¼‰
# VITE_STRIPE_STANDARD_1M_PRICE_ID_LIVE=price_xxxxx
# VITE_STRIPE_STANDARD_3M_PRICE_ID_LIVE=price_xxxxx
# ...
```

**âš ï¸ é‡è¦: Webhook Secret ã®è¨­å®š**

Webhook Secret ãŒæœªè¨­å®šã¾ãŸã¯ä¸ä¸€è‡´ã®å ´åˆã€ä»¥ä¸‹ã®å•é¡ŒãŒç™ºç”Ÿã—ã¾ã™ï¼š
- Webhook ãŒ 401 Unauthorized ã‚¨ãƒ©ãƒ¼ã§å¤±æ•—
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒæ›´æ–°ã•ã‚Œãªã„
- ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç†ãŒå®Œå…¨ã«å‹•ä½œã—ãªã„

**è¨­å®šæ–¹æ³•:**
```bash
# 1. Stripe Dashboard ã‹ã‚‰ Webhook Secret ã‚’å–å¾—
# https://dashboard.stripe.com/test/webhooks

# 2. Supabase Secrets ã«è¨­å®š
npx supabase secrets set STRIPE_WEBHOOK_SECRET_TEST=whsec_xxxxx

# 3. ç¢ºèª
npx supabase secrets list
```

---

#### create-customer-portalï¼ˆDeep Linkå¯¾å¿œ - 2025-11-24æ›´æ–°ï¼‰
**å½¹å‰²**: Stripe Customer Portal ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ

**å…¥åŠ›**:
```typescript
{
  returnUrl: string;
  useTestPrice: boolean;
  planType?: 'standard' | 'feedback';  // Deep Linkç”¨
  duration?: 1 | 3;                    // Deep Linkç”¨
}
```

**å‡ºåŠ›**:
```typescript
{
  url: string; // Customer Portal URL
}
```

**å‡¦ç†**:
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ç¢ºèª
2. Stripe Customer ID å–å¾—
3. **Deep Link ãƒ¢ãƒ¼ãƒ‰åˆ¤å®š**ï¼ˆplanType ã¨ duration ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹ã‹ï¼‰
4. Deep Link ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆ:
   - ç¾åœ¨ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ ID ã‚’å–å¾—
   - ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚¢ã‚¤ãƒ†ãƒ  ID ã‚’å–å¾—
   - æ–°ã—ã„ãƒ—ãƒ©ãƒ³ã® Price ID ã‚’å–å¾—
   - `flow_data` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®š:
     ```typescript
     flow_data: {
       type: 'subscription_update_confirm',
       subscription_update_confirm: {
         subscription: 'sub_xxxxx',
         items: [{
           id: 'si_xxxxx',
           price: 'price_xxxxx',
           quantity: 1
         }]
       }
     }
     ```
5. Customer Portal ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
6. Portal URL è¿”å´

**Deep Link ã®å‹•ä½œ**:
- âœ… Customer Portal ã®ãƒ—ãƒ©ãƒ³å¤‰æ›´ç¢ºèªç”»é¢ã«ç›´æ¥é·ç§»
- âœ… æ—¢å­˜ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°ï¼ˆæ–°è¦ä½œæˆã—ãªã„ï¼‰
- âœ… Stripe ãŒè‡ªå‹•çš„ã«ãƒ—ãƒ­ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæ—¥å‰²ã‚Šè¨ˆç®—ï¼‰ã‚’é©ç”¨
- âœ… åŒã˜ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ ID ã‚’ç¶­æŒ

**æ¨™æº–ãƒ¢ãƒ¼ãƒ‰ï¼ˆDeep Link ãªã—ï¼‰**:
- Customer Portal ã®ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ï¼ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼‰ã«é·ç§»
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹å‹•ã§ãƒ—ãƒ©ãƒ³å¤‰æ›´ã‚’é¸æŠ

---

#### stripe-webhook
**å½¹å‰²**: Stripe Webhook ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†

**å¯¾å¿œã‚¤ãƒ™ãƒ³ãƒˆ**:
- `checkout.session.completed` - æ–°è¦ã‚µãƒ–ã‚¹ã‚¯ä½œæˆ
- `customer.subscription.created` - ã‚µãƒ–ã‚¹ã‚¯ä½œæˆ
- `customer.subscription.updated` - ã‚µãƒ–ã‚¹ã‚¯æ›´æ–°
- `customer.subscription.deleted` - ã‚µãƒ–ã‚¹ã‚¯å‰Šé™¤

**å‡¦ç†ï¼ˆcheckout.session.completedï¼‰**:
1. Webhook ç½²åæ¤œè¨¼
2. Customer IDãƒ»Subscription ID å–å¾—
3. **æ—¢å­˜ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒ–ã‚¹ã‚¯ã‚’ is_active = false ã«æ›´æ–°**
4. æ–°è¦ã‚µãƒ–ã‚¹ã‚¯æƒ…å ±ã‚’ upsert
5. ãƒ—ãƒ©ãƒ³æƒ…å ±ãƒ»æœŸé–“ãƒ»ç’°å¢ƒã‚’ä¿å­˜

**å‡¦ç†ï¼ˆcustomer.subscription.updatedï¼‰** - **2025-11-24 æ›´æ–°**:
1. Webhook ç½²åæ¤œè¨¼
2. Subscription ID ã‹ã‚‰æ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰æ¤œç´¢
3. æ›´æ–°å†…å®¹ã‚’åæ˜ :
   - `plan_type` - ãƒ—ãƒ©ãƒ³å¤‰æ›´æ™‚ã«æ›´æ–°ï¼ˆDeep Linkå¯¾å¿œï¼‰
   - `duration` - æœŸé–“å¤‰æ›´æ™‚ã«æ›´æ–°ï¼ˆDeep Linkå¯¾å¿œï¼‰
   - `cancel_at_period_end`
   - `cancel_at`
   - `current_period_end`
   - `status`

**é‡è¦**: ãƒ—ãƒ©ãƒ³å¤‰æ›´ï¼ˆDeep Linkï¼‰æ™‚ã¯ã€æ—¢å­˜ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ›´æ–°ã™ã‚‹ãŸã‚ã€`customer.subscription.updated` ã‚¤ãƒ™ãƒ³ãƒˆã§ `plan_type` ã¨ `duration` ãŒè‡ªå‹•çš„ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«åæ˜ ã•ã‚Œã¾ã™ã€‚æ–°è¦ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã¯ä½œæˆã•ã‚Œã¾ã›ã‚“ã€‚

**å‡¦ç†ï¼ˆcustomer.subscription.deletedï¼‰**:
1. Webhook ç½²åæ¤œè¨¼
2. `is_active = false` ã«æ›´æ–°

**ç’°å¢ƒåˆ¤å®š**:
- Webhook Secret ã§åˆ¤å®šï¼ˆTest/Liveï¼‰
- DB ã«ä¿å­˜æ™‚ã« `environment` ã‚«ãƒ©ãƒ ã«è¨˜éŒ²

---

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

#### user_subscriptions ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
CREATE TABLE user_subscriptions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  stripe_customer_id TEXT NOT NULL,
  stripe_subscription_id TEXT NOT NULL UNIQUE,
  plan_type TEXT NOT NULL,
  duration INTEGER,
  is_active BOOLEAN DEFAULT true,
  cancel_at_period_end BOOLEAN DEFAULT false,
  cancel_at TIMESTAMPTZ,
  current_period_end TIMESTAMPTZ,
  environment TEXT NOT NULL CHECK (environment IN ('test', 'live')),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  CONSTRAINT user_subscriptions_user_id_environment_key
    UNIQUE (user_id, environment)
);
```

**ã‚«ãƒ©ãƒ èª¬æ˜**:
- `user_id`: Supabase Auth ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
- `stripe_customer_id`: Stripe Customer ID
- `stripe_subscription_id`: Stripe Subscription IDï¼ˆUNIQUEåˆ¶ç´„ï¼‰
- `plan_type`: ãƒ—ãƒ©ãƒ³ã‚¿ã‚¤ãƒ—ï¼ˆ'standard', 'feedback', 'growth'ï¼‰
- `duration`: æœŸé–“ï¼ˆ1 or 3ï¼‰
- `is_active`: ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹
- `cancel_at_period_end`: æœŸé–“çµ‚äº†æ™‚ã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹ã‹
- `cancel_at`: ã‚­ãƒ£ãƒ³ã‚»ãƒ«äºˆå®šæ—¥
- `current_period_end`: æ¬¡å›æ›´æ–°æ—¥
- `environment`: ç’°å¢ƒï¼ˆ'test' or 'live'ï¼‰

**ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**:
```sql
CREATE INDEX idx_user_subscriptions_user_id ON user_subscriptions(user_id);
CREATE INDEX idx_user_subscriptions_stripe_customer_id ON user_subscriptions(stripe_customer_id);
CREATE INDEX idx_user_subscriptions_environment ON user_subscriptions(environment);
```

**UNIQUEåˆ¶ç´„**:
- `stripe_subscription_id`: åŒã˜ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³IDã§é‡è¤‡inserté˜²æ­¢
- `(user_id, environment)`: åŒã˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»åŒã˜ç’°å¢ƒã§è¤‡æ•°ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒ–ã‚¹ã‚¯é˜²æ­¢

---

#### stripe_customers ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
CREATE TABLE stripe_customers (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  stripe_customer_id TEXT NOT NULL UNIQUE,
  email TEXT NOT NULL,
  environment TEXT NOT NULL CHECK (environment IN ('test', 'live')),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  CONSTRAINT stripe_customers_user_id_environment_key
    UNIQUE (user_id, environment)
);
```

**ã‚«ãƒ©ãƒ èª¬æ˜**:
- `user_id`: Supabase Auth ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
- `stripe_customer_id`: Stripe Customer IDï¼ˆUNIQUEåˆ¶ç´„ï¼‰
- `email`: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
- `environment`: ç’°å¢ƒï¼ˆ'test' or 'live'ï¼‰

---

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### èªè¨¼ãƒ»èªå¯

**Supabase Auth**:
- Edge Function ã¯å…¨ã¦èªè¨¼å¿…é ˆ
- `Authorization` ãƒ˜ãƒƒãƒ€ãƒ¼ã§ JWT ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼
- Row Level Security (RLS) ã§ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡

**RLS ãƒãƒªã‚·ãƒ¼**:
```sql
-- user_subscriptions: è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿å‚ç…§å¯èƒ½
CREATE POLICY "Users can view own subscriptions"
ON user_subscriptions FOR SELECT
USING (auth.uid() = user_id);

-- stripe_customers: è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿å‚ç…§å¯èƒ½
CREATE POLICY "Users can view own customer data"
ON stripe_customers FOR SELECT
USING (auth.uid() = user_id);
```

---

### Webhook ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

**ç½²åæ¤œè¨¼**:
```typescript
const sig = req.headers.get('stripe-signature');
const event = stripe.webhooks.constructEvent(
  body,
  sig,
  webhookSecret
);
```

**ç’°å¢ƒå¤‰æ•°**:
```
STRIPE_WEBHOOK_SECRET_TEST=whsec_...
STRIPE_WEBHOOK_SECRET_LIVE=whsec_...
```

---

### äºŒé‡èª²é‡‘é˜²æ­¢

**å®Ÿè£…ãƒ¬ãƒ™ãƒ«**:
1. âœ… ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¬ãƒ™ãƒ«ï¼ˆcreate-checkout ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼‰
2. âœ… Webhook ãƒ¬ãƒ™ãƒ«ï¼ˆé‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼‰
3. âœ… DB ãƒ¬ãƒ™ãƒ«ï¼ˆUNIQUEåˆ¶ç´„ï¼‰

**è©³ç´°**: [å®Ÿè£…æ¸ˆã¿æ©Ÿèƒ½ > 6. äºŒé‡èª²é‡‘é˜²æ­¢](#âœ…-6-äºŒé‡èª²é‡‘é˜²æ­¢)

---

## ãƒ†ã‚¹ãƒˆè¨ˆç”»

### ãƒ†ã‚¹ãƒˆå¯¾è±¡ãƒ•ãƒ­ãƒ¼

| # | ãƒ†ã‚¹ãƒˆå†…å®¹ | çŠ¶æ…‹ |
|---|-----------|------|
| 1 | æ–°è¦ç™»éŒ²ï¼ˆãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ï¼‰ | âœ… å®Œäº† |
| 2 | ãƒ—ãƒ©ãƒ³å¤‰æ›´ï¼ˆStandard â†’ Feedbackï¼‰ | â³ æœªå®Ÿæ–½ |
| 3 | ãƒ—ãƒ©ãƒ³å¤‰æ›´ï¼ˆFeedback â†’ Standardï¼‰ | â³ æœªå®Ÿæ–½ |
| 4 | æœŸé–“å¤‰æ›´ï¼ˆ1ãƒ¶æœˆ â†’ 3ãƒ¶æœˆï¼‰ | â³ æœªå®Ÿæ–½ |
| 5 | æœŸé–“å¤‰æ›´ï¼ˆ3ãƒ¶æœˆ â†’ 1ãƒ¶æœˆï¼‰ | â³ æœªå®Ÿæ–½ |
| 6 | ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆæœŸé–“çµ‚äº†æ™‚ï¼‰ | â³ æœªå®Ÿæ–½ |
| 7 | äºŒé‡èª²é‡‘é˜²æ­¢ã®ç¢ºèª | â³ æœªå®Ÿæ–½ |
| 8 | Test/Live ç’°å¢ƒåˆ†é›¢ | âœ… å®Œäº† |
| 9 | Realtime åŒæœŸ | âœ… å®Œäº† |
| 10 | ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° | âœ… å®Œäº† |

### ãƒ†ã‚¹ãƒˆå®Ÿæ–½æ–¹æ³•

**è©³ç´°**: `.claude/docs/MASTER-DEBUG-LOG.md` ã‚’å‚ç…§

**æ‰‹é †**:
1. ãƒ†ã‚¹ãƒˆè¨ˆç”»ã‚’MASTER-DEBUG-LOG.mdã«è¨˜è¼‰
2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå®Ÿæ–½
3. çµæœã‚’ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«è¨˜å…¥
4. ClaudeãŒæ¤œè¨¼ãƒ»åˆ†æ
5. æ¬¡ã®ãƒ†ã‚¹ãƒˆã«é€²ã‚€

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œ

#### å•é¡Œ1: Edge Function ã‚¨ãƒ©ãƒ¼

**ç—‡çŠ¶**:
```
{"error":true,"message":"ã‚µãƒ¼ãƒãƒ¼å†…éƒ¨ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"}
```

**ç¢ºèªæ–¹æ³•**:
1. Supabase Dashboard â†’ Edge Functions â†’ Logs
2. `[CHECK-SUBSCRIPTION]` ã§å§‹ã¾ã‚‹ãƒ­ã‚°ã‚’ç¢ºèª
3. ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’ç¢ºèª

**è§£æ±ºæ–¹æ³•**:
- ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
- ãƒ­ã‚°ã‹ã‚‰å…·ä½“çš„ãªã‚¨ãƒ©ãƒ¼ç®‡æ‰€ã‚’ç‰¹å®š
- ã‚³ãƒ¼ãƒ‰ä¿®æ­£ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤

---

#### å•é¡Œ2: Webhook 401 Unauthorized ã‚¨ãƒ©ãƒ¼ï¼ˆé‡è¦ï¼ï¼‰

**ç—‡çŠ¶**:
```
POST | 401 | stripe-webhook
```

**å½±éŸ¿ç¯„å›²**:
- âœ— ãƒ—ãƒ©ãƒ³å¤‰æ›´æ™‚ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒæ›´æ–°ã•ã‚Œãªã„ï¼ˆ`plan_type`, `duration` ãŒå¤‰ã‚ã‚‰ãªã„ï¼‰
- âœ— ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒæ›´æ–°ã•ã‚Œãªã„ï¼ˆ`is_active` ãŒ true ã®ã¾ã¾ï¼‰
- âœ— æ–°è¦ç™»éŒ²æ™‚ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒä½œæˆã•ã‚Œãªã„
- **ã™ã¹ã¦ã® Webhook ã‚¤ãƒ™ãƒ³ãƒˆãŒå‡¦ç†ã•ã‚Œãªã„**

**æ ¹æœ¬åŸå› **:
`STRIPE_WEBHOOK_SECRET_TEST` ã¾ãŸã¯ `STRIPE_WEBHOOK_SECRET_LIVE` ãŒ Supabase Secrets ã«è¨­å®šã•ã‚Œã¦ã„ãªã„ã€ã¾ãŸã¯ä¸ä¸€è‡´ã€‚

**ç¢ºèªæ–¹æ³•**:
1. Supabase Dashboard â†’ Edge Functions â†’ Logs ã§ `stripe-webhook` ã‚’ç¢ºèª
2. `POST | 401` ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã„ãªã„ã‹ç¢ºèª
3. Supabase Dashboard â†’ Settings â†’ Edge Functions â†’ Secrets ã§ç’°å¢ƒå¤‰æ•°ã‚’ç¢ºèª

**è§£æ±ºæ–¹æ³•**:
```bash
# 1. Stripe Dashboard ã‹ã‚‰ Webhook Secret ã‚’å–å¾—
# https://dashboard.stripe.com/test/webhooks
# Webhook ã®è©³ç´°ãƒšãƒ¼ã‚¸ã§ã€ŒSigning secretã€ã‚’ã‚³ãƒ”ãƒ¼

# 2. Supabase Secrets ã«è¨­å®š
npx supabase secrets set STRIPE_WEBHOOK_SECRET_TEST=whsec_xxxxx

# 3. æœ¬ç•ªç’°å¢ƒã‚‚è¨­å®šï¼ˆæœ¬ç•ªç§»è¡Œæ™‚ï¼‰
npx supabase secrets set STRIPE_WEBHOOK_SECRET_LIVE=whsec_xxxxx
```

**æ¤œè¨¼æ–¹æ³•**:
1. ãƒ—ãƒ©ãƒ³å¤‰æ›´ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
2. Edge Functions Logs ã§ `stripe-webhook` ãŒ 200 OK ã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèª
3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ `plan_type` ã¨ `duration` ãŒæ­£ã—ãæ›´æ–°ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª:
```sql
SELECT plan_type, duration, updated_at, email
FROM user_subscriptions
JOIN auth.users ON user_subscriptions.user_id = auth.users.id
WHERE email = 'your-email@example.com'
ORDER BY updated_at DESC
LIMIT 1;
```

**äºˆé˜²ç­–**:
- ç’°å¢ƒæ§‹ç¯‰æ™‚ã«å¿…ãš Webhook Secret ã‚’è¨­å®šã™ã‚‹
- `.claude/docs/SUBSCRIPTION-SYSTEM-SPECIFICATION.md` ã®ç’°å¢ƒå¤‰æ•°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‚ç…§
- å®šæœŸçš„ã« Webhook ãƒ­ã‚°ã‚’ç¢ºèªã—ã€401 ã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

**ç™ºç”Ÿå±¥æ­´**:
- 2025-11-24: Test 2E å®Ÿæ–½æ™‚ã«ç™ºè¦‹ãƒ»ä¿®æ­£

---

#### å•é¡Œ3: äºŒé‡èª²é‡‘ãŒç™ºç”Ÿ

**ç¢ºèªæ–¹æ³•**:
```sql
SELECT user_id, COUNT(*) as count
FROM user_subscriptions
WHERE is_active = true
GROUP BY user_id
HAVING COUNT(*) > 1;
```

**è§£æ±ºæ–¹æ³•**:
1. å¤ã„ã‚µãƒ–ã‚¹ã‚¯ã‚’æ‰‹å‹•ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«
2. DB ã§ `is_active = false` ã«æ›´æ–°
3. create-checkout ã®äºŒé‡èª²é‡‘é˜²æ­¢ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç¢ºèª

---

#### å•é¡Œ3: Realtime æ›´æ–°ãŒå‹•ä½œã—ãªã„

**ç¢ºèªæ–¹æ³•**:
- ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ Realtime æ¥ç¶šçŠ¶æ…‹ã‚’ç¢ºèª
- Supabase Dashboard â†’ Database â†’ Replication ã§ Realtime ãŒæœ‰åŠ¹ã‹ç¢ºèª

**è§£æ±ºæ–¹æ³•**:
```sql
-- Realtime ã‚’æœ‰åŠ¹åŒ–
ALTER PUBLICATION supabase_realtime ADD TABLE user_subscriptions;
```

---

## å‚è€ƒè³‡æ–™

### é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [user-flow-specification.md](./user-flow-specification.md) - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼è©³ç´°
- [MASTER-DEBUG-LOG.md](./MASTER-DEBUG-LOG.md) - ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ãƒ»ãƒ†ã‚¹ãƒˆè¨˜éŒ²
- [WORKFLOW.md](./WORKFLOW.md) - é–‹ç™ºãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

### Stripe å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [Subscriptions API](https://stripe.com/docs/api/subscriptions)
- [Customer Portal](https://stripe.com/docs/billing/subscriptions/customer-portal)
- [Webhooks](https://stripe.com/docs/webhooks)

### Supabase å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [Realtime Subscriptions](https://supabase.com/docs/guides/realtime)
- [Edge Functions](https://supabase.com/docs/guides/functions)
- [Row Level Security](https://supabase.com/docs/guides/auth/row-level-security)

---

## ç’°å¢ƒæ§‹ç¯‰ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆå¿…é ˆï¼‰

ã“ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã«å¾“ã£ã¦ç’°å¢ƒã‚’æ§‹ç¯‰ã™ã‚‹ã“ã¨ã§ã€Webhook 401ã‚¨ãƒ©ãƒ¼ãªã©ã®ä¸€èˆ¬çš„ãªå•é¡Œã‚’äº‹å‰ã«é˜²ãã“ã¨ãŒã§ãã¾ã™ã€‚

#### 1. Stripe è¨­å®š

- [ ] Stripe ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ
- [ ] ãƒ†ã‚¹ãƒˆç’°å¢ƒã® API ã‚­ãƒ¼å–å¾—
  - [ ] Secret Keyï¼ˆ`sk_test_...`ï¼‰
  - [ ] Publishable Keyï¼ˆ`pk_test_...`ï¼‰
- [ ] Webhook ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä½œæˆ
  - [ ] URL: `https://[your-project-id].supabase.co/functions/v1/stripe-webhook`
  - [ ] ã‚¤ãƒ™ãƒ³ãƒˆé¸æŠ:
    - [ ] `checkout.session.completed`
    - [ ] `customer.subscription.created`
    - [ ] `customer.subscription.updated`
    - [ ] `customer.subscription.deleted`
  - [ ] **Webhook Signing Secret ã‚’å–å¾—ï¼ˆé‡è¦ï¼ï¼‰**
    - [ ] `whsec_...` å½¢å¼ã®å€¤ã‚’ã‚³ãƒ”ãƒ¼
- [ ] ä¾¡æ ¼ï¼ˆPriceï¼‰ä½œæˆ
  - [ ] Standard 1ãƒ¶æœˆãƒ—ãƒ©ãƒ³
  - [ ] Standard 3ãƒ¶æœˆãƒ—ãƒ©ãƒ³
  - [ ] Feedback 1ãƒ¶æœˆãƒ—ãƒ©ãƒ³
  - [ ] Feedback 3ãƒ¶æœˆãƒ—ãƒ©ãƒ³
  - [ ] å„ Price ID ã‚’è¨˜éŒ²

#### 2. Supabase è¨­å®š

- [ ] Supabase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
  - [ ] `user_subscriptions` ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
  - [ ] `stripe_customers` ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
  - [ ] UNIQUE åˆ¶ç´„ã®ç¢ºèª
- [ ] Row Level Security (RLS) ãƒãƒªã‚·ãƒ¼è¨­å®š
  - [ ] `user_subscriptions` ãƒãƒªã‚·ãƒ¼
  - [ ] `stripe_customers` ãƒãƒªã‚·ãƒ¼
- [ ] Realtime æœ‰åŠ¹åŒ–
  ```sql
  ALTER PUBLICATION supabase_realtime ADD TABLE user_subscriptions;
  ```

#### 3. ç’°å¢ƒå¤‰æ•°è¨­å®šï¼ˆæœ€é‡è¦ï¼ï¼‰

**ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆ.envï¼‰:**
```bash
# Supabase
VITE_SUPABASE_URL=https://[your-project-id].supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbG...

# Stripe Public Keys
VITE_STRIPE_PUBLISHABLE_KEY=pk_test_...

# Stripe Price IDs
VITE_STRIPE_STANDARD_1M_PRICE_ID=price_...
VITE_STRIPE_STANDARD_3M_PRICE_ID=price_...
VITE_STRIPE_FEEDBACK_1M_PRICE_ID=price_...
VITE_STRIPE_FEEDBACK_3M_PRICE_ID=price_...
```

- [ ] `.env` ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
- [ ] å…¨ã¦ã®ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
- [ ] è¨­å®šå€¤ã®ç¢ºèª

**ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆSupabase Secretsï¼‰:**
```bash
# âš ï¸ é‡è¦: ã“ã‚Œã‚‰ã®è¨­å®šãŒãªã„ã¨ Webhook ãŒå‹•ä½œã—ã¾ã›ã‚“ï¼

# Stripe Secret Keys
npx supabase secrets set STRIPE_TEST_SECRET_KEY=sk_test_...
npx supabase secrets set STRIPE_LIVE_SECRET_KEY=sk_live_...

# Webhook Secretsï¼ˆçµ¶å¯¾ã«å¿˜ã‚Œãªã„ã“ã¨ï¼ï¼‰
npx supabase secrets set STRIPE_WEBHOOK_SECRET_TEST=whsec_...
npx supabase secrets set STRIPE_WEBHOOK_SECRET_LIVE=whsec_...

# Stripe Price IDsï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨åŒã˜å€¤ï¼‰
npx supabase secrets set VITE_STRIPE_STANDARD_1M_PRICE_ID=price_...
npx supabase secrets set VITE_STRIPE_STANDARD_3M_PRICE_ID=price_...
npx supabase secrets set VITE_STRIPE_FEEDBACK_1M_PRICE_ID=price_...
npx supabase secrets set VITE_STRIPE_FEEDBACK_3M_PRICE_ID=price_...
```

- [ ] **STRIPE_WEBHOOK_SECRET_TEST ã‚’è¨­å®šï¼ˆæœ€é‡è¦ï¼ï¼‰**
- [ ] STRIPE_TEST_SECRET_KEY ã‚’è¨­å®š
- [ ] ã™ã¹ã¦ã® Price ID ã‚’è¨­å®š
- [ ] è¨­å®šç¢ºèª: Supabase Dashboard â†’ Settings â†’ Edge Functions â†’ Secrets

#### 4. Edge Functions ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
# ã™ã¹ã¦ã® Edge Functions ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
npx supabase functions deploy check-subscription
npx supabase functions deploy create-checkout
npx supabase functions deploy create-customer-portal
npx supabase functions deploy stripe-webhook-test
```

- [ ] ã™ã¹ã¦ã® Edge Functions ãŒæ­£å¸¸ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚ŒãŸã‹ç¢ºèª
- [ ] Edge Functions Logs ã§ã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹ç¢ºèª

#### 5. å‹•ä½œç¢ºèªï¼ˆé‡è¦ï¼ï¼‰

- [ ] **Webhook å‹•ä½œç¢ºèªï¼ˆæœ€é‡è¦ï¼ï¼‰**
  1. Stripe Dashboard â†’ Webhooks â†’ ãƒ†ã‚¹ãƒˆã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ä¿¡
  2. Supabase Edge Functions Logs ã§ `stripe-webhook` ã‚’ç¢ºèª
  3. âœ… 200 OK ãŒè¿”ã£ã¦ã„ã‚‹ã‹ç¢ºèªï¼ˆâŒ 401 ã‚¨ãƒ©ãƒ¼ã§ãªã„ã“ã¨ï¼‰
- [ ] æ–°è¦ç™»éŒ²ãƒ•ãƒ­ãƒ¼
  1. `/subscription` ãƒšãƒ¼ã‚¸ã§ãƒ—ãƒ©ãƒ³é¸æŠ
  2. Checkout å®Œäº†
  3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
- [ ] ãƒ—ãƒ©ãƒ³å¤‰æ›´ãƒ•ãƒ­ãƒ¼ï¼ˆDeep Linkï¼‰
  1. `/subscription` ãƒšãƒ¼ã‚¸ã§åˆ¥ã®ãƒ—ãƒ©ãƒ³ã‚’é¸æŠ
  2. Customer Portal ã§ãƒ—ãƒ©ãƒ³å¤‰æ›´ç¢ºèªç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‹
  3. ãƒ—ãƒ©ãƒ³å¤‰æ›´å®Ÿè¡Œ
  4. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ `plan_type` ã¨ `duration` ãŒæ›´æ–°ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª**
  5. Edge Functions Logs ã§ `customer.subscription.updated` ãŒ 200 OK ã‹ç¢ºèª

### ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°æ—©è¦‹è¡¨

| ç—‡çŠ¶ | åŸå›  | è§£æ±ºæ–¹æ³• |
|------|------|----------|
| Webhook ãŒ 401 ã‚¨ãƒ©ãƒ¼ | `STRIPE_WEBHOOK_SECRET_TEST` æœªè¨­å®š | `npx supabase secrets set STRIPE_WEBHOOK_SECRET_TEST=whsec_...` |
| ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒæ›´æ–°ã•ã‚Œãªã„ | Webhook ãŒå‹•ä½œã—ã¦ã„ãªã„ | ä¸Šè¨˜ã® Webhook å‹•ä½œç¢ºèªã‚’å®Ÿæ–½ |
| Price ID ãŒè¦‹ã¤ã‹ã‚‰ãªã„ | Price ID ãŒ Supabase Secrets ã«æœªè¨­å®š | `npx supabase secrets set VITE_STRIPE_xxx_PRICE_ID=price_...` |
| äºŒé‡èª²é‡‘ãŒç™ºç”Ÿ | DB ã® UNIQUE åˆ¶ç´„ãŒãªã„ | ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†å®Ÿè¡Œ |
| Realtime ãŒå‹•ä½œã—ãªã„ | Realtime ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ãªã„ | `ALTER PUBLICATION supabase_realtime ADD TABLE user_subscriptions;` |

### æœ¬ç•ªç’°å¢ƒç§»è¡Œãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] Stripe æœ¬ç•ªç’°å¢ƒã® API ã‚­ãƒ¼å–å¾—
- [ ] Stripe æœ¬ç•ªç’°å¢ƒã® Webhook Secret å–å¾—
- [ ] `STRIPE_LIVE_SECRET_KEY` ã‚’ Supabase Secrets ã«è¨­å®š
- [ ] `STRIPE_WEBHOOK_SECRET_LIVE` ã‚’ Supabase Secrets ã«è¨­å®š
- [ ] æœ¬ç•ªç’°å¢ƒã® Price ID ã‚’ä½œæˆãƒ»è¨­å®š
- [ ] ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ç’°å¢ƒå¤‰æ•°ã‚’æœ¬ç•ªç”¨ã«æ›´æ–°
- [ ] æœ¬ç•ªç’°å¢ƒã§ãƒ†ã‚¹ãƒˆå®Ÿæ–½
- [ ] Webhook ãƒ­ã‚°ã‚’ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ï¼ˆ401 ã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹ï¼‰

---

**æœ€çµ‚æ›´æ–°æ—¥**: 2025-11-24
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… æœ¬ç•ªç¨¼åƒä¸­ï¼ˆDeep Link & Webhook å®Œå…¨å¯¾å¿œï¼‰
**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—**: æœ¬ç•ªç’°å¢ƒç§»è¡Œæº–å‚™
