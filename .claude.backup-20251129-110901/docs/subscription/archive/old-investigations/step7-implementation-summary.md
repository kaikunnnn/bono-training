# ã‚¹ãƒ†ãƒƒãƒ—7: ãƒ—ãƒ©ãƒ³å¤‰æ›´æ©Ÿèƒ½ å®Ÿè£…å®Œäº†å ±å‘Š

**å®Œäº†æ—¥æ™‚**: 2025-11-17
**å®Ÿè£…æ–¹é‡**: Customer Portalæ´»ç”¨ï¼ˆæ—¥å‰²ã‚Šè¨ˆç®—ãƒ»Stripeæ¨™æº–æ©Ÿèƒ½ï¼‰

---

## âœ… å®Ÿè£…å®Œäº†ã‚¿ã‚¹ã‚¯

### ã‚¿ã‚¹ã‚¯1: èª¤ã£ãŸå®Ÿè£…ã®å‰Šé™¤ âœ…
- `supabase/functions/create-checkout/index.ts`ã®79-98è¡Œç›®ã‚’å‰Šé™¤
- æ‰‹å‹•ã®ã‚µãƒ–ã‚¹ã‚¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†ã‚’å‰Šé™¤
- ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ : Customer Portalã§ãƒ—ãƒ©ãƒ³å¤‰æ›´ã‚’è¡Œã†ãŸã‚

### ã‚¿ã‚¹ã‚¯2: Subscription.tsxã®ä¿®æ­£ âœ…
- `getCustomerPortalUrl`ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
- `handleSubscribe`é–¢æ•°ã‚’ä¿®æ­£:
  ```typescript
  if (isSubscribed) {
    // æ—¢å­˜å¥‘ç´„è€… â†’ Customer Portal
    const portalUrl = await getCustomerPortalUrl('/subscription');
    window.location.href = portalUrl;
  } else {
    // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ Checkout
    const { url } = await createCheckoutSession(...);
    window.location.href = url;
  }
  ```

### ã‚¿ã‚¹ã‚¯4: UIæ”¹å–„ âœ…
- ã™ã§ã«å®Ÿè£…æ¸ˆã¿ï¼ˆ`PlanCard.tsx`ï¼‰
- ãƒœã‚¿ãƒ³ãƒ©ãƒ™ãƒ«:
  - æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼: ã€Œé¸æŠã™ã‚‹ã€
  - æ—¢å­˜å¥‘ç´„è€…: ã€Œãƒ—ãƒ©ãƒ³å¤‰æ›´ã€
  - ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³: ã€Œç¾åœ¨ã®ãƒ—ãƒ©ãƒ³ã€ï¼ˆç„¡åŠ¹åŒ–ï¼‰

### ã‚¿ã‚¹ã‚¯5: Edge Functionå†ãƒ‡ãƒ—ãƒ­ã‚¤ âœ…
- `create-checkout`ã‚’å†ãƒ‡ãƒ—ãƒ­ã‚¤
- èª¤ã£ãŸå®Ÿè£…ï¼ˆæ‰‹å‹•ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼‰ã‚’å‰Šé™¤ã—ãŸçŠ¶æ…‹

---

## â³ å¾Œã§å®Ÿæ–½ã™ã‚‹ã‚¿ã‚¹ã‚¯

### ã‚¿ã‚¹ã‚¯3: Customer Portalè¨­å®šï¼ˆStripeãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼‰

**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: `stripe-customer-portal-setup.md`

**è¨­å®šURL**: https://dashboard.stripe.com/test/settings/billing/portal

**å¿…é ˆè¨­å®šé …ç›®**:
1. âœ… Customer Portalã‚’æœ‰åŠ¹åŒ–
2. âœ… ãƒ—ãƒ©ãƒ³å¤‰æ›´æ©Ÿèƒ½ã‚’ONï¼ˆSubscription changesï¼‰
3. âœ… æ—¥å‰²ã‚Šè¨ˆç®—ã‚’æœ‰åŠ¹åŒ–ï¼ˆProration: Create prorationsï¼‰
4. âœ… è¡¨ç¤ºã™ã‚‹ãƒ—ãƒ©ãƒ³ã‚’è¨­å®šï¼ˆStandard/Feedback 1ãƒ¶æœˆ/3ãƒ¶æœˆï¼‰
5. âœ… ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURLè¨­å®šï¼ˆ`http://localhost:5173/subscription`ï¼‰

**æ¨å¥¨è¨­å®šé …ç›®**:
- ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ©Ÿèƒ½ON
- æ”¯æ‰•ã„æ–¹æ³•ã®æ›´æ–°ON

---

### ã‚¿ã‚¹ã‚¯6: å‹•ä½œãƒ†ã‚¹ãƒˆ

**ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹**:

#### 1. æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²
- æœªå¥‘ç´„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³
- `/subscription`ã§ãƒ—ãƒ©ãƒ³é¸æŠ
- **æœŸå¾…**: Checkoutã«é·ç§»
- ãƒ†ã‚¹ãƒˆã‚«ãƒ¼ãƒ‰æ±ºæ¸ˆ
- `/subscription/success`ã«é·ç§»

#### 2. æ—¢å­˜å¥‘ç´„è€…ã®ãƒ—ãƒ©ãƒ³å¤‰æ›´
- æ—¢å­˜å¥‘ç´„è€…ã§ãƒ­ã‚°ã‚¤ãƒ³
- `/subscription`ã§åˆ¥ãƒ—ãƒ©ãƒ³é¸æŠ
- **æœŸå¾…**: Customer Portalã«é·ç§»
- Customer Portalå†…ã§:
  - ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³è¡¨ç¤º
  - æ–°ã—ã„ãƒ—ãƒ©ãƒ³é¸æŠ
  - **æ—¥å‰²ã‚Šè¨ˆç®—å¾Œã®é‡‘é¡è¡¨ç¤º**
  - ã€Œå¤‰æ›´ã™ã‚‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
- `/subscription`ã«æˆ»ã‚‹
- æ–°ã—ã„ãƒ—ãƒ©ãƒ³ãŒåæ˜ 

#### 3. æœŸé–“å¤‰æ›´
- Standard 1ãƒ¶æœˆ â†’ Standard 3ãƒ¶æœˆ
- Customer Portalã§å¤‰æ›´
- æ—¥å‰²ã‚Šè¨ˆç®—ãŒé©ç”¨ã•ã‚Œã‚‹

---

## ğŸ“ å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«

### ä¿®æ­£
1. `supabase/functions/create-checkout/index.ts`
   - è¡Œ79-98ã‚’å‰Šé™¤ï¼ˆæ‰‹å‹•ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†ï¼‰
   - ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 

2. `src/pages/Subscription.tsx`
   - `getCustomerPortalUrl`ã‚¤ãƒ³ãƒãƒ¼ãƒˆè¿½åŠ 
   - `handleSubscribe`é–¢æ•°ã‚’ä¿®æ­£ï¼ˆæ—¢å­˜å¥‘ç´„è€…ã®åˆ†å²ï¼‰

### æ–°è¦ä½œæˆ
1. `.claude/docs/step7-plan-change-specification.md`
   - è©³ç´°ä»•æ§˜ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
   - ã‚¿ã‚¹ã‚¯ä¸€è¦§

2. `.claude/docs/stripe-customer-portal-setup.md`
   - Stripeãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¨­å®šã‚¬ã‚¤ãƒ‰
   - ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

3. `.claude/docs/step7-implementation-summary.md`
   - å®Ÿè£…å®Œäº†å ±å‘Šï¼ˆã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰

---

## ğŸ¯ å®Ÿè£…ã®ä»•çµ„ã¿

### ãƒ•ãƒ­ãƒ¼å›³

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ/subscriptionãƒšãƒ¼ã‚¸ã§ãƒ—ãƒ©ãƒ³é¸æŠ
           â†“
    æ—¢å­˜å¥‘ç´„è€…ã‹ï¼Ÿ
       â†™        â†˜
     YES         NO
      â†“           â†“
Customer Portal  Checkout
      â†“           â†“
  ãƒ—ãƒ©ãƒ³å¤‰æ›´    æ–°è¦ç™»éŒ²
      â†“           â†“
  æ—¥å‰²ã‚Šè¨ˆç®—    å…¨é¡æ±ºæ¸ˆ
      â†“           â†“
Webhookå‡¦ç†   Webhookå‡¦ç†
      â†“           â†“
DBæ›´æ–°        DBæ›´æ–°
      â†“           â†“
/subscriptionã«æˆ»ã‚‹  /subscription/successã«é·ç§»
```

### Customer Portalã®å‹•ä½œ

1. **é·ç§»æ™‚**:
   - `getCustomerPortalUrl('/subscription')`ã‚’å‘¼ã³å‡ºã—
   - Edge Function: `create-customer-portal`ãŒå®Ÿè¡Œ
   - Stripe API: `stripe.billingPortal.sessions.create()`
   - æˆ»ã‚Šå€¤: `https://billing.stripe.com/session/xxx`

2. **Customer Portalå†…**:
   - Stripeæä¾›ã®UIãŒè¡¨ç¤ºã•ã‚Œã‚‹
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä»¥ä¸‹ã®æ“ä½œãŒå¯èƒ½:
     - ãƒ—ãƒ©ãƒ³å¤‰æ›´ï¼ˆæ—¥å‰²ã‚Šè¨ˆç®—è¡¨ç¤ºï¼‰
     - æ”¯æ‰•ã„æ–¹æ³•æ›´æ–°
     - è§£ç´„
   - **æ—¥å‰²ã‚Šè¨ˆç®—ã¯è‡ªå‹•**ï¼ˆStripeå´ã§å‡¦ç†ï¼‰

3. **å¤‰æ›´å®Œäº†å¾Œ**:
   - Webhookã‚¤ãƒ™ãƒ³ãƒˆç™ºç«: `customer.subscription.updated`
   - `stripe-webhook` Edge Functionã§å‡¦ç†
   - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ›´æ–°: `user_subscriptions`ãƒ†ãƒ¼ãƒ–ãƒ«
   - ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ: `/subscription`

---

## ğŸ”§ Webhookå‡¦ç†

### å¿…è¦ãªWebhookã‚¤ãƒ™ãƒ³ãƒˆ

#### `customer.subscription.updated`

**ãƒˆãƒªã‚¬ãƒ¼**: Customer Portalã§ãƒ—ãƒ©ãƒ³å¤‰æ›´

**å‡¦ç†å†…å®¹**:
```typescript
// stripe-webhook/index.ts ã§å‡¦ç†
async function handleSubscriptionUpdated(subscription) {
  const userId = subscription.metadata.user_id;
  const newPriceId = subscription.items.data[0].price.id;

  // é‡‘é¡ã‹ã‚‰ plan_type ã‚’åˆ¤å®š
  const [planType, duration] = determinePlanInfo(price.unit_amount);

  // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ›´æ–°
  await supabase
    .from('user_subscriptions')
    .update({
      plan_type: planType,
      duration: duration,
      updated_at: new Date().toISOString()
    })
    .eq('user_id', userId);
}
```

**ç¢ºèªæ–¹æ³•**:
1. https://dashboard.stripe.com/test/webhooks
2. ã‚¤ãƒ™ãƒ³ãƒˆå±¥æ­´ã§`customer.subscription.updated`ã‚’ç¢ºèª
3. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒ200 OKã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª

---

## ğŸ’¡ æŠ€è¡“çš„ãªãƒã‚¤ãƒ³ãƒˆ

### ãªãœCustomer Portalã‚’ä½¿ã†ã®ã‹

**ãƒ¡ãƒªãƒƒãƒˆ**:
1. âœ… **æ—¥å‰²ã‚Šè¨ˆç®—ãŒè‡ªå‹•** - StripeãŒå®Œå…¨ã«å‡¦ç†
2. âœ… **2é‡ã‚µãƒ–ã‚¹ã‚¯é˜²æ­¢** - Stripeå´ã§ç®¡ç†
3. âœ… **ã‚»ã‚­ãƒ¥ã‚¢** - Stripeæä¾›ã®UI
4. âœ… **ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ä¸è¦** - StripeãŒæ›´æ–°ãƒ»ä¿å®ˆ
5. âœ… **æ¨™æº–çš„** - ChatGPTã€Claudeã¨åŒã˜æ–¹å¼

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**:
1. âš ï¸ UIã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãŒé™å®šçš„
2. âš ï¸ è‡ªç¤¾ã‚µã‚¤ãƒˆå†…ã§å®Œçµã—ãªã„

### ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã¨ã®ä½¿ã„åˆ†ã‘

| ç”¨é€” | ä½¿ç”¨ã™ã‚‹æ©Ÿèƒ½ | ç†ç”± |
|------|-------------|------|
| æ–°è¦ç™»éŒ² | Checkout | é‡‘é¡ç¢ºèªã€æ±ºæ¸ˆæƒ…å ±å…¥åŠ›ãŒå¿…è¦ |
| ãƒ—ãƒ©ãƒ³å¤‰æ›´ | Customer Portal | æ—¥å‰²ã‚Šè¨ˆç®—ã€æ—¢å­˜æƒ…å ±åˆ©ç”¨ |
| è§£ç´„ | Customer Portal | å®‰å…¨ãªè§£ç´„ãƒ•ãƒ­ãƒ¼ |
| æ”¯æ‰•ã„æ–¹æ³•æ›´æ–° | Customer Portal | ã‚»ã‚­ãƒ¥ã‚¢ãªæƒ…å ±æ›´æ–° |

---

## âš ï¸ æ³¨æ„ç‚¹

### 1. Customer Portalè¨­å®šãŒå¿…é ˆ
- Stripeãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã®è¨­å®šãŒå®Œäº†ã—ã¦ã„ãªã„ã¨å‹•ä½œã—ãªã„
- ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã¨æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰ã§åˆ¥ã€…ã®è¨­å®šãŒå¿…è¦

### 2. Webhookã®ä¾å­˜æ€§
- `customer.subscription.updated`ã‚¤ãƒ™ãƒ³ãƒˆãŒæ­£ã—ãå‡¦ç†ã•ã‚Œã‚‹å¿…è¦ãŒã‚ã‚‹
- ç¾åœ¨ã®`stripe-webhook` Edge Functionã§å¯¾å¿œæ¸ˆã¿

### 3. ä¾¡æ ¼IDã®ç®¡ç†
- Customer Portalã«è¡¨ç¤ºã™ã‚‹ãƒ—ãƒ©ãƒ³ã¯ã€ç’°å¢ƒå¤‰æ•°ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹Price IDã¨ä¸€è‡´ã•ã›ã‚‹
- ä¸ä¸€è‡´ã®å ´åˆã€ãƒ—ãƒ©ãƒ³å¤‰æ›´å¾Œã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒæ­£ã—ãæ›´æ–°ã•ã‚Œãªã„å¯èƒ½æ€§

---

## ğŸ“Š å®Œäº†çŠ¶æ³

### å®Ÿè£…ã‚¿ã‚¹ã‚¯: 5/6å®Œäº† (83%)

- [x] ã‚¿ã‚¹ã‚¯1: èª¤ã£ãŸå®Ÿè£…ã®å‰Šé™¤
- [x] ã‚¿ã‚¹ã‚¯2: Subscription.tsxä¿®æ­£
- [ ] ã‚¿ã‚¹ã‚¯3: Customer Portalè¨­å®šï¼ˆå¾Œã§å®Ÿæ–½ï¼‰
- [x] ã‚¿ã‚¹ã‚¯4: UIæ”¹å–„
- [x] ã‚¿ã‚¹ã‚¯5: Edge Functionå†ãƒ‡ãƒ—ãƒ­ã‚¤
- [ ] ã‚¿ã‚¹ã‚¯6: å‹•ä½œãƒ†ã‚¹ãƒˆï¼ˆå¾Œã§å®Ÿæ–½ï¼‰

### æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

1. **Stripeãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§è¨­å®š**
   - `stripe-customer-portal-setup.md`ã‚’å‚ç…§
   - æ‰€è¦æ™‚é–“: 15åˆ†

2. **å‹•ä½œãƒ†ã‚¹ãƒˆå®Ÿæ–½**
   - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1-3ã‚’å®Ÿè¡Œ
   - æ‰€è¦æ™‚é–“: 30åˆ†

3. **å•é¡ŒãŒã‚ã‚Œã°èª¿æ•´**
   - Webhookç¢ºèª
   - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç¢ºèª

---

**ä½œæˆæ—¥**: 2025-11-17
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: å®Ÿè£…å®Œäº†ã€è¨­å®šãƒ»ãƒ†ã‚¹ãƒˆå¾…ã¡
