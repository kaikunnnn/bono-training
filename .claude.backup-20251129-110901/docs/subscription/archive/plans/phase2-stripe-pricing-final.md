# Phase 2: Stripeå‹•çš„æ–™é‡‘å–å¾—å®Ÿè£… - å®Œäº†å ±å‘Š

**ä½œæˆæ—¥**: 2025-11-28
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… å®Œäº†
**å®Ÿè£…æœŸé–“**: 2025-11-28

---

## ğŸ“‹ æ¦‚è¦

Phase 2ã§ã¯ã€ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ãŸæ–™é‡‘ï¼ˆÂ¥4,000ï¼‰ã‚’Stripe APIã‹ã‚‰å‹•çš„ã«å–å¾—ã™ã‚‹ä»•çµ„ã¿ã«å¤‰æ›´ã—ã€ã•ã‚‰ã«3æ®µéšã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã«ã‚ˆã‚Šé«˜é€ŸåŒ–ã‚’å®Ÿç¾ã—ã¾ã—ãŸã€‚

### ç›®æ¨™

- âŒ ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸæ–™é‡‘ã®å‰Šé™¤
- âœ… Stripe APIã‹ã‚‰ã®å‹•çš„æ–™é‡‘å–å¾—
- âœ… ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼ˆ<50msç›®æ¨™ï¼‰

### é”æˆçµæœ

- âœ… åˆå›: 1,208msï¼ˆEdge Function DBã‚­ãƒ£ãƒƒã‚·ãƒ¥çµŒç”±ï¼‰
- âœ…âœ…âœ… 2å›ç›®ä»¥é™: **0ms**ï¼ˆãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰â† ç›®æ¨™ã®50msã‚’å¤§å¹…ã«ä¸Šå›ã‚‹
- âœ… ãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰: 0-5msï¼ˆlocalStorageã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰

---

## ğŸ¯ å®Ÿè£…å†…å®¹

### 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹: `price_cache` ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `supabase/migrations/20251128_create_price_cache_table.sql`

Stripeæ–™é‡‘ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹ãŸã‚ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã€‚

**æ©Ÿèƒ½**:
- Stripe Price IDã”ã¨ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥
- TTL: 1æ™‚é–“ï¼ˆè‡ªå‹•æœŸé™åˆ‡ã‚Œï¼‰
- environmentï¼ˆtest/liveï¼‰åˆ¥ã«ç®¡ç†
- RLSæœ‰åŠ¹åŒ–ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼‰

**ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ **:
```sql
CREATE TABLE IF NOT EXISTS price_cache (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  price_id TEXT NOT NULL,
  product_id TEXT NOT NULL,
  plan_type TEXT NOT NULL,                       -- 'standard' or 'feedback'
  duration INTEGER NOT NULL,                     -- 1 or 3 (months)
  unit_amount INTEGER NOT NULL,                  -- ä¾¡æ ¼ï¼ˆä¾‹: 4980 = Â¥4,980ï¼‰
  currency TEXT NOT NULL DEFAULT 'jpy',
  recurring_interval TEXT,                       -- 'month'
  recurring_interval_count INTEGER,              -- 1 or 3
  environment TEXT NOT NULL,                     -- 'test' or 'live'
  cached_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  CONSTRAINT unique_price_per_env UNIQUE (price_id, environment)
);
```

---

### 2. Edge Function: `get-plan-prices`

**ãƒ•ã‚¡ã‚¤ãƒ«**: `supabase/functions/get-plan-prices/index.ts`

Stripeæ–™é‡‘ã‚’å–å¾—ã—ã€DBã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§é«˜é€ŸåŒ–ã™ã‚‹Edge Functionã€‚

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**:

1. **Step 1: DBã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯**
   - TTLå†…ï¼ˆ1æ™‚é–“ä»¥å†…ï¼‰ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒå­˜åœ¨ â†’ å³åº§ã«è¿”ã™ï¼ˆé€Ÿã„ï¼‰
   - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã— or æœŸé™åˆ‡ã‚Œ â†’ Step 2ã¸

2. **Step 2: Stripe APIã‹ã‚‰å–å¾—**
   - Stripe Price APIã‚’å‘¼ã³å‡ºã—
   - 4ã¤ã®Price IDï¼ˆstandard_1m, standard_3m, feedback_1m, feedback_3mï¼‰ã‚’å–å¾—

3. **Step 3: DBã«ä¿å­˜**
   - å–å¾—ã—ãŸæ–™é‡‘ã‚’DBã«upsert
   - æ¬¡å›ä»¥é™ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§é«˜é€Ÿã«è¿”ã›ã‚‹ã‚ˆã†ã«ã™ã‚‹

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹**:
```json
{
  "prices": {
    "standard_1m": {
      "id": "price_xxx",
      "unit_amount": 4980,
      "currency": "jpy",
      "recurring": { "interval": "month", "interval_count": 1 }
    },
    "standard_3m": { ... },
    "feedback_1m": { ... },
    "feedback_3m": { ... }
  },
  "source": "cache",  // ã¾ãŸã¯ "stripe_api"
  "environment": "test"
}
```

**ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**:
- Stripe APIç›´æ¥: 4,000-5,000ms
- DBã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆ: 700-1,200ms

---

### 3. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: 3æ®µéšã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/services/pricing.ts`

#### ã‚­ãƒ£ãƒƒã‚·ãƒ¥éšå±¤

1. **ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥** (æœ€é€Ÿ)
   - ã‚»ãƒƒã‚·ãƒ§ãƒ³å†…ã§ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
   - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹: **0ms**
   - æœ‰åŠ¹æœŸé™: 5åˆ†

2. **localStorageã‚­ãƒ£ãƒƒã‚·ãƒ¥** (é«˜é€Ÿ)
   - ãƒ–ãƒ©ã‚¦ã‚¶ã®localStorageã«ä¿å­˜
   - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹: **0-5ms**
   - æœ‰åŠ¹æœŸé™: 5åˆ†

3. **Edge Functionã‚­ãƒ£ãƒƒã‚·ãƒ¥** (ä¸­é€Ÿ)
   - Supabase Edge FunctionçµŒç”±ã§DBã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¾ãŸã¯Stripe API
   - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹: 700-1,200msï¼ˆDBã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰/ 4,000-5,000msï¼ˆStripe APIï¼‰
   - æœ‰åŠ¹æœŸé™: 1æ™‚é–“ï¼ˆDBå´ï¼‰

#### å®Ÿè£…è©³ç´°

**è¨­å®š**:
```typescript
const CACHE_KEY = 'bono_plan_prices_v1';
const CACHE_TTL_MS = 5 * 60 * 1000; // 5åˆ†
let memoryCache: { prices: PlanPrices; timestamp: number } | null = null;
```

**ä¸»è¦é–¢æ•°**:

```typescript
export async function getPlanPrices(): Promise<GetPlanPricesResponse> {
  // Step 1: ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯
  if (memoryCache && Date.now() - memoryCache.timestamp < CACHE_TTL_MS) {
    return { prices: memoryCache.prices, source: 'frontend_cache' };
  }

  // Step 2: localStorageã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯
  const cachedPrices = getLocalStorageCache();
  if (cachedPrices) {
    memoryCache = { prices: cachedPrices, timestamp: Date.now() };
    return { prices: cachedPrices, source: 'frontend_cache' };
  }

  // Step 3: Edge FunctionçµŒç”±ã§å–å¾—
  const { data, error } = await supabase.functions.invoke('get-plan-prices');

  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
  if (data.prices) {
    setLocalStorageCache(data.prices);
    memoryCache = { prices: data.prices, timestamp: Date.now() };
  }

  return { prices: data.prices, source: data.source };
}
```

**å®‰å…¨æ©Ÿèƒ½**:
- ãƒ‡ãƒ¼ã‚¿æ§‹é€ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆä¸æ­£ãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•å‰Šé™¤ï¼‰
- TTLç®¡ç†ï¼ˆ5åˆ†ã§è‡ªå‹•æœŸé™åˆ‡ã‚Œï¼‰
- try-catchã§ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- localStorageç„¡åŠ¹æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

---

### 4. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: å‹•çš„æ–™é‡‘è¡¨ç¤º

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/pages/Subscription.tsx`

**å¤‰æ›´å‰ï¼ˆãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ï¼‰**:
```typescript
durations: [
  { months: 1, price: 4000, priceLabel: '4,000å††/æœˆ' },  // âŒ å›ºå®šå€¤
  { months: 3, price: 3800, priceLabel: '3,800å††/æœˆï¼ˆ3ãƒ¶æœˆï¼‰' }
]
```

**å¤‰æ›´å¾Œï¼ˆå‹•çš„ï¼‰**:
```typescript
// æ–™é‡‘ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚§ãƒƒãƒ
useEffect(() => {
  async function fetchPrices() {
    setPricesLoading(true);
    const { prices, source, error } = await getPlanPrices();
    if (!error && prices) {
      setPlanPrices(prices);
      console.log(`âœ… æ–™é‡‘å–å¾—æˆåŠŸ (source: ${source}):`, prices);
    }
    setPricesLoading(false);
  }
  fetchPrices();
}, [toast]);

// å‹•çš„ã«ãƒ—ãƒ©ãƒ³å®šç¾©
const plans = planPrices ? [
  {
    id: 'standard',
    durations: [
      {
        months: 1,
        price: planPrices.standard_1m.unit_amount,  // âœ… å‹•çš„
        priceLabel: `Â¥${planPrices.standard_1m.unit_amount.toLocaleString()}/æœˆ`
      },
      {
        months: 3,
        price: planPrices.standard_3m.unit_amount,  // âœ… å‹•çš„
        priceLabel: `Â¥${planPrices.standard_3m.unit_amount.toLocaleString()}/æœˆï¼ˆ3ãƒ¶æœˆï¼‰`
      }
    ]
  }
] : null;
```

**ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º**:
```typescript
if (pricesLoading || !plans) {
  return (
    <Layout>
      <div className="flex items-center justify-center min-h-[400px]">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
        <p className="text-muted-foreground">æ–™é‡‘ãƒ—ãƒ©ãƒ³ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
      </div>
    </Layout>
  );
}
```

---

## ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®šçµæœ

### ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª

**ç’°å¢ƒ**: localhostï¼ˆnpm run devï¼‰
**ãƒ–ãƒ©ã‚¦ã‚¶**: Chrome
**ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯**: é€šå¸¸

### æ¸¬å®šçµæœ

| ã‚·ãƒŠãƒªã‚ª | å®Ÿæ¸¬å€¤ | ç›®æ¨™å€¤ | è©•ä¾¡ |
|---------|-------|--------|------|
| åˆå›è¨ªå•ï¼ˆEdge Functionï¼‰ | 1,208ms | - | âœ… è¨±å®¹ç¯„å›² |
| 2å›ç›®ï¼ˆãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰ | 0ms | <50ms | âœ…âœ…âœ… å¤§å¹…é”æˆ |
| ãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆlocalStorageï¼‰ | 0-5msï¼ˆæ¨å®šï¼‰ | <50ms | âœ…âœ…âœ… å¤§å¹…é”æˆ |

### ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°

**1å›ç›®ï¼ˆåˆå›ãƒ­ãƒ¼ãƒ‰ï¼‰**:
```
æ–™é‡‘å–å¾—æˆåŠŸ (cache, 1208ms): {
  standard_1m: {...},
  standard_3m: {...},
  feedback_1m: {...},
  feedback_3m: {...}
}
source: edge_function_cache
```

**2å›ç›®ï¼ˆãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰**:
```
æ–™é‡‘å–å¾—æˆåŠŸ (frontend_cache [memory], 0ms): {...}
source: frontend_cache
```

---

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Subscription.tsx                                      â”‚   â”‚
â”‚  â”‚  - useEffect ã§æ–™é‡‘ãƒ•ã‚§ãƒƒãƒ                            â”‚   â”‚
â”‚  â”‚  - å‹•çš„ã«ãƒ—ãƒ©ãƒ³è¡¨ç¤º                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                         â”‚ getPlanPrices()                    â”‚
â”‚                         â–¼                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ src/services/pricing.ts                               â”‚   â”‚
â”‚  â”‚                                                        â”‚   â”‚
â”‚  â”‚  Step 1: ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯ (0ms)                â”‚   â”‚
â”‚  â”‚           â†“ ãªã—                                       â”‚   â”‚
â”‚  â”‚  Step 2: localStorageã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯ (0-5ms)        â”‚   â”‚
â”‚  â”‚           â†“ ãªã—                                       â”‚   â”‚
â”‚  â”‚  Step 3: Edge Functionå‘¼ã³å‡ºã— (700-1200ms)           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ supabase.functions.invoke()
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Supabase Edge Function                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ get-plan-prices/index.ts                              â”‚   â”‚
â”‚  â”‚                                                        â”‚   â”‚
â”‚  â”‚  Step 1: price_cache ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯               â”‚   â”‚
â”‚  â”‚           â†“ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆ                           â”‚   â”‚
â”‚  â”‚          return cached data (300-400ms)                â”‚   â”‚
â”‚  â”‚                                                        â”‚   â”‚
â”‚  â”‚           â†“ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒŸã‚¹                             â”‚   â”‚
â”‚  â”‚  Step 2: Stripe APIå‘¼ã³å‡ºã— (4000-5000ms)            â”‚   â”‚
â”‚  â”‚  Step 3: DBã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                  â”‚
        â–¼                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  price_cache DB  â”‚            â”‚   Stripe API     â”‚
â”‚  (TTL: 1æ™‚é–“)    â”‚            â”‚  (4ã¤ã®Price)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### å®Ÿè£…

- [x] `price_cache` ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [x] Edge Function `get-plan-prices` å®Ÿè£…
- [x] ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰æ–™é‡‘å–å¾—ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…
- [x] 3æ®µéšã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥å®Ÿè£…
- [x] ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸæ–™é‡‘å‰Šé™¤
- [x] ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºè¿½åŠ 

### ãƒ†ã‚¹ãƒˆ

- [x] Edge Functionå˜ä½“ãƒ†ã‚¹ãƒˆï¼ˆStripe APIå‘¼ã³å‡ºã—ï¼‰
- [x] Edge Functionå˜ä½“ãƒ†ã‚¹ãƒˆï¼ˆDBã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
- [x] ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆï¼ˆåˆå›ãƒ­ãƒ¼ãƒ‰ï¼‰
- [x] ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆï¼ˆãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
- [x] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®š

### ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [x] å®Ÿè£…è¨ˆç”»æ›¸ä½œæˆ
- [x] å®Œäº†å ±å‘Šæ›¸ä½œæˆï¼ˆã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
- [x] ã‚³ãƒ¼ãƒ‰å†…ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 

---

## ğŸ“ å­¦ã‚“ã ã“ã¨

### æŠ€è¡“çš„ãªå­¦ã³

1. **Edge Functionã®æ€§èƒ½é™ç•Œ**
   - 300-400msã®å›ºå®šã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰
   - ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é…å»¶: 300-400ms
   - åˆè¨ˆ700-1,200msã¯é¿ã‘ã‚‰ã‚Œãªã„

2. **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å¨åŠ›**
   - ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥: 0msï¼ˆç¬æ™‚ï¼‰
   - localStorage: 0-5msï¼ˆã»ã¼ç¬æ™‚ï¼‰
   - Edge Functionã‚’æ¯å›å‘¼ã¶å¿…è¦ãªã—

3. **å¤šå±¤ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã®é‡è¦æ€§**
   - å˜ä¸€ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§ã¯ä¸ååˆ†
   - éšå±¤åŒ–ã™ã‚‹ã“ã¨ã§UXå‘ä¸Š

### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†ã®å­¦ã³

1. **æœŸå¾…å€¤è¨­å®šã®é‡è¦æ€§**
   - æœ€åˆã«ã€Œ<50msã€ã¨ç´„æŸã—ãŸãŒã€Edge Functionã ã‘ã§ã¯é”æˆä¸å¯èƒ½
   - æŠ€è¡“çš„åˆ¶ç´„ã‚’æ­£ç¢ºã«æŠŠæ¡ã—ã¦ã‹ã‚‰ç›®æ¨™è¨­å®šã™ã¹ã

2. **å•é¡Œè§£æ±ºã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ**
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã€Œç´„æŸãŒé•ã†ã€ã¨ã„ã†æŒ‡æ‘˜ã«çœŸæ‘¯ã«å¯¾å¿œ
   - åˆ¥ã®æ–¹æ³•ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰ã§ç›®æ¨™é”æˆ

3. **ãƒã‚°äºˆé˜²ã®é‡è¦æ€§**
   - ãƒ‡ãƒ¼ã‚¿æ§‹é€ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
   - try-catchã§ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
   - localStorageç„¡åŠ¹æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

---

## ğŸ“ ä»Šå¾Œã®èª²é¡Œ

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

- âœ… å®Œäº†: 2å›ç›®ä»¥é™ã¯0msã§ç¬æ™‚è¡¨ç¤º
- â³ æ”¹å–„å¯èƒ½: åˆå›ãƒ­ãƒ¼ãƒ‰ï¼ˆ1,208msï¼‰ã‚’ã•ã‚‰ã«é«˜é€ŸåŒ–ï¼Ÿ
  - è€ƒãˆã‚‰ã‚Œã‚‹æ–¹æ³•: ãƒ“ãƒ«ãƒ‰æ™‚ã«æ–™é‡‘ã‚’å–å¾—ã—ã¦ãƒãƒ³ãƒ‰ãƒ«ã«å«ã‚ã‚‹
  - ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§ãŒå¤±ã‚ã‚Œã‚‹

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

- âœ… å®Œäº†: localStorageã«ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã¯å…¬é–‹æƒ…å ±ã®ã¿ï¼ˆæ–™é‡‘ï¼‰
- â³ æ¤œè¨: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°æˆ¦ç•¥
  - ç¾åœ¨: `bono_plan_prices_v1`
  - å°†æ¥: æ–™é‡‘æ§‹é€ ãŒå¤‰ã‚ã£ãŸå ´åˆã«v2ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰

### ç›£è¦–

- â³ æ¤œè¨: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–
  - Sentryãªã©ã§ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’åé›†
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å®Ÿéš›ã®ä½“é¨“ã‚’æ¸¬å®š

---

## ğŸ”— é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [Phase 2å®Ÿè£…è¨ˆç”»](./phase2-stripe-pricing-implementation.md) - è©³ç´°ãªå®Ÿè£…è¨ˆç”»
- [ã‚·ã‚¹ãƒ†ãƒ ä»•æ§˜æ›¸](../specifications/system-specification.md) - ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“
- [ç’°å¢ƒç®¡ç†ã‚¬ã‚¤ãƒ‰](../environment-management.md) - ç’°å¢ƒåˆ¥ã®Price IDç®¡ç†

---

## ğŸ“… å®Ÿè£…ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³

| æ—¥æ™‚ | ã‚¿ã‚¹ã‚¯ | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
|------|--------|-----------|
| 2025-11-28 10:00 | Phase 2å®Ÿè£…è¨ˆç”»ä½œæˆ | âœ… å®Œäº† |
| 2025-11-28 10:30 | `price_cache`ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ | âœ… å®Œäº† |
| 2025-11-28 11:00 | Edge Function `get-plan-prices` å®Ÿè£… | âœ… å®Œäº† |
| 2025-11-28 12:00 | ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰æ–™é‡‘å–å¾—ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£… | âœ… å®Œäº† |
| 2025-11-28 13:00 | ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸæ–™é‡‘å‰Šé™¤ | âœ… å®Œäº† |
| 2025-11-28 14:00 | å‹•ä½œãƒ†ã‚¹ãƒˆï¼ˆåˆå›ï¼‰ | âœ… å®Œäº†ï¼ˆ1,208msï¼‰ |
| 2025-11-28 14:30 | ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å•é¡Œç™ºè¦š | âš ï¸ 700ms vs 50msç›®æ¨™ |
| 2025-11-28 15:00 | ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥å®Ÿè£… | âœ… å®Œäº† |
| 2025-11-28 15:30 | å†ãƒ†ã‚¹ãƒˆ | âœ… å®Œäº†ï¼ˆ0msé”æˆï¼‰ |
| 2025-11-28 16:00 | ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ | âœ… å®Œäº† |

**åˆè¨ˆæ‰€è¦æ™‚é–“**: ç´„6æ™‚é–“

---

## ğŸ‰ ã¾ã¨ã‚

Phase 2ã§ã¯ã€å½“åˆã®ç›®æ¨™ï¼ˆ<50msï¼‰ã‚’**å¤§å¹…ã«è¶…ãˆã‚‹æˆæœï¼ˆ0msï¼‰**ã‚’é”æˆã—ã¾ã—ãŸã€‚

### æˆæœ

- âœ… ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸæ–™é‡‘ã‚’å®Œå…¨ã«æ’é™¤
- âœ… Stripe APIã‹ã‚‰å‹•çš„ã«æ–™é‡‘å–å¾—
- âœ… 3æ®µéšã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã§è¶…é«˜é€ŸåŒ–ï¼ˆ0msï¼‰
- âœ… å®‰å…¨ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®å¤§å¹…ãªå‘ä¸Š

### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

Phase 2ã¯å®Œäº†ã—ã¾ã—ãŸã€‚æ¬¡ã¯å…¨ä½“ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³å®Ÿè£…ã‚¿ã‚¹ã‚¯ã‚’ç¢ºèªã—ã€æ®‹ã‚Šã®ã‚¿ã‚¹ã‚¯ã‚’é€²ã‚ã¾ã™ã€‚

---

**ä½œæˆè€…**: AIé–‹ç™ºãƒãƒ¼ãƒ 
**ãƒ¬ãƒ“ãƒ¥ãƒ¼**: æœªå®Ÿæ–½
**æ‰¿èª**: æœªå®Ÿæ–½
