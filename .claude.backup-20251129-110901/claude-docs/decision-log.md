# 実装決定ログ

**最終更新**: 2025-11-28

---

## 🎯 このドキュメントの目的

「なぜこの実装方法を選んだか」を記録し、後から振り返った時やチームメンバーが理解する際の助けとする。

**ルール**:
- 重要な実装の決定は**必ず**記録
- 却下した選択肢も理由とともに記載
- 将来見直す可能性があるものは明記

---

## 📋 決定記録テンプレート

```markdown
## [DECISION-XXX] 決定のタイトル

**決定日**: YYYY-MM-DD
**決定者**: 名前
**ステータス**: 🟢 採用中 / 🟡 要検討 / 🔴 廃止予定

**背景・課題**:
なぜこの決定が必要になったか

**決定内容**:
何を決定したか（一行で）

**選択肢の比較**:
| 選択肢 | メリット | デメリット | 結論 |
|--------|---------|-----------|------|
| 選択肢A | ... | ... | ✅ 採用 |
| 選択肢B | ... | ... | ❌ 却下 |
| 選択肢C | ... | ... | ❌ 却下 |

**採用理由**:
1. 理由1
2. 理由2
3. 理由3

**トレードオフ**:
この決定によって何を犠牲にしたか

**影響範囲**:
- 影響を受けるファイル・機能
- 関連する実装

**将来の見直し条件**:
どういう状況になったら再検討すべきか

**参考資料**:
- [実装計画](../subscription/implementation-plans/...)
- [外部リソース](https://example.com)
```

---

## 🟢 現在採用中の決定

### [DECISION-001] サブスクリプション更新は既存を更新（新規作成しない）

**決定日**: 2025-11-27
**決定者**: Takumi + Claude
**ステータス**: 🟢 採用中

**背景・課題**:
プラン変更時に2重課金が発生していた。原因は既存のサブスクリプションを確認せずに新規作成していたため。

**決定内容**:
プラン変更時は、既存のサブスクリプションを更新する方式を採用

**選択肢の比較**:
| 選択肢 | メリット | デメリット | 結論 |
|--------|---------|-----------|------|
| A. 既存を更新 | 2重課金を防げる、Stripe推奨 | 実装がやや複雑 | ✅ 採用 |
| B. 既存をキャンセル→新規作成 | 実装がシンプル | 一瞬サブスクなし状態になる、履歴が複雑化 | ❌ 却下 |
| C. 並行稼働→旧を削除 | ダウンタイムなし | 2重課金リスク、管理が複雑 | ❌ 却下 |

**採用理由**:
1. Stripe公式ドキュメントで推奨されている方法
2. 2重課金のリスクを完全に排除できる
3. ユーザー体験が途切れない（即座に新プラン利用可能）

**トレードオフ**:
実装の複雑さが増すが、安全性を優先

**影響範囲**:
- `lib/stripe/subscription.ts`の`updateSubscription`関数
- フロントエンドのプラン変更フロー

**将来の見直し条件**:
- Stripeのベストプラクティスが変更された場合
- 2重課金を防ぐより良い方法が見つかった場合

**参考資料**:
- [Stripe: Updating Subscriptions](https://stripe.com/docs/billing/subscriptions/upgrade-downgrade)
- [実装計画](../subscription/implementation-plans/2025-11-27-subscription-update.md)

---

### [DECISION-002] Webhook処理の冪等性は専用テーブルで管理

**決定日**: 2025-11-27
**決定者**: Takumi + Claude
**ステータス**: 🟢 採用中

**背景・課題**:
Stripeからのwebhookが複数回送信される可能性があり、同じイベントを2回処理すると2重課金やデータ不整合が発生する。

**決定内容**:
`webhook_events`テーブルを作成し、処理済みイベントIDを記録することで冪等性を保証

**選択肢の比較**:
| 選択肢 | メリット | デメリット | 結論 |
|--------|---------|-----------|------|
| A. 専用テーブルで管理 | 確実、監査ログにもなる | テーブルが増える | ✅ 採用 |
| B. subscriptionsテーブルのタイムスタンプで判定 | テーブル不要 | 誤判定のリスク、監査が難しい | ❌ 却下 |
| C. Redisなどのキャッシュで管理 | 高速 | 追加インフラ必要、永続化しない | ❌ 却下 |

**採用理由**:
1. 最も確実に冪等性を保証できる
2. イベント処理の履歴が残り、デバッグ・監査が容易
3. 追加インフラ不要（既存のPostgreSQLで完結）

**トレードオフ**:
テーブルが1つ増えるが、データ量は少ないため問題なし

**影響範囲**:
- `webhook_events`テーブル（新規作成）
- `app/api/webhooks/stripe/route.ts`

**将来の見直し条件**:
- webhookイベントが大量になりパフォーマンス問題が発生した場合

**参考資料**:
- [Stripe: Handling Webhook Events](https://stripe.com/docs/webhooks/best-practices)

---

### [DECISION-003] Edge Functionsを使用（API Routesではない）

**決定日**: 2025-11-26
**決定者**: Takumi + Claude
**ステータス**: 🟢 採用中

**背景・課題**:
Checkout Session作成処理をどこで実装するか

**決定内容**:
Supabase Edge Functionsを使用

**選択肢の比較**:
| 選択肢 | メリット | デメリット | 結論 |
|--------|---------|-----------|------|
| A. Edge Functions | Supabaseと統合、RLSと連携 | デバッグがやや難しい | ✅ 採用 |
| B. Next.js API Routes | デバッグ容易、Next.jsと統合 | Supabase RLSと分離 | ❌ 却下 |
| C. 両方使う | 柔軟性高い | 実装が複雑、保守が大変 | ❌ 却下 |

**採用理由**:
1. SupabaseのRLS（Row Level Security）と連携しやすい
2. 認証情報を自動で引き継げる
3. Vercelの関数制限に影響されない

**トレードオフ**:
ローカル開発でのデバッグがAPI Routesより少し難しい

**影響範囲**:
- `supabase/functions/create-checkout/`
- フロントエンドの呼び出し方法

**将来の見直し条件**:
- Edge Functionsでパフォーマンス問題が発生した場合
- Next.jsとの統合でメリットが大きい場合

**参考資料**:
- [Supabase Edge Functions](https://supabase.com/docs/guides/functions)

---

## 🟡 要検討（将来見直す可能性）

### [DECISION-101] TypeScriptのstrict modeは全プロジェクトで有効

**決定日**: 2025-11-26
**決定者**: Takumi
**ステータス**: 🟡 要検討

**背景・課題**:
型安全性を高めるため

**決定内容**:
`tsconfig.json`でstrict mode有効化

**トレードオフ**:
開発初期は型エラーが多く発生する可能性

**将来の見直し条件**:
- 型エラーが開発速度を著しく低下させる場合
- ただし、基本的には維持する方針

---

## 🔴 廃止予定・却下された決定

### [DECISION-901] ~~新規サブスクリプション作成方式~~（廃止）

**決定日**: 2025-11-25
**廃止日**: 2025-11-27
**ステータス**: 🔴 廃止

**元の決定**:
プラン変更時に新規サブスクリプションを作成し、既存を削除

**廃止理由**:
2重課金が頻発したため、DECISION-001の方式に変更

**教訓**:
- 「新規作成してから削除」は危険
- Stripe公式の推奨方法に従うべき

---

## 📝 新しい決定を追加する際のルール

1. **重要な決定のみ記録**
   - アーキテクチャレベルの決定
   - 複数の選択肢があった場合
   - 将来見直す可能性がある決定

2. **必ず記載する項目**
   - 選択肢の比較（メリット・デメリット）
   - 採用理由（なぜこれを選んだか）
   - トレードオフ（何を犠牲にしたか）
   - 将来の見直し条件

3. **採番ルール**
   - 採用中: DECISION-001〜099
   - 要検討: DECISION-101〜199
   - 廃止: DECISION-901〜999

---

## 🔄 このドキュメントの更新タイミング

- 重要な実装方針を決定した時
- 既存の決定を見直した時
- 新しい問題に対する解決策を選択した時

**「なぜこうしたのか」を忘れないために、必ず記録してください。**
**3ヶ月後の自分、新しいチームメンバーのために。**
