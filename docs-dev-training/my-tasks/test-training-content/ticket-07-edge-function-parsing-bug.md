# 🐛 Ticket #07: Edge Function フロントマター解析バグ修正

## 優先度: **HIGH**

## 問題の概要

`supabase/functions/get-training-list/index.ts` のフロントマター解析処理に重大なバグがあり、トレーニングの `index.md` ではなくタスクファイルのデータを誤って取得している。

### 症状

- トレーニングのメインタイトルではなく、内部タスクのタイトルが表示される
- 複数行のYAML配列や複雑な構造が正しく解析されない
- デバッグログから不正なデータフローが確認される

### 確認されたバグ

1. **ファイル優先順位の問題**: タスクファイルの情報がメインの `index.md` を上書きしている
2. **フロントマター解析の脆弱性**: 複雑なYAML構造に対応していない
3. **エラーハンドリング不足**: 解析失敗時のフォールバック処理が不適切

## 技術的分析

### 現在のコード問題箇所

```javascript
// 問題: parseFrontmatter関数の限界
function parseFrontmatter(content) {
  // 現在の実装では複雑なYAML構造を正しく処理できない
  // 特に配列や複数行文字列の処理に問題
}
```

### 影響を受ける処理

- `getTrainingDetail` - トレーニング詳細取得
- フロントマター解析全般
- タスクデータとメインデータの混在

## 修正計画

### 1. フロントマター解析ロジックの改善

- [ ] より堅牢なYAMLパーサーの実装
- [ ] 配列データの適切な処理
- [ ] 複数行文字列の正確な解析

### 2. データ優先順位の修正

- [ ] メインの `index.md` を最優先で処理
- [ ] タスクデータとの明確な分離
- [ ] データマージロジックの見直し

### 3. エラーハンドリング強化

- [ ] 解析失敗時の詳細ログ出力
- [ ] フォールバック処理の改善
- [ ] デバッグ情報の充実

### 4. テスト体制の構築

- [ ] Edge Function 単体テストの追加
- [ ] フロントマター解析テストケース作成
- [ ] 回帰テスト実装

## 実装アプローチ

### Phase 1: 緊急修正
```javascript
// より堅牢なfrontmatter解析
function parseRobustFrontmatter(content) {
  // YAML.parse を使用した適切な解析
  // エラーハンドリングの追加
  // データ型検証の実装
}
```

### Phase 2: 構造改善
- ファイル読み込み順序の最適化
- データマージロジックの再設計
- パフォーマンス向上

## テスト項目

- [ ] 各トレーニングファイルでの正しいタイトル取得
- [ ] 複雑なYAML構造の正確な解析
- [ ] エラー状況での適切なフォールバック
- [ ] パフォーマンス回帰テスト

## 完了基準

- [ ] Console ログで正しいトレーニングタイトルが表示される
- [ ] Edge Function ログでデータ解析エラーが発生していない
- [ ] 全トレーニングが期待通りの情報で表示される

---

**担当**: バックエンド開発チーム  
**期限**: 3日以内  
**関連チケット**: #06, #08, #09  
**技術要件**: Deno, Supabase Edge Functions, YAML処理